<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì§ì‹œê³µ ë°œì£¼ í”„ë¡œê·¸ë¨</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["'Pretendard Variable'", "Pretendard", "Inter", "sans-serif"],
          },
          colors: {
            brand: '#00A1FF',
            'brand-weak': '#F0F8FC',
            'genuine-blue': { 50:'#F0F8FC',100:'#D9EFFF',200:'#9ED7FF',300:'#5EBFFF',400:'#00A1FF',500:'#0A78C0',600:'#095890',700:'#064470',800:'#072B47',900:'#06192B' },
            success: { DEFAULT:'#16a34a', weak:'#f0fdf4', foreground:'#15803d' },
            warning: { DEFAULT:'#fbbf24', weak:'#fffbeb', foreground:'#b45309' },
            destructive: { DEFAULT:'#dc2626', weak:'#fef2f2', foreground:'#fef2f2' },
            muted: { DEFAULT:'#f3f4f6', foreground:'#6b7280' },
            accent: { DEFAULT:'#f3f4f6', foreground:'#111827' },
          },
          borderRadius: { '2xl':'1rem', '3xl':'1.25rem' },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: 'Pretendard Variable', 'Pretendard', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; letter-spacing: -0.3px; word-break: keep-all; }
    ::-webkit-scrollbar { height: 6px; width: 6px; }
    ::-webkit-scrollbar-track { background: #F3F4F6; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

    /* Typography classes */
    .body-xs  { font-size: 0.625rem; line-height: 1.375; font-weight: 400; }
    .body-sm  { font-size: 0.75rem;  line-height: 1.375; font-weight: 400; }
    .body-md  { font-size: 0.875rem; line-height: 1.375; font-weight: 400; }
    .body-lg  { font-size: 1rem;     line-height: 1.375; font-weight: 400; }
    .heading-xs { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-sm { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-md { font-size: 1.125rem; line-height: 1.25; font-weight: 600; }
    .heading-lg { font-size: 1.25rem;  line-height: 1.25; font-weight: 600; }
    .heading-xl { font-size: 1.5rem;   line-height: 1.25; font-weight: 600; }

    /* ì²´í¬ë°•ìŠ¤ ì»¤ìŠ¤í…€ */
    .cb-custom {
      appearance: none; -webkit-appearance: none;
      width: 16px; height: 16px;
      border: 1.5px solid #D1D5DB;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      position: relative;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .cb-custom:checked {
      background: #111827;
      border-color: #111827;
    }
    .cb-custom:checked::after {
      content: '';
      position: absolute;
      left: 3px; top: 0px;
      width: 5px; height: 9px;
      border: 2px solid #fff;
      border-top: none; border-left: none;
      transform: rotate(45deg);
    }
    .cb-custom:indeterminate {
      background: #111827;
      border-color: #111827;
    }
    .cb-custom:indeterminate::after {
      content: '';
      position: absolute;
      left: 2px; top: 5px;
      width: 8px; height: 2px;
      background: #fff;
      border-radius: 1px;
    }
    .cb-custom:hover:not(:checked) { border-color: #111827; }

    /* Button transitions */
    .btn-primary { 
      background: #00A1FF; color: #fff; font-weight: 600;
      transition: all 0.15s;
    }
    .btn-primary:hover { background: #0A78C0; }
    .btn-primary:active { transform: scale(0.97); }
    .btn-primary:disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; transform: none; }
    
    .btn-outline {
      background: #fff; border: 1px solid #e5e7eb; color: #374151; font-weight: 600;
      transition: all 0.15s;
    }
    .btn-outline:hover { background: #f9fafb; border-color: #d1d5db; }
    .btn-outline:active { transform: scale(0.97); }

    .btn-destructive {
      background: #dc2626; color: #fff; font-weight: 600;
      transition: all 0.15s;
    }
    .btn-destructive:hover { background: #b91c1c; }
    .btn-destructive:active { transform: scale(0.97); }

    @keyframes fadeIn { 0% { opacity:0; transform:translateY(6px); } 100% { opacity:1; transform:translateY(0); } }
  </style>
  <meta property="og:title" content="ì§ì‹œê³µ ë°œì£¼ í”„ë¡œê·¸ë¨">
  <meta name="twitter:title" content="ì§ì‹œê³µ ë°œì£¼ í”„ë¡œê·¸ë¨">
  <meta name="description" content="Lovable Generated Project">
  <meta property="og:description" content="Lovable Generated Project">
  <meta name="twitter:description" content="Lovable Generated Project">
  <meta property="og:image" content="https://pub-bb2e103a32db4e198524a2e9ed8f35b4.r2.dev/f31ce985-1de9-4228-a3ba-1300b3a3bdda/id-preview-6c350680--9547eb62-de2c-4760-89d1-dc58aec41b2f.lovable.app-1772167717281.png">
  <meta name="twitter:image" content="https://pub-bb2e103a32db4e198524a2e9ed8f35b4.r2.dev/f31ce985-1de9-4228-a3ba-1300b3a3bdda/id-preview-6c350680--9547eb62-de2c-4760-89d1-dc58aec41b2f.lovable.app-1772167717281.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
</head>
<body class="bg-[#F9FAFB] min-h-screen">
<div id="root"></div>

<script>
  (function () {
    const path = window.location.pathname.replace(/\/+$/, '');
    const routeAliasMap = {
      '/detail': '/detail.html',
      '/factory': '/factory.html',
      '/countertop': '/countertop.html',
      '/supplier': '/supplier.html',
      '/engineer': '/engineer.html',
      '/portal-login': '/portal-login.html',
    };
    const target = routeAliasMap[path];
    if (target) {
      window.location.replace(`${target}${window.location.search}${window.location.hash}`);
    }
  })();
</script>

<script type="text/babel">
const { useState, useMemo, useEffect, useRef, useCallback } = React;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1. ìƒìˆ˜ / í—¬í¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const _kstDateStr = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Seoul' }); // "YYYY-MM-DD"
const TODAY = new Date(_kstDateStr + 'T00:00:00');
const TODAY_STR = _kstDateStr;

/* â”€â”€ Supabase DB ìœ í‹¸ â”€â”€ */
const SUPABASE_URL = "https://ykifurzrrbjrgjrznimk.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlraWZ1cnpycmJqcmdqcnpuaW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjE3NTcsImV4cCI6MjA4NzY5Nzc1N30.BVTlrG_Q_cXqj6qOa_rZPXrCs7MhwuR9o8koncGoUU0";
const SB_HEADERS = { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" };

function safeText(v) {
  if (typeof v === "string") return v;
  if (v == null) return "";
  return String(v);
}

function ensureObject(v) {
  return v && typeof v === "object" && !Array.isArray(v) ? v : {};
}

function normalizeCaseShape(raw) {
  if (!raw) return null;
  const schedule = ensureObject(raw.schedule);
  const status = ensureObject(raw.status);
  const normalized = {
    ...raw,
    id: safeText(raw.id),
    customer: safeText(raw.customer),
    phone: safeText(raw.phone),
    address: safeText(raw.address),
    manager: safeText(raw.manager),
    schedule,
    status,
    archived: !!raw.archived,
    cancelled: !!raw.cancelled,
  };
  return normalized.id ? normalized : null;
}

function dbRowToCase(r) {
  return normalizeCaseShape({
    id: r.id, customer: r.customer || "", phone: r.phone || "", address: r.address || "", manager: r.manager || "",
    schedule: r.schedule || {}, status: r.status || {},
    archived: r.archived || false, cancelled: r.cancelled || false,
    mokdaeVersions: r.mokdae_versions || [], mokdaeUploadedFiles: r.mokdae_uploaded_files || {},
    cadVersions: r.cad_versions || [],
    mokdaeConsumerApproved: r.mokdae_consumer_approved || false, mokdaeConfirmedAt: r.mokdae_confirmed_at || null,
    mokdaeClaims: r.mokdae_claims || [],
    mokdaeProductionStarted: r.mokdae_production_started || false,
    mokdaeFinalDate: r.mokdae_final_date || "",
    sangpanVersions: r.sangpan_versions || [], sangpanUploadedFiles: r.sangpan_uploaded_files || {},
    sangpanDrawingVersions: r.sangpan_drawing_versions || [],
    sangpanConsumerApproved: r.sangpan_consumer_approved || false, sangpanConfirmedAt: r.sangpan_confirmed_at || null,
    sangpanClaims: r.sangpan_claims || [],
    sangpanProductionStarted: r.sangpan_production_started || false,
    sangpanFinalDate: r.sangpan_final_date || "",
    gigiFinalDate: r.gigi_final_date || "",
    silcheukProposals: r.silcheuk_proposals || [], silcheukSent: r.silcheuk_sent || false,
    silcheukEngResponse: r.silcheuk_eng_response || null,
    silcheukFinalized: r.silcheuk_finalized || false,
    silcheukFinalDate: r.silcheuk_final_date || "", silcheukFinalTime: r.silcheuk_final_time || "",
    silcheukUploadResult: r.silcheuk_upload_result || null, silcheukResultDone: r.silcheuk_result_done || false,
  });
}

async function loadAllCasesFromDB() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/cases?select=*&order=created_at.desc`, {
      headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
    });
    if (!res.ok) throw new Error("fetch failed");
    return (await res.json()).map(dbRowToCase).filter(Boolean);
  } catch (e) { console.warn("DB load failed:", e); return null; }
}

async function patchCaseInDB(caseId, fields) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/cases?id=eq.${encodeURIComponent(caseId)}`, {
    method: "PATCH",
    headers: SB_HEADERS,
    body: JSON.stringify(fields),
  });
  if (!res.ok) throw new Error(`DB patch failed: ${caseId}`);
}

/* â”€â”€ localStorage ìœ í‹¸ (í•˜ìœ„ í˜¸í™˜) â”€â”€ */
const LS_KEY = 'JIKSIGONG_DATA';

function loadData() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return [];
}

function saveData(items) {
  try { localStorage.setItem(LS_KEY, JSON.stringify(items)); } catch(e) {}
}

function generateNewId(items) {
  const year = new Date().getFullYear();
  const nums = items.map(i => {
    const m = i.id.match(/C-\d{4}-(\d+)/);
    return m ? parseInt(m[1]) : 0;
  });
  const max = nums.length > 0 ? Math.max(...nums) : 0;
  return `C-${year}-${String(max + 1).padStart(3, '0')}`;
}

function daysDiff(dateStr) {
  if (!dateStr) return null;
  const d = new Date(dateStr);
  return Math.floor((d - TODAY) / (1000 * 60 * 60 * 24));
}

function isUrgentDate(dateStr) {
  const diff = daysDiff(dateStr);
  return diff !== null && diff <= 2;
}

function getBadgeStyle(text) {
  if (!text) return "bg-gray-100 text-muted-foreground";
  const t = text.toLowerCase();

  if (
    t.includes("ë°˜ë ¤") || t.includes("ìˆ˜ì •ìš”ì²­") || t.includes("ìˆ˜ì • ìš”ì²­") ||
    t.includes("ê¸´ê¸‰") || t.includes("ì¬ë§ˆê°ìš”ì²­") || t.includes("ì¬ë§ˆê° ìš”ì²­")
  ) return "bg-destructive-weak text-red-700 border border-red-200 font-semibold";

  if (t.includes("ì¡°ì •") && !t.includes("ê¸´ê¸‰"))
    return "bg-orange-50 text-orange-700 border border-orange-200 font-semibold";

  if (t.includes("í™•ì •") || t.includes("ì™„ë£Œ") || t.includes("í™•ì¸"))
    return "bg-success-weak text-success-foreground border border-green-200 font-semibold";

  if (t.includes("ì œì‘ì§„í–‰"))
    return "bg-teal-50 text-teal-700 border border-teal-200 font-semibold";

  if (t.includes("ì§„í–‰") || t.includes("ê²€í† "))
    return "bg-brand-weak text-brand border border-brand/20 font-medium";

  if (t.includes("ì˜ˆì •") || t.includes("ì™„ë£ŒëŒ€ê¸°"))
    return "bg-brand-weak text-brand border border-brand/20 font-medium";

  if (t.includes("ëŒ€ê¸°") || t.includes("ë¯¸ë°°ì •"))
    return "bg-gray-100 text-muted-foreground border border-gray-200";

  if (t.includes("ì¡°ìœ¨"))
    return "bg-warning-weak text-warning-foreground border border-amber-200 font-medium";

  return "bg-gray-100 text-gray-600 border border-gray-200";
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   3. ìì¬ DB ì—…ë¡œë“œ ëª¨ë‹¬
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function MaterialDbModal({ open, onClose }) {
  const [dragging, setDragging]     = useState(false);
  const [uploadedFile, setUploadedFile] = useState(null);
  const [uploading, setUploading]   = useState(false);
  const [done, setDone]             = useState(false);
  const [uploadResult, setUploadResult] = useState(null);
  const [uploadError, setUploadError]   = useState(null);
  const fileInputRef = useRef(null);

  useEffect(() => {
    const fn = e => e.key === "Escape" && handleClose();
    if (open) document.addEventListener("keydown", fn);
    return () => document.removeEventListener("keydown", fn);
  }, [open]);

  const handleClose = () => {
    if (uploading) return;
    setDragging(false); setUploadedFile(null); setUploading(false); setDone(false);
    setUploadResult(null); setUploadError(null);
    onClose();
  };

  const acceptFile = useCallback((file) => {
    if (!file) return;
    const ext = file.name.split(".").pop().toLowerCase();
    if (!["xlsx", "xls", "csv"].includes(ext)) { alert("xlsx / xls / csv íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•´ìš”."); return; }
    setUploadedFile(file); setDone(false); setUploadError(null);
  }, []);

  const handleDragOver  = e => { e.preventDefault(); setDragging(true); };
  const handleDragLeave = e => { e.preventDefault(); setDragging(false); };
  const handleDrop = e => { e.preventDefault(); setDragging(false); acceptFile(e.dataTransfer.files[0]); };
  const handleInputChange = e => { acceptFile(e.target.files[0]); e.target.value = ""; };
  const handleUpload = async () => {
    if (!uploadedFile) return;
    setUploading(true);
    setUploadError(null);
    try {
      const SUPABASE_URL = "https://ykifurzrrbjrgjrznimk.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlraWZ1cnpycmJqcmdqcnpuaW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjE3NTcsImV4cCI6MjA4NzY5Nzc1N30.BVTlrG_Q_cXqj6qOa_rZPXrCs7MhwuR9o8koncGoUU0";
      const formData = new FormData();
      formData.append("file", uploadedFile);
      const res = await fetch(`${SUPABASE_URL}/functions/v1/parse-materials`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${SUPABASE_KEY}` },
        body: formData,
      });
      const json = await res.json();
      if (!res.ok || json.error) {
        setUploadError(json.error || "ì—…ë¡œë“œ ì‹¤íŒ¨");
        setUploading(false);
        return;
      }
      setUploadResult(json);
      setUploading(false);
      setDone(true);
    } catch (err) {
      setUploadError(String(err));
      setUploading(false);
    }
  };

  const sizeLabel = uploadedFile
    ? uploadedFile.size < 1024 * 1024
      ? `${(uploadedFile.size / 1024).toFixed(1)} KB`
      : `${(uploadedFile.size / 1024 / 1024).toFixed(2)} MB`
    : "";

  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={handleClose}>
      <div className="relative w-full max-w-lg bg-white rounded-2xl shadow overflow-hidden" onClick={e => e.stopPropagation()}>
        <div className="bg-gray-900 px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 bg-white/10 rounded-xl flex items-center justify-center">
              <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7M9 11l3 3 3-3M12 14V3" />
              </svg>
            </div>
            <div>
              <h2 className="text-sm font-semibold text-white">ìì¬ ë§ˆìŠ¤í„° DB ì—…ë°ì´íŠ¸</h2>
              <p className="text-xs text-gray-400 mt-1">ì—‘ì…€ íŒŒì¼ë¡œ ê¸°ê¸°/ìì¬ ëª©ë¡ì„ ì¼ê´„ ê°±ì‹ í•´ìš”.</p>
            </div>
          </div>
          <button onClick={handleClose} disabled={uploading}
            className="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors disabled:opacity-40">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div className="px-6 py-5 space-y-4">
          {done ? (
            <div className="flex flex-col items-center justify-center py-8 gap-4 text-center">
              <div className="w-16 h-16 rounded-full bg-emerald-50 border border-emerald-200 flex items-center justify-center">
                <svg className="w-8 h-8 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <p className="text-base font-semibold text-gray-900">ì—…ë¡œë“œ ì™„ë£Œ</p>
                <p className="text-sm text-gray-500 mt-1">
                  <span className="font-medium text-gray-700">{uploadedFile.name}</span> íŒŒì¼ì˜ ìì¬ ë°ì´í„°ê°€ ë°˜ì˜ë˜ì—ˆì–´ìš”.
                </p>
              </div>
              <div className="text-xs text-gray-400 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 w-full">
                <div className="flex gap-6 justify-center mb-2">
                  <span>ğŸ“¦ ì´ {uploadResult ? uploadResult.totalInserted : 0}ê°œ í•­ëª© ë°˜ì˜</span>
                  <span>ğŸ• {new Date().toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit" })} ë°˜ì˜</span>
                </div>
                {uploadResult && uploadResult.categories && (
                  <div className="flex flex-wrap gap-1.5 justify-center">
                    {Object.entries(uploadResult.categories).map(([cat, cnt]) => (
                      <span key={cat} className="bg-white border border-gray-200 px-2 py-0.5 rounded-full text-gray-600">
                        {cat} <span className="font-semibold text-gray-800">{cnt}</span>
                      </span>
                    ))}
                  </div>
                )}
              </div>
              <button onClick={handleClose} className="w-full h-10 rounded-lg text-sm font-medium bg-gray-900 hover:bg-gray-800 text-white transition-colors">í™•ì¸</button>
            </div>
          ) : (
            <>
              <div className="flex items-start gap-2 bg-brand-weak border border-brand/20 rounded-lg px-4 py-3">
                <svg className="w-4 h-4 text-brand mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p className="text-xs text-brand leading-relaxed">
                  ì‚¬ì „ ë°°í¬ëœ <span className="font-semibold">ìì¬ ë§ˆìŠ¤í„° í…œí”Œë¦¿(.xlsx)</span> ì–‘ì‹ì— ë§ì¶° ì‘ì„±ëœ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.
                  ê¸°ì¡´ DBëŠ” ì´ íŒŒì¼ë¡œ <span className="font-semibold">ì „ì²´ ë®ì–´ì“°ê¸°</span>ë©ë‹ˆë‹¤.
                </p>
              </div>
              <div
                onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}
                onClick={() => !uploadedFile && fileInputRef.current?.click()}
                className={`relative flex flex-col items-center justify-center gap-3 rounded-xl border-2 border-dashed transition-all duration-200
                  ${uploadedFile ? "border-emerald-400 bg-emerald-50 cursor-default py-5"
                    : dragging ? "border-brand bg-brand-weak scale-[1.01] py-10 cursor-copy"
                    : "border-gray-200 bg-gray-50 hover:border-brand hover:bg-brand-weak py-10 cursor-pointer"}`}>
                <input ref={fileInputRef} type="file" accept=".xlsx,.xls,.csv" className="hidden" onChange={handleInputChange} />
                {uploadedFile ? (
                  <div className="flex items-center gap-4 w-full px-6">
                    <div className="w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center flex-shrink-0">
                      <svg className="w-5 h-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-gray-900 truncate">{uploadedFile.name}</p>
                      <p className="text-xs text-gray-400 mt-1">{sizeLabel}</p>
                    </div>
                    <button onClick={e => { e.stopPropagation(); setUploadedFile(null); setDone(false); }}
                      className="w-7 h-7 flex items-center justify-center rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors flex-shrink-0">
                      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                ) : (
                  <>
                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center transition-colors ${dragging ? "bg-brand-weak" : "bg-white border border-gray-200 shadow-sm"}`}>
                      <svg className={`w-6 h-6 transition-colors ${dragging ? "text-brand" : "text-gray-400"}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                      </svg>
                    </div>
                    <div className="text-center">
                      <p className={`text-sm font-medium transition-colors ${dragging ? "text-brand" : "text-gray-600"}`}>
                        {dragging ? "ì—¬ê¸°ì— íŒŒì¼ì„ ë†“ìœ¼ì„¸ìš”!" : "ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ë¡œ ëŒì–´ì˜¤ê±°ë‚˜"}
                      </p>
                      {!dragging && <p className="text-xs text-gray-400 mt-1"><span className="text-brand font-medium underline underline-offset-2">íŒŒì¼ ì„ íƒ</span>ì„ ëˆŒëŸ¬ ì—…ë¡œë“œí•´ìš”</p>}
                    </div>
                    <div className="flex items-center gap-2 text-xs text-gray-400">
                      {[".xlsx", ".xls", ".csv"].map(ext => (
                        <span key={ext} className="bg-white border border-gray-200 px-2 py-1 rounded-full font-mono">{ext}</span>
                      ))}
                    </div>
                  </>
                )}
              </div>
              <div className="flex items-start gap-2 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-4 py-3">
                <svg className="w-4 h-4 text-amber-500 mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                </svg>
                <span>ì—…ë¡œë“œ ì¦‰ì‹œ ëª¨ë“  í˜„ì¥ì˜ ê¸°ê¸° ì„ íƒ ëª©ë¡ì´ ê°±ì‹ ë¼ìš”. ì˜ëª»ëœ íŒŒì¼ ì—…ë¡œë“œ ì‹œ ë¡¤ë°±ì´ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”.</span>
              </div>
              {uploadError && (
                <div className="flex items-start gap-2 text-xs text-red-700 bg-red-50 border border-red-200 rounded-lg px-4 py-3">
                  <svg className="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>{uploadError}</span>
                </div>
              )}
              <div className="flex gap-3 pt-1">
                <button onClick={handleClose} className="flex-1 h-10 rounded-lg text-sm font-medium border border-gray-200 text-gray-700 hover:bg-gray-50 transition-colors">ì·¨ì†Œ</button>
                <button onClick={handleUpload} disabled={!uploadedFile || uploading}
                  className="flex-1 h-10 rounded-lg text-sm font-semibold bg-brand hover:bg-[#0090e6] disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed text-white transition-colors flex items-center justify-center gap-2">
                  {uploading ? (
                    <><svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>ì—…ë¡œë“œ ì¤‘â€¦</>
                  ) : (
                    <><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>DB ì—…ë°ì´íŠ¸ ì ìš©</>
                  )}
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   4. ì„œë¸Œ ì»´í¬ë„ŒíŠ¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function StatusBadge({ text, defaultText }) {
  const display = text || defaultText || "";
  if (!display) return <span className="text-gray-300">-</span>;
  return (
    <span className={`inline-block px-2 py-1 rounded-full text-xs whitespace-nowrap ${getBadgeStyle(display)}`}>
      {display}
    </span>
  );
}

function DateCell({ dateStr }) {
  if (!dateStr) return <span className="text-gray-300">-</span>;
  const diff = daysDiff(dateStr);
  const urgent = diff !== null && diff <= 2;
  let dLabel = null;
  if (diff !== null) {
    if (diff === 0)       dLabel = "(ì˜¤ëŠ˜)";
    else if (diff < 0)   dLabel = `(D${diff})`;
    else                 dLabel = `(D-${diff})`;
  }
  return (
    <div className="flex flex-col items-center leading-snug">
      <span className={urgent ? "text-red-600 font-semibold whitespace-nowrap" : "text-gray-700 whitespace-nowrap"}>
        {dateStr}
      </span>
      {dLabel && (
        <span className={`text-xs mt-0.5 whitespace-nowrap ${urgent ? "text-red-500 font-semibold" : "text-gray-400"}`}>
          {dLabel}
        </span>
      )}
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   5. í…Œì´ë¸” (ì²´í¬ë°•ìŠ¤ í¬í•¨)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function OrderTable({ data, selectedIds, onToggleSelect, onToggleAll }) {
  const [hoveredRow, setHoveredRow] = useState(null);

  const allSelected  = data.length > 0 && selectedIds.length === data.length;
  const someSelected = selectedIds.length > 0 && selectedIds.length < data.length;

  const headerCbRef = useRef(null);
  useEffect(() => {
    if (headerCbRef.current) headerCbRef.current.indeterminate = someSelected;
  }, [someSelected]);

  const colGroups = [
    { label: "",         span: 1, cls: "bg-gray-50 border-r border-gray-200" },
    { label: "ê¸°ë³¸ ì •ë³´", span: 5, cls: "bg-gray-50" },
    { label: "ì¼ì •",      span: 4, cls: "bg-brand-weak" },
    { label: "ì§„í–‰ ìƒíƒœ", span: 4, cls: "bg-gray-50" },
  ];

  const cols = [
    { label: "",           w: "w-10"  },
    { label: "ë‹´ë‹¹ì",  w: "w-20"  },
    { label: "ìƒë‹´ ID", w: "w-36"  },
    { label: "ê³ ê°ëª…",  w: "w-14"  },
    { label: "ì „í™”ë²ˆí˜¸",    w: "w-32"  },
    { label: "í˜„ì¥ ì£¼ì†Œ",   w: "w-56"  },
    { label: "ì‹¤ì¸¡ ì¼ì •",   w: "w-32"  },
    { label: "ëª©ëŒ€ ì¼ì •",   w: "w-32"  },
    { label: "ê¸°ê¸° ì¼ì •",   w: "w-32"  },
    { label: "ìƒíŒ ì¼ì •",   w: "w-32"  },
    { label: "ì‹¤ì¸¡ ë‹¨ê³„",   w: "w-24"  },
    { label: "ëª©ëŒ€ ë°œì£¼",   w: "w-36"  },
    { label: "ê¸°ê¸° ë°œì£¼",   w: "w-32"  },
    { label: "ìƒíŒ ë°œì£¼",   w: "w-36"  },
  ];

  return (
    <div className="overflow-x-auto">
      <table className="w-full border-collapse text-sm" style={{ minWidth: "1440px" }}>
        <thead className="sticky top-0 z-10 bg-white border-b border-gray-200">
          {/* ì»¬ëŸ¼ ê·¸ë£¹ í–‰ */}
          <tr className="border-b border-gray-200">
            {colGroups.map((g, i) => (
              <th key={i} colSpan={g.span}
                className={`${g.cls} text-gray-600 text-center py-2 body-sm font-semibold tracking-normal ${i < colGroups.length - 1 ? "border-r border-gray-200" : ""}`}>
                {g.label}
              </th>
            ))}
          </tr>
          {/* ì»¬ëŸ¼ í—¤ë” í–‰ */}
          <tr className="bg-gray-50 text-gray-600 body-sm border-b border-gray-200">
            {cols.map((col, i) => (
              <th key={i}
                className={`${col.w} py-2.5 px-3 text-center font-semibold whitespace-pre-line ${i < cols.length - 1 ? "border-r border-gray-200" : ""}`}>
                {i === 0 ? (
                  <div className="flex items-center justify-center">
                    <input
                      ref={headerCbRef}
                      type="checkbox"
                      className="cb-custom"
                      checked={allSelected}
                      onChange={e => onToggleAll(e.target.checked)}
                      onClick={e => e.stopPropagation()}
                    />
                  </div>
                ) : col.label}
              </th>
            ))}
          </tr>
        </thead>

        <tbody>
          {data.length === 0 && (
            <tr>
              <td colSpan={14} className="py-20 text-center text-gray-400 bg-white">
                <div className="flex flex-col items-center gap-2">
                  <svg className="w-10 h-10 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                  </svg>
                  <span className="text-sm">ë°ì´í„°ê°€ ì—†ì–´ìš”.</span>
                </div>
              </td>
            </tr>
          )}
          {data.map((row, idx) => {
            const isSelected = selectedIds.includes(row.id);
            const isHovered  = hoveredRow === row.id;
            const base = idx % 2 === 0 ? "bg-white" : "bg-[#FAFBFC]";
            const rowBg = isSelected ? "bg-genuine-blue-50" : isHovered ? "bg-gray-50" : base;

            return (
              <tr
                key={row.id}
                className={`${rowBg} cursor-pointer border-b border-gray-200 transition-colors duration-75 group`}
                onMouseEnter={() => setHoveredRow(row.id)}
                onMouseLeave={() => setHoveredRow(null)}
                onClick={() => {
                  sessionStorage.setItem('CURRENT_CASE_ID', row.id);
                  window.location.href = 'detail.html';
                }}
              >
                {/* ì²´í¬ë°•ìŠ¤ */}
                <td className="px-3 py-3 text-center border-r border-gray-200" onClick={e => e.stopPropagation()}>
                  <div className="flex items-center justify-center">
                    <input
                      type="checkbox"
                      className="cb-custom"
                      checked={isSelected}
                      onChange={() => onToggleSelect(row.id)}
                    />
                  </div>
                </td>

                {/* ë‹´ë‹¹ì */}
                <td className="px-3 py-2 text-center border-r border-gray-200">
                  <span className="text-xs text-gray-700 font-medium">{row.manager || "-"}</span>
                </td>

                {/* ìƒë‹´ID */}
                <td className="px-3 py-2 text-center border-r border-gray-200">
                  <span className="font-mono text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded">{row.id}</span>
                </td>

                {/* ê³ ê°ëª… */}
                <td className="px-3 py-2 text-center font-medium text-gray-900 border-r border-gray-200 whitespace-nowrap">
                  {row.customer}
                </td>

                {/* ì „í™”ë²ˆí˜¸ */}
                <td className="px-3 py-2 text-center text-gray-600 border-r border-gray-200 font-mono text-xs">
                  {row.phone}
                </td>

                {/* í˜„ì¥ì£¼ì†Œ */}
                <td className="px-3 py-2 text-gray-600 border-r border-gray-200 text-xs leading-relaxed break-words" title={row.address}>
                  {row.address}
                </td>

                {/* ì¼ì • 4ê°œ */}
                <td className="px-3 py-2 text-center border-r border-gray-200 border-l-2 border-l-brand/20 text-xs">
                  <DateCell dateStr={row.schedule.silcheuk} />
                </td>
                <td className="px-3 py-2 text-center border-r border-gray-200 text-xs">
                  <DateCell dateStr={row.schedule.mokdae} />
                </td>
                <td className="px-3 py-2 text-center border-r border-gray-200 text-xs">
                  <DateCell dateStr={row.schedule.gigi} />
                </td>
                <td className="px-3 py-2 text-center border-r border-gray-200 text-xs">
                  <DateCell dateStr={row.schedule.sangpan} />
                </td>

                {/* ìƒíƒœ 4ê°œ */}
                <td className="px-3 py-2 text-center border-r border-gray-200 border-l-2 border-l-gray-300">
                  <StatusBadge text={row.status.silcheuk} defaultText="ì‹¤ì¸¡ ìš”ì²­ ëŒ€ê¸°" />
                </td>
                <td className="px-3 py-2 text-center border-r border-gray-200">
                  <StatusBadge text={row.status.mokdae} defaultText="ë°œì£¼ ìš”ì²­ ëŒ€ê¸°" />
                </td>
                <td className="px-3 py-2 text-center border-r border-gray-200">
                  <StatusBadge text={row.status.gigi} defaultText="ë°œì£¼ ìš”ì²­ ëŒ€ê¸°" />
                </td>
                <td className="px-3 py-2 text-center">
                  <StatusBadge text={row.status.sangpan} defaultText="ë°œì£¼ ìš”ì²­ ëŒ€ê¸°" />
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   6. í•„í„° ë°”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function FilterBar({ search, onSearch, managerFilter, onManagerFilter, managers }) {
  return (
    <div className="flex flex-wrap items-center gap-3 px-4 py-3 bg-white border-b border-gray-200">
      <div className="relative">
        <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z" />
        </svg>
        <input
          type="text" placeholder="ê³ ê°ëª… / ìƒë‹´ID / ì£¼ì†Œ ê²€ìƒ‰â€¦"
          value={search} onChange={e => onSearch(e.target.value)}
          className="pl-9 pr-4 h-9 text-sm border border-gray-200 rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent bg-white"
        />
      </div>
      <select
        value={managerFilter} onChange={e => onManagerFilter(e.target.value)}
        className="text-sm border border-gray-200 rounded-lg px-3 h-9 focus:outline-none focus:ring-2 focus:ring-brand bg-white text-gray-700">
        <option value="">ì „ì²´ ë‹´ë‹¹ì</option>
        {managers.map(m => <option key={m} value={m}>{m}</option>)}
      </select>
      <div className="ml-auto flex items-center gap-4 text-xs text-gray-500">
        <span className="flex items-center gap-1"><span className="inline-block w-2 h-2 rounded-full bg-red-500"></span>ì¼ì • ì„ë°•/ì´ˆê³¼ (D-2 ì´ë‚´)</span>
        <span className="flex items-center gap-1"><span className="inline-block w-2 h-2 bg-red-100 border border-red-300 rounded-full"></span>ë°˜ë ¤/ê¸´ê¸‰</span>
        <span className="flex items-center gap-1"><span className="inline-block w-2 h-2 bg-emerald-100 border border-emerald-300 rounded-full"></span>í™•ì •/ì™„ë£Œ</span>
      </div>
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   6-b. í˜„ì¥ ì‚­ì œ í™•ì¸ ëª¨ë‹¬
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function DeleteConfirmModal({ open, count, onConfirm, onCancel }) {
  useEffect(() => {
    const fn = e => e.key === "Escape" && onCancel();
    if (open) document.addEventListener("keydown", fn);
    return () => document.removeEventListener("keydown", fn);
  }, [open, onCancel]);

  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onCancel} />
      <div className="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 animate-[fadeIn_0.18s_ease-out]">
        {/* ì•„ì´ì½˜ */}
        <div className="flex items-center justify-center w-12 h-12 bg-red-100 rounded-2xl mx-auto mb-4">
          <svg className="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </div>
        <h3 className="text-base font-bold text-gray-900 text-center mb-1">í˜„ì¥ ì‚­ì œ</h3>
        <p className="text-sm text-gray-500 text-center mb-1">
          ì„ íƒí•œ <span className="font-semibold text-gray-800">{count}ê±´</span>ì˜ í˜„ì¥ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”?
        </p>
        <p className="text-xs text-gray-400 text-center mb-6 leading-relaxed">
          ì‚­ì œëœ í˜„ì¥ì€ indexì—ì„œ ìˆ¨ê²¨ì§€ì§€ë§Œ,<br/>
          ê³µê¸‰ì—…ì²´Â·ê¸°ì‚¬ í™”ë©´ì—ì„œ <span className="font-medium text-red-500">ì·¨ì†Œëœ ìš”ì²­</span>ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
        </p>
        <div className="flex gap-3">
          <button
            onClick={onCancel}
            className="flex-1 h-10 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-gray-50 transition-colors"
          >
            ì·¨ì†Œ
          </button>
          <button
            onClick={onConfirm}
            className="flex-1 h-10 rounded-xl bg-red-600 hover:bg-red-700 text-white text-sm font-semibold transition-colors shadow-sm"
          >
            ì‚­ì œ
          </button>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   7. App (ìµœìƒìœ„)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function App() {
  const [items, setItems]             = useState([]);
  const [loading, setLoading]         = useState(true);
  const [tab, setTab]                 = useState("active");     // "active" | "archived" | "cancelled" | "approvals"
  const [selectedIds, setSelectedIds] = useState([]);
  const [search, setSearch]           = useState("");
  const [managerFilter, setManagerFilter] = useState("");
  const [dbModalOpen, setDbModalOpen] = useState(false);
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
  const [supplierAccounts, setSupplierAccounts] = useState([]);
  const [pendingCount, setPendingCount] = useState(0);

  /* DB primary load + gigi_store ë³‘í•© */
  const refreshFromDB = useCallback(async () => {
    try {
      const [casesFromDb, gigiRows] = await Promise.all([
        loadAllCasesFromDB(),
        fetch(`${SUPABASE_URL}/rest/v1/gigi_store?select=case_id,data`, {
          headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
        }).then(r => r.ok ? r.json() : []).catch(() => []),
      ]);

      if (casesFromDb) {
        const gigiMap = {};
        gigiRows.forEach(g => {
          if (g?.case_id) gigiMap[g.case_id] = ensureObject(g.data);
        });

        const merged = casesFromDb
          .map(c => {
            const gigiData = gigiMap[c.id];
            if (!gigiData || Object.keys(gigiData).length === 0) return normalizeCaseShape(c);
            return normalizeCaseShape({
              ...c,
              gigiOrderData: gigiData,
              status: { ...ensureObject(c.status), gigi: gigiData.status || ensureObject(c.status).gigi },
            });
          })
          .filter(Boolean);

        setItems(merged);
        saveData(merged);
      } else {
        setItems((loadData() || []).map(normalizeCaseShape).filter(Boolean));
      }
    } catch (e) {
      console.warn("DB load failed, fallback to localStorage:", e);
      setItems((loadData() || []).map(normalizeCaseShape).filter(Boolean));
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => { refreshFromDB(); }, [refreshFromDB]);

  /* ê³µê¸‰ì‚¬ ê³„ì • ë¡œë“œ */
  const loadSupplierAccounts = useCallback(async () => {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/supplier_accounts?select=*&order=created_at.desc`, {
        headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
      });
      if (res.ok) {
        const data = await res.json();
        setSupplierAccounts(data);
        setPendingCount(data.filter(a => !a.approved).length);
      }
    } catch (e) { console.warn("supplier_accounts load failed:", e); }
  }, []);

  useEffect(() => { loadSupplierAccounts(); }, [loadSupplierAccounts]);

  /* íƒ­ ì „í™˜ ì‹œ DB ìƒˆë¡œê³ ì¹¨ */
  useEffect(() => {
    const onVisible = () => { if (document.visibilityState === 'visible') refreshFromDB(); };
    document.addEventListener('visibilitychange', onVisible);
    return () => document.removeEventListener('visibilitychange', onVisible);
  }, [refreshFromDB]);

  /* ì‹¤ì‹œê°„ ëˆ„ë½ ëŒ€ë¹„ í´ë§ fallback */
  useEffect(() => {
    const timer = setInterval(() => { refreshFromDB(); loadSupplierAccounts(); }, 20000);
    return () => clearInterval(timer);
  }, [refreshFromDB]);

  /* íƒ­ ì „í™˜ ì‹œ ì„ íƒ ì´ˆê¸°í™” */
  const handleTabChange = t => { setTab(t); setSelectedIds([]); setSearch(""); setManagerFilter(""); };

  /* í•„í„°ëœ í˜„ì¬ íƒ­ ë°ì´í„° */
  const tabData = useMemo(() => {
    if (tab === "cancelled") return items.filter(r => r.cancelled === true);
    return items.filter(r => !r.cancelled && r.archived === (tab === "archived"));
  }, [items, tab]);
  const managers = useMemo(
    () => [...new Set(tabData.map(d => safeText(d.manager)).filter(Boolean))].sort(),
    [tabData]
  );
  const filtered = useMemo(() => {
    return tabData.filter(row => {
      const q = search.toLowerCase();
      const matchSearch = !q
        || safeText(row.customer).toLowerCase().includes(q)
        || safeText(row.id).toLowerCase().includes(q)
        || safeText(row.address).toLowerCase().includes(q);
      const matchManager = !managerFilter || safeText(row.manager) === managerFilter;
      return matchSearch && matchManager;
    });
  }, [tabData, search, managerFilter]);

  /* ì²´í¬ë°•ìŠ¤ */
  const handleToggleSelect = id => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
  };
  const handleToggleAll = checked => {
    setSelectedIds(checked ? filtered.map(r => r.id) : []);
  };

  /* í˜„ì¥ ì´ë™ ì•¡ì…˜ (ì•„ì¹´ì´ë¸Œ â†” ì§„í–‰ì¤‘) â†’ DB ë°˜ì˜ */
  const handleMove = async () => {
    if (selectedIds.length === 0) return;
    const toArchive = tab === "active";

    setItems(prev => {
      const updated = prev.map(r => selectedIds.includes(r.id) ? { ...r, archived: toArchive } : r);
      saveData(updated);
      return updated;
    });

    await Promise.allSettled(selectedIds.map(id => patchCaseInDB(id, { archived: toArchive })));
    await refreshFromDB();
    setSelectedIds([]);
  };

  /* í˜„ì¥ ì‚­ì œ ì•¡ì…˜ â†’ cancelled: true â†’ DB ë°˜ì˜ */
  const handleDelete = async () => {
    if (selectedIds.length === 0) return;

    setItems(prev => {
      const updated = prev.map(r => selectedIds.includes(r.id) ? { ...r, cancelled: true } : r);
      saveData(updated);
      return updated;
    });

    await Promise.allSettled(selectedIds.map(id => patchCaseInDB(id, { cancelled: true })));
    await refreshFromDB();
    setSelectedIds([]);
    setDeleteConfirmOpen(false);
  };

  /* ì·¨ì†Œëœ í˜„ì¥ ë³µì› â†’ ì§„í–‰ì¤‘ìœ¼ë¡œ â†’ DB ë°˜ì˜ */
  const handleRestore = async () => {
    if (selectedIds.length === 0) return;

    setItems(prev => {
      const updated = prev.map(r => selectedIds.includes(r.id) ? { ...r, cancelled: false, archived: false } : r);
      saveData(updated);
      return updated;
    });

    await Promise.allSettled(selectedIds.map(id => patchCaseInDB(id, { cancelled: false, archived: false })));
    await refreshFromDB();
    setSelectedIds([]);
  };

  /* ê³µê¸‰ì‚¬ ê³„ì • ìŠ¹ì¸ */
  const handleApproveAccount = async (accountId) => {
    await fetch(`${SUPABASE_URL}/rest/v1/supplier_accounts?id=eq.${accountId}`, {
      method: "PATCH", headers: SB_HEADERS, body: JSON.stringify({ approved: true }),
    });
    loadSupplierAccounts();
  };

  /* ê³µê¸‰ì‚¬ ê³„ì • ì‚­ì œ (ê±°ì ˆ) */
  const handleRejectAccount = async (accountId) => {
    await fetch(`${SUPABASE_URL}/rest/v1/supplier_accounts?id=eq.${accountId}`, {
      method: "DELETE", headers: SB_HEADERS,
    });
    loadSupplierAccounts();
  };

  const PROCESS_LABELS = { engineer: "ì‹¤ì¸¡ê¸°ì‚¬", factory: "ëª©ëŒ€", supplier: "ê¸°ê¸°", countertop: "ìƒíŒ" };

  /* ì„ë°• ì¼ì • ì¹´ìš´íŠ¸ (í—¤ë”ìš©) â€” ì·¨ì†Œëœ í˜„ì¥ ì œì™¸ */
  const urgentCount = useMemo(
    () => items.filter(r => !r.archived && !r.cancelled).flatMap(r => Object.values(r.schedule)).filter(isUrgentDate).length,
    [items]
  );

  const activeCount    = items.filter(r => !r.archived && !r.cancelled).length;
  const archivedCount  = items.filter(r => r.archived  && !r.cancelled).length;
  const cancelledCount = items.filter(r => r.cancelled === true).length;

  return (
    <div className="min-h-screen bg-[#F9FAFB] flex flex-col">

      {/* â”€â”€ í—¤ë” â”€â”€ */}
      <header className="bg-white text-gray-900 px-6 h-14 flex items-center justify-between border-b border-gray-200 flex-shrink-0">
        <div className="flex items-center gap-3">
          <img src="/images/ohouse-logo.png" alt="ì˜¤ëŠ˜ì˜ì§‘" className="h-10" />
          <div className="h-6 w-px bg-gray-200"></div>
          <span className="text-sm font-medium text-gray-500">ë°œì£¼ ì‹œìŠ¤í…œ</span>
        </div>
        <div className="flex items-center gap-3">
          {urgentCount > 0 && (
            <div className="flex items-center gap-1.5 bg-destructive-weak border border-red-200 text-red-700 px-3 h-7 rounded-full body-sm font-medium">
              <span className="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span>
              ì„ë°• ì¼ì • {urgentCount}ê±´
            </div>
          )}
          <div className="body-sm text-muted-foreground hidden sm:block">
            ì˜¤ëŠ˜ <span className="text-gray-900 font-semibold">{TODAY_STR}</span>
          </div>
          <div className="w-px h-4 bg-gray-200"></div>
          <button onClick={() => setDbModalOpen(true)}
            className="btn-outline flex items-center gap-2 px-3 h-8 rounded-lg body-sm">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7M9 11l3 3 3-3M12 14V3" />
            </svg>
            ìì¬ DB ì—…ë¡œë“œ
          </button>
        </div>
      </header>

      <MaterialDbModal open={dbModalOpen} onClose={() => setDbModalOpen(false)} />
      <DeleteConfirmModal
        open={deleteConfirmOpen}
        count={selectedIds.length}
        onConfirm={handleDelete}
        onCancel={() => setDeleteConfirmOpen(false)}
      />

      {/* â”€â”€ ë©”ì¸ ì»¨í…ì¸  â”€â”€ */}
      <div className="flex-1 flex flex-col px-6 py-5 gap-4">

        {/* â”€â”€ íƒ­ + í˜„ì¥ ì¶”ê°€ ë²„íŠ¼ â”€â”€ */}
        <div className="flex items-center justify-between">
          {/* íƒ­ â€” ì–¸ë”ë¼ì¸ ìŠ¤íƒ€ì¼ */}
          <div className="flex items-center gap-1 border-b border-gray-200">
            <button
              onClick={() => handleTabChange("active")}
              className={`flex items-center gap-2 px-4 h-10 body-md font-semibold transition-all border-b-2 -mb-px ${
                tab === "active"
                  ? "border-brand text-brand"
                  : "border-transparent text-muted-foreground hover:text-gray-800"
              }`}
            >
              ì§„í–‰ ì¤‘
              <span className={`body-sm px-2 py-0.5 rounded-full font-bold transition-colors ${
                tab === "active" ? "bg-brand text-white" : "bg-gray-100 text-muted-foreground"
              }`}>
                {activeCount}
              </span>
            </button>
            <button
              onClick={() => handleTabChange("archived")}
              className={`flex items-center gap-2 px-4 h-10 body-md font-semibold transition-all border-b-2 -mb-px ${
                tab === "archived"
                  ? "border-brand text-brand"
                  : "border-transparent text-muted-foreground hover:text-gray-800"
              }`}
            >
              ì•„ì¹´ì´ë¹™(ì™„ë£Œ)
              <span className={`body-sm px-2 py-0.5 rounded-full font-bold transition-colors ${
                tab === "archived" ? "bg-gray-600 text-white" : "bg-gray-100 text-muted-foreground"
              }`}>
                {archivedCount}
              </span>
            </button>
            <button
              onClick={() => handleTabChange("cancelled")}
              className={`flex items-center gap-2 px-4 h-10 body-md font-semibold transition-all border-b-2 -mb-px ${
                tab === "cancelled"
                  ? "border-red-500 text-red-600"
                  : "border-transparent text-muted-foreground hover:text-gray-800"
              }`}
            >
              ì·¨ì†Œë¨
              {cancelledCount > 0 && (
                <span className={`body-sm px-2 py-0.5 rounded-full font-bold transition-colors ${
                  tab === "cancelled" ? "bg-destructive-weak text-red-600" : "bg-gray-100 text-muted-foreground"
                }`}>
                  {cancelledCount}
                </span>
              )}
            </button>
            <button
              onClick={() => { handleTabChange("approvals"); loadSupplierAccounts(); }}
              className={`relative flex items-center gap-2 px-4 h-10 body-md font-semibold transition-all border-b-2 -mb-px ${
                tab === "approvals"
                  ? "border-brand text-brand"
                  : "border-transparent text-muted-foreground hover:text-gray-800"
              }`}
            >
              ê°€ì… ìŠ¹ì¸
              {pendingCount > 0 && tab !== "approvals" && (
                <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center text-white text-[10px] font-bold animate-pulse">
                  {pendingCount}
                </span>
              )}
              {pendingCount > 0 && (
                <span className={`body-sm px-2 py-0.5 rounded-full font-bold transition-colors ${
                  tab === "approvals" ? "bg-red-500 text-white" : "bg-red-100 text-red-600"
                }`}>
                  {pendingCount}
                </span>
              )}
            </button>
          </div>

          {/* í˜„ì¥ ì¶”ê°€ ë²„íŠ¼ */}
          <button
            onClick={() => {
              sessionStorage.removeItem('CURRENT_CASE_ID');
              window.location.href = 'detail.html?new=1';
            }}
            className="btn-primary flex items-center gap-2 px-5 h-10 rounded-lg body-md"
          >
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
            </svg>
            í˜„ì¥ ì¶”ê°€í•˜ê¸°
          </button>
        </div>

        {/* â”€â”€ ê°€ì… ìŠ¹ì¸ íŒ¨ë„ â”€â”€ */}
        {tab === "approvals" && (
          <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div className="px-5 py-4 border-b border-gray-200">
              <h2 className="text-base font-bold text-gray-900">ê³µê¸‰ì‚¬ ê°€ì… ìŠ¹ì¸ ê´€ë¦¬</h2>
              <p className="text-xs text-gray-500 mt-1">ê°€ì… ì‹ ì²­í•œ ê³µê¸‰ì‚¬ ê³„ì •ì„ ìŠ¹ì¸í•˜ê±°ë‚˜ ê±°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            {supplierAccounts.length === 0 ? (
              <div className="py-16 text-center text-gray-400">
                <svg className="w-10 h-10 mx-auto mb-2 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span className="text-sm">ê°€ì… ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</span>
              </div>
            ) : (
              <div className="divide-y divide-gray-100">
                {supplierAccounts.map(acc => (
                  <div key={acc.id} className="flex items-center justify-between px-5 py-3.5 hover:bg-gray-50 transition-colors">
                    <div className="flex items-center gap-4">
                      <div className={`w-9 h-9 rounded-full flex items-center justify-center text-sm font-bold ${
                        acc.approved ? "bg-emerald-100 text-emerald-700" : "bg-amber-100 text-amber-700"
                      }`}>
                        {acc.email?.[0]?.toUpperCase() || "?"}
                      </div>
                      <div>
                        <p className="text-sm font-medium text-gray-900">{acc.email}</p>
                        <div className="flex items-center gap-2 mt-0.5">
                          <span className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">{PROCESS_LABELS[acc.process_type] || acc.process_type}</span>
                          <span className="text-xs text-gray-400">{new Date(acc.created_at).toLocaleDateString("ko-KR")}</span>
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      {acc.approved ? (
                        <span className="text-xs font-semibold text-emerald-600 bg-emerald-50 border border-emerald-200 px-3 py-1.5 rounded-lg">ìŠ¹ì¸ë¨</span>
                      ) : (
                        <>
                          <button onClick={() => handleApproveAccount(acc.id)}
                            className="text-xs font-semibold text-white bg-brand hover:bg-[#0090e6] px-3 py-1.5 rounded-lg transition-colors">
                            ìŠ¹ì¸
                          </button>
                          <button onClick={() => handleRejectAccount(acc.id)}
                            className="text-xs font-semibold text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded-lg transition-colors">
                            ê±°ì ˆ
                          </button>
                        </>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* â”€â”€ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ â”€â”€ */}
        {tab !== "approvals" && (
        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">

          {/* í…Œì´ë¸” í—¤ë” ë°” */}
          <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between gap-3">
            <div>
              <div className="flex items-center gap-2">
                <h2 className="text-base font-bold text-gray-900">
                  {tab === "active" ? "ì§„í–‰ ì¤‘ í˜„ì¥ ëª©ë¡" : tab === "archived" ? "ì•„ì¹´ì´ë¹™(ì™„ë£Œ) í˜„ì¥ ëª©ë¡" : "ì·¨ì†Œëœ í˜„ì¥ ëª©ë¡"}
                </h2>
                <span className="body-sm text-muted-foreground bg-gray-100 px-2 py-0.5 rounded-full">{filtered.length}ê±´</span>
              </div>
            </div>
          </div>

          {/* ì•¡ì…˜ ë°” */}
          {selectedIds.length > 0 && (
            <div className="px-4 py-2.5 bg-brand-weak border-b border-brand/20 flex items-center gap-3">
              <span className="body-sm text-brand font-semibold">{selectedIds.length}ê±´ ì„ íƒ</span>
              <div className="w-px h-4 bg-brand/20"></div>
              {tab === "cancelled" ? (
                <button onClick={handleRestore}
                  className="flex items-center gap-1.5 px-3 h-7 rounded-lg body-sm font-semibold bg-emerald-600 text-white hover:bg-emerald-700 transition-colors">
                  <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                  </svg>
                  ë³µì›
                </button>
              ) : (
                <>
                  <button onClick={handleMove}
                    className="flex items-center gap-1.5 px-3 h-7 rounded-lg body-sm font-semibold bg-gray-800 text-white hover:bg-gray-700 transition-colors">
                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg>
                    {tab === "active" ? "ì•„ì¹´ì´ë¹™" : "ì§„í–‰ ì¤‘ìœ¼ë¡œ ì´ë™"}
                  </button>
                  <button onClick={() => setDeleteConfirmOpen(true)}
                    className="flex items-center gap-1.5 px-3 h-7 rounded-lg body-sm font-semibold btn-destructive transition-colors">
                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    ì‚­ì œ
                  </button>
                </>
              )}
              <button onClick={() => setSelectedIds([])}
                className="ml-auto flex items-center gap-1 px-2 h-7 rounded-lg body-sm text-muted-foreground hover:bg-gray-100 transition-colors">
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
                ì„ íƒ í•´ì œ
              </button>
            </div>
          )}

          {/* í•„í„° ë°” */}
          <FilterBar
            search={search} onSearch={setSearch}
            managerFilter={managerFilter} onManagerFilter={setManagerFilter}
            managers={managers}
          />

          {/* í…Œì´ë¸” */}
          <OrderTable
            data={filtered}
            selectedIds={selectedIds}
            onToggleSelect={handleToggleSelect}
            onToggleAll={handleToggleAll}
          />

          {/* í•˜ë‹¨ í‘¸í„° */}
          <div className="px-4 py-2.5 bg-[#FAFBFC] border-t border-gray-200 flex items-center justify-between body-sm text-muted-foreground">
            <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {TODAY_STR}</span>
            <span>í–‰ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ Â· ìƒíƒœ ë±ƒì§€ëŠ” ì½ê¸° ì „ìš©</span>
          </div>
        </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
