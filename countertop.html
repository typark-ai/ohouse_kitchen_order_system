<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìƒíŒ ë°œì£¼ ê´€ë¦¬ | ì§ì‹œê³µ B2B</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["'Pretendard Variable'", "Pretendard", "Inter", "sans-serif"] },
          colors: {
            brand: '#00A1FF', 'brand-weak': '#F0F8FC',
            'genuine-blue': { 50:'#F0F8FC',100:'#D9EFFF',200:'#9ED7FF',300:'#5EBFFF',400:'#00A1FF',500:'#0A78C0' },
            success: { DEFAULT:'#16a34a', weak:'#f0fdf4', foreground:'#15803d' },
            warning: { DEFAULT:'#fbbf24', weak:'#fffbeb', foreground:'#b45309' },
            destructive: { DEFAULT:'#dc2626', weak:'#fef2f2', foreground:'#fef2f2' },
            muted: { DEFAULT:'#f3f4f6', foreground:'#6b7280' },
          },
          borderRadius: { '2xl':'1rem', '3xl':'1.25rem' },
        },
      },
    };
  </script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: 'Pretendard Variable', 'Pretendard', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; letter-spacing: -0.3px; word-break: keep-all; background: #F9FAFB; margin: 0; }
    .body-xs  { font-size: 0.625rem; line-height: 1.375; font-weight: 400; }
    .body-sm  { font-size: 0.75rem;  line-height: 1.375; font-weight: 400; }
    .body-md  { font-size: 0.875rem; line-height: 1.375; font-weight: 400; }
    .heading-xs { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-sm { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-md { font-size: 1.125rem; line-height: 1.25; font-weight: 600; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #F3F4F6; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

    .cb-custom {
      appearance: none; -webkit-appearance: none;
      width: 16px; height: 16px;
      border: 1.5px solid #D1D5DB; border-radius: 4px;
      background: #fff; cursor: pointer; position: relative;
      transition: all 0.1s; flex-shrink: 0;
    }
    .cb-custom:checked { background: #00A1FF; border-color: #00A1FF; }
    .cb-custom:checked::after {
      content: ''; position: absolute; left: 3px; top: 0px;
      width: 5px; height: 9px;
      border: 2px solid #fff; border-top: none; border-left: none;
      transform: rotate(45deg);
    }
    .cb-custom:indeterminate { background: #00A1FF; border-color: #00A1FF; }
    .cb-custom:indeterminate::after {
      content: ''; position: absolute; left: 3px; top: 6px;
      width: 8px; height: 0; border-top: 2px solid #fff;
    }

    @keyframes toastIn  { 0% { transform: translateY(20px) scale(0.95); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
    @keyframes toastOut { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(8px) scale(0.95); opacity: 0; } }
    .toast-enter { animation: toastIn  0.35s cubic-bezier(0.21,1.02,0.73,1) forwards; }
    .toast-exit  { animation: toastOut 0.25s ease-in forwards; }

    @keyframes fadeIn { 0% { opacity: 0; transform: translateY(6px); } 100% { opacity: 1; transform: translateY(0); } }
    .anim-in { animation: fadeIn 0.2s ease-out forwards; }

    .drop-active { border-color: #00A1FF !important; background: #F0F8FC !important; }
    .img-thumb { object-fit: cover; border-radius: 8px; width: 56px; height: 56px; flex-shrink: 0; border: 1px solid #E5E7EB; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   localStorage + DB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LS_KEY = 'JIKSIGONG_DATA';
const TODAY_STR = new Date().toLocaleDateString("ko-KR", { year: "numeric", month: "long", day: "numeric" });

function loadCases() {
  try { const r = localStorage.getItem(LS_KEY); return r ? JSON.parse(r) : []; } catch { return []; }
}

const SUPABASE_URL = "https://ykifurzrrbjrgjrznimk.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlraWZ1cnpycmJqcmdqcnpuaW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjE3NTcsImV4cCI6MjA4NzY5Nzc1N30.BVTlrG_Q_cXqj6qOa_rZPXrCs7MhwuR9o8koncGoUU0";
const STORAGE_BUCKET = "case-files";

async function uploadFileToStorage(file, caseId, section) {
  const timestamp = Date.now();
  const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
  const storagePath = `${caseId}/${section}/${timestamp}_${safeName}`;
  const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${STORAGE_BUCKET}/${storagePath}`, {
    method: "POST",
    headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": file.type || "application/octet-stream", "x-upsert": "true" },
    body: file,
  });
  if (!res.ok) { console.error("Storage upload failed:", await res.text()); return null; }
  return { storagePath, publicUrl: `${SUPABASE_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${storagePath}` };
}

function resizeImageToBlob(file, maxSize = 900) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        let { width, height } = img;
        if (width > maxSize || height > maxSize) {
          if (width >= height) { height = Math.round(height * maxSize / width); width = maxSize; }
          else { width = Math.round(width * maxSize / height); height = maxSize; }
        }
        const canvas = document.createElement("canvas");
        canvas.width = width; canvas.height = height;
        canvas.getContext("2d").drawImage(img, 0, 0, width, height);
        canvas.toBlob((blob) => resolve(blob), "image/jpeg", 0.75);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function dbRowToCase(r) {
  return {
    id: r.id, customer: r.customer, phone: r.phone, address: r.address, manager: r.manager,
    schedule: r.schedule || {}, status: r.status || {},
    archived: r.archived || false, cancelled: r.cancelled || false,
    mokdaeVersions: r.mokdae_versions || [], mokdaeUploadedFiles: r.mokdae_uploaded_files || {},
    cadVersions: r.cad_versions || [],
    mokdaeProductionStarted: r.mokdae_production_started || false,
    mokdaeConfirmedAt: r.mokdae_confirmed_at || null,
    mokdaeClaims: r.mokdae_claims || [],
    sangpanVersions: r.sangpan_versions || [], sangpanUploadedFiles: r.sangpan_uploaded_files || {},
    sangpanDrawingVersions: r.sangpan_drawing_versions || [],
    sangpanConsumerApproved: r.sangpan_consumer_approved || false,
    sangpanConfirmedAt: r.sangpan_confirmed_at || null,
    sangpanClaims: r.sangpan_claims || [],
    sangpanProductionStarted: r.sangpan_production_started || false,
    sangpanProductionStartedAt: r.sangpan_production_started_at || null,
    sangpanFinalDate: r.sangpan_final_date || "",
    silcheukUploadResult: r.silcheuk_upload_result || null,
    silcheukResultDone: r.silcheuk_result_done || false,
  };
}

function caseToDbRow(c) {
  return {
    id: c.id, customer: c.customer || null, phone: c.phone || null, address: c.address || null, manager: c.manager || null,
    schedule: c.schedule || {}, status: c.status || {},
    archived: c.archived || false, cancelled: c.cancelled || false,
    mokdae_versions: c.mokdaeVersions || [], mokdae_uploaded_files: c.mokdaeUploadedFiles || {},
    cad_versions: c.cadVersions || [],
    mokdae_production_started: c.mokdaeProductionStarted || false,
    mokdae_confirmed_at: c.mokdaeConfirmedAt || null,
    mokdae_claims: c.mokdaeClaims || [],
    sangpan_versions: c.sangpanVersions || [], sangpan_uploaded_files: c.sangpanUploadedFiles || {},
    sangpan_drawing_versions: c.sangpanDrawingVersions || [],
    sangpan_consumer_approved: c.sangpanConsumerApproved || false,
    sangpan_confirmed_at: c.sangpanConfirmedAt || null,
    sangpan_claims: c.sangpanClaims || [],
    sangpan_production_started: c.sangpanProductionStarted || false,
    sangpan_production_started_at: c.sangpanProductionStartedAt || null,
    sangpan_final_date: c.sangpanFinalDate || null,
    silcheuk_upload_result: c.silcheukUploadResult || null,
    silcheuk_result_done: c.silcheukResultDone || false,
  };
}

async function loadAllCasesFromDB() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/cases?select=*&order=created_at.desc`, {
      headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
    });
    if (!res.ok) throw new Error("fetch failed");
    return (await res.json()).map(dbRowToCase);
  } catch (e) { console.warn("DB load failed:", e); return null; }
}

async function syncCaseToDB(caseData) {
  try {
    await fetch(`${SUPABASE_URL}/rest/v1/cases`, {
      method: "POST",
      headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json", "Prefer": "resolution=merge-duplicates" },
      body: JSON.stringify(caseToDbRow(caseData)),
    });
  } catch (e) { console.warn("DB sync failed:", e); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Helpers
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function daysDiff(dateStr) {
  if (!dateStr) return null;
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(dateStr); d.setHours(0,0,0,0);
  return Math.ceil((d - today) / 86400000);
}

/* â”€â”€ ê³µì¥ ì „ìš© ìƒíƒœ ê³„ì‚° â”€â”€ */
function computeCountertopStatus(c) {
  if (c.sangpanProductionStarted) return "ì œì‘ ì§„í–‰ ë‹¨ê³„";
  const claims = c.sangpanClaims || [];
  if (claims.some(cl => cl.status === "ì¬ë§ˆê°ìš”ì²­")) return "ì¬ë§ˆê° ìš”ì²­";
  const isConfirmed = !!c.sangpanConfirmedAt;
  if (isConfirmed) {
    const submitted = (c.sangpanVersions || []).filter(v => !v.isNew);
    const latest = submitted.length > 0 ? submitted[submitted.length - 1] : null;
    if (latest?.sentAt && c.sangpanConfirmedAt) {
      try { if (new Date(latest.sentAt) > new Date(c.sangpanConfirmedAt)) return "ê¸´ê¸‰ ë°œì£¼"; } catch {}
    }
    return "ë°œì£¼ í™•ì •";
  }
  const sangpanDrawingVersions = c.sangpanDrawingVersions || [];
  if (sangpanDrawingVersions.length > 0) return "ë„ë©´ í™•ì¸ ë‹¨ê³„";
  const submitted = (c.sangpanVersions || []).filter(v => !v.isNew);
  if (submitted.length > 0) {
    const latest = submitted[submitted.length - 1];
    return latest.factoryChecked ? "ìƒíŒ ë„ë©´ ì‘ì—… ì¤‘" : "ë°œì£¼ì„œ í™•ì¸ ìš”ì²­";
  }
  return "ëŒ€ê¸°";
}

/* â”€â”€ ê³µì¥ ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ â”€â”€ */
function getCountertopStatusStyle(text) {
  if (!text || text === "ëŒ€ê¸°") return "bg-gray-100 text-gray-500";
  if (text === "ì œì‘ ì§„í–‰ ë‹¨ê³„") return "bg-teal-50 text-teal-700 border border-teal-200 font-semibold";
  if (text === "ì¬ë§ˆê° ìš”ì²­" || text === "ê¸´ê¸‰ ë°œì£¼") return "bg-red-50 text-red-700 border border-red-200 font-semibold";
  if (text === "ë°œì£¼ í™•ì •") return "bg-emerald-50 text-emerald-700 border border-emerald-200 font-semibold";
  if (text === "ë„ë©´ í™•ì¸ ë‹¨ê³„" || text === "ë°œì£¼ì„œ í™•ì¸ ìš”ì²­") return "bg-brand-weak text-brand border border-brand/20";
  if (text === "ìƒíŒ ë„ë©´ ì‘ì—… ì¤‘") return "bg-orange-50 text-orange-700 border border-orange-200 font-semibold";
  return "bg-gray-100 text-gray-500";
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   useToast + Toast
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function useToast() {
  const [toasts, setToasts] = useState([]);
  const add    = useCallback(({ type='info', title, message, duration=4000 }) => {
    const id = Date.now() + Math.random();
    setToasts(p => [...p, { id, type, title, message, duration }]);
  }, []);
  const remove = useCallback(id => setToasts(p => p.filter(t => t.id !== id)), []);
  return { toasts, add, remove };
}

function Toast({ toast, onRemove }) {
  const [ex, setEx] = useState(false);
  useEffect(() => {
    const t = setTimeout(() => { setEx(true); setTimeout(() => onRemove(toast.id), 250); }, toast.duration);
    return () => clearTimeout(t);
  }, []);
  const border = { success:'border-emerald-500', error:'border-red-500', info:'border-brand', warning:'border-amber-500' };
  return (
    <div className={`${ex?'toast-exit':'toast-enter'} ${border[toast.type]||border.info} border-l-4 bg-white rounded-xl shadow-lg px-4 py-3 flex items-start gap-3 min-w-[300px] max-w-sm pointer-events-auto`}>
      <div className="flex-1 min-w-0">
        {toast.title && <p className="text-sm font-bold text-gray-800">{toast.title}</p>}
        <p className="text-sm text-gray-500 mt-0.5 leading-relaxed">{toast.message}</p>
      </div>
      <button onClick={() => { setEx(true); setTimeout(() => onRemove(toast.id), 250); }} className="text-gray-300 hover:text-gray-500 flex-shrink-0">
        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
  );
}
function ToastContainer({ toasts, onRemove }) {
  return (
    <div className="fixed top-6 right-6 z-[300] flex flex-col gap-2 pointer-events-none">
      {toasts.map(t => <Toast key={t.id} toast={t} onRemove={onRemove} />)}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„œë¸Œ ì»´í¬ë„ŒíŠ¸: StatusBadge, DateCell
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function StatusBadge({ text }) {
  if (!text || text === "ëŒ€ê¸°") return <span className="text-gray-300">-</span>;
  return (
    <span className={`inline-block px-2 py-1 rounded-full text-xs whitespace-nowrap ${getCountertopStatusStyle(text)}`}>
      {text}
    </span>
  );
}

function DateCell({ dateStr }) {
  if (!dateStr) return <span className="text-gray-300">-</span>;
  const diff = daysDiff(dateStr);
  const urgent = diff !== null && diff <= 2;
  let dLabel = null;
  if (diff !== null) {
    if (diff === 0)      dLabel = "(ì˜¤ëŠ˜)";
    else if (diff < 0)   dLabel = `(D${diff})`;
    else                  dLabel = `(D-${diff})`;
  }
  return (
    <div className="flex flex-col items-center leading-snug">
      <span className={urgent ? "text-red-600 font-semibold whitespace-nowrap" : "text-gray-700 whitespace-nowrap"}>
        {dateStr}
      </span>
      {dLabel && (
        <span className={`text-xs mt-0.5 whitespace-nowrap ${urgent ? "text-red-500 font-semibold" : "text-gray-400"}`}>
          {dLabel}
        </span>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ListPage â€” index.html í…Œì´ë¸” UI ë§¤ì¹­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ListPage({ cases, onSelect, onArchive, onRestore, onToast }) {
  const [tab, setTab]                 = useState("active");
  const [selectedIds, setSelectedIds] = useState([]);
  const [search, setSearch]           = useState("");
  const [hoveredRow, setHoveredRow]   = useState(null);

  const handleTabChange = (t) => { setTab(t); setSelectedIds([]); setSearch(""); };

  const activeCount  = cases.filter(c => !c.archived && !c.cancelled).length;
  const archiveCount = cases.filter(c => c.archived === true).length;
  const cancelledCases = useMemo(() => cases.filter(c => c.cancelled === true && !c.archived), [cases]);

  const tabData = useMemo(() => {
    if (tab === "archived") return cases.filter(c => c.archived === true);
    return cases.filter(c => !c.archived && !c.cancelled);
  }, [cases, tab]);

  const filtered = useMemo(() => {
    if (!search) return tabData;
    const q = search.toLowerCase();
    return tabData.filter(c =>
      (c.customer || "").toLowerCase().includes(q) ||
      (c.id || "").toLowerCase().includes(q) ||
      (c.address || "").toLowerCase().includes(q)
    );
  }, [tabData, search]);

  /* ì²´í¬ë°•ìŠ¤ */
  const handleToggleSelect = (id) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
  };
  const handleToggleAll = (checked) => {
    setSelectedIds(checked ? filtered.map(c => c.id) : []);
  };

  const allSelected  = filtered.length > 0 && selectedIds.length === filtered.length;
  const someSelected = selectedIds.length > 0 && selectedIds.length < filtered.length;
  const headerCbRef  = useRef(null);
  useEffect(() => {
    if (headerCbRef.current) headerCbRef.current.indeterminate = someSelected;
  }, [someSelected]);

  const handleArchiveAction = () => {
    if (selectedIds.length === 0) return;
    onArchive(selectedIds);
    setSelectedIds([]);
    onToast({ type: 'success', title: 'ì•„ì¹´ì´ë¸Œ ì™„ë£Œ', message: `${selectedIds.length}ê±´ì´ ì•„ì¹´ì´ë¸Œë˜ì—ˆìŠµë‹ˆë‹¤.` });
  };
  const handleRestoreAction = () => {
    if (selectedIds.length === 0) return;
    onRestore(selectedIds);
    setSelectedIds([]);
    onToast({ type: 'success', title: 'ë³µì› ì™„ë£Œ', message: `${selectedIds.length}ê±´ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.` });
  };

  /* í…Œì´ë¸” ì»¬ëŸ¼ ì •ì˜ */
  const colGroups = [
    { label: "",         span: 1, cls: "bg-gray-50 border-r border-gray-200" },
    { label: "ê¸°ë³¸ ì •ë³´", span: 3, cls: "bg-gray-50" },
    { label: "ì¼ì •",      span: 1, cls: "bg-brand-weak" },
    { label: "ê³µì¥ ìƒíƒœ", span: 1, cls: "bg-gray-50" },
  ];
  const cols = [
    { label: "",               w: "w-10"  },
    { label: "ìƒë‹´ ID",        w: "w-36"  },
    { label: "ê³ ê°ëª…",         w: "w-20"  },
    { label: "í˜„ì¥ ì£¼ì†Œ",      w: "w-56"  },
    { label: "ìƒíŒ ì˜ˆì •ì¼ì •",  w: "w-32"  },
    { label: "ê³µì¥ ìƒíƒœ",      w: "w-36"  },
  ];

  return (
    <div className="min-h-screen bg-[#F9FAFB] flex flex-col">

      {/* â”€â”€ í—¤ë” â”€â”€ */}
      <header className="bg-white text-gray-900 px-6 h-14 flex items-center justify-between border-b border-gray-200 flex-shrink-0">
        <div className="flex items-center gap-3">
          <img src="/images/ohouse-logo.png" alt="ì˜¤ëŠ˜ì˜ì§‘" className="h-10" />
          <div className="h-6 w-px bg-gray-200"></div>
          <div>
            <h1 className="heading-sm text-gray-900">ìƒíŒ ê³µì¥ í¬í„¸</h1>
            <p className="body-xs text-muted-foreground">ë°œì£¼ ì‹œìŠ¤í…œ</p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <div className="body-sm text-muted-foreground hidden sm:block">
            ì˜¤ëŠ˜ <span className="text-gray-900 font-semibold">{TODAY_STR}</span>
          </div>
        </div>
      </header>

      {/* â”€â”€ ë©”ì¸ ì»¨í…ì¸  â”€â”€ */}
      <div className="flex-1 flex flex-col px-6 py-5 gap-4">

        {/* â”€â”€ íƒ­ â€” ì–¸ë”ë¼ì¸ ìŠ¤íƒ€ì¼ â”€â”€ */}
        <div className="flex items-center">
          <div className="flex items-center gap-1 border-b border-gray-200">
            <button onClick={() => handleTabChange("active")}
              className={`flex items-center gap-2 px-4 h-10 body-md font-semibold transition-all border-b-2 -mb-px ${
                tab === "active" ? "border-brand text-brand" : "border-transparent text-muted-foreground hover:text-gray-800"
              }`}>
              ì§„í–‰ ì¤‘
              <span className={`body-sm px-2 py-0.5 rounded-full font-bold transition-colors ${
                tab === "active" ? "bg-brand text-white" : "bg-gray-100 text-muted-foreground"
              }`}>{activeCount}</span>
            </button>
            <button onClick={() => handleTabChange("archived")}
              className={`flex items-center gap-2 px-4 h-10 body-md font-semibold transition-all border-b-2 -mb-px ${
                tab === "archived" ? "border-brand text-brand" : "border-transparent text-muted-foreground hover:text-gray-800"
              }`}>
              ì•„ì¹´ì´ë¸Œ
              <span className={`body-sm px-2 py-0.5 rounded-full font-bold transition-colors ${
                tab === "archived" ? "bg-gray-600 text-white" : "bg-gray-100 text-muted-foreground"
              }`}>{archiveCount}</span>
            </button>
          </div>
        </div>

        {/* â”€â”€ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ â”€â”€ */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">

          {/* í…Œì´ë¸” í—¤ë” ë°” */}
          <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between gap-3">
            <div>
              <div className="flex items-center gap-2">
                <h2 className="font-semibold text-gray-900 text-sm">
                  {tab === "active" ? "ì§„í–‰ ì¤‘ í˜„ì¥ ëª©ë¡" : "ì•„ì¹´ì´ë¸Œ í˜„ì¥ ëª©ë¡"}
                </h2>
                {tab === "archived" && (
                  <span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full font-medium">ì™„ë£Œ ì²˜ë¦¬ëœ í˜„ì¥</span>
                )}
              </div>
              <p className="text-xs text-gray-400 mt-1">
                ì´ <span className="font-medium text-gray-700">{filtered.length}</span>ê±´
                {filtered.length !== tabData.length && ` (ì „ì²´ ${tabData.length}ê±´ ì¤‘ í•„í„°)`}
                &nbsp;Â·&nbsp;í–‰ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•´ìš”
              </p>
            </div>
          </div>

          {/* í•„í„° ë°” */}
          <div className="flex flex-wrap items-center gap-3 px-4 py-3 bg-white border-b border-gray-200">
            <div className="relative">
              <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z" />
              </svg>
              <input type="text" placeholder="ê³ ê°ëª… / ìƒë‹´ID / ì£¼ì†Œ ê²€ìƒ‰â€¦"
                value={search} onChange={e => setSearch(e.target.value)}
                className="pl-9 pr-4 h-9 text-sm border border-gray-200 rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent bg-white"
              />
            </div>
            <div className="ml-auto flex items-center gap-4 text-xs text-gray-500">
              <span className="flex items-center gap-1"><span className="inline-block w-2 h-2 rounded-full bg-red-500"></span>ì¼ì • ì„ë°• (D-2 ì´ë‚´)</span>
              <span className="flex items-center gap-1"><span className="inline-block w-2 h-2 bg-teal-100 border border-teal-300 rounded-full"></span>ì œì‘ ì§„í–‰</span>
              <span className="flex items-center gap-1"><span className="inline-block w-2 h-2 bg-emerald-100 border border-emerald-300 rounded-full"></span>í™•ì •/ì™„ë£Œ</span>
            </div>
          </div>

          {/* â”€â”€ ì•¡ì…˜ ë°” (ì²´í¬ ì„ íƒ ì‹œ) â”€â”€ */}
          {selectedIds.length > 0 && (
            <div className="flex items-center justify-between px-4 py-2 bg-brand-weak border-b border-brand/20">
              <div className="flex items-center gap-3">
                <span className="text-xs font-semibold text-brand">
                  {selectedIds.length}ê±´ ì„ íƒë¨
                </span>
                {tab === "active" && (
                  <button onClick={handleArchiveAction}
                    className="flex items-center gap-1 text-xs font-semibold text-white bg-gray-700 hover:bg-gray-800 px-3 h-7 rounded-lg transition-colors">
                    ì•„ì¹´ì´ë¸Œ
                  </button>
                )}
                {tab === "archived" && (
                  <button onClick={handleRestoreAction}
                    className="flex items-center gap-1 text-xs font-semibold text-white bg-brand hover:bg-[#0090e6] px-3 h-7 rounded-lg transition-colors">
                    ë³µì›
                  </button>
                )}
              </div>
              <button onClick={() => setSelectedIds([])} className="text-xs text-gray-500 hover:text-gray-700 font-medium">
                ì„ íƒ í•´ì œ
              </button>
            </div>
          )}

          {/* â”€â”€ í…Œì´ë¸” â”€â”€ */}
          <div className="overflow-x-auto flex-1">
            <table className="w-full border-collapse text-sm" style={{ minWidth: "800px" }}>
              <thead className="sticky top-0 z-10">
                {/* ì»¬ëŸ¼ ê·¸ë£¹ í–‰ */}
                <tr className="border-b border-gray-200">
                  {colGroups.map((g, i) => (
                    <th key={i} colSpan={g.span}
                      className={`${g.cls} text-gray-500 text-center py-2 body-sm font-semibold tracking-wider uppercase ${i < colGroups.length - 1 ? "border-r border-gray-200" : ""}`}>
                      {g.label}
                    </th>
                  ))}
                </tr>
                {/* ì»¬ëŸ¼ í—¤ë” í–‰ */}
                <tr className="bg-gray-50 text-gray-600 body-sm border-b border-gray-200">
                  {cols.map((col, i) => (
                    <th key={i}
                      className={`${col.w} py-2.5 px-3 text-center font-semibold whitespace-pre-line ${i < cols.length - 1 ? "border-r border-gray-200" : ""}`}>
                      {i === 0 ? (
                        <div className="flex items-center justify-center">
                          <input ref={headerCbRef} type="checkbox" className="cb-custom"
                            checked={allSelected} onChange={e => handleToggleAll(e.target.checked)}
                            onClick={e => e.stopPropagation()} />
                        </div>
                      ) : col.label}
                    </th>
                  ))}
                </tr>
              </thead>

              <tbody>
                {filtered.length === 0 && (
                  <tr>
                    <td colSpan={6} className="py-20 text-center text-gray-400 bg-white">
                      <div className="flex flex-col items-center gap-2">
                        <svg className="w-10 h-10 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0H4"/>
                        </svg>
                        <span className="text-sm">ë°ì´í„°ê°€ ì—†ì–´ìš”.</span>
                      </div>
                    </td>
                  </tr>
                )}
                {filtered.map((c, idx) => {
                  const isSelected = selectedIds.includes(c.id);
                  const isHovered  = hoveredRow === c.id;
                  const base  = idx % 2 === 0 ? "bg-white" : "bg-gray-50/70";
                  const rowBg = isSelected ? "bg-brand-weak" : isHovered ? "bg-brand-weak/50" : base;
                  const factoryStatus = computeCountertopStatus(c);

                  return (
                    <tr key={c.id}
                      className={`${rowBg} cursor-pointer border-b border-gray-200 transition-colors duration-75 group`}
                      onMouseEnter={() => setHoveredRow(c.id)}
                      onMouseLeave={() => setHoveredRow(null)}
                      onClick={() => onSelect(c.id)}>

                      {/* ì²´í¬ë°•ìŠ¤ */}
                      <td className="px-3 py-3 text-center border-r border-gray-200" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-center">
                          <input type="checkbox" className="cb-custom" checked={isSelected}
                            onChange={() => handleToggleSelect(c.id)} />
                        </div>
                      </td>

                      {/* ìƒë‹´ID */}
                      <td className="px-3 py-2 text-center border-r border-gray-200">
                        <span className="font-mono text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded">{c.id}</span>
                      </td>

                      {/* ê³ ê°ëª… */}
                      <td className="px-3 py-2 text-center font-medium text-gray-900 border-r border-gray-200 whitespace-nowrap">
                        {c.customer || "-"}
                      </td>

                      {/* í˜„ì¥ì£¼ì†Œ */}
                      <td className="px-3 py-2 text-gray-600 border-r border-gray-200 text-xs leading-relaxed break-words" title={c.address}>
                        {c.address || "-"}
                      </td>

                      {/* ìƒíŒ ì˜ˆì •ì¼ì • */}
                      <td className="px-3 py-2 text-center border-r border-gray-200 border-l-2 border-l-brand/20 text-xs">
                        <DateCell dateStr={c.schedule?.sangpan} />
                      </td>

                      {/* ê³µì¥ ìƒíƒœ */}
                      <td className="px-3 py-2 text-center border-l-2 border-l-gray-300">
                        <StatusBadge text={factoryStatus} />
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* â”€â”€ ì·¨ì†Œëœ í˜„ì¥ â”€â”€ */}
      {tab === "active" && cancelledCases.length > 0 && (
        <div className="px-6 pb-4">
          <div className="flex items-center gap-3 my-4">
            <div className="h-px flex-1 bg-red-100"></div>
            <span className="text-xs font-semibold text-red-400 flex items-center gap-1">
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636l-12.728 12.728M5.636 5.636l12.728 12.728" /></svg>
              ì·¨ì†Œëœ í˜„ì¥ {cancelledCases.length}ê±´
            </span>
            <div className="h-px flex-1 bg-red-100"></div>
          </div>
          <div className="space-y-2">
            {cancelledCases.map(c => {
              const cStatus = computeCountertopStatus(c);
              return (
                <div key={c.id} className="bg-gray-50 rounded-2xl border border-gray-200 overflow-hidden opacity-60 px-4 py-3">
                  <div className="flex items-center justify-between gap-3">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="text-xs font-mono font-semibold text-gray-400">{c.id}</span>
                        <span className="text-xs font-semibold px-2 py-0.5 rounded-full border bg-red-50 text-red-400 border-red-200">ì·¨ì†Œë¨</span>
                      </div>
                      <p className="text-sm font-bold text-gray-500 line-through">{c.customer} ê³ ê°</p>
                      <p className="text-xs text-gray-400 truncate mt-0.5">{c.address}</p>
                    </div>
                    <div className="text-right flex-shrink-0">
                      <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${getCountertopStatusStyle(cStatus)}`}>{cStatus}</span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* â”€â”€ í‘¸í„° â”€â”€ */}
      <footer className="px-6 py-3 bg-gray-50 border-t border-gray-200 flex-shrink-0">
        <p className="text-xs text-gray-400 text-center">
          ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {TODAY_STR} &nbsp;|&nbsp; í–‰ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ Â· ìƒíƒœ ë±ƒì§€ëŠ” ìë™ ê³„ì‚°
        </p>
      </footer>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DetailPage â€” ìš”ì²­ ìƒì„¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function DetailPage({ caseData, onBack, onToast, onUpdate }) {
  const [lightbox, setLightbox] = useState(null);

  const c = caseData;
  const versions      = c.sangpanVersions     || [];
  const uploadedFiles = c.sangpanUploadedFiles || {};
  const sangpanDrawingVersions   = c.sangpanDrawingVersions         || [];
  const submittedVers = versions.filter(v => !v.isNew);
  const factoryStatus = computeCountertopStatus(c);

  /* â”€â”€ ê³µì¥ í™•ì¸ í† ê¸€ â”€â”€ */
  const handleFactoryCheck = (versionNo) => {
    const newVersions = versions.map(v =>
      v.versionNo === versionNo ? { ...v, factoryChecked: !v.factoryChecked } : v
    );
    const updated = { ...c, sangpanVersions: newVersions };
    onUpdate(updated);
    const ver = newVersions.find(v => v.versionNo === versionNo);
    onToast({
      type: ver.factoryChecked ? 'success' : 'info',
      title: ver.factoryChecked ? 'ê³µì¥ í™•ì¸ ì™„ë£Œ' : 'ê³µì¥ í™•ì¸ í•´ì œ',
      message: `ë°œì£¼ V${versionNo} ${ver.factoryChecked ? 'í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤' : 'í™•ì¸ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤'}`,
    });
  };

  /* â”€â”€ ì œì‘ ì§„í–‰ ì‹œì‘ â”€â”€ */
  const handleStartProduction = () => {
    const now = new Date().toISOString();
    const updated = {
      ...c,
      sangpanProductionStarted: true,
      sangpanProductionStartedAt: now,
      status: { ...(c.status || {}), sangpan: "ì œì‘ì§„í–‰" },
    };
    onUpdate(updated);
    onToast({ type: 'success', title: 'ğŸ­ ì œì‘ ì§„í–‰ ì‹œì‘', message: 'ê³µì¥ ì œì‘ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë³¸ì‚¬ì— ìë™ í†µë³´ë©ë‹ˆë‹¤.' });
  };

  /* â”€â”€ ì œì‘ ì§„í–‰ ì¤‘ë‹¨ â”€â”€ */
  const handleStopProduction = () => {
    const updated = {
      ...c,
      sangpanProductionStarted: false,
      sangpanProductionStartedAt: null,
      status: { ...(c.status || {}), sangpan: "ë°œì£¼í™•ì •" },
    };
    onUpdate(updated);
    onToast({ type: 'info', title: 'ì œì‘ ì§„í–‰ ì¤‘ë‹¨', message: 'ì œì‘ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë°œì£¼ í™•ì • ìƒíƒœë¡œ ë³µì›ë©ë‹ˆë‹¤.' });
  };

  /* â”€â”€ ìƒíŒ ë„ë©´ íŒŒì¼ ì—…ë¡œë“œ (canvas ë¦¬ì‚¬ì´ì¦ˆ â†’ ìŠ¤í…Œì´ì§• â†’ ë°œì†¡) â”€â”€ */
  const cadFileRef = useRef(null);
  const [cadDragOver, setCadDragOver] = useState(false);
  const [cadUploading, setCadUploading] = useState(false);
  const [stagedCad, setStagedCad] = useState(null);

  /* ìµœì‹  ë°œì£¼ ì„œë¥˜ í™•ì¸ ì—¬ë¶€ */
  const latestSubmitted = submittedVers.length > 0 ? submittedVers[submittedVers.length - 1] : null;
  const isLatestDocChecked = latestSubmitted?.factoryChecked === true;

  const handleCadFile = useCallback(async (file) => {
    if (!file) return;
    if (!isLatestDocChecked) {
      onToast({ type: 'warning', title: 'ë°œì£¼ ì„œë¥˜ í™•ì¸ í•„ìš”', message: 'ë°œì£¼ ì„œë¥˜ í™•ì¸ ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.' });
      return;
    }
    setCadUploading(true);
    const isImg = file.type.startsWith("image/");
    const sizeStr = file.size < 1048576 ? `${(file.size/1024).toFixed(0)} KB` : `${(file.size/1048576).toFixed(1)} MB`;
    const now = new Date().toLocaleString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    const vNo = sangpanDrawingVersions.length + 1;

    let previewUrl = null;
    try {
      let uploadFile = file;
      if (isImg) {
        const resizedBlob = await resizeImageToBlob(file);
        if (resizedBlob) uploadFile = new File([resizedBlob], file.name, { type: "image/jpeg" });
      }
      const uploaded = await uploadFileToStorage(uploadFile, c.id, "sangpan-drawing");
      if (uploaded) {
        previewUrl = uploaded.publicUrl;
      }
    } catch (e) {
      console.error("Drawing upload error:", e);
    }

    const newCad = { versionNo: vNo, uploadedAt: now, fileName: file.name, fileSize: sizeStr, status: "ë„ë©´ê²€í† ì¤‘", previewUrl };
    setStagedCad(newCad);
    setCadUploading(false);
    onToast({ type: 'info', title: 'ìƒíŒ ë„ë©´ íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ', message: `${file.name} â€” "ë°œì†¡" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë³¸ì‚¬ì— ì „ë‹¬í•˜ì„¸ìš”.` });
  }, [sangpanDrawingVersions, onToast, isLatestDocChecked, c.id]);

  const handleCadSend = useCallback(() => {
    if (!stagedCad) return;
    const updated = { ...c, sangpanDrawingVersions: [...sangpanDrawingVersions, stagedCad] };
    onUpdate(updated);
    setStagedCad(null);
    onToast({ type: 'success', title: 'ìƒíŒ ë„ë©´ ë°œì†¡ ì™„ë£Œ', message: `${stagedCad.fileName} â€” ë³¸ì‚¬ ê²€í†  ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.` });
  }, [c, sangpanDrawingVersions, stagedCad, onUpdate, onToast]);

  const handleCadCancel = useCallback(() => {
    setStagedCad(null);
    onToast({ type: 'info', title: 'ì—…ë¡œë“œ ì·¨ì†Œ', message: 'ìƒíŒ ë„ë©´ íŒŒì¼ ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' });
  }, [onToast]);

  /* â”€â”€ ì‹¤ì¸¡ ìë£Œ â”€â”€ */
  const silcheukResult = c.silcheukUploadResult || null;
  const silcheukImages = [
    ...(silcheukResult?.drawings || []).map(f => ({ ...f, category: "ë„ë©´" })),
    ...(silcheukResult?.photos   || []).map(f => ({ ...f, category: "ì‚¬ì§„" })),
  ];

  return (
    <div className="flex flex-col h-full overflow-hidden">
      {/* í—¤ë” */}
      <header className="bg-gray-900 text-white px-6 py-4 flex-shrink-0">
        <div className="flex items-start justify-between gap-4">
          <div className="flex items-center gap-4">
            <button onClick={onBack}
              className="flex items-center gap-1.5 text-gray-400 hover:text-white text-sm transition-colors px-2 py-1 rounded-lg hover:bg-white/10">
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
              ëª©ë¡
            </button>
            <div className="w-px h-8 bg-gray-700"></div>
            <div>
              <div className="flex items-center gap-2 mb-0.5">
                <span className="text-xs font-mono text-gray-400">{c.id}</span>
                <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${getCountertopStatusStyle(factoryStatus)}`}>
                  {factoryStatus}
                </span>
              </div>
              <h1 className="text-lg font-black leading-snug">{c.customer || 'ì‹ ê·œ'} ê³ ê° í˜„ì¥</h1>
              <p className="text-sm text-gray-300 mt-0.5">{c.address || '-'}</p>
            </div>
          </div>
          <div className="text-right flex-shrink-0">
            <p className="text-[11px] text-gray-400 uppercase tracking-wide">ìƒíŒ ë‚©ê¸°</p>
            <p className="text-sm font-bold">{c.schedule?.sangpan || '-'}</p>
            <p className="text-[11px] text-gray-400 uppercase tracking-wide mt-2">ë‹´ë‹¹ì</p>
            <p className="text-sm font-semibold text-gray-200">{c.manager || '-'}</p>
          </div>
        </div>
      </header>

      {/* ì œì‘ ì§„í–‰ ì œì–´ ë°”ëŠ” ìƒíŒ ë„ë©´ ì„¹ì…˜ ì•„ë˜ë¡œ ì´ë™ */}

      {/* ìŠ¤í¬ë¡¤ ì˜ì—­ */}
      <div className="flex-1 overflow-y-auto bg-gray-50">
        <div className="max-w-4xl mx-auto px-6 py-6 space-y-6">

          {/* â•â•â• ì„¹ì…˜ 1: ë°œì£¼ ì„œë¥˜ (Read-Only) â•â•â• */}
          <section className="bg-white border border-gray-200 rounded-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3.5 border-b border-gray-100">
              <div className="flex items-center gap-2">
                <div className="w-7 h-7 rounded-lg bg-brand flex items-center justify-center">
                  <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                <div>
                  <h2 className="text-sm font-bold text-gray-800">ë°œì£¼ ì„œë¥˜</h2>
                  <p className="text-xs text-gray-400">ë³¸ì‚¬ì—ì„œ ì „ë‹¬ëœ ë°œì£¼ì„œ Â· ê³µì¥ í™•ì¸</p>
                </div>
              </div>
              {submittedVers.length > 0 && (
                <span className="bg-brand text-white text-[10px] font-black px-2 py-0.5 rounded-full">{submittedVers.length}ê±´</span>
              )}
            </div>

            <div className="p-5">
              {submittedVers.length === 0 ? (
                <div className="flex flex-col items-center justify-center py-10 gap-2 text-gray-300">
                  <svg className="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <p className="text-sm font-medium text-gray-400">ì•„ì§ ì „ë‹¬ëœ ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                  <p className="text-xs">ë³¸ì‚¬ ê´€ë¦¬ìê°€ ë°œì£¼ì„œë¥¼ ì œì¶œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {[...submittedVers].reverse().map((v, idx) => {
                    const files = uploadedFiles[v.versionNo] || [];
                    const images = files.filter(f => f.isImage);
                    return (
                      <div key={v.versionNo} className={`rounded-xl border p-4 ${idx === 0 ? 'border-brand/30 bg-brand-weak/30' : 'border-gray-100 bg-gray-50/50'}`}>
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center gap-2">
                            <span className={`text-xs font-black px-2 py-0.5 rounded-full ${idx === 0 ? 'bg-brand text-white' : 'bg-gray-200 text-gray-500'}`}>
                              V{v.versionNo}
                            </span>
                            {idx === 0 && <span className="text-[10px] text-brand font-semibold">ìµœì‹ </span>}
                            <span className="text-xs text-gray-400">{v.sentAt}</span>
                          </div>
                          <button onClick={() => handleFactoryCheck(v.versionNo)}
                            className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold transition-all active:scale-95 ${
                              v.factoryChecked
                                ? 'bg-emerald-500 text-white shadow-sm hover:bg-emerald-600'
                                : 'bg-white border border-gray-200 text-gray-600 hover:border-brand hover:text-brand'
                            }`}>
                            {v.factoryChecked ? (
                              <><svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" /></svg>ê³µì¥ í™•ì¸ë¨</>
                            ) : 'ê³µì¥ í™•ì¸'}
                          </button>
                        </div>
                        {v.sangpanDate && (
                          <div className="flex items-center gap-2 mb-3 bg-white rounded-lg px-3 py-2 border border-gray-100">
                            <svg className="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <rect x="3" y="4" width="18" height="18" rx="2" strokeWidth={2}/><path strokeLinecap="round" strokeWidth={2} d="M16 2v4M8 2v4M3 10h18"/>
                            </svg>
                            <span className="text-xs text-gray-500">ìƒíŒ ì˜ˆì • ì¼ì •:</span>
                            <span className="text-xs font-bold text-gray-800">{v.sangpanDate}</span>
                          </div>
                        )}
                        {v.memo && (
                          <div className="mb-3 bg-white rounded-lg px-3 py-2 border border-gray-100">
                            <p className="text-xs text-gray-500">{v.memo}</p>
                          </div>
                        )}
                        {images.length > 0 && (
                          <div className="grid grid-cols-4 gap-2">
                            {images.map(f => (
                              <div key={f.id} className="relative cursor-pointer group" onClick={() => setLightbox({ url: f.url, name: f.name })}>
                                <img src={f.url} alt={f.name} className="w-full aspect-square object-cover rounded-lg border border-gray-200 group-hover:ring-2 group-hover:ring-brand transition-all" />
                                {f.url && (
                                  <a href={f.url} download={f.name} onClick={e => e.stopPropagation()}
                                    className="absolute top-1 right-1 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                    title="ë‹¤ìš´ë¡œë“œ">
                                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                    </svg>
                                  </a>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                        {files.filter(f => !f.isImage).length > 0 && (
                          <div className="mt-2 space-y-1">
                            {files.filter(f => !f.isImage).map(f => (
                              <div key={f.id} className="flex items-center gap-2 bg-white rounded-lg px-3 py-2 border border-gray-100">
                                <svg className="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <span className="text-xs text-gray-600 truncate">{f.name}</span>
                                <span className="text-[10px] text-gray-400 flex-shrink-0">{f.size}</span>
                                {f.url && (
                                  <a href={f.url} download={f.name}
                                    className="ml-auto flex-shrink-0 text-gray-400 hover:text-brand transition-colors"
                                    title="ë‹¤ìš´ë¡œë“œ">
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                    </svg>
                                  </a>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </section>

          {/* â•â•â• ì„¹ì…˜ 1.5: ëª©ëŒ€ ë°œì£¼ì„œ & CAD ë„ë©´ (Read-Only) â•â•â• */}
          {(() => {
            const mokdaeVers = c.mokdaeVersions || [];
            const mokdaeFilesMap = c.mokdaeUploadedFiles || {};
            const cadVers = c.cadVersions || [];
            const mokdaeSubmitted = mokdaeVers.filter(v => !v.isNew);
            if (mokdaeSubmitted.length === 0 && cadVers.length === 0) return null;
            return (
              <section className="bg-white border border-gray-200 rounded-2xl overflow-hidden">
                <div className="flex items-center gap-2 px-5 py-3.5 border-b border-gray-100">
                  <div className="w-7 h-7 rounded-lg bg-indigo-500 flex items-center justify-center">
                    <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                  </div>
                  <div>
                    <h2 className="text-sm font-bold text-gray-800">ëª©ëŒ€ ë°œì£¼ì„œ & CAD ë„ë©´</h2>
                    <p className="text-xs text-gray-400">ë³¸ì‚¬ì—ì„œ ì „ë‹¬ëœ ëª©ëŒ€ ë°œì£¼ ë‚´ì—­</p>
                  </div>
                </div>
                <div className="p-5 space-y-4">
                  {mokdaeSubmitted.length > 0 && (
                    <div>
                      <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">ëª©ëŒ€ ë°œì£¼ì„œ</p>
                      <div className="space-y-3">
                        {[...mokdaeSubmitted].reverse().map((v, idx) => {
                          const mFiles = mokdaeFilesMap[v.versionNo] || [];
                          const mImages = mFiles.filter(f => f.isImage);
                          const mNonImages = mFiles.filter(f => !f.isImage);
                          return (
                            <div key={v.versionNo} className={`rounded-xl border p-4 ${idx === 0 ? 'border-indigo-200 bg-indigo-50/30' : 'border-gray-100 bg-gray-50/50'}`}>
                              <div className="flex items-center gap-2 mb-2">
                                <span className={`text-xs font-black px-2 py-0.5 rounded-full ${idx === 0 ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-500'}`}>V{v.versionNo}</span>
                                {idx === 0 && <span className="text-[10px] text-indigo-600 font-semibold">ìµœì‹ </span>}
                                <span className="text-xs text-gray-400">{v.sentAt}</span>
                              </div>
                              {v.mokdaeDate && (
                                <div className="flex items-center gap-2 mb-2 text-xs text-gray-500">
                                  <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2" strokeWidth={2}/><path strokeLinecap="round" strokeWidth={2} d="M16 2v4M8 2v4M3 10h18"/></svg>
                                  ëª©ëŒ€ ì˜ˆì •: <span className="font-bold text-gray-800">{v.mokdaeDate}</span>
                                </div>
                              )}
                              {mImages.length > 0 && (
                                <div className="grid grid-cols-4 gap-2 mb-2">
                                  {mImages.map(f => (
                                    <div key={f.id} className="relative cursor-pointer group" onClick={() => f.url && setLightbox({ url: f.url, name: f.name })}>
                                      <img src={f.url} alt={f.name} className="w-full aspect-square object-cover rounded-lg border border-gray-200 group-hover:ring-2 group-hover:ring-indigo-400 transition-all" />
                                      {f.url && (
                                        <a href={f.url} download={f.name} onClick={e => e.stopPropagation()}
                                          className="absolute top-1 right-1 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" title="ë‹¤ìš´ë¡œë“œ">
                                          <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                        </a>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              )}
                              {mNonImages.length > 0 && (
                                <div className="space-y-1">
                                  {mNonImages.map(f => (
                                    <div key={f.id} className="flex items-center gap-2 bg-white rounded-lg px-3 py-2 border border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors"
                                      onClick={() => { if (f.url) { const a = document.createElement('a'); a.href = f.url; a.download = f.name; document.body.appendChild(a); a.click(); document.body.removeChild(a); } }}>
                                      <svg className="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                      <span className="text-xs text-gray-600 truncate">{f.name}</span>
                                      <span className="text-[10px] text-gray-400 flex-shrink-0">{f.size}</span>
                                      <svg className="w-4 h-4 text-gray-400 ml-auto flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  {cadVers.length > 0 && (
                    <div>
                      <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">CAD ë„ë©´</p>
                      <div className="space-y-2">
                        {[...cadVers].reverse().map((v, idx) => (
                          <div key={v.versionNo} className={`rounded-xl border px-4 py-3 flex items-center gap-3 ${idx === 0 ? 'border-orange-200 bg-orange-50/50' : 'border-gray-100 bg-gray-50/50'}`}>
                            {v.previewUrl ? (
                              <img src={v.previewUrl} alt={`CAD V${v.versionNo}`}
                                className="img-thumb cursor-pointer hover:ring-2 hover:ring-orange-400 transition-all"
                                onClick={() => setLightbox({ url: v.previewUrl, name: v.fileName })} />
                            ) : (
                              <div className="w-8 h-8 rounded-lg bg-orange-500 text-white flex items-center justify-center text-xs font-black flex-shrink-0">V{v.versionNo}</div>
                            )}
                            <div className="flex-1 min-w-0">
                              <p className="text-xs font-semibold text-gray-800 truncate">{v.fileName}</p>
                              <p className="text-[10px] text-gray-400">{v.uploadedAt} Â· {v.fileSize}</p>
                            </div>
                            {v.previewUrl && (
                              <a href={v.previewUrl} download={v.fileName}
                                className="flex-shrink-0 text-gray-400 hover:text-orange-500 transition-colors" title="ë‹¤ìš´ë¡œë“œ">
                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                              </a>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </section>
            );
          })()}

          {/* â•â•â• ì„¹ì…˜ 2: ì‹¤ì¸¡ ìë£Œ (Read-Only) â•â•â• */}
          <section className="bg-white border border-gray-200 rounded-2xl overflow-hidden">
            <div className="flex items-center gap-2 px-5 py-3.5 border-b border-gray-100">
              <div className="w-7 h-7 rounded-lg bg-emerald-500 flex items-center justify-center">
                <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </div>
              <div>
                <h2 className="text-sm font-bold text-gray-800">ì‹¤ì¸¡ ìë£Œ</h2>
                <p className="text-xs text-gray-400">ì‹¤ì¸¡ ì‚¬ì§„ Â· ì‹¤ì¸¡ì§€ Â· ì¼ì •</p>
              </div>
            </div>
            <div className="p-5">
              <div className="grid grid-cols-2 gap-3 mb-4">
                <div className="bg-gray-50 rounded-xl px-4 py-3 border border-gray-100">
                  <p className="text-[11px] text-gray-400 font-medium">ì‹¤ì¸¡ ì¼ì •</p>
                  <p className="text-sm font-bold text-gray-800 mt-0.5">{c.schedule?.silcheuk || 'ë¯¸ì •'}</p>
                </div>
                <div className="bg-gray-50 rounded-xl px-4 py-3 border border-gray-100">
                  <p className="text-[11px] text-gray-400 font-medium">ì‹¤ì¸¡ ìƒíƒœ</p>
                  <p className={`text-sm font-bold mt-0.5 ${(c.status?.silcheuk||'').includes('ì™„ë£Œ') ? 'text-emerald-600' : 'text-amber-600'}`}>
                    {c.status?.silcheuk || '-'}
                  </p>
                </div>
              </div>
              {silcheukImages.length > 0 ? (
                <div className="grid grid-cols-4 gap-2">
                  {silcheukImages.map((f, i) => (
                    <div key={i} className="relative cursor-pointer group" onClick={() => f.url && setLightbox({ url: f.url, name: f.name })}>
                      {f.url ? (
                        <img src={f.url} alt={f.name} className="w-full aspect-square object-cover rounded-lg border border-gray-200 group-hover:ring-2 group-hover:ring-emerald-400 transition-all" />
                      ) : (
                        <div className="w-full aspect-square bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center">
                          <svg className="w-6 h-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                        </div>
                      )}
                      <div className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[9px] px-1.5 py-0.5 rounded-b-lg truncate">
                        {f.category} Â· {f.name}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="flex items-center gap-2 text-xs text-gray-400 bg-gray-50 border border-dashed border-gray-200 rounded-xl px-4 py-4">
                  <svg className="w-5 h-5 text-gray-300 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  <span>ì•„ì§ ì‹¤ì¸¡ ìë£Œê°€ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>
                </div>
              )}
            </div>
          </section>

          {/* â•â•â• ì„¹ì…˜ 3: ìƒíŒ ë„ë©´ ì—…ë¡œë“œ â•â•â• */}
          <section className="bg-white border border-gray-200 rounded-2xl overflow-hidden">
            <div className="flex items-center justify-between px-5 py-3.5 border-b border-gray-100">
              <div className="flex items-center gap-2">
                <div className="w-7 h-7 rounded-lg bg-orange-500 flex items-center justify-center">
                  <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                <div>
                  <h2 className="text-sm font-bold text-gray-800">ìƒíŒ ë„ë©´</h2>
                  <p className="text-xs text-gray-400">ë„ë©´ ì—…ë¡œë“œ Â· ë³¸ì‚¬ ê²€í†  ì—°ë™</p>
                </div>
              </div>
              {sangpanDrawingVersions.length > 0 && (
                <span className="bg-orange-500 text-white text-[10px] font-black px-2 py-0.5 rounded-full">{sangpanDrawingVersions.length}ê±´</span>
              )}
            </div>
            <div className="p-5 space-y-4">
              {sangpanDrawingVersions.length > 0 && (
                <div className="space-y-2">
                  {[...sangpanDrawingVersions].reverse().map((v, idx) => {
                    const cadStatusCls = {
                      "ìŠ¹ì¸": "bg-emerald-100 text-emerald-700 border-emerald-200",
                      "ë„ë©´ìˆ˜ì •ìš”ì²­": "bg-orange-100 text-orange-700 border-orange-200",
                      "ë„ë©´ê²€í† ì¤‘": "bg-brand-weak text-brand border-brand/20",
                    };
                    return (
                      <div key={v.versionNo} className={`rounded-xl border px-4 py-3 ${idx === 0 ? 'border-orange-200 bg-orange-50/50' : 'border-gray-100 bg-gray-50/50'}`}>
                        <div className="flex items-center gap-3">
                          {v.previewUrl ? (
                            <img src={v.previewUrl} alt={`ë„ë©´ V${v.versionNo}`}
                              className="img-thumb cursor-pointer hover:ring-2 hover:ring-orange-400 transition-all"
                              onClick={() => setLightbox({ url: v.previewUrl, name: v.fileName })} />
                          ) : (
                            <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 text-xs font-black ${idx === 0 ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                              V{v.versionNo}
                            </div>
                          )}
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-1.5 mb-0.5">
                              <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full ${idx === 0 ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-500'}`}>V{v.versionNo}</span>
                              {idx === 0 && <span className="text-[10px] text-orange-600 font-semibold">ìµœì‹ </span>}
                            </div>
                            <p className="text-xs font-semibold text-gray-800 truncate">{v.fileName}</p>
                            <p className="text-[10px] text-gray-400">{v.uploadedAt} Â· {v.fileSize}</p>
                          </div>
                          <span className={`text-xs font-semibold px-2 py-1 rounded-full border flex-shrink-0 ${cadStatusCls[v.status] || 'bg-amber-100 text-amber-700 border-amber-200'}`}>
                            {v.status}
                          </span>
                        </div>
                        {v.revisionNote && (
                          <div className="mt-2 flex items-start gap-2 bg-orange-100 border border-orange-200 rounded-lg px-3 py-2">
                            <svg className="w-3.5 h-3.5 text-orange-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            <div>
                              <p className="text-[10px] font-bold text-orange-700">ë³¸ì‚¬ ìˆ˜ì • ìš”ì²­</p>
                              <p className="text-xs text-orange-900 leading-relaxed mt-0.5">{v.revisionNote}</p>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}

              {/* ë°œì†¡ ëŒ€ê¸° ì¤‘ì¸ ìƒíŒ ë„ë©´ */}
              {stagedCad && (
                <div className="border-2 border-orange-300 bg-orange-50 rounded-xl p-4 space-y-3">
                  <div className="flex items-center gap-2">
                    <span className="text-xs font-bold text-orange-700 bg-orange-200 px-2 py-0.5 rounded-full">ë°œì†¡ ëŒ€ê¸°</span>
                    <span className="text-xs text-gray-500">ì•„ë˜ "ë°œì†¡" ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë³¸ì‚¬ì— ì „ë‹¬ë©ë‹ˆë‹¤</span>
                  </div>
                  <div className="flex items-center gap-3">
                    {stagedCad.previewUrl ? (
                      <img src={stagedCad.previewUrl} alt="Preview"
                        className="img-thumb cursor-pointer hover:ring-2 hover:ring-orange-400 transition-all"
                        onClick={() => setLightbox({ url: stagedCad.previewUrl, name: stagedCad.fileName })} />
                    ) : (
                      <div className="w-8 h-8 rounded-lg bg-orange-500 text-white flex items-center justify-center text-xs font-black flex-shrink-0">
                        V{stagedCad.versionNo}
                      </div>
                    )}
                    <div className="flex-1 min-w-0">
                      <p className="text-xs font-semibold text-gray-800 truncate">{stagedCad.fileName}</p>
                      <p className="text-[10px] text-gray-400">{stagedCad.uploadedAt} Â· {stagedCad.fileSize}</p>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={handleCadSend}
                      className="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-bold bg-orange-500 hover:bg-orange-600 text-white transition-all shadow-sm active:scale-95">
                      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                      </svg>
                      ë°œì†¡
                    </button>
                    <button onClick={handleCadCancel}
                      className="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-semibold border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                      ì·¨ì†Œ
                    </button>
                  </div>
                </div>
              )}

              <input ref={cadFileRef} type="file" className="hidden" accept=".dwg,.dxf,.pdf,.png,.jpg,.jpeg"
                onChange={e => { if (e.target.files[0]) handleCadFile(e.target.files[0]); e.target.value = ''; }} />
              <div
                onDrop={e => { e.preventDefault(); setCadDragOver(false); if (!stagedCad && e.dataTransfer.files[0]) handleCadFile(e.dataTransfer.files[0]); }}
                onDragOver={e => { e.preventDefault(); if (!stagedCad) setCadDragOver(true); }}
                onDragLeave={() => setCadDragOver(false)}
                onClick={() => !cadUploading && !stagedCad && cadFileRef.current?.click()}
                className={`border-2 border-dashed rounded-xl flex flex-col items-center justify-center gap-2 transition-all py-8 select-none ${
                  stagedCad ? 'border-gray-100 bg-gray-50 cursor-not-allowed opacity-50' :
                  cadDragOver ? 'drop-active cursor-pointer' : cadUploading ? 'border-orange-300 bg-orange-50 cursor-pointer' : 'border-gray-200 hover:border-orange-400 hover:bg-orange-50/40 cursor-pointer'
                }`}>
                {cadUploading ? (
                  <>
                    <svg className="w-6 h-6 text-orange-500 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <p className="text-xs text-orange-600 font-semibold">ì—…ë¡œë“œ ì¤‘â€¦</p>
                  </>
                ) : (
                  <>
                    <svg className="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    <p className="text-sm text-gray-500 font-medium">ìƒíŒ ë„ë©´ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                    <p className="text-xs text-gray-400">.DWG Â· .DXF Â· .PDF Â· .PNG Â· ë“œë˜ê·¸&ë“œë¡­ ì§€ì›</p>
                  </>
                )}
              </div>
            </div>
          </section>

          {/* â•â•â• ì œì‘ ì§„í–‰ ì œì–´ ë°” â•â•â• */}
          <section className="bg-white border border-gray-200 rounded-2xl overflow-hidden">
            <div className="px-5 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-7 h-7 rounded-lg bg-teal-600 flex items-center justify-center">
                  <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                </div>
                <div>
                  <h2 className="text-sm font-bold text-gray-800">ì œì‘ ìƒíƒœ</h2>
                  <div className="flex items-center gap-2 mt-0.5">
                    <span className={`text-xs font-bold px-3 py-1 rounded-full ${getCountertopStatusStyle(factoryStatus)}`}>
                      {factoryStatus}
                    </span>
                    {c.sangpanProductionStarted && c.sangpanProductionStartedAt && (
                      <span className="text-[10px] text-gray-400">
                        ì‹œì‘: {new Date(c.sangpanProductionStartedAt).toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}
                      </span>
                    )}
                  </div>
                </div>
              </div>
              <div className="flex items-center gap-2">
                {!c.sangpanProductionStarted ? (
                  <button onClick={handleStartProduction}
                    disabled={!c.sangpanConfirmedAt}
                    className={`flex items-center gap-2 px-4 py-2 text-sm font-bold rounded-lg transition-all shadow-sm ${
                      c.sangpanConfirmedAt
                        ? 'bg-teal-600 hover:bg-teal-700 text-white active:scale-95'
                        : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                    }`}>
                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                    ì œì‘ ì§„í–‰
                  </button>
                ) : (
                  <button onClick={handleStopProduction}
                    className="flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold rounded-lg transition-all shadow-sm active:scale-95">
                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/></svg>
                    ì œì‘ ì§„í–‰ ì¤‘ë‹¨
                  </button>
                )}
              </div>
            </div>
          </section>

          <div className="h-8"></div>
        </div>
      </div>

      {/* â”€â”€ ë¼ì´íŠ¸ë°•ìŠ¤ â”€â”€ */}
      {lightbox && (
        <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-8"
             onClick={() => setLightbox(null)}>
          <div className="relative flex flex-col items-center max-w-full max-h-full" onClick={e => e.stopPropagation()}>
            <button onClick={() => setLightbox(null)}
              className="absolute -top-3 -right-3 w-8 h-8 bg-white/20 hover:bg-white/40 rounded-full flex items-center justify-center text-white transition-colors z-10">
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            <img src={lightbox.url} alt={lightbox.name}
              className="max-w-full rounded-xl object-contain shadow-2xl"
              style={{ maxHeight: "80vh" }} />
            <div className="mt-3 flex items-center gap-4 w-full px-1">
              <p className="flex-1 text-white/70 text-sm truncate">{lightbox.name}</p>
              <span className="flex-shrink-0 text-xs text-white/40 bg-white/10 px-2 py-1 rounded">ESCë¡œ ë‹«ê¸°</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   App
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function App() {
  const [cases, setCases]           = useState([]);
  const [view, setView]             = useState('list');
  const [selectedId, setSelectedId] = useState(null);
  const { toasts, add: addToast, remove: removeToast } = useToast();

  useEffect(() => {
    setCases(loadCases());
    (async () => {
      const fromDb = await loadAllCasesFromDB();
      if (fromDb && fromDb.length > 0) {
        setCases(fromDb);
        try { localStorage.setItem(LS_KEY, JSON.stringify(fromDb)); } catch {}
      }
    })();
  }, []);

  /* cross-tab ë™ê¸°í™” */
  useEffect(() => {
    const refresh = () => setCases(loadCases());
    const onStorage = (e) => { if (e.key === LS_KEY) refresh(); };
    const onVisible = () => { if (document.visibilityState === 'visible') refresh(); };
    window.addEventListener('storage', onStorage);
    document.addEventListener('visibilitychange', onVisible);
    return () => {
      window.removeEventListener('storage', onStorage);
      document.removeEventListener('visibilitychange', onVisible);
    };
  }, []);

  /* ESC â†’ ëª©ë¡ìœ¼ë¡œ */
  useEffect(() => {
    const fn = (e) => { if (e.key === 'Escape' && view === 'detail') setView('list'); };
    document.addEventListener('keydown', fn);
    return () => document.removeEventListener('keydown', fn);
  }, [view]);

  const handleArchive = useCallback((ids) => {
    setCases(prev => {
      const next = prev.map(c => ids.includes(c.id) ? { ...c, archived: true } : c);
      try { localStorage.setItem(LS_KEY, JSON.stringify(next)); } catch {}
      return next;
    });
  }, []);

  const handleRestore = useCallback((ids) => {
    setCases(prev => {
      const next = prev.map(c => ids.includes(c.id) ? { ...c, archived: false } : c);
      try { localStorage.setItem(LS_KEY, JSON.stringify(next)); } catch {}
      return next;
    });
  }, []);

  const handleBack = useCallback(() => { setView('list'); setSelectedId(null); }, []);
  const handleSelect = useCallback((id) => { setSelectedId(id); setView('detail'); }, []);

  const handleUpdateCase = useCallback((updated) => {
    setCases(prev => {
      const next = prev.map(c => c.id === updated.id ? updated : c);
      try { localStorage.setItem(LS_KEY, JSON.stringify(next)); } catch {}
      syncCaseToDB(updated);
      return next;
    });
  }, []);

  const selectedCase = cases.find(c => c.id === selectedId);

  return (
    <div className="h-screen overflow-hidden bg-gray-100 flex flex-col">
      {view === 'list' ? (
        <ListPage cases={cases} onSelect={handleSelect} onArchive={handleArchive} onRestore={handleRestore} onToast={addToast} />
      ) : selectedCase ? (
        <DetailPage caseData={selectedCase} onBack={handleBack} onToast={addToast} onUpdate={handleUpdateCase} />
      ) : (
        <div className="flex items-center justify-center h-full">
          <button onClick={handleBack} className="text-brand text-sm font-bold">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      )}
      <ToastContainer toasts={toasts} onRemove={removeToast} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
