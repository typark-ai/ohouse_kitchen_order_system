<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>í˜„ì¥ ì‹¤ì¸¡ | ì§ì‹œê³µ ë°œì£¼ ì‹œìŠ¤í…œ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["'Pretendard Variable'", "Pretendard", "Inter", "sans-serif"],
          },
          colors: {
            brand: '#00A1FF', 'brand-weak': '#F0F8FC',
            'genuine-blue': { 50:'#F0F8FC',100:'#D9EFFF',200:'#9ED7FF',300:'#5EBFFF',400:'#00A1FF',500:'#0A78C0' },
            success: { DEFAULT:'#16a34a', weak:'#f0fdf4', foreground:'#15803d' },
            warning: { DEFAULT:'#fbbf24', weak:'#fffbeb', foreground:'#b45309' },
            destructive: { DEFAULT:'#dc2626', weak:'#fef2f2', foreground:'#fef2f2' },
            muted: { DEFAULT:'#f3f4f6', foreground:'#6b7280' },
          },
          borderRadius: { '2xl':'1rem', '3xl':'1.25rem' },
          animation: {
            'slide-up':   'slideUp 0.32s cubic-bezier(0.21,1.02,0.73,1) forwards',
            'fade-in':    'fadeIn 0.22s ease-out forwards',
            'bounce-in':  'bounceIn 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards',
            'shimmer':    'shimmer 1.8s linear infinite',
            'toast-in':   'toastIn 0.35s cubic-bezier(0.21,1.02,0.73,1) forwards',
            'toast-out':  'toastOut 0.25s ease-in forwards',
            'check-draw': 'checkDraw 0.5s ease-out 0.1s both',
          },
          keyframes: {
            slideUp:    { '0%': { transform:'translateY(100%)', opacity:'0' }, '100%': { transform:'translateY(0)', opacity:'1' } },
            fadeIn:     { '0%': { opacity:'0', transform:'translateY(8px)' }, '100%': { opacity:'1', transform:'translateY(0)' } },
            bounceIn:   { '0%': { transform:'scale(0.6)', opacity:'0' }, '100%': { transform:'scale(1)', opacity:'1' } },
            shimmer:    { '0%': { backgroundPosition:'-400px 0' }, '100%': { backgroundPosition:'400px 0' } },
            toastIn:    { '0%': { transform:'translateY(120%) scale(0.9)', opacity:'0' }, '100%': { transform:'translateY(0) scale(1)', opacity:'1' } },
            toastOut:   { '0%': { transform:'translateY(0) scale(1)', opacity:'1' }, '100%': { transform:'translateY(20px) scale(0.95)', opacity:'0' } },
            checkDraw:  { '0%': { strokeDashoffset:'30' }, '100%': { strokeDashoffset:'0' } },
          },
        },
      },
    };
  </script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; background: #F3F4F6; }
    body { font-family: 'Pretendard Variable', 'Pretendard', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; letter-spacing: -0.3px; word-break: keep-all; }
    .body-xs  { font-size: 0.625rem; line-height: 1.375; font-weight: 400; }
    .body-sm  { font-size: 0.75rem;  line-height: 1.375; font-weight: 400; }
    .body-md  { font-size: 0.875rem; line-height: 1.375; font-weight: 400; }
    .heading-xs { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-sm { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-md { font-size: 1.125rem; line-height: 1.25; font-weight: 600; }

    #root {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100%;
      background: #E5E7EB;
    }
    .mobile-shell {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: #F9FAFB;
      position: relative;
      box-shadow: 0 0 32px rgba(0,0,0,0.12);
    }

    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }

    .toast-enter { animation: toastIn 0.35s cubic-bezier(0.21,1.02,0.73,1) forwards; }
    .toast-exit  { animation: toastOut 0.25s ease-in forwards; }

    .btn-done {
      background: linear-gradient(90deg, #059669 25%, #10b981 50%, #059669 75%);
      background-size: 400px 100%;
      animation: shimmer 1.8s infinite linear;
    }

    .thumb-del { opacity: 0; transition: opacity 0.15s; }
    .thumb-wrap:hover .thumb-del,
    .thumb-wrap:active .thumb-del { opacity: 1; }

    @keyframes ripple {
      0%   { transform: scale(0); opacity: 0.5; }
      100% { transform: scale(4); opacity: 0; }
    }
    .ripple-btn { position: relative; overflow: hidden; }
    .ripple-btn::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      width: 60px; height: 60px;
      background: rgba(255,255,255,0.35);
      top: 50%; left: 50%;
      transform: scale(0) translate(-50%,-50%);
      transform-origin: top left;
    }
    .ripple-btn:active::after { animation: ripple 0.5s ease-out; }

    .sheet-backdrop { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

    .cb-custom {
      appearance: none; -webkit-appearance: none;
      width: 16px; height: 16px;
      border: 1.5px solid #D1D5DB; border-radius: 4px;
      background: #fff; cursor: pointer; position: relative;
      transition: all 0.1s; flex-shrink: 0;
    }
    .cb-custom:checked { background: #00A1FF; border-color: #00A1FF; }
    .cb-custom:checked::after {
      content: ''; position: absolute; left: 3px; top: 0px;
      width: 5px; height: 9px;
      border: 2px solid #fff; border-top: none; border-left: none;
      transform: rotate(45deg);
    }
    .cb-custom:indeterminate { background: #00A1FF; border-color: #00A1FF; }
    .cb-custom:indeterminate::after {
      content: ''; position: absolute; left: 3px; top: 6px;
      width: 8px; height: 0; border-top: 2px solid #fff;
    }

    .check-path {
      stroke-dasharray: 30;
      stroke-dashoffset: 30;
    }
    .check-path.drawn {
      animation: checkDraw 0.5s ease-out 0.1s both;
      stroke-dashoffset: 0;
    }

    .cal-day:hover:not(:disabled) { background: #F0F8FC; color: #00A1FF; }
    .cal-day:disabled { opacity: 0.3; cursor: not-allowed; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

/* â”€â”€ localStorage â”€â”€ */
const LS_CASES = 'JIKSIGONG_DATA';
function loadCases() {
  try { const r = localStorage.getItem(LS_CASES); return r ? JSON.parse(r) : []; } catch { return []; }
}
function saveEngResponse(caseId, response) {
  try {
    const raw = localStorage.getItem(LS_CASES);
    const items = raw ? JSON.parse(raw) : [];
    const idx = items.findIndex(c => c.id === caseId);
    if (idx === -1) return;
    items[idx] = { ...items[idx], silcheukEngResponse: response };
    localStorage.setItem(LS_CASES, JSON.stringify(items));
  } catch(e) {}
}
function saveUploadResult(caseId, result) {
  try {
    const raw = localStorage.getItem(LS_CASES);
    const items = raw ? JSON.parse(raw) : [];
    const idx = items.findIndex(c => c.id === caseId);
    if (idx === -1) return;
    items[idx] = { ...items[idx], silcheukUploadResult: result };
    localStorage.setItem(LS_CASES, JSON.stringify(items));
  } catch(e) {}
}

/* JIKSIGONG_DATA â†’ engineer í¬ë§· ë³€í™˜ */
function fmtProposalLabel(dateStr, timeStr) {
  if (!dateStr) return "ì¼ì • ë¯¸ì •";
  const [y, m, d] = dateStr.split("-").map(Number);
  const dow = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][new Date(y, m-1, d).getDay()];
  const timeLabel = timeStr ? ` ${timeStr}` : "";
  return `${m}ì›” ${d}ì¼ (${dow})${timeLabel}`;
}
function mapToSite(c) {
  const silcheukStatus = c.status?.silcheuk || "ëŒ€ê¸°";

  /* ê´€ë¦¬ìê°€ ë°œì†¡í•œ í¬ë§ ì¼ì •ì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš© */
  let proposals = [];
  if (c.silcheukSent && c.silcheukProposals && c.silcheukProposals.length > 0) {
    proposals = c.silcheukProposals.map(p => ({
      id:    p.id,
      date:  p.date,
      time:  p.time,
      label: fmtProposalLabel(p.date, p.time),
    }));
  } else {
    /* êµ¬í˜• ë°ì´í„°: schedule.silcheuk ë‹¨ì¼ ë‚ ì§œ fallback */
    const silcheukDate = c.schedule?.silcheuk || null;
    if (silcheukDate) {
      proposals = [{ id: 1, date: silcheukDate, time: "10:00", label: fmtProposalLabel(silcheukDate, "10:00") }];
    }
  }

  return {
    caseId:    c.id,
    customer:  c.customer  || "",
    phone:     c.phone     || "",
    address:   c.address   || "",
    manager:   c.manager ? `${c.manager} (ì˜ì—…)` : "",
    status:    silcheukStatus,
    cancelled: c.cancelled === true,
    archived:  c.archived  === true,
    proposals,
    /* ê´€ë¦¬ìê°€ ê³ ê° ì•ˆë‚´ ì „ë‹¬ ì™„ë£Œ ì‹œ ì±„ì›Œì§ */
    finalized:  c.silcheukFinalized  || false,
    finalDate:  c.silcheukFinalDate  || "",
    finalTime:  c.silcheukFinalTime  || "",
  };
}

const SITE_STATUS_STYLES = {
  "ì¼ì •ì¡°ìœ¨ì¤‘": "bg-amber-100 text-amber-700 border-amber-200",
  "ì‹¤ì¸¡ì˜ˆì •":   "bg-brand-weak text-brand border-brand/20",
  "ì™„ë£Œ":       "bg-emerald-100 text-emerald-700 border-emerald-200",
  "ëŒ€ê¸°":       "bg-gray-100 text-gray-500 border-gray-200",
  "ì·¨ì†Œë¨":     "bg-red-50 text-red-400 border-red-200",
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function useToast() {
  const [toasts, setToasts] = useState([]);
  const add = useCallback(({ type = "info", message, duration = 3200 }) => {
    const id = Date.now() + Math.random();
    setToasts(p => [...p, { id, type, message, duration }]);
  }, []);
  const remove = useCallback(id => setToasts(p => p.filter(t => t.id !== id)), []);
  return { toasts, add, remove };
}

function ToastItem({ toast, onRemove }) {
  const [exiting, setExiting] = useState(false);
  useEffect(() => {
    const t = setTimeout(() => {
      setExiting(true);
      setTimeout(() => onRemove(toast.id), 260);
    }, toast.duration);
    return () => clearTimeout(t);
  }, []);
  const icons = {
    success: <svg className="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7"/></svg>,
    info:    <svg className="w-4 h-4 text-brand flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    warning: <svg className="w-4 h-4 text-amber-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>,
  };
  const borders = { success:"border-l-4 border-emerald-500", info:"border-l-4 border-brand", warning:"border-l-4 border-amber-500" };
  return (
    <div className={`${exiting?"toast-exit":"toast-enter"} ${borders[toast.type]||borders.info}
      bg-white rounded-2xl shadow px-4 py-3 flex items-center gap-3 text-sm text-gray-700 font-medium`}>
      {icons[toast.type] || icons.info}
      <span className="flex-1">{toast.message}</span>
    </div>
  );
}

function ToastStack({ toasts, onRemove }) {
  return (
    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-[200] flex flex-col gap-2 items-center pointer-events-none"
      style={{ width: "min(440px, 90vw)" }}>
      {toasts.map(t => <ToastItem key={t.id} toast={t} onRemove={onRemove} />)}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 1 â€” í˜„ì¥ ì •ë³´ ì¹´ë“œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SiteInfoCard({ data }) {
  const [copied, setCopied] = useState(false);
  const handleCopy = () => {
    navigator.clipboard?.writeText(data.phone).then(() => {
      setCopied(true);
      setTimeout(() => setCopied(false), 1800);
    });
  };
  return (
    <div className="mx-4 mt-4 bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
      {/* ìƒë‹¨ í—¤ë” */}
      <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 rounded-xl bg-brand flex items-center justify-center flex-shrink-0">
            <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <div>
            <p className="body-xs text-muted-foreground font-medium tracking-widest uppercase">Today's Field</p>
            <p className="body-xs text-gray-900 font-semibold font-mono">{data.caseId}</p>
          </div>
        </div>
        <span className="flex items-center gap-1 bg-success-weak border border-green-200 text-success-foreground body-sm font-semibold px-2 py-1 rounded-full">
          <span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
          ì‹¤ì¸¡ ë°°ì •
        </span>
      </div>

      {/* ë‚´ìš© */}
      <div className="px-4 py-4 space-y-3">
        {/* ì£¼ì†Œ */}
        <div className="flex items-start gap-3">
          <div className="w-8 h-8 rounded-xl bg-brand-weak flex items-center justify-center flex-shrink-0 mt-1">
            <svg className="w-4 h-4 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
          </div>
          <div className="flex-1 min-w-0">
            <p className="text-xs text-gray-400 font-medium uppercase tracking-wide mb-1">í˜„ì¥ ì£¼ì†Œ</p>
            <p className="text-sm font-semibold text-gray-900 leading-snug">{data.address}</p>
          </div>
        </div>

        <div className="border-t border-gray-100"></div>

        {/* ê³ ê°ëª… + ì—°ë½ì²˜ */}
        <div className="flex items-center gap-3">
          <div className="flex items-center gap-3 flex-1">
            <div className="w-8 h-8 rounded-xl bg-gray-100 flex items-center justify-center flex-shrink-0">
              <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
            </div>
            <div>
              <p className="text-xs text-gray-400 font-medium uppercase tracking-wide mb-1">ê³ ê°</p>
              <p className="text-sm font-bold text-gray-900">{data.customer}</p>
            </div>
          </div>
          <a href={`tel:${data.phone.replace(/-/g,"")}`}
            className="flex items-center gap-2 bg-emerald-50 border border-emerald-200 text-emerald-700 text-xs font-semibold px-3 h-9 rounded-xl active:scale-95 transition-transform">
            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
            </svg>
            {data.phone}
          </a>
        </div>

        {/* ë‹´ë‹¹ì */}
        <div className="flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2">
          <svg className="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
              d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <span className="text-xs text-gray-500">ë³¸ì‚¬ ë‹´ë‹¹:</span>
          <span className="text-xs font-semibold text-gray-700">{data.manager}</span>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëŒ€ì²´ ì¼ì • ì œì•ˆ Bottom Sheet
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ProposeSheet({ onClose, onSubmit }) {
  const today = new Date(2026, 1, 25);
  const [viewYear, setViewYear]   = useState(2026);
  const [viewMonth, setViewMonth] = useState(1);
  const [selDate, setSelDate]     = useState(null);
  const [selHour, setSelHour]     = useState("10");
  const [selMin, setSelMin]       = useState("00");

  const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
  const firstDow    = new Date(viewYear, viewMonth, 1).getDay();
  const monthLabel  = `${viewYear}ë…„ ${viewMonth + 1}ì›”`;

  const prevMonth = () => {
    if (viewMonth === 0) { setViewMonth(11); setViewYear(y => y - 1); }
    else setViewMonth(m => m - 1);
    setSelDate(null);
  };
  const nextMonth = () => {
    if (viewMonth === 11) { setViewMonth(0); setViewYear(y => y + 1); }
    else setViewMonth(m => m + 1);
    setSelDate(null);
  };

  const isPast = (d) => {
    const dt = new Date(viewYear, viewMonth, d);
    dt.setHours(0,0,0,0);
    const t = new Date(today); t.setHours(0,0,0,0);
    return dt <= t;
  };

  const handleSubmit = () => {
    if (!selDate) return;
    const mm = String(viewMonth + 1).padStart(2,"0");
    const dd = String(selDate).padStart(2,"0");
    onSubmit({ date: `${viewYear}-${mm}-${dd}`, time: `${selHour}:${selMin}` });
  };

  return (
    <div className="fixed inset-0 z-[100] flex flex-col justify-end" style={{ maxWidth:480, margin:"0 auto" }}>
      <div className="sheet-backdrop absolute inset-0 bg-black/50" onClick={onClose} />

      <div className="relative bg-white rounded-t-3xl shadow animate-slide-up overflow-hidden"
        style={{ maxHeight:"92vh", overflowY:"auto" }}>

        <div className="flex justify-center pt-3 pb-1">
          <div className="w-10 h-1 rounded-full bg-gray-200"></div>
        </div>

        <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
          <div>
            <h3 className="text-base font-semibold text-gray-900">ëŒ€ì²´ ì¼ì • ì œì•ˆ</h3>
            <p className="text-xs text-gray-400 mt-1">ë°©ë¬¸ ê°€ëŠ¥í•œ ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•´ìš”</p>
          </div>
          <button onClick={onClose}
            className="w-8 h-8 rounded-xl flex items-center justify-center text-gray-400 hover:bg-gray-100 active:bg-gray-200 transition-colors">
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div className="px-4 pt-4 pb-6 space-y-4">
          {/* â”€â”€ ë‹¬ë ¥ â”€â”€ */}
          <div>
            <div className="flex items-center justify-between mb-3">
              <button onClick={prevMonth}
                className="w-9 h-9 rounded-xl flex items-center justify-center text-gray-500 hover:bg-gray-100 active:bg-gray-200 transition-colors">
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7"/>
                </svg>
              </button>
              <span className="text-sm font-semibold text-gray-900">{monthLabel}</span>
              <button onClick={nextMonth}
                className="w-9 h-9 rounded-xl flex items-center justify-center text-gray-500 hover:bg-gray-100 active:bg-gray-200 transition-colors">
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/>
                </svg>
              </button>
            </div>

            <div className="grid grid-cols-7 mb-1">
              {["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].map((d,i) => (
                <div key={d} className={`text-center text-xs font-semibold py-1
                  ${i===0?"text-red-400":i===6?"text-brand":"text-gray-400"}`}>
                  {d}
                </div>
              ))}
            </div>

            <div className="grid grid-cols-7 gap-y-1">
              {Array.from({ length: firstDow }).map((_,i) => <div key={`e${i}`}/>)}
              {Array.from({ length: daysInMonth }, (_,i) => i+1).map(d => {
                const past = isPast(d);
                const dow  = (firstDow + d - 1) % 7;
                const isSelected = selDate === d;
                return (
                  <button
                    key={d}
                    disabled={past}
                    onClick={() => setSelDate(d)}
                    className={`cal-day mx-auto w-9 h-9 rounded-xl text-sm font-semibold flex items-center justify-center transition-all
                      ${isSelected
                        ? "bg-brand text-white shadow-sm scale-110"
                        : past
                          ? "text-gray-300 cursor-not-allowed"
                          : dow===0
                            ? "text-red-500 hover:bg-red-50"
                            : dow===6
                              ? "text-brand hover:bg-brand-weak"
                              : "text-gray-700 hover:bg-gray-100"
                      }`}
                  >
                    {d}
                  </button>
                );
              })}
            </div>
          </div>

          {selDate && (
            <div className="animate-fade-in bg-brand-weak border border-brand/20 rounded-xl px-4 py-2 flex items-center gap-2">
              <svg className="w-4 h-4 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span className="text-sm font-semibold text-brand">
                {viewYear}ë…„ {viewMonth+1}ì›” {selDate}ì¼ ì„ íƒë¨
              </span>
            </div>
          )}

          {/* â”€â”€ ì‹œê°„ ì„ íƒ â”€â”€ */}
          <div>
            <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">ë°©ë¬¸ í¬ë§ ì‹œê°„</p>
            <div className="flex items-center gap-2">
              <div className="flex-1">
                <label className="block text-xs text-gray-400 font-medium mb-1 text-center">ì‹œ</label>
                <select value={selHour} onChange={e => setSelHour(e.target.value)}
                  className="w-full text-center text-base font-bold text-gray-900 border-2 border-gray-200 rounded-xl py-3 focus:outline-none focus:border-brand focus:ring-2 focus:ring-brand/20 bg-white appearance-none">
                  {Array.from({length:13},(_,i)=>i+7).map(h=>(
                    <option key={h} value={String(h).padStart(2,"0")}>{String(h).padStart(2,"0")}ì‹œ</option>
                  ))}
                </select>
              </div>
              <span className="text-2xl font-bold text-gray-300 pb-1">:</span>
              <div className="flex-1">
                <label className="block text-xs text-gray-400 font-medium mb-1 text-center">ë¶„</label>
                <select value={selMin} onChange={e => setSelMin(e.target.value)}
                  className="w-full text-center text-base font-bold text-gray-900 border-2 border-gray-200 rounded-xl py-3 focus:outline-none focus:border-brand focus:ring-2 focus:ring-brand/20 bg-white appearance-none">
                  {["00","30"].map(m=>(
                    <option key={m} value={m}>{m}ë¶„</option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          <button
            onClick={handleSubmit}
            disabled={!selDate}
            className={`ripple-btn w-full h-12 rounded-2xl text-sm font-semibold flex items-center justify-center gap-2 transition-all
              ${selDate
                ? "bg-gray-900 hover:bg-gray-800 active:scale-[0.98] text-white shadow-sm"
                : "bg-gray-200 text-gray-400 cursor-not-allowed"
              }`}
          >
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
            {selDate
              ? `${viewMonth+1}ì›” ${selDate}ì¼ ${selHour}:${selMin} ì—­ì œì•ˆí•˜ê¸°`
              : "ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ìš”"
            }
          </button>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 2 â€” ì¼ì • ì¡°ìœ¨ (Ping-pong)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ScheduleSection({ proposals, caseId, onToast, finalized, finalDate, finalTime }) {
  const [accepted, setAccepted]   = useState(null);
  const [showSheet, setShowSheet] = useState(false);
  const [proposed, setProposed]   = useState(null);

  const handleAccept = (p) => {
    /* ì´ë¯¸ ìˆ˜ë½ëœ í•­ëª©ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ìˆ˜ë½ ì·¨ì†Œ (í† ê¸€) */
    if (accepted === p.id) {
      setAccepted(null);
      if (caseId) saveEngResponse(caseId, null);
      onToast({ type:"info", message:`â†© ${p.label} ìˆ˜ë½ì´ ì·¨ì†Œë˜ì—ˆì–´ìš”.`, duration:2500 });
      return;
    }
    setAccepted(p.id);
    setProposed(null);
    /* ê¸°ì‚¬ ìˆ˜ë½ â†’ localStorageì— ì €ì¥ â†’ ê´€ë¦¬ì ìƒì„¸ í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥ */
    if (caseId) {
      saveEngResponse(caseId, { type: "accepted", date: p.date, time: p.time });
    }
    onToast({ type:"success", message:`âœ… ${p.label} ì¼ì •ì´ ìˆ˜ë½ë˜ì—ˆì–´ìš”. ë³¸ì‚¬ì— ì „ë‹¬ë©ë‹ˆë‹¤.`, duration:3500 });
  };

  const handlePropose = ({ date, time }) => {
    setShowSheet(false);
    setAccepted(null);
    const [y,m,d] = date.split("-");
    const label = `${parseInt(m)}ì›” ${parseInt(d)}ì¼ ${time}`;
    setProposed({ date, time, label });
    /* ëŒ€ì²´ ì¼ì • ì—­ì œì•ˆ â†’ localStorageì— ì €ì¥ â†’ ê´€ë¦¬ì ìƒì„¸ í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥ */
    if (caseId) {
      saveEngResponse(caseId, { type: "counter", date, time, counterProposals: [{ date, time }] });
    }
    onToast({ type:"info", message:`ğŸ“… ëŒ€ì²´ ì¼ì •(${label})ì´ ë³¸ì‚¬ë¡œ ì „ë‹¬ë˜ì—ˆì–´ìš”.`, duration:3500 });
  };

  return (
    <div className="mx-4 mt-4">
      <div className="flex items-center gap-2 mb-3">
        <div className="w-6 h-6 rounded-lg bg-brand flex items-center justify-center">
          <svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </div>
        <div>
          <h2 className="text-sm font-semibold text-gray-900">ì¼ì • ì¡°ìœ¨</h2>
          <p className="text-xs text-gray-400">
            {finalized ? "í™•ì •ëœ ì¼ì •ì´ ì „ë‹¬ë˜ì—ˆì–´ìš” Â· ìˆ˜ì • ë¶ˆê°€" : "ë³¸ì‚¬ ì œì•ˆ ì¼ì •ì„ í™•ì¸í•˜ê³  ì‘ë‹µí•´ìš”"}
          </p>
        </div>
      </div>

      {finalized ? (
        /* â”€â”€ ìµœì¢… ì¼ì • í™•ì • ì™„ë£Œ (read-only) â”€â”€ */
        <div className="bg-emerald-50 rounded-2xl border border-emerald-200 overflow-hidden animate-fade-in">
          <div className="flex items-center gap-2 px-4 py-2 bg-emerald-100 border-b border-emerald-200">
            <svg className="w-4 h-4 text-emerald-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p className="text-xs font-semibold text-emerald-700">ë³¸ì‚¬ì—ì„œ ìµœì¢… ì¼ì •ì„ í™•ì •í–ˆì–´ìš”</p>
          </div>
          <div className="px-4 py-4 flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-emerald-500 flex items-center justify-center flex-shrink-0">
              <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div className="flex-1">
              <p className="text-base font-bold text-emerald-800">
                {fmtProposalLabel(finalDate, finalTime)}
              </p>
              <p className="text-xs text-emerald-600 mt-0.5">í™•ì • ì™„ë£Œ Â· ì¼ì • ìˆ˜ì • ë¶ˆê°€</p>
            </div>
            <svg className="w-5 h-5 text-gray-300 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8}
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <div className="mx-4 mb-4 flex items-center gap-2 bg-white border border-emerald-200 rounded-xl px-3 py-2.5">
            <svg className="w-3.5 h-3.5 text-brand flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span className="text-xs text-gray-600">ì•„ë˜ ì‹¤ì¸¡ ê²°ê³¼ ì—…ë¡œë“œ ì˜ì—­ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
          </div>
        </div>
      ) : (
        <>
          <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div className="flex items-center gap-2 px-4 py-2 bg-gray-50 border-b border-gray-100">
              <div className="w-5 h-5 rounded-full bg-gray-700 flex items-center justify-center">
                <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
              </div>
              <p className="text-xs text-gray-500">
                <span className="font-semibold text-gray-700">ë³¸ì‚¬(ì˜¤ëŠ˜ì˜ì§‘)</span>ì—ì„œ ê³ ê° í¬ë§ ì¼ì •ì„ ì œì•ˆí–ˆì–´ìš”
              </p>
            </div>

            <div className="divide-y divide-gray-100">
              {proposals.map((p, idx) => {
                const isAccepted = accepted === p.id;
                return (
                  <div key={p.id}
                    className={`flex items-center gap-3 px-4 py-3 transition-colors
                      ${isAccepted ? "bg-emerald-50" : "bg-white"}`}>
                    <span className={`w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center flex-shrink-0
                      ${isAccepted
                        ? "bg-emerald-500 text-white"
                        : "bg-brand-weak text-brand"
                      }`}>
                      {isAccepted ? (
                        <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7"/>
                        </svg>
                      ) : idx+1}
                    </span>

                    <div className="flex-1">
                      <p className={`text-sm font-semibold ${isAccepted ? "text-emerald-800" : "text-gray-900"}`}>
                        {p.label}
                      </p>
                      {isAccepted && (
                        <p className="text-xs text-emerald-600 font-medium mt-1 animate-fade-in">ìˆ˜ë½ë¨ Â· ë³¸ì‚¬ ì „ë‹¬ ì™„ë£Œ</p>
                      )}
                    </div>

                    {isAccepted ? (
                      <button
                        onClick={() => handleAccept(p)}
                        title="ë‹¤ì‹œ í´ë¦­í•˜ë©´ ìˆ˜ë½ ì·¨ì†Œ"
                        className="ripple-btn text-xs font-semibold text-emerald-600 bg-emerald-100 border border-emerald-200 px-3 py-1 rounded-xl hover:bg-emerald-200 active:scale-95 transition-all"
                      >
                        ìˆ˜ë½ë¨
                      </button>
                    ) : (
                      <button
                        onClick={() => handleAccept(p)}
                        className="ripple-btn flex items-center gap-1 text-xs font-semibold text-white bg-brand
                          hover:bg-[#0090e6] active:scale-95 px-3 h-8 rounded-xl shadow-sm transition-all"
                      >
                        <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7"/>
                        </svg>
                        ìˆ˜ë½
                      </button>
                    )}
                  </div>
                );
              })}
            </div>

            {proposed && (
              <div className="mx-4 mb-3 animate-fade-in bg-brand-weak border border-brand/20 rounded-xl px-4 py-3 flex items-start gap-2">
                <svg className="w-4 h-4 text-brand mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                    d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                </svg>
                <div>
                  <p className="text-xs font-semibold text-brand">ì—­ì œì•ˆ ì „ë‹¬ë¨</p>
                  <p className="text-xs text-brand/70 mt-1">{proposed.label} â€” ë³¸ì‚¬ í™•ì¸ í›„ ì—°ë½ ì˜ˆì •</p>
                </div>
              </div>
            )}

            {!accepted && (
              <div className="px-4 pb-4 pt-2">
                <button
                  onClick={() => setShowSheet(true)}
                  className="ripple-btn w-full flex items-center justify-center gap-2 py-3 rounded-2xl
                    border-2 border-dashed border-amber-300 bg-amber-50 text-amber-700
                    hover:border-amber-400 hover:bg-amber-100 active:scale-[0.98]
                    text-sm font-semibold transition-all"
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                  </svg>
                  ì¼ì • ë¶ˆê°€ â€” ëŒ€ì²´ ì¼ì • ì œì•ˆí•˜ê¸°
                </button>
              </div>
            )}
          </div>

          {showSheet && (
            <ProposeSheet onClose={() => setShowSheet(false)} onSubmit={handlePropose} />
          )}
        </>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì—…ë¡œë“œ ë²„íŠ¼ (í° ë„¤ëª¨ ì¹´ë“œ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function UploadCard({ icon, label, sublabel, color, files, onAdd, onRemove, accept, multiple = true, locked = false }) {
  const inputRef = useRef(null);

  /* ì´ë¯¸ì§€: canvasë¡œ ìµœëŒ€ 900px ë¦¬ì‚¬ì´ì¦ˆ í›„ JPEG 75% ì €ì¥ (localStorage ìš©ëŸ‰ ì´ˆê³¼ ë°©ì§€)
     ë¹„ì´ë¯¸ì§€(PDF/DWG ë“±): url=null, ë©”íƒ€ë°ì´í„°ë§Œ ì €ì¥ */
  const handleInput = async (e) => {
    const files = Array.from(e.target.files);
    const toStorable = (f) => new Promise((resolve) => {
      if (!f.type.startsWith("image/")) {
        resolve({ id: Date.now() + Math.random(), name: f.name, url: null, isImage: false, size: f.size });
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const MAX = 900;
          let { width, height } = img;
          if (width > MAX || height > MAX) {
            if (width >= height) { height = Math.round(height * MAX / width); width = MAX; }
            else                 { width  = Math.round(width  * MAX / height); height = MAX; }
          }
          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          canvas.getContext("2d").drawImage(img, 0, 0, width, height);
          resolve({
            id:      Date.now() + Math.random(),
            name:    f.name,
            url:     canvas.toDataURL("image/jpeg", 0.75),
            isImage: true,
            size:    f.size,
          });
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(f);
    });
    const newFiles = await Promise.all(files.map(toStorable));
    onAdd(newFiles);
    e.target.value = "";
  };

  const isEmpty = files.length === 0;

  return (
    <div className="flex flex-col gap-2">
      <button
        onClick={() => !locked && inputRef.current?.click()}
        disabled={locked}
        className={`ripple-btn w-full flex flex-col items-center justify-center gap-2 py-4 rounded-2xl border-2 transition-all
          ${locked
            ? 'border-dashed border-gray-200 bg-gray-50 text-gray-300 cursor-not-allowed'
            : isEmpty
              ? `border-dashed ${color.border} ${color.bg} ${color.text} active:scale-[0.97]`
              : `border-solid ${color.activeBorder} ${color.activeBg} ${color.text} active:scale-[0.97]`
          }`}
      >
        <input ref={inputRef} type="file" accept={accept} multiple={multiple} className="hidden" onChange={handleInput} disabled={locked} />
        <div className={`w-12 h-12 rounded-2xl ${locked ? 'bg-gray-100' : color.iconBg} flex items-center justify-center transition-colors`}>
          {locked
            ? <svg className="w-6 h-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8}
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
            : icon
          }
        </div>
        <div className="text-center">
          <p className="text-sm font-semibold">{label}</p>
          <p className={`text-xs mt-1 ${locked ? 'text-gray-300' : color.sub}`}>
            {locked ? 'ì¼ì • í™•ì • í›„ ê°€ëŠ¥' : sublabel}
          </p>
        </div>
        {!locked && !isEmpty && (
          <span className={`text-xs font-semibold ${color.badge} px-2 py-1 rounded-full`}>
            {files.length}ê°œ Â· íƒ­í•˜ì—¬ ì¶”ê°€
          </span>
        )}
      </button>

      {!locked && files.length > 0 && (
        <div className="flex flex-wrap gap-2 px-1 animate-fade-in">
          {files.map(f => (
            <div key={f.id} className="thumb-wrap relative w-16 h-16 rounded-xl overflow-hidden border border-gray-200 shadow-sm group">
              {f.isImage ? (
                <img src={f.url} alt={f.name} className="w-full h-full object-cover"/>
              ) : (
                <div className="w-full h-full bg-gray-100 flex flex-col items-center justify-center gap-1 px-1">
                  <svg className="w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5}
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <p className="text-xs text-gray-500 truncate w-full text-center">{f.name.split(".").pop()}</p>
                </div>
              )}
              <button
                onClick={() => onRemove(f.id)}
                className="thumb-del absolute top-1 right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center shadow-sm"
              >
                <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION 3 â€” ì‹¤ì¸¡ ê²°ê³¼ ì—…ë¡œë“œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function UploadSection({ onToast, siteStatus, finalized, caseId }) {
  const [drawings, setDrawings] = useState([]);
  const [photos, setPhotos]     = useState([]);
  const [memo, setMemo]           = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [submitted,  setSubmitted]  = useState(false);

  /* ì‹¤ì¸¡ì˜ˆì • ìƒíƒœì´ê±°ë‚˜ ê´€ë¦¬ìê°€ ìµœì¢… ì¼ì •ì„ í™•ì •í•œ ê²½ìš° ì—…ë¡œë“œ/ì „ì†¡ ê°€ëŠ¥ */
  const isScheduleConfirmed = siteStatus === "ì‹¤ì¸¡ì˜ˆì •" || finalized === true;

  /* ì‹¤ì¸¡ì§€ ë˜ëŠ” í˜„ì¥ì‚¬ì§„ ìµœì†Œ 1ê°œ ì²¨ë¶€ + ì¼ì • í™•ì • ìƒíƒœì—¬ì•¼ ì „ì†¡ ê°€ëŠ¥ */
  const canSubmit = (drawings.length > 0 || photos.length > 0) && !submitted && isScheduleConfirmed;

  const handleSubmit = () => {
    if (!canSubmit) return;
    setSubmitting(true);
    /* localStorageì— ì—…ë¡œë“œ ê²°ê³¼ ì €ì¥ â†’ detail.html SectionResultì—ì„œ í‘œì‹œ */
    const result = {
      drawings:    drawings.map(f => ({ id: f.id, name: f.name, url: f.url, isImage: f.isImage })),
      photos:      photos.map(f => ({ id: f.id, name: f.name, url: f.url, isImage: f.isImage })),
      memo,
      submittedAt: new Date().toISOString(),
    };
    if (caseId) saveUploadResult(caseId, result);
    setTimeout(() => {
      setSubmitting(false);
      setSubmitted(true);
      onToast({ type:"success", message:"ğŸ“¤ ì‹¤ì¸¡ ê²°ê³¼ê°€ ë³¸ì‚¬ë¡œ ì „ì†¡ë˜ì—ˆì–´ìš”!", duration:4000 });
    }, 2000);
  };

  return (
    <div className="mx-4 mt-4">
      <div className="flex items-center gap-2 mb-3">
        <div className="w-6 h-6 rounded-lg bg-brand flex items-center justify-center">
          <svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </div>
        <div>
          <h2 className="text-sm font-semibold text-gray-900">ì‹¤ì¸¡ ê²°ê³¼ ì—…ë¡œë“œ</h2>
          <p className="text-xs text-gray-400">í˜„ì¥ ìë£Œë¥¼ ì²¨ë¶€í•˜ê³  ê²°ê³¼ë¥¼ ì „ì†¡í•´ìš”</p>
        </div>
      </div>

      <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 space-y-4">

        {/* ì ê¸ˆ ë°°ë„ˆ â€” ì‹¤ì¸¡ì˜ˆì • ìƒíƒœê°€ ì•„ë‹ ë•Œ í‘œì‹œ */}
        {!isScheduleConfirmed && (
          <div className="flex items-start gap-2.5 bg-amber-50 border border-amber-200 rounded-xl px-3 py-2.5">
            <svg className="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
            <div>
              <p className="text-xs font-bold text-amber-700">ì—…ë¡œë“œ ì ê¸ˆ</p>
              <p className="text-xs text-amber-600 mt-0.5 leading-snug">ì‹¤ì¸¡ ì¼ì •ì´ í™•ì •(ì‹¤ì¸¡ì˜ˆì •)ëœ í›„ì— ì—…ë¡œë“œê°€ ê°€ëŠ¥í•´ìš”</p>
            </div>
          </div>
        )}

        <div className="grid grid-cols-2 gap-3">
          <UploadCard
            label="ì‹¤ì¸¡ì§€(ë„ë©´)"
            sublabel="PDF Â· DWG Â· ì´ë¯¸ì§€"
            accept=".pdf,.dwg,.jpg,.jpeg,.png,.heic"
            locked={!isScheduleConfirmed}
            icon={
              <svg className="w-7 h-7 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8}
                  d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            }
            color={{
              border:"border-rose-300", bg:"bg-rose-50", text:"text-rose-600",
              activeBorder:"border-rose-400", activeBg:"bg-rose-50",
              iconBg:"bg-white border border-rose-100",
              sub:"text-rose-400", badge:"bg-rose-100 text-rose-600",
            }}
            files={drawings}
            onAdd={f => setDrawings(p => [...p, ...f])}
            onRemove={id => setDrawings(p => p.filter(f => f.id !== id))}
          />

          <UploadCard
            label="í˜„ì¥ ì‚¬ì§„"
            sublabel="ì¹´ë©”ë¼ Â· ì•¨ë²”"
            accept="image/*"
            locked={!isScheduleConfirmed}
            icon={
              <svg className="w-7 h-7 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8}
                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            }
            color={{
              border:"border-brand/40", bg:"bg-brand-weak", text:"text-brand",
              activeBorder:"border-brand/60", activeBg:"bg-brand-weak",
              iconBg:"bg-white border border-brand/20",
              sub:"text-brand/60", badge:"bg-brand-weak text-brand",
            }}
            files={photos}
            onAdd={f => setPhotos(p => [...p, ...f])}
            onRemove={id => setPhotos(p => p.filter(f => f.id !== id))}
          />
        </div>

        {(drawings.length > 0 || photos.length > 0) && (
          <div className="animate-fade-in flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2">
            <svg className="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7"/>
            </svg>
            <div className="flex gap-3 text-xs">
              {drawings.length > 0 && (
                <span className="text-rose-600 font-semibold">ğŸ“ ë„ë©´ {drawings.length}ê°œ</span>
              )}
              {photos.length > 0 && (
                <span className="text-brand font-semibold">ğŸ“· ì‚¬ì§„ {photos.length}ì¥</span>
              )}
            </div>
            <span className="ml-auto text-xs text-gray-400">ì²¨ë¶€ë¨</span>
          </div>
        )}

        <div className="border-t border-gray-100"></div>

        <div>
          <label className="flex items-center gap-1 text-xs font-semibold text-gray-600 mb-2">
            <svg className="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            í˜„ì¥ íŠ¹ì´ì‚¬í•­ ë©”ëª¨
            <span className="ml-auto text-gray-300 font-normal">{memo.length} / 500</span>
          </label>
          <textarea
            value={memo}
            onChange={e => { if(e.target.value.length <= 500) setMemo(e.target.value); }}
            placeholder={"í˜„ì¥ì—ì„œ ë°œê²¬ëœ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•´ìš”.\nì˜ˆ) ë²½ë©´ ìˆ˜ì§ ë¶ˆëŸ‰ ì•½ 12mm, ë°°ê´€ ìœ„ì¹˜ ìƒì´ ë“±"}
            rows={4}
            className="w-full px-3 py-3 text-sm border border-gray-200 rounded-xl resize-none
              focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand
              text-gray-700 leading-relaxed placeholder:text-gray-300 bg-gray-50
              focus:bg-white transition-colors"
          />
        </div>
      </div>

      <div className="mt-3 pb-8">
        <button
          onClick={handleSubmit}
          disabled={!canSubmit || submitting}
          className={`ripple-btn w-full py-4 rounded-2xl text-base font-bold flex items-center justify-center gap-3
            transition-all duration-300
            ${submitted
              ? "btn-done text-white shadow-sm cursor-default"
              : canSubmit && !submitting
                ? "bg-brand hover:bg-[#0090e6] active:scale-[0.98] text-white shadow-sm"
                : submitting
                  ? "bg-brand/60 text-white cursor-wait"
                  : "bg-gray-200 text-gray-400 cursor-not-allowed"
              }`}
        >
          {submitted ? (
            <>
              <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path className="check-path drawn" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              ì „ì†¡ ì™„ë£Œ â€” ë³¸ì‚¬ì— ì „ë‹¬ë¨
            </>
          ) : submitting ? (
            <>
              <svg className="w-6 h-6 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              ì „ì†¡ ì¤‘â€¦
            </>
          ) : (
            <>
              <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
              </svg>
              ì‹¤ì¸¡ ì™„ë£Œ ì „ì†¡
            </>
          )}
        </button>

        {!canSubmit && !submitted && !submitting && (
          <p className="text-center text-xs text-gray-400 mt-2 animate-fade-in">
            {!isScheduleConfirmed
              ? 'ì¼ì • í™•ì • í›„ ì—…ë¡œë“œ ë° ì „ì†¡ì´ ê°€ëŠ¥í•´ìš”'
              : 'ì‹¤ì¸¡ì§€ Â· ì‚¬ì§„ì„ 1ê°œ ì´ìƒ ì²¨ë¶€í•´ì•¼ ì „ì†¡í•  ìˆ˜ ìˆì–´ìš”'}
          </p>
        )}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SITE LIST VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SiteListView({ sites, cancelledSites = [], archivedSites = [], onSelect, onArchive, onRestore, onToast }) {
  const [tab, setTab] = useState("active");
  const [selectedIds, setSelectedIds] = useState([]);

  const handleTabChange = (t) => { setTab(t); setSelectedIds([]); };
  const toggleSelect = (id) => setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);

  /* ì§„í–‰ ì¤‘ íƒ­: í™œì„± ì‚¬ì´íŠ¸ + ì·¨ì†Œëœ ì‚¬ì´íŠ¸ë¥¼ í•©ì³ì„œ ì²´í¬ë°•ìŠ¤ í‘œì‹œ */
  const allActiveSites = useMemo(() => [...sites, ...cancelledSites], [sites, cancelledSites]);
  const todayCount = sites.filter(s => s.status === "ì‹¤ì¸¡ì˜ˆì •" || s.status === "ì¼ì •ì¡°ìœ¨ì¤‘").length;

  const handleArchiveAction = () => {
    if (selectedIds.length === 0) return;
    onArchive(selectedIds);
    onToast({ type: 'success', title: 'ì•„ì¹´ì´ë¹™ ì™„ë£Œ', message: `${selectedIds.length}ê±´ì´ ì•„ì¹´ì´ë¸Œë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.` });
    setSelectedIds([]);
  };
  const handleRestoreAction = () => {
    if (selectedIds.length === 0) return;
    onRestore(selectedIds);
    onToast({ type: 'success', title: 'ë³µêµ¬ ì™„ë£Œ', message: `${selectedIds.length}ê±´ì´ ì§„í–‰ ì¤‘ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.` });
    setSelectedIds([]);
  };

  return (
    <div className="overflow-y-auto pb-4">
      {/* â”€â”€ íƒ­ ë°” â”€â”€ */}
      <div className="px-4 pt-3 pb-1 flex items-center gap-1 border-b border-gray-100">
        <button
          onClick={() => handleTabChange("active")}
          className={`px-3 py-2 text-xs font-bold rounded-lg transition-colors ${
            tab === "active" ? "bg-gray-900 text-white" : "text-gray-400 hover:text-gray-600 hover:bg-gray-100"
          }`}>
          ì§„í–‰ ì¤‘ {(sites.length + cancelledSites.length) > 0 && <span className="ml-1 opacity-70">({sites.length + cancelledSites.length})</span>}
        </button>
        <button
          onClick={() => handleTabChange("archived")}
          className={`px-3 py-2 text-xs font-bold rounded-lg transition-colors ${
            tab === "archived" ? "bg-gray-900 text-white" : "text-gray-400 hover:text-gray-600 hover:bg-gray-100"
          }`}>
          ì•„ì¹´ì´ë¸Œ {archivedSites.length > 0 && <span className="ml-1 opacity-70">({archivedSites.length})</span>}
        </button>
      </div>

      {/* â”€â”€ ì§„í–‰ ì¤‘ íƒ­ â”€â”€ */}
      {tab === "active" && (
        <>
          <div className="px-4 pt-3 pb-2 flex items-center justify-between">
            <p className="text-xs text-gray-500 font-semibold">
              ì´ {sites.length}ê°œ í˜„ì¥
              {todayCount > 0 && (
                <span className="ml-2 bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full border border-amber-200">
                  ì¼ì • ì¡°ìœ¨ {todayCount}ê±´
                </span>
              )}
            </p>
          </div>

          {allActiveSites.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-20 gap-3 px-8">
              <div className="w-14 h-14 bg-gray-100 rounded-2xl flex items-center justify-center">
                <svg className="w-7 h-7 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5}
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
              </div>
              <p className="text-sm font-semibold text-gray-400">ë°°ì •ëœ í˜„ì¥ì´ ì—†ì–´ìš”</p>
              <p className="text-xs text-gray-300 text-center leading-relaxed">
                ë³¸ì‚¬ì—ì„œ í˜„ì¥ì„ ë“±ë¡í•˜ë©´<br/>ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
              </p>
            </div>
          ) : (
            <div className="px-4 space-y-3">
              {/* í™œì„± ì‚¬ì´íŠ¸ */}
              {sites.map(site => (
                <div key={site.caseId} className="flex items-start gap-2">
                  <div className="pt-5 pl-1 flex-shrink-0">
                    <input type="checkbox" className="cb-custom"
                      checked={selectedIds.includes(site.caseId)}
                      onChange={() => toggleSelect(site.caseId)} />
                  </div>
                  <button
                    onClick={() => onSelect(site)}
                    className="flex-1 text-left bg-white rounded-2xl border border-gray-200 shadow-sm active:scale-[0.98] transition-transform overflow-hidden"
                  >
                    <div className="px-4 py-4">
                      <div className="flex items-start justify-between gap-3">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1.5">
                            <span className="text-xs font-mono font-semibold text-gray-400">{site.caseId}</span>
                            <span className={`text-xs font-semibold px-2 py-0.5 rounded-full border ${SITE_STATUS_STYLES[site.status] || SITE_STATUS_STYLES["ëŒ€ê¸°"]}`}>
                              {site.status}
                            </span>
                          </div>
                          <p className="text-sm font-bold text-gray-900 mb-1">{site.customer} ê³ ê°</p>
                          <p className="text-xs text-gray-500 truncate">{site.address}</p>
                        </div>
                        <svg className="w-5 h-5 text-gray-300 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                      </div>
                      <div className="mt-3 flex items-center gap-2 text-xs text-gray-400 border-t border-gray-100 pt-3">
                        <svg className="w-3.5 h-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>{site.proposals[0]?.label || "ì¼ì • ë¯¸ì •"}</span>
                        {site.proposals.length > 1 && (
                          <span className="text-gray-300">ì™¸ {site.proposals.length - 1}ì•ˆ</span>
                        )}
                      </div>
                    </div>
                  </button>
                </div>
              ))}

              {/* ì·¨ì†Œëœ í˜„ì¥ */}
              {cancelledSites.length > 0 && (
                <>
                  <div className="flex items-center gap-2 mt-3 mb-1">
                    <div className="h-px flex-1 bg-red-100"></div>
                    <span className="text-xs font-semibold text-red-400 flex items-center gap-1.5">
                      <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                          d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                      </svg>
                      ì·¨ì†Œëœ ìš”ì²­ {cancelledSites.length}ê±´
                    </span>
                    <div className="h-px flex-1 bg-red-100"></div>
                  </div>
                  {cancelledSites.map(site => (
                    <div key={site.caseId} className="flex items-start gap-2">
                      <div className="pt-4 pl-1 flex-shrink-0">
                        <input type="checkbox" className="cb-custom"
                          checked={selectedIds.includes(site.caseId)}
                          onChange={() => toggleSelect(site.caseId)} />
                      </div>
                      <div className="flex-1 bg-gray-50 rounded-2xl border border-gray-200 overflow-hidden opacity-60">
                        <div className="px-4 py-3">
                          <div className="flex items-start justify-between gap-3">
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 mb-1">
                                <span className="text-xs font-mono font-semibold text-gray-400">{site.caseId}</span>
                                <span className="text-xs font-semibold px-2 py-0.5 rounded-full border bg-red-50 text-red-400 border-red-200">ì·¨ì†Œë¨</span>
                              </div>
                              <p className="text-sm font-bold text-gray-500 line-through">{site.customer} ê³ ê°</p>
                              <p className="text-xs text-gray-400 truncate mt-0.5">{site.address}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </>
              )}
            </div>
          )}
        </>
      )}

      {/* â”€â”€ ì•„ì¹´ì´ë¸Œ íƒ­ â”€â”€ */}
      {tab === "archived" && (
        <>
          {archivedSites.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-20 gap-3 px-8">
              <div className="w-14 h-14 bg-gray-100 rounded-2xl flex items-center justify-center">
                <svg className="w-7 h-7 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                </svg>
              </div>
              <p className="text-sm font-semibold text-gray-400">ì•„ì¹´ì´ë¸Œê°€ ë¹„ì–´ìˆì–´ìš”</p>
              <p className="text-xs text-gray-300 text-center leading-relaxed">
                ì§„í–‰ ì¤‘ íƒ­ì—ì„œ í˜„ì¥ì„ ì„ íƒí•˜ì—¬<br/>ì•„ì¹´ì´ë¸Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
              </p>
            </div>
          ) : (
            <div className="px-4 pt-3 space-y-3">
              {archivedSites.map(site => (
                <div key={site.caseId} className="flex items-start gap-2">
                  <div className="pt-4 pl-1 flex-shrink-0">
                    <input type="checkbox" className="cb-custom"
                      checked={selectedIds.includes(site.caseId)}
                      onChange={() => toggleSelect(site.caseId)} />
                  </div>
                  <div className={`flex-1 rounded-2xl border overflow-hidden ${
                    site.cancelled
                      ? 'bg-gray-50 border-gray-200 opacity-60'
                      : 'bg-white border-gray-200 shadow-sm'
                  }`}>
                    <div className="px-4 py-3">
                      <div className="flex items-start justify-between gap-3">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="text-xs font-mono font-semibold text-gray-400">{site.caseId}</span>
                            {site.cancelled ? (
                              <span className="text-xs font-semibold px-2 py-0.5 rounded-full border bg-red-50 text-red-400 border-red-200">ì·¨ì†Œë¨</span>
                            ) : (
                              <span className={`text-xs font-semibold px-2 py-0.5 rounded-full border ${SITE_STATUS_STYLES[site.status] || SITE_STATUS_STYLES["ëŒ€ê¸°"]}`}>
                                {site.status}
                              </span>
                            )}
                            <span className="text-xs font-semibold px-2 py-0.5 rounded-full border bg-gray-100 text-gray-400 border-gray-200">ì•„ì¹´ì´ë¸Œ</span>
                          </div>
                          <p className={`text-sm font-bold mb-1 ${site.cancelled ? 'text-gray-500 line-through' : 'text-gray-900'}`}>{site.customer} ê³ ê°</p>
                          <p className="text-xs text-gray-400 truncate mt-0.5">{site.address}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </>
      )}

      {/* â”€â”€ í•˜ë‹¨ ì•¡ì…˜ ë°” â”€â”€ */}
      {selectedIds.length > 0 && (
        <div className="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[430px] bg-white border-t border-gray-200 shadow-lg px-4 py-3 z-50 flex items-center justify-between">
          <span className="text-xs font-semibold text-gray-600">{selectedIds.length}ê±´ ì„ íƒë¨</span>
          <div className="flex items-center gap-2">
            <button onClick={() => setSelectedIds([])}
              className="px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              ì„ íƒ í•´ì œ
            </button>
            {tab === "active" ? (
              <button onClick={handleArchiveAction}
                className="px-4 py-2 text-xs font-bold text-white bg-gray-700 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-1.5">
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                </svg>
                ì•„ì¹´ì´ë¹™
              </button>
            ) : (
              <button onClick={handleRestoreAction}
                className="px-4 py-2 text-xs font-bold text-white bg-brand rounded-lg hover:bg-brand-dark transition-colors flex items-center gap-1.5">
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                ë³µêµ¬
              </button>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function App() {
  const { toasts, add: addToast, remove: removeToast } = useToast();
  const [selectedSite, setSelectedSite] = useState(null);
  const [refreshKey, setRefreshKey] = useState(0);

  /* cross-tab ë™ê¸°í™” â€” ë‹¤ë¥¸ íƒ­ì—ì„œ ë°ì´í„° ë³€ê²½ ì‹œ ìë™ ê°±ì‹  */
  useEffect(() => {
    const bump = () => setRefreshKey(k => k + 1);
    const onStorage = (e) => { if (e.key === LS_CASES) bump(); };
    const onVisible = () => { if (document.visibilityState === 'visible') bump(); };
    window.addEventListener('storage', onStorage);
    document.addEventListener('visibilitychange', onVisible);
    return () => {
      window.removeEventListener('storage', onStorage);
      document.removeEventListener('visibilitychange', onVisible);
    };
  }, []);

  /* localStorageì—ì„œ ë¡œë“œ â†’ ì‹¤ì¸¡ ê´€ë ¨ ì¼€ì´ìŠ¤ í•„í„° (ì·¨ì†Œë¨ ë³„ë„ ë¶„ë¦¬) */
  const allSilcheukCases = useMemo(() =>
    loadCases()
      .filter(c =>
        /* ê´€ë¦¬ìê°€ í¬ë§ ì¼ì •ì„ ë°œì†¡í–ˆê±°ë‚˜, ê¸°ì¡´ ì‹¤ì¸¡ ìƒíƒœê°€ ìˆëŠ” ê²½ìš° í‘œì‹œ */
        c.silcheukSent ||
        (c.status?.silcheuk && c.status.silcheuk !== "ë°œì£¼ìš”ì²­ëŒ€ê¸°" && c.status.silcheuk !== "ì‹¤ì¸¡ ìš”ì²­ ëŒ€ê¸°")
      )
      .map(mapToSite),
    [refreshKey]
  );
  const sites          = useMemo(() => allSilcheukCases.filter(s => !s.cancelled && !s.archived), [allSilcheukCases]);
  const cancelledSites = useMemo(() => allSilcheukCases.filter(s => s.cancelled && !s.archived), [allSilcheukCases]);
  const archivedSites  = useMemo(() => allSilcheukCases.filter(s => s.archived), [allSilcheukCases]);

  /* ì•„ì¹´ì´ë¹™ / ë³µêµ¬ */
  const handleArchive = useCallback((caseIds) => {
    try {
      const raw = localStorage.getItem(LS_CASES);
      const items = raw ? JSON.parse(raw) : [];
      const updated = items.map(c => caseIds.includes(c.id) ? { ...c, archived: true } : c);
      localStorage.setItem(LS_CASES, JSON.stringify(updated));
      setRefreshKey(k => k + 1);
    } catch {}
  }, []);

  const handleRestore = useCallback((caseIds) => {
    try {
      const raw = localStorage.getItem(LS_CASES);
      const items = raw ? JSON.parse(raw) : [];
      const updated = items.map(c => caseIds.includes(c.id) ? { ...c, archived: false } : c);
      localStorage.setItem(LS_CASES, JSON.stringify(updated));
      setRefreshKey(k => k + 1);
    } catch {}
  }, []);

  const engineerName = "í˜„ì¥ ê¸°ì‚¬";

  return (
    <div className="mobile-shell">
      {/* â”€â”€ ìƒë‹¨ ì•± í—¤ë” â”€â”€ */}
      <div className="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div className="flex items-center justify-between px-4 py-3">
          <div className="flex items-center gap-2">
            {selectedSite ? (
              <button
                onClick={() => setSelectedSite(null)}
                className="w-8 h-8 flex items-center justify-center rounded-xl hover:bg-gray-100 transition-colors mr-0.5"
              >
                <svg className="w-5 h-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
            ) : (
              <div className="w-8 h-8 bg-gray-900 rounded-xl flex items-center justify-center">
                <svg className="w-[18px] h-[18px] text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
              </div>
            )}
            <div>
              <p className="text-xs text-gray-400 leading-none font-medium">ì§ì‹œê³µ ë°œì£¼ ì‹œìŠ¤í…œ</p>
              <p className="text-sm font-bold text-gray-900 leading-tight">
                {selectedSite ? `${selectedSite.customer} í˜„ì¥` : "ë‚´ í˜„ì¥ ëª©ë¡"}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="flex items-center gap-2 bg-brand-weak border border-brand/20 px-2 py-1 rounded-xl">
              <div className="w-6 h-6 bg-brand rounded-lg flex items-center justify-center">
                <span className="text-white text-xs font-bold">{engineerName[0]}</span>
              </div>
              <span className="text-xs font-semibold text-brand">{engineerName} ê¸°ì‚¬</span>
            </div>
          </div>
        </div>
      </div>

      {/* â”€â”€ ì»¨í…ì¸  â”€â”€ */}
      {selectedSite ? (
        <div className="overflow-y-auto pb-4">
          <SiteInfoCard data={selectedSite} />
          <ScheduleSection
            proposals={selectedSite.proposals}
            caseId={selectedSite.caseId}
            onToast={addToast}
            finalized={selectedSite.finalized}
            finalDate={selectedSite.finalDate}
            finalTime={selectedSite.finalTime}
          />

          <div className="mx-4 mt-4 flex items-center gap-3">
            <div className="flex-1 h-px bg-gray-200"></div>
            <span className="text-xs text-gray-400 font-semibold uppercase tracking-widest">í˜„ì¥ ì‘ì—…</span>
            <div className="flex-1 h-px bg-gray-200"></div>
          </div>

          <UploadSection onToast={addToast} siteStatus={selectedSite.status} finalized={selectedSite.finalized} caseId={selectedSite.caseId} />
        </div>
      ) : (
        <SiteListView
          sites={sites}
          cancelledSites={cancelledSites}
          archivedSites={archivedSites}
          onSelect={setSelectedSite}
          onArchive={handleArchive}
          onRestore={handleRestore}
          onToast={addToast}
        />
      )}

      <ToastStack toasts={toasts} onRemove={removeToast} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
