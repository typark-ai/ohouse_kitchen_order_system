<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>기기 발주 관리 | 직시공 B2B</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["'Pretendard Variable'", "Pretendard", "Inter", "sans-serif"] },
          colors: {
            brand: '#00A1FF', 'brand-weak': '#F0F8FC',
            'genuine-blue': { 50:'#F0F8FC',100:'#D9EFFF',200:'#9ED7FF',300:'#5EBFFF',400:'#00A1FF',500:'#0A78C0' },
            success: { DEFAULT:'#16a34a', weak:'#f0fdf4', foreground:'#15803d' },
            warning: { DEFAULT:'#fbbf24', weak:'#fffbeb', foreground:'#b45309' },
            destructive: { DEFAULT:'#dc2626', weak:'#fef2f2', foreground:'#fef2f2' },
            muted: { DEFAULT:'#f3f4f6', foreground:'#6b7280' },
          },
          borderRadius: { '2xl':'1rem', '3xl':'1.25rem' },
        },
      },
    };
  </script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: 'Pretendard Variable', 'Pretendard', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; letter-spacing: -0.3px; word-break: keep-all; background: #F9FAFB; margin: 0; }
    .body-xs  { font-size: 0.625rem; line-height: 1.375; font-weight: 400; }
    .body-sm  { font-size: 0.75rem;  line-height: 1.375; font-weight: 400; }
    .body-md  { font-size: 0.875rem; line-height: 1.375; font-weight: 400; }
    .heading-xs { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-sm { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-md { font-size: 1.125rem; line-height: 1.25; font-weight: 600; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #F3F4F6; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

    .cb-custom {
      appearance: none; -webkit-appearance: none;
      width: 16px; height: 16px;
      border: 1.5px solid #D1D5DB; border-radius: 4px;
      background: #fff; cursor: pointer; position: relative;
      transition: all 0.1s; flex-shrink: 0;
    }
    .cb-custom:checked { background: #00A1FF; border-color: #00A1FF; }
    .cb-custom:checked::after {
      content: ''; position: absolute; left: 3px; top: 0px;
      width: 5px; height: 9px;
      border: 2px solid #fff; border-top: none; border-left: none;
      transform: rotate(45deg);
    }
    .cb-custom:indeterminate { background: #00A1FF; border-color: #00A1FF; }
    .cb-custom:indeterminate::after {
      content: ''; position: absolute; left: 3px; top: 6px;
      width: 8px; height: 0; border-top: 2px solid #fff;
    }

    @keyframes toastIn  { 0% { transform: translateY(20px) scale(0.95); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
    @keyframes toastOut { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(8px) scale(0.95); opacity: 0; } }
    .toast-enter { animation: toastIn  0.35s cubic-bezier(0.21,1.02,0.73,1) forwards; }
    .toast-exit  { animation: toastOut 0.25s ease-in forwards; }

    @keyframes fadeIn { 0% { opacity: 0; transform: translateY(6px); } 100% { opacity: 1; transform: translateY(0); } }
    .anim-in { animation: fadeIn 0.2s ease-out forwards; }

    @keyframes modalIn { from { opacity:0; transform:scale(0.93) translateY(14px); } to { opacity:1; transform:scale(1) translateY(0); } }
    .modal-box { animation: modalIn 0.26s cubic-bezier(0.21,1.02,0.73,1); }

    .step-line { flex: 1; height: 2px; }
    .btn-press:active { transform: scale(0.97); }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

/* ═══════════════════════════════════════
   DB Primary
═══════════════════════════════════════ */
const LS_CASES = 'JIKSIGONG_DATA';
const TODAY_STR = new Date().toLocaleDateString("ko-KR", { year: "numeric", month: "long", day: "numeric" });

const SUPABASE_URL = "https://ykifurzrrbjrgjrznimk.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlraWZ1cnpycmJqcmdqcnpuaW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjE3NTcsImV4cCI6MjA4NzY5Nzc1N30.BVTlrG_Q_cXqj6qOa_rZPXrCs7MhwuR9o8koncGoUU0";
const SB_HEADERS = { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" };

function dbRowToCase(r) {
  return {
    id: r.id, customer: r.customer, phone: r.phone, address: r.address, manager: r.manager,
    schedule: r.schedule || {}, status: r.status || {},
    archived: r.archived || false, cancelled: r.cancelled || false,
    gigiOrderData: null, gigiFinalDate: r.gigi_final_date || "",
  };
}

async function loadAllCasesFromDB() {
  try {
    const [casesRes, gigiRes] = await Promise.all([
      fetch(`${SUPABASE_URL}/rest/v1/cases?select=*&order=created_at.desc`, {
        headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
      }),
      fetch(`${SUPABASE_URL}/rest/v1/gigi_store?select=case_id,data`, {
        headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
      }),
    ]);
    if (!casesRes.ok) throw new Error("cases fetch failed");
    const cases = (await casesRes.json()).map(dbRowToCase);
    const gigiRows = gigiRes.ok ? await gigiRes.json() : [];
    // gigi_store 데이터를 cases에 병합
    const gigiMap = {};
    gigiRows.forEach(g => { gigiMap[g.case_id] = g.data; });
    return cases.map(c => {
      const gigiData = gigiMap[c.id];
      if (gigiData) {
        return {
          ...c,
          gigiOrderData: gigiData,
          status: { ...c.status, gigi: gigiData.status || c.status.gigi },
          gigiFinalDate: c.gigiFinalDate || gigiData.requestedDate || "",
        };
      }
      return c;
    });
  } catch (e) { console.warn("DB load failed:", e); return null; }
}

async function patchCaseInDB(caseId, fields) {
  try {
    await fetch(`${SUPABASE_URL}/rest/v1/cases?id=eq.${encodeURIComponent(caseId)}`, {
      method: "PATCH",
      headers: SB_HEADERS,
      body: JSON.stringify(fields),
    });
  } catch (e) { console.warn("DB patch failed:", e); }
}

async function upsertGigiStore(caseId, data) {
  try {
    await fetch(`${SUPABASE_URL}/rest/v1/gigi_store`, {
      method: "POST",
      headers: { ...SB_HEADERS, "Prefer": "resolution=merge-duplicates" },
      body: JSON.stringify({ case_id: caseId, data }),
    });
  } catch (e) { console.warn("gigi_store upsert failed:", e); }
}

/* ═══════════════════════════════════════
   Helpers
═══════════════════════════════════════ */
const GIGI_STEPS = ["발주 대기", "발주 요청", "승인 대기", "발주 확정"];

function getGigiStep(s) {
  if (!s || s.includes('대기')) return 0;
  if (s === '발주확정') return 3;
  if (s === '발주요청반려') return 1;
  return 2;
}

function daysDiff(dateStr) {
  if (!dateStr) return null;
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(dateStr); d.setHours(0,0,0,0);
  return Math.ceil((d - today) / 86400000);
}

function computeSupplierStatus(c) {
  if (!c.gigiOrderData) return "대기";
  const s = c.gigiOrderData.status || c.status?.gigi || "";
  if (s === "발주확정") return "발주 확정";
  if (s === "발주요청반려") return "반려";
  if (s === "발주요청완료") return "승인 대기";
  return "대기";
}

function getSupplierStatusStyle(text) {
  if (!text || text === "대기") return "bg-gray-100 text-gray-500";
  if (text === "발주 확정") return "bg-emerald-50 text-emerald-700 border border-emerald-200 font-semibold";
  if (text === "반려") return "bg-red-50 text-red-700 border border-red-200 font-semibold";
  if (text === "승인 대기") return "bg-brand-weak text-brand border border-brand/20";
  return "bg-gray-100 text-gray-500";
}

function getCaseBadgeCls(s) {
  if (!s || s.includes('대기')) return 'bg-gray-100 text-gray-500 border-gray-200';
  if (s.includes('확정')) return 'bg-emerald-100 text-emerald-700 border-emerald-200';
  if (s.includes('반려')) return 'bg-red-100 text-red-600 border-red-200';
  return 'bg-brand-weak text-brand border-brand/20';
}

/* ═══════════════════════════════════════
   useToast + Toast
═══════════════════════════════════════ */
function useToast() {
  const [toasts, setToasts] = useState([]);
  const add    = useCallback(({ type='info', title, message, duration=4000 }) => {
    const id = Date.now() + Math.random();
    setToasts(p => [...p, { id, type, title, message, duration }]);
  }, []);
  const remove = useCallback(id => setToasts(p => p.filter(t => t.id !== id)), []);
  return { toasts, add, remove };
}

function Toast({ toast, onRemove }) {
  const [ex, setEx] = useState(false);
  useEffect(() => {
    const t = setTimeout(() => { setEx(true); setTimeout(() => onRemove(toast.id), 250); }, toast.duration);
    return () => clearTimeout(t);
  }, []);
  const border = { success:'border-emerald-500', error:'border-red-500', info:'border-brand', warning:'border-amber-500' };
  return (
    <div className={`${ex?'toast-exit':'toast-enter'} ${border[toast.type]||border.info} border-l-4 bg-white rounded-xl shadow-lg px-4 py-3 flex items-start gap-3 min-w-[300px] max-w-sm pointer-events-auto`}>
      <div className="flex-1 min-w-0">
        {toast.title && <p className="text-sm font-bold text-gray-800">{toast.title}</p>}
        <p className="text-sm text-gray-500 mt-0.5 leading-relaxed">{toast.message}</p>
      </div>
      <button onClick={() => { setEx(true); setTimeout(() => onRemove(toast.id), 250); }} className="text-gray-300 hover:text-gray-500 flex-shrink-0">
        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
  );
}
function ToastContainer({ toasts, onRemove }) {
  return (
    <div className="fixed top-6 right-6 z-[300] flex flex-col gap-2 pointer-events-none">
      {toasts.map(t => <Toast key={t.id} toast={t} onRemove={onRemove} />)}
    </div>
  );
}

/* ═══════════════════════════════════════
   서브 컴포넌트: StatusBadge, DateCell
═══════════════════════════════════════ */
function StatusBadge({ text }) {
  if (!text || text === "대기") return <span className="text-gray-300">-</span>;
  return (
    <span className={`inline-block px-2 py-1 rounded-full text-xs whitespace-nowrap ${getSupplierStatusStyle(text)}`}>
      {text}
    </span>
  );
}

function DateCell({ dateStr }) {
  if (!dateStr) return <span className="text-gray-300">-</span>;
  const diff = daysDiff(dateStr);
  const urgent = diff !== null && diff <= 2;
  let dLabel = null;
  if (diff !== null) {
    if (diff === 0)      dLabel = "(오늘)";
    else if (diff < 0)   dLabel = `(D${diff})`;
    else                  dLabel = `(D-${diff})`;
  }
  return (
    <div className="flex flex-col items-center leading-snug">
      <span className={urgent ? "text-red-600 font-semibold whitespace-nowrap" : "text-gray-700 whitespace-nowrap"}>
        {dateStr}
      </span>
      {dLabel && (
        <span className={`text-xs mt-0.5 whitespace-nowrap ${urgent ? "text-red-500 font-semibold" : "text-gray-400"}`}>
          {dLabel}
        </span>
      )}
    </div>
  );
}

/* ═══════════════════════════════════════
   Stepper
═══════════════════════════════════════ */
function Stepper({ step }) {
  return (
    <div className="flex items-center w-full">
      {GIGI_STEPS.map((label, i) => {
        const done   = i < step;
        const active = i === step;
        return (
          <React.Fragment key={i}>
            <div className="flex flex-col items-center gap-1.5 flex-shrink-0">
              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-black transition-all
                ${done ? 'bg-emerald-500 text-white shadow-sm' : active ? 'bg-brand text-white shadow ring-4 ring-brand/15' : 'bg-gray-200 text-gray-400'}`}>
                {done
                  ? <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7"/></svg>
                  : i + 1}
              </div>
              <span className={`text-xs font-semibold whitespace-nowrap ${done ? 'text-emerald-600' : active ? 'text-brand font-black' : 'text-gray-400'}`}>
                {label}{active && <span className="ml-1 font-normal text-brand/60">(현재)</span>}
              </span>
            </div>
            {i < GIGI_STEPS.length - 1 && <div className={`step-line mx-2 rounded-full ${done ? 'bg-emerald-400' : 'bg-gray-200'}`} />}
          </React.Fragment>
        );
      })}
    </div>
  );
}

/* ═══════════════════════════════════════
   ListPage — 테이블 목록 (factory/countertop과 동일 패턴)
═══════════════════════════════════════ */
function ListPage({ cases, onSelect, onArchive, onRestore, onToast }) {
  const [tab, setTab]                 = useState("active");
  const [selectedIds, setSelectedIds] = useState([]);
  const [search, setSearch]           = useState("");
  const [hoveredRow, setHoveredRow]   = useState(null);

  const handleTabChange = (t) => { setTab(t); setSelectedIds([]); setSearch(""); };

  const activeCount  = cases.filter(c => !c.archived && !c.cancelled && c.gigiOrderData).length;
  const archiveCount = cases.filter(c => c.archived === true).length;
  const cancelledCases = useMemo(() => cases.filter(c => c.cancelled === true && !c.archived), [cases]);

  const tabData = useMemo(() => {
    if (tab === "archived") return cases.filter(c => c.archived === true);
    return cases.filter(c => !c.archived && !c.cancelled && c.gigiOrderData);
  }, [cases, tab]);

  const filtered = useMemo(() => {
    if (!search) return tabData;
    const q = search.toLowerCase();
    return tabData.filter(c =>
      (c.customer || "").toLowerCase().includes(q) ||
      (c.id || "").toLowerCase().includes(q) ||
      (c.address || "").toLowerCase().includes(q)
    );
  }, [tabData, search]);

  const handleToggleSelect = (id) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
  };
  const handleToggleAll = (checked) => {
    setSelectedIds(checked ? filtered.map(c => c.id) : []);
  };

  const allSelected  = filtered.length > 0 && selectedIds.length === filtered.length;
  const someSelected = selectedIds.length > 0 && selectedIds.length < filtered.length;
  const headerCbRef  = useRef(null);
  useEffect(() => {
    if (headerCbRef.current) headerCbRef.current.indeterminate = someSelected;
  }, [someSelected]);

  const handleArchiveAction = () => {
    if (selectedIds.length === 0) return;
    onArchive(selectedIds);
    setSelectedIds([]);
    onToast({ type: 'success', title: '아카이브 완료', message: `${selectedIds.length}건이 아카이브되었습니다.` });
  };
  const handleRestoreAction = () => {
    if (selectedIds.length === 0) return;
    onRestore(selectedIds);
    setSelectedIds([]);
    onToast({ type: 'success', title: '복원 완료', message: `${selectedIds.length}건이 복원되었습니다.` });
  };

  const colGroups = [
    { label: "",         span: 1, cls: "bg-gray-50 border-r border-gray-200" },
    { label: "기본 정보", span: 3, cls: "bg-gray-50" },
    { label: "일정",      span: 1, cls: "bg-brand-weak" },
    { label: "발주 상태", span: 1, cls: "bg-gray-50" },
  ];
  const cols = [
    { label: "",               w: "w-10"  },
    { label: "상담 ID",        w: "w-36"  },
    { label: "고객명",         w: "w-20"  },
    { label: "현장 주소",      w: "w-56"  },
    { label: "희망 납기일",    w: "w-32"  },
    { label: "발주 상태",      w: "w-36"  },
  ];

  return (
    <div className="min-h-screen bg-[#F9FAFB] flex flex-col">

      {/* ── 헤더 ── */}
      <header className="bg-white text-gray-900 px-6 h-14 flex items-center justify-between border-b border-gray-200 flex-shrink-0">
        <div className="flex items-center gap-3">
          <img src="/images/ohouse-logo.png" alt="오늘의집" className="h-10" />
          <div className="h-6 w-px bg-gray-200"></div>
          <div>
            <h1 className="heading-sm text-gray-900">기기 업체 포털</h1>
            <p className="body-xs text-muted-foreground">발주 시스템</p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <div className="body-sm text-muted-foreground hidden sm:block">
            오늘 <span className="text-gray-900 font-semibold">{TODAY_STR}</span>
          </div>
        </div>
      </header>

      {/* ── 메인 컨텐츠 ── */}
      <div className="flex-1 flex flex-col px-6 py-5 gap-4">

        {/* ── 탭 ── */}
        <div className="flex items-center">
          <div className="flex items-center gap-1 border-b border-gray-200">
            <button onClick={() => handleTabChange("active")}
              className={`flex items-center gap-2 px-4 h-10 body-md font-semibold transition-all border-b-2 -mb-px ${
                tab === "active" ? "border-brand text-brand" : "border-transparent text-muted-foreground hover:text-gray-800"
              }`}>
              진행 중
              <span className={`body-sm px-2 py-0.5 rounded-full font-bold transition-colors ${
                tab === "active" ? "bg-brand text-white" : "bg-gray-100 text-muted-foreground"
              }`}>{activeCount}</span>
            </button>
            <button onClick={() => handleTabChange("archived")}
              className={`flex items-center gap-2 px-4 h-10 body-md font-semibold transition-all border-b-2 -mb-px ${
                tab === "archived" ? "border-brand text-brand" : "border-transparent text-muted-foreground hover:text-gray-800"
              }`}>
              아카이브
              <span className={`body-sm px-2 py-0.5 rounded-full font-bold transition-colors ${
                tab === "archived" ? "bg-gray-600 text-white" : "bg-gray-100 text-muted-foreground"
              }`}>{archiveCount}</span>
            </button>
          </div>
        </div>

        {/* ── 테이블 컨테이너 ── */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">

          {/* 테이블 헤더 바 */}
          <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between gap-3">
            <div>
              <div className="flex items-center gap-2">
                <h2 className="font-semibold text-gray-900 text-sm">
                  {tab === "active" ? "진행 중 발주 목록" : "아카이브 발주 목록"}
                </h2>
                {tab === "archived" && (
                  <span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full font-medium">완료 처리된 현장</span>
                )}
              </div>
              <p className="text-xs text-gray-400 mt-1">
                총 <span className="font-medium text-gray-700">{filtered.length}</span>건
                {filtered.length !== tabData.length && ` (전체 ${tabData.length}건 중 필터)`}
                &nbsp;·&nbsp;행 클릭 시 상세 페이지로 이동해요
              </p>
            </div>
          </div>

          {/* 필터 바 */}
          <div className="flex flex-wrap items-center gap-3 px-4 py-3 bg-white border-b border-gray-200">
            <div className="relative">
              <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z" />
              </svg>
              <input type="text" placeholder="고객명 / 상담ID / 주소 검색…"
                value={search} onChange={e => setSearch(e.target.value)}
                className="pl-9 pr-4 h-9 text-sm border border-gray-200 rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent bg-white"
              />
            </div>
            <div className="ml-auto flex items-center gap-4 text-xs text-gray-500">
              <span className="flex items-center gap-1"><span className="inline-block w-2 h-2 rounded-full bg-red-500"></span>일정 임박 (D-2 이내)</span>
              <span className="flex items-center gap-1"><span className="inline-block w-2 h-2 bg-emerald-100 border border-emerald-300 rounded-full"></span>확정/완료</span>
            </div>
          </div>

          {/* ── 액션 바 (체크 선택 시) ── */}
          {selectedIds.length > 0 && (
            <div className="flex items-center justify-between px-4 py-2 bg-brand-weak border-b border-brand/20">
              <div className="flex items-center gap-3">
                <span className="text-xs font-semibold text-brand">
                  {selectedIds.length}건 선택됨
                </span>
                {tab === "active" && (
                  <button onClick={handleArchiveAction}
                    className="flex items-center gap-1 text-xs font-semibold text-white bg-gray-700 hover:bg-gray-800 px-3 h-7 rounded-lg transition-colors">
                    아카이브
                  </button>
                )}
                {tab === "archived" && (
                  <button onClick={handleRestoreAction}
                    className="flex items-center gap-1 text-xs font-semibold text-white bg-brand hover:bg-[#0090e6] px-3 h-7 rounded-lg transition-colors">
                    복원
                  </button>
                )}
              </div>
              <button onClick={() => setSelectedIds([])} className="text-xs text-gray-500 hover:text-gray-700 font-medium">
                선택 해제
              </button>
            </div>
          )}

          {/* ── 테이블 ── */}
          <div className="overflow-x-auto flex-1">
            <table className="w-full border-collapse text-sm" style={{ minWidth: "800px" }}>
              <thead className="sticky top-0 z-10">
                <tr className="border-b border-gray-200">
                  {colGroups.map((g, i) => (
                    <th key={i} colSpan={g.span}
                      className={`${g.cls} text-gray-500 text-center py-2 body-sm font-semibold tracking-wider uppercase ${i < colGroups.length - 1 ? "border-r border-gray-200" : ""}`}>
                      {g.label}
                    </th>
                  ))}
                </tr>
                <tr className="bg-gray-50 text-gray-600 body-sm border-b border-gray-200">
                  {cols.map((col, i) => (
                    <th key={i}
                      className={`${col.w} py-2.5 px-3 text-center font-semibold whitespace-pre-line ${i < cols.length - 1 ? "border-r border-gray-200" : ""}`}>
                      {i === 0 ? (
                        <div className="flex items-center justify-center">
                          <input ref={headerCbRef} type="checkbox" className="cb-custom"
                            checked={allSelected} onChange={e => handleToggleAll(e.target.checked)}
                            onClick={e => e.stopPropagation()} />
                        </div>
                      ) : col.label}
                    </th>
                  ))}
                </tr>
              </thead>

              <tbody>
                {filtered.length === 0 && (
                  <tr>
                    <td colSpan={6} className="py-20 text-center text-gray-400 bg-white">
                      <div className="flex flex-col items-center gap-2">
                        <svg className="w-10 h-10 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0H4"/>
                        </svg>
                        <span className="text-sm">데이터가 없어요.</span>
                      </div>
                    </td>
                  </tr>
                )}
                {filtered.map((c, idx) => {
                  const isSelected = selectedIds.includes(c.id);
                  const isHovered  = hoveredRow === c.id;
                  const base  = idx % 2 === 0 ? "bg-white" : "bg-gray-50/70";
                  const rowBg = isSelected ? "bg-brand-weak" : isHovered ? "bg-brand-weak/50" : base;
                  const supplierStatus = computeSupplierStatus(c);

                  return (
                    <tr key={c.id}
                      className={`${rowBg} cursor-pointer border-b border-gray-200 transition-colors duration-75 group`}
                      onMouseEnter={() => setHoveredRow(c.id)}
                      onMouseLeave={() => setHoveredRow(null)}
                      onClick={() => onSelect(c.id)}>

                      <td className="px-3 py-3 text-center border-r border-gray-200" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-center">
                          <input type="checkbox" className="cb-custom" checked={isSelected}
                            onChange={() => handleToggleSelect(c.id)} />
                        </div>
                      </td>

                      <td className="px-3 py-2 text-center border-r border-gray-200">
                        <span className="font-mono text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded">{c.id}</span>
                      </td>

                      <td className="px-3 py-2 text-center font-medium text-gray-900 border-r border-gray-200 whitespace-nowrap">
                        {c.customer || "-"}
                      </td>

                      <td className="px-3 py-2 text-gray-600 border-r border-gray-200 text-xs leading-relaxed break-words" title={c.address}>
                        {c.address || "-"}
                      </td>

                      <td className="px-3 py-2 text-center border-r border-gray-200 border-l-2 border-l-brand/20 text-xs">
                        <DateCell dateStr={c.gigiOrderData?.requestedDate} />
                      </td>

                      <td className="px-3 py-2 text-center border-l-2 border-l-gray-300">
                        <StatusBadge text={supplierStatus} />
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* ── 취소된 현장 ── */}
      {tab === "active" && cancelledCases.length > 0 && (
        <div className="px-6 pb-4">
          <div className="flex items-center gap-3 my-4">
            <div className="h-px flex-1 bg-red-100"></div>
            <span className="text-xs font-semibold text-red-400 flex items-center gap-1">
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636l-12.728 12.728M5.636 5.636l12.728 12.728" /></svg>
              취소된 현장 {cancelledCases.length}건
            </span>
            <div className="h-px flex-1 bg-red-100"></div>
          </div>
          <div className="space-y-2">
            {cancelledCases.map(c => {
              const sStatus = computeSupplierStatus(c);
              return (
                <div key={c.id} className="bg-gray-50 rounded-2xl border border-gray-200 overflow-hidden opacity-60 px-4 py-3">
                  <div className="flex items-center justify-between gap-3">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="text-xs font-mono font-semibold text-gray-400">{c.id}</span>
                        <span className="text-xs font-semibold px-2 py-0.5 rounded-full border bg-red-50 text-red-400 border-red-200">취소됨</span>
                      </div>
                      <p className="text-sm font-bold text-gray-500 line-through">{c.customer} 고객</p>
                      <p className="text-xs text-gray-400 truncate mt-0.5">{c.address}</p>
                    </div>
                    <div className="text-right flex-shrink-0">
                      <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${getSupplierStatusStyle(sStatus)}`}>{sStatus}</span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* ── 푸터 ── */}
      <footer className="px-6 py-3 bg-gray-50 border-t border-gray-200 flex-shrink-0">
        <p className="text-xs text-gray-400 text-center">
          마지막 업데이트: {TODAY_STR} &nbsp;|&nbsp; 행 클릭 시 상세 페이지로 이동 · 상태 뱃지는 자동 계산
        </p>
      </footer>
    </div>
  );
}

/* ═══════════════════════════════════════
   RejectModal
═══════════════════════════════════════ */
function RejectModal({ caseData, onConfirm, onCancel }) {
  const [reason, setReason] = useState('');
  const reasonRef = useRef(null);
  useEffect(() => { reasonRef.current?.focus(); }, []);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" onClick={onCancel}>
      <div className="modal-box bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e => e.stopPropagation()}>
        <div className="flex items-center gap-3 px-6 py-5 border-b border-gray-100">
          <div className="w-9 h-9 rounded-full bg-red-100 flex items-center justify-center">
            <svg className="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"/></svg>
          </div>
          <div>
            <h2 className="text-base font-bold text-gray-900">발주 반려</h2>
            <p className="text-xs text-gray-500 mt-0.5">{caseData.customer} 고객 · {caseData.id}</p>
          </div>
        </div>
        <div className="px-6 py-4 space-y-4">
          <div>
            <label className="block text-xs font-semibold text-gray-700 mb-1.5">반려 사유 <span className="text-red-500">*</span></label>
            <textarea ref={reasonRef} value={reason} onChange={e => setReason(e.target.value)} rows={4}
              placeholder="예) 해당 모델 생산 단종, 재고 소진으로 납기 불가, 대체 모델 제안 예정 등"
              className="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent placeholder-gray-300 leading-relaxed"
            />
          </div>
        </div>
        <div className="flex gap-2.5 px-6 pb-5">
          <button onClick={onCancel} className="flex-1 py-2.5 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-gray-50">취소</button>
          <button onClick={() => reason.trim() && onConfirm(reason.trim())}
            disabled={!reason.trim()}
            className="flex-1 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 disabled:bg-gray-200 disabled:text-gray-400 text-white text-sm font-semibold">
            반려 확정
          </button>
        </div>
      </div>
    </div>
  );
}

/* ═══════════════════════════════════════
   DetailPage — 발주 상세 (기존 DetailView 유지)
═══════════════════════════════════════ */
function DetailPage({ caseData, onBack, onApprove, onReject, onToast }) {
  const order = caseData.gigiOrderData;
  const step  = getGigiStep(caseData.status?.gigi);
  const [showRejectModal, setShowRejectModal] = useState(false);

  const isApproved = order?.status === "발주확정";
  const isRejected = order?.status === "발주요청반려";
  const isPending  = order?.status === "발주요청완료";

  const itemLabel = (item) => {
    if (item.mode === "custom" && item.custom) return `[직접입력] ${item.custom}`;
    return item.value;
  };

  return (
    <div className="min-h-screen bg-[#F9FAFB] flex flex-col">

      {/* ── 헤더 ── */}
      <header className="bg-white text-gray-900 px-6 h-14 flex items-center justify-between border-b border-gray-200 flex-shrink-0">
        <div className="flex items-center gap-3">
          <button onClick={onBack}
            className="flex items-center gap-1.5 text-sm font-semibold text-gray-600 hover:text-brand transition-colors">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
            목록으로
          </button>
          <div className="w-px h-6 bg-gray-200"></div>
          <div className="w-8 h-8 bg-gray-900 rounded-xl flex items-center justify-center">
            <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18"/>
            </svg>
          </div>
          <div>
            <h1 className="heading-sm text-gray-900">기기 업체 포털</h1>
            <p className="body-xs text-muted-foreground">발주 상세 · {caseData.id}</p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <div className="body-sm text-muted-foreground hidden sm:block">
            오늘 <span className="text-gray-900 font-semibold">{TODAY_STR}</span>
          </div>
        </div>
      </header>

      {/* 컨텐츠 */}
      <div className="flex-1 overflow-y-auto">
        {/* 현장 헤더 */}
        <div className="bg-white border-b border-gray-200 px-6 py-4">
          <div className="flex items-start justify-between gap-4 max-w-3xl mx-auto">
            <div>
              <div className="flex items-center gap-2 mb-1.5">
                <span className="body-sm font-mono text-muted-foreground">{caseData.id}</span>
                <span className={`body-sm font-bold px-2 py-0.5 rounded-full border ${getCaseBadgeCls(caseData.status?.gigi)}`}>
                  {caseData.status?.gigi || '-'}
                </span>
              </div>
              <h2 className="heading-md text-gray-900 leading-snug">{caseData.customer} 고객 현장</h2>
              <p className="body-md text-muted-foreground mt-0.5 leading-snug">{caseData.address}</p>
            </div>
            <div className="text-right flex-shrink-0">
              <p className="body-xs text-muted-foreground uppercase tracking-wide">희망 납기</p>
              <p className="body-md font-bold text-gray-900">{order?.requestedDate || '-'}</p>
              <p className="body-xs text-muted-foreground uppercase tracking-wide mt-2">담당자</p>
              <p className="body-md font-semibold text-gray-700">{caseData.manager}</p>
            </div>
          </div>
        </div>

        {/* 스테퍼 */}
        <div className="bg-white border-b border-gray-200 px-6 py-4">
          <div className="max-w-3xl mx-auto">
            <Stepper step={step} />
          </div>
        </div>

        {/* 상세 내용 */}
        <div className="max-w-3xl mx-auto px-6 py-6 space-y-5">

          {/* 발주 내역 */}
          <div>
            <h3 className="text-sm font-black text-gray-900 flex items-center gap-2 mb-4">
              <span className="w-1.5 h-4 bg-violet-500 rounded-full inline-block"></span>
              발주 내역
              {order?.items && (
                <span className="ml-1 bg-violet-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">{order.items.length}건</span>
              )}
            </h3>

            {!order?.items || order.items.length === 0 ? (
              <div className="bg-gray-50 border border-dashed border-gray-200 rounded-2xl flex flex-col items-center justify-center py-12 gap-3">
                <svg className="w-8 h-8 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18"/>
                </svg>
                <p className="text-sm text-gray-400 font-medium">발주 내역이 없습니다</p>
              </div>
            ) : (
              <div className="space-y-2">
                {order.items.map((item, idx) => (
                  <div key={idx} className="bg-white border border-gray-200 rounded-2xl p-4 anim-in">
                    <div className="flex items-start justify-between gap-3">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1.5">
                          <span className="text-xs font-bold text-gray-500 bg-gray-100 border border-gray-200 px-2 py-0.5 rounded-full">
                            {item.category}
                          </span>
                          {item.mode === "custom" && (
                            <span className="text-[10px] font-bold bg-purple-100 text-purple-700 border border-purple-200 px-1.5 py-0.5 rounded-full">직접입력</span>
                          )}
                        </div>
                        <p className="text-sm font-bold text-gray-900">{itemLabel(item)}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* 납기 일정 정보 */}
          <div className="bg-white border border-gray-200 rounded-2xl p-5">
            <div className="flex items-center gap-3 mb-3">
              <div className="w-8 h-8 rounded-xl bg-brand-weak flex items-center justify-center">
                <svg className="w-4 h-4 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
              <div>
                <p className="text-sm font-bold text-gray-800">희망 납기 일정</p>
                <p className="text-xs text-gray-400 mt-0.5">본사에서 요청한 기기 납기 일정입니다</p>
              </div>
              <span className="ml-auto text-lg font-black text-brand">{order?.requestedDate || '-'}</span>
            </div>
            {order?.submittedAt && (
              <p className="text-xs text-gray-400">발주 요청 시각: {new Date(order.submittedAt).toLocaleString("ko-KR")}</p>
            )}
          </div>

          {/* 승인/반려 상태 표시 */}
          {isApproved && (
            <div className="flex items-center gap-3 bg-emerald-50 border-2 border-emerald-200 rounded-xl px-5 py-4">
              <div className="w-10 h-10 rounded-xl bg-emerald-500 flex items-center justify-center flex-shrink-0">
                <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <p className="text-sm font-bold text-emerald-800">발주 승인 완료</p>
                <p className="text-xs text-emerald-600 mt-0.5">납기 일정이 확정되었습니다.</p>
              </div>
            </div>
          )}

          {isRejected && (
            <div className="bg-red-50 border-2 border-red-200 rounded-xl px-5 py-4 space-y-2">
              <div className="flex items-center gap-2">
                <svg className="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>
                <p className="text-sm font-bold text-red-700">반려 처리됨</p>
              </div>
              <div className="bg-white/80 rounded-lg px-4 py-3 border border-red-100">
                <p className="text-xs font-semibold text-red-600 mb-1">반려 사유</p>
                <p className="text-sm text-gray-700">{order?.rejectionReason}</p>
              </div>
              <p className="text-xs text-red-500">본사에서 수정 후 재발주 요청할 예정입니다.</p>
            </div>
          )}

          {/* 승인/반려 액션 버튼 */}
          {isPending && (
            <div className="flex gap-3">
              <button
                onClick={() => {
                  onApprove(caseData.id);
                  onToast({ type: 'success', title: '발주 승인 완료', message: `${caseData.customer} 고객 현장의 기기 발주가 승인되었습니다.`, duration: 5000 });
                }}
                className="flex-1 flex items-center justify-center gap-2 py-3.5 rounded-2xl text-sm font-bold
                           bg-emerald-600 hover:bg-emerald-700 text-white shadow-sm shadow-emerald-200
                           transition-all hover:-translate-y-0.5 btn-press"
              >
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                발주 승인
              </button>
              <button
                onClick={() => setShowRejectModal(true)}
                className="flex-1 flex items-center justify-center gap-2 py-3.5 rounded-2xl text-sm font-bold
                           bg-red-500 hover:bg-red-600 text-white shadow-sm shadow-red-200
                           transition-all hover:-translate-y-0.5 btn-press"
              >
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
                반려
              </button>
            </div>
          )}

          <div className="h-8" />
        </div>
      </div>

      {/* 반려 모달 */}
      {showRejectModal && (
        <RejectModal
          caseData={caseData}
          onConfirm={(reason) => {
            onReject(caseData.id, reason);
            setShowRejectModal(false);
            onToast({ type: 'warning', title: '발주 반려', message: `${caseData.customer} 고객 현장의 기기 발주가 반려되었습니다.` });
          }}
          onCancel={() => setShowRejectModal(false)}
        />
      )}
    </div>
  );
}

/* ═══════════════════════════════════════
   App — List ↔ Detail 전환
═══════════════════════════════════════ */
function App() {
  const [cases, setCases]     = useState([]);
  const [loading, setLoading] = useState(true);
  const [view, setView]       = useState("list"); // "list" | "detail"
  const [selectedId, setSelectedId] = useState(null);
  const { toasts, add: addToast, remove: removeToast } = useToast();

  const refresh = useCallback(async () => {
    try {
      const fromDb = await loadAllCasesFromDB();
      if (fromDb) {
        setCases(fromDb);
      }
    } catch (e) {
      console.warn("Refresh failed:", e);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => { refresh(); }, [refresh]);

  /* cross-tab 동기화 */
  useEffect(() => {
    const onVisible = () => { if (document.visibilityState === 'visible') refresh(); };
    document.addEventListener('visibilitychange', onVisible);
    return () => { document.removeEventListener('visibilitychange', onVisible); };
  }, [refresh]);

  const handleSelect = useCallback((id) => {
    setSelectedId(id);
    setView("detail");
  }, []);

  const handleBack = useCallback(() => {
    setView("list");
    refresh();
  }, [refresh]);

  const handleArchive = useCallback((ids) => {
    setCases(prev => prev.map(c => ids.includes(c.id) ? { ...c, archived: true } : c));
    ids.forEach(id => patchCaseInDB(id, { archived: true }));
  }, []);

  const handleRestore = useCallback((ids) => {
    setCases(prev => prev.map(c => ids.includes(c.id) ? { ...c, archived: false } : c));
    ids.forEach(id => patchCaseInDB(id, { archived: false }));
  }, []);

  const handleApprove = useCallback((caseId) => {
    setCases(prev => prev.map(c => {
      if (c.id !== caseId) return c;
      const updatedGigi = { ...c.gigiOrderData, status: "발주확정" };
      const finalDate = c.gigiOrderData?.requestedDate || "";
      // DB: cases 테이블 + gigi_store 동시 업데이트
      patchCaseInDB(caseId, {
        status: { ...c.status, gigi: "발주확정" },
        gigi_final_date: finalDate,
        schedule: { ...(c.schedule || {}), gigi: finalDate },
      });
      upsertGigiStore(caseId, updatedGigi);
      return {
        ...c,
        gigiOrderData: updatedGigi,
        status: { ...c.status, gigi: "발주확정" },
        gigiFinalDate: finalDate,
        schedule: { ...(c.schedule || {}), gigi: finalDate },
      };
    }));
  }, []);

  const handleReject = useCallback((caseId, reason) => {
    setCases(prev => prev.map(c => {
      if (c.id !== caseId) return c;
      const updatedGigi = {
        ...c.gigiOrderData,
        status: "발주요청반려",
        rejectionReason: reason,
        rejectedAt: new Date().toISOString(),
      };
      // DB: cases 테이블 + gigi_store 동시 업데이트
      patchCaseInDB(caseId, {
        status: { ...c.status, gigi: "발주요청반려" },
      });
      upsertGigiStore(caseId, updatedGigi);
      return {
        ...c,
        gigiOrderData: updatedGigi,
        status: { ...c.status, gigi: "발주요청반려" },
      };
    }));
  }, []);

  const selectedCase = cases.find(c => c.id === selectedId);

  return (
    <>
      {view === "list" ? (
        <ListPage
          cases={cases}
          onSelect={handleSelect}
          onArchive={handleArchive}
          onRestore={handleRestore}
          onToast={addToast}
        />
      ) : selectedCase ? (
        <DetailPage
          caseData={selectedCase}
          onBack={handleBack}
          onApprove={handleApprove}
          onReject={handleReject}
          onToast={addToast}
        />
      ) : (
        <ListPage
          cases={cases}
          onSelect={handleSelect}
          onArchive={handleArchive}
          onRestore={handleRestore}
          onToast={addToast}
        />
      )}
      <ToastContainer toasts={toasts} onRemove={removeToast} />
    </>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
