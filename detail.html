<!-- v2 -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í˜„ì¥ ìƒì„¸ - C-2026-001 | ì§ì‹œê³µ ë°œì£¼ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["'Pretendard Variable'", "Pretendard", "Inter", "sans-serif"],
          },
          colors: {
            brand: '#00A1FF',
            'brand-weak': '#F0F8FC',
            'genuine-blue': { 50:'#F0F8FC',100:'#D9EFFF',200:'#9ED7FF',300:'#5EBFFF',400:'#00A1FF',500:'#0A78C0',600:'#095890' },
            success: { DEFAULT:'#16a34a', weak:'#f0fdf4', foreground:'#15803d' },
            warning: { DEFAULT:'#fbbf24', weak:'#fffbeb', foreground:'#b45309' },
            destructive: { DEFAULT:'#dc2626', weak:'#fef2f2', foreground:'#fef2f2' },
            muted: { DEFAULT:'#f3f4f6', foreground:'#6b7280' },
            accent: { DEFAULT:'#f3f4f6', foreground:'#111827' },
          },
          borderRadius: { '2xl':'1rem', '3xl':'1.25rem' },
          animation: {
            'slide-in-right': 'slideInRight 0.3s ease-out',
            'fade-out': 'fadeOut 0.4s ease-in forwards',
            'toast-in': 'toastIn 0.35s cubic-bezier(0.21, 1.02, 0.73, 1) forwards',
            'toast-out': 'toastOut 0.25s ease-in forwards',
          },
          keyframes: {
            slideInRight: {
              '0%': { transform: 'translateX(20px)', opacity: '0' },
              '100%': { transform: 'translateX(0)', opacity: '1' },
            },
            toastIn: {
              '0%': { transform: 'translateY(100%) scale(0.9)', opacity: '0' },
              '100%': { transform: 'translateY(0) scale(1)', opacity: '1' },
            },
            toastOut: {
              '0%': { transform: 'translateY(0) scale(1)', opacity: '1' },
              '100%': { transform: 'translateY(20px) scale(0.95)', opacity: '0' },
            },
          },
        },
      },
    };
  </script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: 'Pretendard Variable', 'Pretendard', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; letter-spacing: -0.3px; word-break: keep-all; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #F9FAFB; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

    /* Typography */
    .body-xs  { font-size: 0.625rem; line-height: 1.375; font-weight: 400; }
    .body-sm  { font-size: 0.75rem;  line-height: 1.375; font-weight: 400; }
    .body-md  { font-size: 0.875rem; line-height: 1.375; font-weight: 400; }
    .body-lg  { font-size: 1rem;     line-height: 1.375; font-weight: 400; }
    .heading-xs { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-sm { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-md { font-size: 1.125rem; line-height: 1.25; font-weight: 600; }
    .heading-lg { font-size: 1.25rem;  line-height: 1.25; font-weight: 600; }

    .tab-active {
      border-bottom: 2px solid #00A1FF;
      color: #00A1FF;
      font-weight: 600;
    }
    .tab-inactive {
      border-bottom: 2px solid transparent;
      color: #6B7280;
    }
    .tab-inactive:hover {
      color: #374151;
      border-bottom-color: #E5E7EB;
    }

    /* ping-pong ì—°ê²°ì„  */
    .flow-arrow::before {
      content: '';
      display: block;
      width: 2px;
      background: linear-gradient(to bottom, #E5E7EB, #F0F8FC);
      height: 24px;
      margin: 0 auto;
    }

    /* ì´ë¯¸ì§€ ì¸ë„¤ì¼ í˜¸ë²„ */
    .thumb-wrap:hover .thumb-overlay {
      opacity: 1;
    }

    /* í† ìŠ¤íŠ¸ */
    @keyframes toastIn {
      0% { transform: translateY(100%) scale(0.9); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    @keyframes toastOut {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(20px) scale(0.95); opacity: 0; }
    }
    .toast-enter { animation: toastIn 0.35s cubic-bezier(0.21,1.02,0.73,1) forwards; }
    .toast-exit { animation: toastOut 0.25s ease-in forwards; }

    /* í™•ì • ë²„íŠ¼ shimmer */
    @keyframes shimmer {
      0% { background-position: -400px 0; }
      100% { background-position: 400px 0; }
    }
    .btn-confirm-done {
      background: linear-gradient(90deg, #059669 25%, #10b981 50%, #059669 75%);
      background-size: 400px 100%;
      animation: shimmer 2.5s infinite linear;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col overflow-hidden" style="height:100vh;">
<div id="root" class="flex flex-col h-full"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

/* â”€â”€ localStorage ìœ í‹¸ â”€â”€ */
const LS_KEY = 'JIKSIGONG_DATA';
function loadAllItems() {
  try { const r = localStorage.getItem(LS_KEY); return r ? JSON.parse(r) : null; } catch(e) { return null; }
}
function loadItemById(id) {
  const items = loadAllItems();
  return items ? (items.find(i => i.id === id) || null) : null;
}
function persistItem(updated) {
  const items = loadAllItems() || [];
  const idx = items.findIndex(i => i.id === updated.id);
  if (idx >= 0) items[idx] = updated; else items.push(updated);
  try { localStorage.setItem(LS_KEY, JSON.stringify(items)); } catch(e) {}
}
function getCaseId() {
  // sessionStorage ìš°ì„ , ì—†ìœ¼ë©´ URL query param í´ë°± (ì§ì ‘ URL ì ‘ê·¼ ì‹œ)
  try {
    const fromSession = sessionStorage.getItem('CURRENT_CASE_ID');
    if (fromSession) return fromSession;
    return new URLSearchParams(window.location.search).get('id');
  } catch(e) { return null; }
}
function isNewCaseMode() {
  try { return new URLSearchParams(window.location.search).get('new') === '1'; } catch(e) { return false; }
}


const MANAGERS = ["ê¹€ë¯¼ì¤€", "ì´ì„œì—°", "ë°•í˜„ìš°", "ì •ìœ ë‚˜", "í•œì†Œí¬"];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ToastContainer({ toasts, onRemove }) {
  return (
    <div className="fixed bottom-6 right-6 z-50 flex flex-col gap-2 items-end pointer-events-none">
      {toasts.map(t => (
        <Toast key={t.id} toast={t} onRemove={onRemove} />
      ))}
    </div>
  );
}

function Toast({ toast, onRemove }) {
  const [exiting, setExiting] = useState(false);

  useEffect(() => {
    const timer = setTimeout(() => {
      setExiting(true);
      setTimeout(() => onRemove(toast.id), 280);
    }, toast.duration || 4000);
    return () => clearTimeout(timer);
  }, []);

  const iconMap = {
    success: (
      <svg className="w-5 h-5 text-emerald-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    info: (
      <svg className="w-5 h-5 text-brand flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    warning: (
      <svg className="w-5 h-5 text-amber-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
      </svg>
    ),
  };

  const borderMap = {
    success: "border-l-4 border-emerald-500",
    info: "border-l-4 border-brand",
    warning: "border-l-4 border-amber-500",
  };

  return (
    <div
      className={`
        pointer-events-auto
        ${exiting ? "toast-exit" : "toast-enter"}
        ${borderMap[toast.type] || borderMap.info}
        bg-white rounded-xl shadow px-4 py-3 flex items-start gap-3 min-w-[320px] max-w-sm
      `}
    >
      {iconMap[toast.type] || iconMap.info}
      <div className="flex-1 min-w-0">
        {toast.title && <p className="text-sm font-semibold text-gray-800">{toast.title}</p>}
        <p className="text-sm text-gray-600 mt-1">{toast.message}</p>
      </div>
      <button
        onClick={() => { setExiting(true); setTimeout(() => onRemove(toast.id), 280); }}
        className="text-gray-300 hover:text-gray-500 transition-colors flex-shrink-0 mt-1"
      >
        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  );
}

function useToast() {
  const [toasts, setToasts] = useState([]);
  const add = useCallback(({ type = "info", title, message, duration = 4000 }) => {
    const id = Date.now() + Math.random();
    setToasts(prev => [...prev, { id, type, title, message, duration }]);
  }, []);
  const remove = useCallback((id) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);
  return { toasts, add, remove };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEFT PANEL â€” ê¸°ë³¸ ì •ë³´ + ì¼ì • + ì§„í–‰ ìƒíƒœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SILCHEUK_STATUS_OPTS = ["ì‹¤ì¸¡ì˜ˆì •","ì‹¤ì¸¡ì¤‘","ì™„ë£Œ","ë°˜ë ¤"];
const MOKDAE_STATUS_OPTS   = ["ë°œì£¼ìš”ì²­ëŒ€ê¸°","CADë„ë©´ê²€í† ì¤‘","ë°œì£¼ìš”ì²­ì™„ë£Œ","ë°œì£¼í™•ì •","ì œì‘ì§„í–‰","ë°œì£¼ìš”ì²­ë°˜ë ¤","ì¬ë§ˆê°í™•ì •","í™•ì •í›„ì¡°ì •(ê¸´ê¸‰)","CADìˆ˜ì •ìš”ì²­"];
const GIGI_STATUS_OPTS     = ["ë°œì£¼ìš”ì²­ëŒ€ê¸°","ë°œì£¼ìš”ì²­ì™„ë£Œ","ë°œì£¼í™•ì •","ë°œì£¼ìš”ì²­ë°˜ë ¤","ì¬ë§ˆê°í™•ì •","í™•ì •í›„ì¡°ì •(ê¸´ê¸‰)"];
const SANGPAN_STATUS_OPTS  = ["ë°œì£¼ìš”ì²­ëŒ€ê¸°","ìƒíŒë„ë©´ê²€í† ì¤‘","ë°œì£¼ìš”ì²­ì™„ë£Œ","ë°œì£¼í™•ì •","ë°œì£¼ìš”ì²­ë°˜ë ¤","ì¬ë§ˆê°í™•ì •","ìƒíŒë„ë©´ìˆ˜ì •ìš”ì²­"];

function LeftPanel({ data, onSave, isNew, silcheukFinalDate, mokdaeFinalDate, gigiFinalDate }) {
  const [form, setForm] = useState({
    id:       data.id || "",
    manager:  data.manager || "",
    customer: data.customer || "",
    phone:    data.phone || "",
    address:  data.address || "",
    archived: data.archived || false,
    schedule: {
      silcheuk: (data.schedule && data.schedule.silcheuk) || "",
      mokdae:   (data.schedule && data.schedule.mokdae)   || "",
      gigi:     (data.schedule && data.schedule.gigi)     || "",
      sangpan:  (data.schedule && data.schedule.sangpan)  || "",
    },
    status: {
      silcheuk: (data.status && data.status.silcheuk) || "",
      mokdae:   (data.status && data.status.mokdae)   || "",
      gigi:     (data.status && data.status.gigi)     || "",
      sangpan:  (data.status && data.status.sangpan)  || "",
    },
  });
  const [saved, setSaved] = useState(false);

  /* data propì´ ì™¸ë¶€ì—ì„œ ë°”ë€Œë©´ formë„ ë™ê¸°í™” (status, schedule í¬í•¨) */
  useEffect(() => {
    setForm(prev => ({
      ...prev,
      id:       data.id || "",
      manager:  data.manager || "",
      customer: data.customer || "",
      phone:    data.phone || "",
      address:  data.address || "",
      archived: data.archived || false,
      schedule: {
        silcheuk: (data.schedule && data.schedule.silcheuk) || "",
        mokdae:   (data.schedule && data.schedule.mokdae)   || "",
        gigi:     (data.schedule && data.schedule.gigi)     || "",
        sangpan:  (data.schedule && data.schedule.sangpan)  || "",
      },
      status: {
        silcheuk: (data.status && data.status.silcheuk) || "",
        mokdae:   (data.status && data.status.mokdae)   || "",
        gigi:     (data.status && data.status.gigi)     || "",
        sangpan:  (data.status && data.status.sangpan)  || "",
      },
    }));
  }, [data.id, data.status?.mokdae, data.status?.gigi, data.status?.sangpan, data.status?.silcheuk, data.schedule?.mokdae, data.schedule?.gigi, data.schedule?.sangpan, data.schedule?.silcheuk]);

  /* ì‹¤ì¸¡ íƒ­ ì „ë‹¬ ì™„ë£Œ ì‹œ silcheukFinalDateê°€ ì±„ì›Œì§€ë©´ formì— ìë™ ë°˜ì˜ */
  useEffect(() => {
    if (silcheukFinalDate) {
      setForm(prev => ({ ...prev, schedule: { ...prev.schedule, silcheuk: silcheukFinalDate } }));
    }
  }, [silcheukFinalDate]);

  /* ëª©ëŒ€ ë°œì£¼ì„œ ê³µì¥ ìŠ¹ì¸ ì‹œ mokdaeFinalDateê°€ ì±„ì›Œì§€ë©´ formì— ìë™ ë°˜ì˜ */
  useEffect(() => {
    setForm(prev => ({ ...prev, schedule: { ...prev.schedule, mokdae: mokdaeFinalDate || "" } }));
  }, [mokdaeFinalDate]);

  /* ê¸°ê¸° íƒ­ì—ì„œ ì¼ì • í™•ì • ì‹œ gigiFinalDateê°€ ì±„ì›Œì§€ë©´ formì— ìë™ ë°˜ì˜ */
  useEffect(() => {
    setForm(prev => ({ ...prev, schedule: { ...prev.schedule, gigi: gigiFinalDate || "" } }));
  }, [gigiFinalDate]);

  const handleChange   = (k, v)  => { setForm(prev => ({ ...prev, [k]: v })); setSaved(false); };
  const handleSchedule = (k, v)  => { setForm(prev => ({ ...prev, schedule: { ...prev.schedule, [k]: v } })); setSaved(false); };
  const handleStatus   = (k, v)  => { setForm(prev => ({ ...prev, status:   { ...prev.status,   [k]: v } })); setSaved(false); };

  /* ë‚ ì§œ ì…ë ¥ ì œí•œ: ì˜¤ëŠ˜ ì´ì „ ë¶ˆê°€ + ê¸°ê¸°/ìƒíŒì€ ì‹¤ì¸¡ ì¼ì • ì´í›„ë§Œ ê°€ëŠ¥ */
  const today = new Date().toISOString().slice(0, 10);
  const minScheduleDate = silcheukFinalDate && silcheukFinalDate > today ? silcheukFinalDate : today;

  /* ì‹ ê·œ í˜„ì¥ ëª¨ë“œ: 5ê°œ í•„ìˆ˜ í•­ëª©ì´ ëª¨ë‘ ì…ë ¥ë˜ì–´ì•¼ ì €ì¥ ê°€ëŠ¥ */
  const requiredFilled = !isNew || (
    form.id.trim() && form.manager.trim() && form.customer.trim() &&
    form.phone.trim() && form.address.trim()
  );

  const handleSave = () => {
    const ok = onSave(form);
    if (ok !== false) {
      setSaved(true);
      setTimeout(() => setSaved(false), 2500);
    }
  };

  return (
    <aside className="w-[30%] min-w-[280px] bg-white border-r border-gray-200 flex flex-col h-full overflow-hidden">
      {/* íŒ¨ë„ í—¤ë” */}
      <div className="px-5 py-4 border-b border-gray-100 flex-shrink-0">
        <div className="flex items-center gap-2 mb-1">
          <span className="w-1.5 h-5 rounded-full bg-brand inline-block"></span>
          <h2 className="text-sm font-bold text-gray-800">ê¸°ë³¸ ì •ë³´</h2>
        </div>
        {isNew
          ? <p className="text-xs text-orange-500 pl-3.5 font-medium">í•„ìˆ˜ í•­ëª©(*)ì„ ëª¨ë‘ ì…ë ¥í•œ í›„ ì €ì¥í•˜ì„¸ìš”.</p>
          : <p className="text-xs text-gray-400 pl-3.5">ìˆ˜ì • í›„ í•˜ë‹¨ [ì €ì¥] ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
        }
      </div>

      {/* í¼ ì˜ì—­ */}
      <div className="flex-1 overflow-y-auto px-5 py-5 space-y-5">

        {/* ì·¨ì†Œëœ í˜„ì¥ ë°°ë„ˆ */}
        {data.cancelled && (
          <div className="flex items-start gap-3 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
            <svg className="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
            <div>
              <p className="text-sm font-bold text-red-700">ì·¨ì†Œëœ í˜„ì¥</p>
              <p className="text-xs text-red-500 mt-0.5">ì´ í˜„ì¥ì€ ì‚­ì œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê³µê¸‰ì—…ì²´Â·ê¸°ì‚¬ í™”ë©´ì—ì„œ ì·¨ì†Œëœ ìš”ì²­ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
          </div>
        )}

        {/* ìƒë‹´ ID */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            ìƒë‹´ ID {isNew && <span className="text-red-500">*</span>}
          </label>
          <input
            type="text"
            value={form.id}
            onChange={e => handleChange("id", e.target.value)}
            className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg font-mono
                       focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                       text-gray-800 transition-shadow"
            placeholder="C-2026-001"
          />
        </div>

        {/* ì˜ì—… ë‹´ë‹¹ì */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            ì˜ì—… ë‹´ë‹¹ì <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <select
              value={form.manager}
              onChange={e => handleChange("manager", e.target.value)}
              className="w-full appearance-none px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                         text-gray-800 cursor-pointer transition-shadow"
            >
              <option value="">ë‹´ë‹¹ì ì„ íƒ</option>
              {MANAGERS.map(m => <option key={m} value={m}>{m}</option>)}
            </select>
            <svg className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>

        {/* ê³ ê°ëª… */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            ê³ ê°ëª… <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <input
              type="text"
              value={form.customer}
              onChange={e => handleChange("customer", e.target.value)}
              className="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                         text-gray-800 transition-shadow"
            />
          </div>
        </div>

        {/* ê³ ê° ì „í™”ë²ˆí˜¸ */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            ê³ ê° ì „í™”ë²ˆí˜¸ {isNew && <span className="text-red-500">*</span>}
          </label>
          <div className="relative">
            <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            <input
              type="tel"
              value={form.phone}
              onChange={e => handleChange("phone", e.target.value)}
              className="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                         text-gray-800 font-mono transition-shadow"
            />
          </div>
        </div>

        {/* í˜„ì¥ ì£¼ì†Œ */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            í˜„ì¥ ì£¼ì†Œ {isNew && <span className="text-red-500">*</span>}
          </label>
          <div className="relative">
            <svg className="absolute left-3 top-3 w-4 h-4 text-gray-400"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <textarea
              value={form.address}
              onChange={e => handleChange("address", e.target.value)}
              rows={3}
              className="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                         text-gray-800 resize-none leading-relaxed transition-shadow"
            />
          </div>
        </div>

        {/* ê³µì • ì¼ì • */}
        <div className="bg-gray-50 rounded-xl p-4 border border-gray-200 space-y-3">
          <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide flex items-center gap-1.5">
            <svg className="w-3.5 h-3.5 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            ê³µì • ì¼ì •
          </p>

          {/* ì‹¤ì¸¡ ì¼ì •: ì‹¤ì¸¡ íƒ­ ìµœì¢… í™•ì • ì¼ì • ìë™ ë°˜ì˜ (read-only, ë°ì´í„° ê¸°ë°˜ í‘œì‹œ) */}
          <div className="flex items-center gap-3">
            <span className="text-xs text-gray-500 font-semibold w-8 flex-shrink-0">ì‹¤ì¸¡</span>
            {!silcheukFinalDate ? (
              <div className="flex-1 flex items-center gap-2 px-2 py-1.5 bg-gray-100 border border-gray-100 rounded-lg">
                <svg className="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span className="text-xs text-gray-400">ì‹¤ì¸¡ íƒ­ ì „ë‹¬ ì™„ë£Œ í›„ ìë™ ì…ë ¥</span>
              </div>
            ) : (
              <input
                type="date"
                value={form.schedule.silcheuk}
                disabled
                className="flex-1 px-2 py-1.5 text-xs border border-gray-100 rounded-lg bg-gray-50 text-gray-500 cursor-default"
              />
            )}
          </div>

          {/* ëª©ëŒ€ ì¼ì •: ë°œì£¼ì„œ ê³µì¥ ìŠ¹ì¸ í›„ ìë™ ì…ë ¥ (read-only) */}
          <div className="flex items-center gap-3">
            <span className="text-xs text-gray-500 font-semibold w-8 flex-shrink-0">ëª©ëŒ€</span>
            {!mokdaeFinalDate ? (
              <div className="flex-1 flex items-center gap-2 px-2 py-1.5 bg-gray-100 border border-gray-100 rounded-lg">
                <svg className="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span className="text-xs text-gray-400">ë°œì£¼ì„œ ê³µì¥ ìŠ¹ì¸ í›„ ìë™ ì…ë ¥</span>
              </div>
            ) : (
              <input
                type="date"
                value={form.schedule.mokdae}
                disabled
                className="flex-1 px-2 py-1.5 text-xs border border-gray-100 rounded-lg bg-gray-50 text-gray-500 cursor-default"
              />
            )}
          </div>

          {/* ê¸°ê¸° ì¼ì •: ê¸°ê¸°íƒ­ì—ì„œ í™•ì • â†’ read-only */}
          <div className="flex items-center gap-3">
            <span className="text-xs text-gray-500 font-semibold w-8 flex-shrink-0">ê¸°ê¸°</span>
            {gigiFinalDate ? (
              <input
                type="date"
                value={form.schedule.gigi}
                disabled
                className="flex-1 px-2 py-1.5 text-xs border border-gray-100 rounded-lg bg-gray-50 text-gray-500 cursor-default"
              />
            ) : (
              <span className="flex-1 text-xs text-gray-300 px-2 py-1.5">ê¸°ê¸° íƒ­ì—ì„œ ì¼ì •ì„ ì„ íƒí•˜ì„¸ìš”</span>
            )}
          </div>

          {/* ìƒíŒ ì¼ì •: ì˜¤ëŠ˜ ì´ì „ ë¶ˆê°€ + ì‹¤ì¸¡ ì¼ì • ì´í›„ë§Œ ê°€ëŠ¥ */}
          <div className="flex items-center gap-3">
            <span className="text-xs text-gray-500 font-semibold w-8 flex-shrink-0">ìƒíŒ</span>
            <input
              type="date"
              value={form.schedule.sangpan}
              min={minScheduleDate}
              onChange={e => handleSchedule("sangpan", e.target.value)}
              className="flex-1 px-2 py-1.5 text-xs border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand bg-white text-gray-700"
            />
          </div>
        </div>

      </div>

      {/* ì €ì¥ ë²„íŠ¼ */}
      <div className="px-5 py-4 border-t border-gray-100 flex-shrink-0">
        <button
          onClick={handleSave}
          disabled={!requiredFilled}
          className={`w-full py-2 rounded-xl text-sm font-semibold transition-all duration-200 flex items-center justify-center gap-2 ${
            !requiredFilled
              ? "bg-gray-200 text-gray-400 cursor-not-allowed"
              : saved
              ? "bg-emerald-500 text-white shadow-sm"
              : "bg-brand hover:bg-[#0090e6] text-white shadow-sm hover:shadow"
          }`}
        >
          {saved ? (
            <>
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
              ì €ì¥ ì™„ë£Œ â€” ëŒ€ì‹œë³´ë“œì— ë°˜ì˜ë¨
            </>
          ) : (
            <>
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
              ì €ì¥í•˜ê¸°
            </>
          )}
        </button>
      </div>
    </aside>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION A â€” ì‹¤ì¸¡ ì¼ì • (Ping-pong)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let nextId = 3;

function SectionSchedule({ data, onToast, onScheduleUnlock, onStatusChange, onProposalsSend, onFinalConfirm, resultDone }) {
  /* ë‚ ì§œ ì…ë ¥ ì œí•œ: ì˜¤ëŠ˜ ì´ì „ ë¶ˆê°€ */
  const today = new Date().toISOString().slice(0, 10);

  /* â”€â”€ Step 1: ê³ ê° í¬ë§ ì¼ì • â”€â”€ */
  const [proposals, setProposals] = useState(
    data.proposals && data.proposals.length > 0
      ? data.proposals
      : [{ id: 1, date: "", time: "10:00" }]
  );
  const [sent, setSent] = useState(data.sent || false);

  /* â”€â”€ Step 2: ê¸°ì‚¬ ì‘ë‹µ (engineer.htmlì—ì„œ localStorageë¡œ ìˆ˜ì‹ ) â”€â”€ */
  const engResponse = data.engResponse || null; // { type:"accepted"|"counter", date, time, counterProposals:[{date,time}] }

  /* â”€â”€ Step 3: ìµœì¢… í™•ì • â€” localStorageì—ì„œ ë³µì› (í˜ì´ì§€ ë¦¬ë¡œë“œ ì‹œ íœ˜ë°œ ë°©ì§€) â”€â”€ */
  const [finalStatus, setFinalStatus]               = useState(data.finalized ? "done" : "waiting");
  const [selectedScheduleKey, setSelectedScheduleKey] = useState(
    data.finalized && data.finalDate ? `${data.finalDate}|${data.finalTime}` : ""
  );

  /* scheduleOptions: ê¸°ì‚¬ ì‘ë‹µ ê¸°ë°˜ ì„ íƒ ê°€ëŠ¥ ì¼ì • */
  const scheduleOptions = (() => {
    if (!engResponse) return [];
    if (engResponse.type === "accepted") return [{ date: engResponse.date, time: engResponse.time }];
    if (engResponse.type === "counter") return (engResponse.counterProposals || [{ date: engResponse.date, time: engResponse.time }]).filter(p => p.date);
    return [];
  })();

  /* scheduleOptions ìƒì„±ë˜ë©´ ì²« í•­ëª© ìë™ ì„ íƒ */
  useEffect(() => {
    if (scheduleOptions.length > 0 && !selectedScheduleKey) {
      const opt = scheduleOptions[0];
      setSelectedScheduleKey(`${opt.date}|${opt.time}`);
    }
  }, [scheduleOptions.length]);

  /* â”€â”€ Step 1 í•¸ë“¤ëŸ¬ â”€â”€ */
  const addProposal    = () => setProposals(prev => [...prev, { id: Date.now(), date: "", time: "10:00" }]);
  const removeProposal = (id) => { setProposals(prev => prev.filter(p => p.id !== id)); setSent(false); };
  const updateProposal = (id, key, value) => {
    setProposals(prev => prev.map(p => p.id === id ? { ...p, [key]: value } : p));
    setSent(false);
  };
  const handleSend = () => {
    if (proposals.some(p => !p.date)) {
      onToast({ type: "warning", title: "ì…ë ¥ í™•ì¸ í•„ìš”", message: "ë‚ ì§œê°€ ë¹„ì–´ìˆëŠ” í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤." });
      return;
    }
    setSent(true);
    onProposalsSend && onProposalsSend(proposals, true);
    onToast({ type: "success", title: "ê¸°ì‚¬ ì „ë‹¬ ì™„ë£Œ", message: "ê³ ê° í¬ë§ ì¼ì •ì´ ê¸°ì‚¬ì—ê²Œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤." });
  };
  const handleReset = () => {
    const fresh = [{ id: 1, date: "", time: "10:00" }];
    setProposals(fresh);
    setSent(false);
    onProposalsSend && onProposalsSend(fresh, false);
    setFinalStatus("waiting");
    setSelectedScheduleKey("");
  };

  /* â”€â”€ Step 3 í•¸ë“¤ëŸ¬ â”€â”€ */
  const handleFinalStatusChange = (v) => {
    setFinalStatus(v);
    if (v === "done") {
      onScheduleUnlock && onScheduleUnlock();
      const [selDate, selTime] = (selectedScheduleKey || "").split("|");
      /* ìµœì¢… í™•ì • ì¼ì •ì„ App â†’ localStorage â†’ engineer.html ë¡œ ì „ë‹¬ */
      onFinalConfirm && onFinalConfirm(selDate || "", selTime || "");
      onToast({
        type: "success",
        title: "ê³ ê° ì „ë‹¬ ì™„ë£Œ",
        message: `${selDate || ""} ${selTime || ""} ì¼ì •ì´ ê³ ê°ê³¼ ê¸°ì‚¬ì—ê²Œ ë™ì‹œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        duration: 5000,
      });
    }
  };

  /* â”€â”€ ì‹¤ì¸¡ ìƒíƒœ ë±ƒì§€ â”€â”€ */
  /* resultDone(ê²€ìˆ˜ ì™„ë£Œ)ê°€ ìµœìš°ì„  â€” ë¦¬ë§ˆìš´íŠ¸ ì‹œ "ì‹¤ì¸¡ ì˜ˆì •"ì´ "ì™„ë£Œ"ë¥¼ ë®ì–´ì“°ëŠ” ë²„ê·¸ ë°©ì§€ */
  const scheduleStatus =
    resultDone                              ? "ì™„ë£Œ"
    : finalStatus === "done"               ? "ì‹¤ì¸¡ ì˜ˆì •"
    : (sent && proposals.length > 0)       ? "ì¼ì • ì¡°ìœ¨ì¤‘"
    : "ì‹¤ì¸¡ ìš”ì²­ ëŒ€ê¸°";
  const scheduleStatusStyle = {
    "ì‹¤ì¸¡ ìš”ì²­ ëŒ€ê¸°": "bg-gray-100 text-gray-500 border border-gray-200",
    "ì¼ì • ì¡°ìœ¨ì¤‘":    "bg-amber-100 text-amber-700 border border-amber-200",
    "ì‹¤ì¸¡ ì˜ˆì •":      "bg-brand-weak text-brand border border-brand/20",
    "ì™„ë£Œ":           "bg-emerald-100 text-emerald-700 border border-emerald-200",
  }[scheduleStatus] || "bg-gray-100 text-gray-500 border border-gray-200";

  /* ì‹¤ì¸¡ ìƒíƒœ ë³€ê²½ ì‹œ ë¶€ëª¨ì— ì•Œë¦¼ â†’ ëŒ€ì‹œë³´ë“œ ìë™ ì—°ë™ */
  useEffect(() => {
    onStatusChange && onStatusChange("silcheuk", scheduleStatus);
  }, [scheduleStatus]);

  return (
    <div className="space-y-4">
      {/* í—¤ë” */}
      <div className="flex items-center gap-2">
        <div className="w-1 h-5 rounded-full bg-brand"></div>
        <h3 className="font-bold text-gray-800 text-sm">ì‹¤ì¸¡ ì¼ì • ì¡°ìœ¨</h3>
        <span className={`ml-auto text-xs font-semibold px-2.5 py-1 rounded-full ${scheduleStatusStyle}`}>
          {scheduleStatus}
        </span>
      </div>

      {/* â”€â”€ STEP 1: ê³ ê° í¬ë§ ì¼ì • â”€â”€ */}
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <div className="flex items-center justify-between px-4 py-3 bg-gray-50 border-b border-gray-100">
          <div className="flex items-center gap-2">
            <span className="flex items-center justify-center w-5 h-5 rounded-full bg-brand text-white text-xs font-bold">1</span>
            <span className="text-sm font-semibold text-gray-700">ê³ ê° í¬ë§ ì¼ì •</span>
            <span className="text-xs text-gray-400">(ê´€ë¦¬ì ì…ë ¥ â†’ ê¸°ì‚¬ ì „ë‹¬)</span>
          </div>
          {sent && (
            <span className="flex items-center gap-1 text-xs text-emerald-600 font-semibold">
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
              ë°œì†¡ ì™„ë£Œ
            </span>
          )}
        </div>

        <div className="px-4 py-4 space-y-2.5">
          {/* ìµœì¢… í™•ì •(ê³ ê° ì „ë‹¬) ì™„ë£Œ ì‹œ ì…ë ¥ ë¹„í™œì„±í™” */}
          {finalStatus === "done" && (
            <div className="flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg mb-1">
              <svg className="w-3.5 h-3.5 text-emerald-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <span className="text-xs text-emerald-700 font-medium">ìµœì¢… ì¼ì •ì´ í™•ì •ë˜ì–´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>
            </div>
          )}
          {proposals.map((p, idx) => (
            <div key={p.id} className="flex items-center gap-2">
              <span className="text-xs font-medium text-gray-400 w-7 text-center">{idx + 1}ì•ˆ</span>
              <input
                type="date" value={p.date}
                min={today}
                disabled={finalStatus === "done"}
                onChange={e => updateProposal(p.id, "date", e.target.value)}
                className={`flex-1 px-3 py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-gray-700 ${finalStatus === "done" ? "bg-gray-50 border-gray-100 cursor-default" : "border-gray-300 bg-white"}`}
              />
              <input
                type="time" value={p.time}
                disabled={finalStatus === "done"}
                onChange={e => updateProposal(p.id, "time", e.target.value)}
                className={`w-28 px-3 py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-gray-700 ${finalStatus === "done" ? "bg-gray-50 border-gray-100 cursor-default" : "border-gray-300 bg-white"}`}
              />
              {proposals.length > 1 && finalStatus !== "done" && (
                <button onClick={() => removeProposal(p.id)}
                  className="w-7 h-7 flex items-center justify-center rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors">
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              )}
            </div>
          ))}
          {finalStatus !== "done" && (
            <button onClick={addProposal}
              className="flex items-center gap-2 text-xs text-brand hover:text-[#0090e6] font-medium px-2 py-1.5 rounded-lg hover:bg-brand-weak transition-colors mt-1">
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>
              ì¼ì • ì•ˆ ì¶”ê°€
            </button>
          )}
        </div>

        <div className="px-4 py-3 bg-gray-50 border-t border-gray-100 flex justify-end gap-2">
          <button onClick={handleReset}
            disabled={finalStatus === "done"}
            className={`px-3 py-1.5 text-xs font-medium border rounded-lg transition-colors ${finalStatus === "done" ? "text-gray-300 border-gray-200 cursor-not-allowed" : "text-gray-500 hover:text-gray-700 border-gray-300 hover:bg-white"}`}>
            ì´ˆê¸°í™”
          </button>
          <button onClick={handleSend}
            disabled={finalStatus === "done"}
            className={`px-4 py-1.5 text-xs font-semibold rounded-lg transition-colors flex items-center gap-2 shadow-sm ${finalStatus === "done" ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "text-white bg-brand hover:bg-[#0090e6]"}`}>
            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
            ê¸°ì‚¬ì—ê²Œ ë°œì†¡
          </button>
        </div>
      </div>

      {/* â”€â”€ ì—°ê²° í™”ì‚´í‘œ â”€â”€ */}
      <div className="flex items-center gap-2 px-4">
        <div className="flex-1 h-px bg-gradient-to-r from-brand/30 to-gray-200"></div>
        <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
        </svg>
        <div className="flex-1 h-px bg-gradient-to-l from-gray-200 to-amber-200"></div>
      </div>

      {/* â”€â”€ STEP 2: ê¸°ì‚¬ í™•ì¸ Â· ì‘ë‹µ â”€â”€ */}
      <div className={`border rounded-xl overflow-hidden transition-colors ${
        !sent                               ? "border-gray-200 bg-white"
        : engResponse?.type === "accepted"  ? "border-emerald-200 bg-emerald-50/30"
        : engResponse?.type === "counter"   ? "border-red-200 bg-red-50/30"
        : "border-amber-200 bg-amber-50/20"
      }`}>
        <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 bg-white/70">
          <div className="flex items-center gap-2">
            <span className="flex items-center justify-center w-5 h-5 rounded-full bg-amber-500 text-white text-xs font-bold">2</span>
            <span className="text-sm font-semibold text-gray-700">ê¸°ì‚¬ í™•ì¸ Â· ì‘ë‹µ</span>
          </div>
          <span className={`text-xs font-bold px-3 py-1 rounded-full border ${
            !sent                               ? "bg-gray-100 text-gray-400 border-gray-200"
            : engResponse?.type === "accepted"  ? "bg-emerald-100 text-emerald-700 border-emerald-300"
            : engResponse?.type === "counter"   ? "bg-red-100 text-red-700 border-red-300"
            : "bg-amber-100 text-amber-700 border-amber-300"
          }`}>
            {!sent ? "ì „ë‹¬ ì „" : engResponse?.type === "accepted" ? "ì¼ì • ìˆ˜ë½ âœ“" : engResponse?.type === "counter" ? "ëŒ€ì²´ ì œì•ˆ" : "ì‘ë‹µ ëŒ€ê¸°ì¤‘"}
          </span>
        </div>

        <div className="px-4 py-4">
          {/* ë°œì†¡ ì „ */}
          {!sent && (
            <div className="flex items-center justify-center gap-2 py-6 text-sm text-gray-400">
              <svg className="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              ê³ ê° í¬ë§ ì¼ì •ì„ ì…ë ¥í•˜ê³  ê¸°ì‚¬ì—ê²Œ ë°œì†¡í•˜ë©´ ì´ í™”ë©´ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </div>
          )}

          {/* ë°œì†¡ í›„ Â· ê¸°ì‚¬ ì‘ë‹µ ëŒ€ê¸° */}
          {sent && !engResponse && (
            <div className="space-y-3">
              <div>
                <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">ì „ë‹¬ëœ ê³ ê° í¬ë§ ì¼ì •</p>
                <div className="space-y-1.5">
                  {proposals.map((p, idx) => (
                    <div key={p.id} className="flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
                      <span className="text-xs font-bold text-gray-400 w-5 text-center">{idx + 1}</span>
                      <svg className="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span className="text-sm font-semibold text-gray-700">{p.date || "ë‚ ì§œ ë¯¸ì…ë ¥"}</span>
                      <span className="text-sm text-gray-500">{p.time}</span>
                    </div>
                  ))}
                </div>
              </div>
              <div className="flex items-center gap-2 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2.5">
                <svg className="w-4 h-4 text-amber-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span className="text-xs text-amber-700 font-semibold">ê¸°ì‚¬ ì•±ì—ì„œ ì‘ë‹µì„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤</span>
              </div>
            </div>
          )}

          {/* ë°œì†¡ í›„ Â· ê¸°ì‚¬ ìˆ˜ë½ */}
          {sent && engResponse?.type === "accepted" && (
            <div className="flex items-start gap-3 bg-emerald-50 border border-emerald-200 rounded-xl px-4 py-3">
              <div className="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center flex-shrink-0 mt-0.5">
                <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <p className="text-sm font-semibold text-emerald-700">ê¸°ì‚¬ â€” ì¼ì • ìˆ˜ë½</p>
                <p className="text-xs text-emerald-600 mt-1">
                  ìˆ˜ë½ ì¼ì •: <span className="font-bold">{engResponse.date}  {engResponse.time}</span>
                </p>
              </div>
            </div>
          )}

          {/* ë°œì†¡ í›„ Â· ê¸°ì‚¬ ëŒ€ì²´ ì œì•ˆ */}
          {sent && engResponse?.type === "counter" && (
            <div className="space-y-3">
              <div className="flex items-start gap-3 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
                <div className="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center flex-shrink-0 mt-0.5">
                  <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </div>
                <div>
                  <p className="text-sm font-semibold text-red-700">ê¸°ì‚¬ â€” ì¼ì • ë¶ˆê°€</p>
                  <p className="text-xs text-red-500 mt-0.5">ì•„ë˜ ëŒ€ì²´ ì¼ì •ìœ¼ë¡œ ì—­ì œì•ˆí–ˆìŠµë‹ˆë‹¤</p>
                </div>
              </div>
              <div>
                <p className="text-xs font-semibold text-gray-500 mb-2 flex items-center gap-1">
                  <svg className="w-3.5 h-3.5 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                  </svg>
                  ê¸°ì‚¬ ì—­ì œì•ˆ ì¼ì‹œ
                </p>
                <div className="flex flex-wrap gap-2">
                  {(engResponse.counterProposals || [{ date: engResponse.date, time: engResponse.time }]).map((cp, i) => (
                    <div key={i} className="flex items-center gap-2 bg-amber-50 border-2 border-amber-400 rounded-lg px-3 py-2">
                      <svg className="w-3.5 h-3.5 text-amber-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span className="text-sm font-bold text-amber-800">{cp.date}</span>
                      <span className="text-sm text-amber-700 font-medium">{cp.time}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* â”€â”€ ì—°ê²° í™”ì‚´í‘œ â”€â”€ */}
      <div className="flex items-center gap-2 px-4">
        <div className="flex-1 h-px bg-gradient-to-r from-amber-200 to-gray-200"></div>
        <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
        </svg>
        <div className="flex-1 h-px bg-gradient-to-l from-gray-200 to-emerald-200"></div>
      </div>

      {/* â”€â”€ STEP 3: ìµœì¢… í™•ì • ì¼ì • â”€â”€ */}
      <div className="bg-white border border-emerald-200 rounded-xl overflow-hidden">
        <div className="flex items-center justify-between px-4 py-3 bg-emerald-50 border-b border-emerald-100">
          <div className="flex items-center gap-2">
            <span className="flex items-center justify-center w-5 h-5 rounded-full bg-emerald-600 text-white text-xs font-bold">3</span>
            <span className="text-sm font-semibold text-gray-700">ìµœì¢… í™•ì • ì¼ì •</span>
          </div>
          {scheduleOptions.length > 0 && (
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-500">ê³ ê° ì•ˆë‚´:</span>
              <div className="relative">
                <select
                  value={finalStatus} onChange={e => handleFinalStatusChange(e.target.value)}
                  className={`appearance-none text-xs font-semibold px-3 py-1.5 pr-7 rounded-lg border cursor-pointer focus:outline-none focus:ring-2 focus:ring-emerald-400 transition-all ${
                    finalStatus === "done"
                      ? "bg-emerald-100 text-emerald-700 border-emerald-300"
                      : "bg-gray-100 text-gray-600 border-gray-300"
                  }`}
                >
                  <option value="waiting">ğŸ“¢ ì „ë‹¬ ëŒ€ê¸°</option>
                  <option value="done">âœ… ì „ë‹¬ ì™„ë£Œ</option>
                </select>
                <svg className="absolute right-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-current pointer-events-none opacity-60"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          )}
        </div>

        <div className="px-4 py-4">
          {scheduleOptions.length === 0 ? (
            <div className="flex items-center gap-3 bg-gray-50 border border-dashed border-gray-300 rounded-xl px-4 py-3">
              <svg className="w-4 h-4 text-gray-300 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <span className="text-sm text-gray-400">ê¸°ì‚¬ ì‘ë‹µ ìˆ˜ì‹  í›„ ì¼ì • ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤</span>
            </div>
          ) : (
            <div className="space-y-3">
              <div className="flex items-center gap-3">
                <div className="flex-1">
                  <p className="text-xs font-semibold text-gray-500 mb-1.5">
                    {engResponse?.type === "accepted" ? "ê¸°ì‚¬ ìŠ¹ë‚™ ì¼ì •" : "ê¸°ì‚¬ ì—­ì œì•ˆ ì¼ì‹œ ì„ íƒ"}
                  </p>
                  <div className="relative">
                    <select
                      value={selectedScheduleKey} onChange={e => setSelectedScheduleKey(e.target.value)}
                      disabled={finalStatus === "done"}
                      className={`w-full appearance-none text-sm font-bold px-4 py-2.5 pr-9 rounded-xl border focus:outline-none focus:ring-2 focus:ring-emerald-400 transition-all ${
                        finalStatus === "done"
                          ? "bg-emerald-50 text-emerald-700 border-emerald-200 cursor-default"
                          : "bg-white text-gray-800 border-gray-300 hover:border-emerald-400 cursor-pointer"
                      }`}
                    >
                      {scheduleOptions.map((opt, i) => (
                        <option key={`${opt.date}|${opt.time}`} value={`${opt.date}|${opt.time}`}>
                          {opt.date}  {opt.time}{engResponse?.type === "counter" ? `  (${i + 1}ì•ˆ Â· ê¸°ì‚¬ ì—­ì œì•ˆ)` : "  (ê¸°ì‚¬ ìŠ¹ë‚™)"}
                        </option>
                      ))}
                    </select>
                    {finalStatus !== "done" && (
                      <svg className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    )}
                  </div>
                </div>
              </div>
              {finalStatus === "done" && (
                <div className="flex items-center gap-2 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2 text-xs text-emerald-700 font-semibold">
                  <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                  </svg>
                  ê³ ê°ê³¼ ê¸°ì‚¬ì—ê²Œ ë™ì‹œ ì „ë‹¬ ì™„ë£Œ
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION B â€” ì‹¤ì¸¡ ê²°ê³¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SectionResult({ data, onToast, onConfirm }) {
  const [isDone, setIsDone] = useState(data.isDone);
  const [selectedImg, setSelectedImg] = useState(null);

  /* ì—…ë¡œë“œ ì‹œê° í¬ë§· */
  const fmtSubmittedAt = (iso) => {
    if (!iso) return null;
    try {
      const d = new Date(iso);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    } catch { return null; }
  };
  const submittedLabel = fmtSubmittedAt(data.submittedAt);
  const hasImages = data.images && data.images.length > 0;

  const handleConfirm = () => {
    setIsDone(true);
    onConfirm?.(); // localStorage ì €ì¥ + status.silcheuk â†’ "ì™„ë£Œ" ì²˜ë¦¬
    onToast({
      type: "success",
      title: "ëŒ€ì‹œë³´ë“œ ìƒíƒœ ë³€ê²½",
      message: "ëŒ€ì‹œë³´ë“œ ì‹¤ì¸¡ ìƒíƒœê°€ [ì™„ë£Œ]ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.",
      duration: 5000,
    });
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center gap-2">
        <div className="w-1 h-5 rounded-full bg-brand"></div>
        <h3 className="font-bold text-gray-800 text-sm">ì‹¤ì¸¡ ê²°ê³¼ ê²€ìˆ˜</h3>
        {isDone && (
          <span className="ml-auto flex items-center gap-1 text-xs font-bold text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full">
            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
            </svg>
            ê²€ìˆ˜ ì™„ë£Œ
          </span>
        )}
      </div>

      {/* ì‹¤ì¸¡ì§€ & ì‚¬ì§„ ê·¸ë¦¬ë“œ */}
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <div className="px-4 py-3 bg-gray-50 border-b border-gray-100 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span className="text-sm font-semibold text-gray-700">ì‹¤ì¸¡ì§€ ë° í˜„ì¥ ì‚¬ì§„</span>
            {hasImages && <span className="text-xs text-gray-400">({data.images.length}ì¥ Â· í´ë¦­í•˜ë©´ í™•ëŒ€)</span>}
          </div>
          {submittedLabel && (
            <span className="text-xs text-gray-400">ì—…ë¡œë“œ: {submittedLabel}</span>
          )}
        </div>

        {hasImages ? (
          <div className="p-4 grid grid-cols-4 gap-3">
            {data.images.map(img => (
              <div
                key={img.id}
                className="thumb-wrap relative aspect-[4/3] rounded-lg overflow-hidden cursor-zoom-in group border border-gray-200"
                onClick={() => setSelectedImg(img)}
              >
                {img.isImage ? (
                  <img
                    src={img.url}
                    alt={img.label}
                    className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                    loading="lazy"
                  />
                ) : (
                  <div className="w-full h-full bg-gray-100 flex flex-col items-center justify-center gap-1 p-2">
                    <svg className="w-7 h-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5}
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p className="text-xs text-gray-500 truncate w-full text-center">{img.name}</p>
                  </div>
                )}
                <div className="thumb-overlay absolute inset-0 bg-gray-900/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-end">
                  <p className="text-white text-xs font-medium p-2 w-full truncate">{img.label}</p>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="p-8 flex flex-col items-center gap-2 text-center">
            <svg className="w-10 h-10 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5}
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p className="text-sm text-gray-400 font-medium">ì•„ì§ ì—…ë¡œë“œëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <p className="text-xs text-gray-300">ê¸°ì‚¬ê°€ ì‹¤ì¸¡ ê²°ê³¼ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
          </div>
        )}
      </div>

      {/* ì‹¤ì¸¡ ë©”ëª¨ */}
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <div className="px-4 py-3 bg-gray-50 border-b border-gray-100 flex items-center gap-2">
          <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <span className="text-sm font-semibold text-gray-700">ì‹¤ì¸¡ ë©”ëª¨</span>
          <span className="text-xs text-gray-400">(ê¸°ì‚¬ ì‘ì„± Â· Read-only)</span>
        </div>
        <div className="px-4 py-4">
          {data.memo ? (
            <pre className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap font-sans bg-gray-50 rounded-lg p-4 border border-gray-100">
              {data.memo}
            </pre>
          ) : (
            <p className="text-sm text-gray-300 italic">ë©”ëª¨ ì—†ìŒ</p>
          )}
        </div>
      </div>

      {/* í™•ì • ë²„íŠ¼ */}
      <button
        onClick={handleConfirm}
        disabled={isDone}
        className={`w-full py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2
          ${isDone
            ? "btn-confirm-done text-white cursor-default shadow-sm"
            : "bg-brand hover:bg-[#0090e6] text-white shadow-sm  hover:shadow-sm hover:-translate-y-0.5"
          }`}
      >
        {isDone ? (
          <>
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            ì‹¤ì¸¡ ê²°ê³¼ ê²€ìˆ˜ ì™„ë£Œë¨
          </>
        ) : (
          <>
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
            ì‹¤ì¸¡ ê²°ê³¼ í™•ì¸ ì™„ë£Œ
          </>
        )}
      </button>

      {/* ì´ë¯¸ì§€ ë¼ì´íŠ¸ë°•ìŠ¤ */}
      {selectedImg && (
        <div
          className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-6"
          onClick={() => setSelectedImg(null)}
        >
          <div
            className="relative max-w-3xl w-full bg-white rounded-2xl overflow-hidden shadow"
            onClick={e => e.stopPropagation()}
          >
            <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
              <p className="text-sm font-semibold text-gray-800">{selectedImg.label}</p>
              <button
                onClick={() => setSelectedImg(null)}
                className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500 transition-colors"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <img src={selectedImg.url} alt={selectedImg.label} className="w-full object-contain max-h-[70vh]" />
            <div className="px-4 py-2 bg-gray-50 text-xs text-gray-400 text-center">
              í´ë¦­í•˜ê±°ë‚˜ ESCë¥¼ ëˆŒëŸ¬ ë‹«ê¸°
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


/* â”€â”€â”€â”€â”€ ê³µí†µ í—¬í¼ â”€â”€â”€â”€â”€ */
function SectionHeader({ color, icon, title, sub, badge }) {
  const colorMap = {
    blue:   { bg: "bg-brand-weak",   border: "border-brand/10",   dot: "bg-brand",   icon: "bg-brand"   },
    orange: { bg: "bg-orange-50", border: "border-orange-100", dot: "bg-orange-600", icon: "bg-orange-600" },
    green:  { bg: "bg-emerald-50",border: "border-emerald-100",dot: "bg-emerald-600",icon: "bg-emerald-600" },
    amber:  { bg: "bg-amber-50",  border: "border-amber-100",  dot: "bg-amber-600",  icon: "bg-amber-600"  },
  };
  const c = colorMap[color] || colorMap.blue;
  return (
    <div className={`flex items-center justify-between px-5 py-3 ${c.bg} border-b ${c.border}`}>
      <div className="flex items-center gap-2">
        <div className={`w-6 h-6 rounded-lg ${c.icon} flex items-center justify-center flex-shrink-0`}>
          {icon}
        </div>
        <div>
          <h4 className="text-sm font-bold text-gray-800">{title}</h4>
          {sub && <p className="text-xs text-gray-400 mt-1">{sub}</p>}
        </div>
      </div>
      {badge}
    </div>
  );
}

/* â”€â”€â”€â”€â”€ ìƒíƒœ ë±ƒì§€ ìŠ¤íƒ€ì¼ (ëª©ëŒ€ ì „ìš©) â”€â”€â”€â”€â”€ */
function MokdaeStatusBadge({ status, large = false }) {
  const map = {
    "ë°œì£¼ìš”ì²­ëŒ€ê¸°":     { cls: "bg-gray-100 text-gray-500 border-gray-200",          dot: "bg-gray-400" },
    "ë°œì£¼ìš”ì²­ì™„ë£Œ":     { cls: "bg-brand-weak text-brand border-brand/20",              dot: "bg-brand" },
    "ë°œì£¼ìš”ì²­ë°˜ë ¤":     { cls: "bg-red-100 text-red-700 border-red-200",                 dot: "bg-red-500" },
    "CADë„ë©´ê²€í† ì¤‘":    { cls: "bg-brand-weak text-brand border-brand/20",              dot: "bg-brand" },
    "CADìˆ˜ì •ìš”ì²­":      { cls: "bg-orange-100 text-orange-700 border-orange-200",        dot: "bg-orange-500" },
    "ë°œì£¼í™•ì •":         { cls: "bg-emerald-100 text-emerald-700 border-emerald-200",     dot: "bg-emerald-500" },
    "í™•ì •í›„ì¡°ì •ê¸´ê¸‰":   { cls: "bg-red-100 text-red-700 border-red-200",                 dot: "bg-red-500 animate-pulse" },
    "ì¬ë§ˆê°ìš”ì²­":       { cls: "bg-orange-100 text-orange-700 border-orange-200",        dot: "bg-orange-500" },
    "ì¬ë§ˆê°ì¡°ì •":       { cls: "bg-amber-100 text-amber-700 border-amber-200",           dot: "bg-amber-500" },
    "ì¬ë§ˆê°í™•ì •":       { cls: "bg-emerald-100 text-emerald-700 border-emerald-200",     dot: "bg-emerald-500" },
    "ì œì‘ì§„í–‰":         { cls: "bg-teal-100 text-teal-700 border-teal-200",             dot: "bg-teal-500" },
    "ë„ë©´ê²€í† ì¤‘":         { cls: "bg-brand-weak text-brand border-brand/20",              dot: "bg-brand" },
    "ë„ë©´ìˆ˜ì •ìš”ì²­":       { cls: "bg-orange-100 text-orange-700 border-orange-200",        dot: "bg-orange-500" },
  };
  const s = map[status] || { cls: "bg-gray-100 text-gray-500 border-gray-200", dot: "bg-gray-400" };
  const sizeBase = large ? "text-sm px-3 py-1.5 gap-2" : "text-xs px-2 py-1 gap-2";
  return (
    <span className={`inline-flex items-center rounded-full border font-semibold ${sizeBase} ${s.cls}`}>
      <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${s.dot}`}></span>
      {status}
    </span>
  );
}

/* â”€â”€â”€â”€â”€ íŒŒì¼ ì•„ì´í…œ (ì—…ê·¸ë ˆì´ë“œ) â”€â”€â”€â”€â”€ */
const FILE_TYPE_META = {
  "ì‹¤ì¸¡ì§€":   { color: "bg-rose-100 text-rose-600 border-rose-200",    icon: "ğŸ“" },
  "í˜„ì¥ì‚¬ì§„": { color: "bg-purple-100 text-purple-600 border-purple-200", icon: "ğŸ“·" },
  "3Dë„ë©´":   { color: "bg-brand-weak text-brand border-brand/20",     icon: "ğŸ§Š" },
  "ê¸°ê¸°ìŠ¤í™": { color: "bg-amber-100 text-amber-700 border-amber-200",  icon: "âš™ï¸" },
};
const EXT_COLOR = {
  pdf: "bg-red-100 text-red-700", xlsx: "bg-emerald-100 text-emerald-700",
  zip: "bg-purple-100 text-purple-700", skp: "bg-cyan-100 text-cyan-700",
  dwg: "bg-brand-weak text-brand",
};

function FileItem({ file, showRequired = false }) {
  const ext = file.name.split(".").pop().toLowerCase();
  const meta = FILE_TYPE_META[file.type] || { color: "bg-gray-100 text-gray-600 border-gray-200", icon: "ğŸ“„" };
  return (
    <div className={`flex items-center gap-3 px-3 py-2 rounded-lg border transition-colors group
      ${!file.uploaded ? "border-dashed border-red-300 bg-red-50/40" : "border-gray-200 bg-white hover:border-brand/30 hover:bg-brand-weak/20"}`}>
      {/* íŒŒì¼ ìœ í˜• íƒœê·¸ */}
      <span className={`flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full border whitespace-nowrap ${meta.color}`}>
        <span className="text-base leading-none">{meta.icon}</span>
        {file.type}
      </span>
      <div className="flex-1 min-w-0">
        {file.uploaded ? (
          <>
            <p className="text-sm text-gray-700 font-medium truncate">{file.name}</p>
            <p className="text-xs text-gray-400">{file.size}</p>
          </>
        ) : (
          <>
            <p className="text-sm text-red-500 font-medium">ë¯¸ì—…ë¡œë“œ</p>
            <p className="text-xs text-red-400">{file.required ? "í•„ìˆ˜ ì„œë¥˜" : "ì„ íƒ ì„œë¥˜"}</p>
          </>
        )}
      </div>
      <div className="flex items-center gap-2 flex-shrink-0">
        {showRequired && file.required && !file.uploaded && (
          <span className="text-xs font-bold text-red-600 bg-red-100 px-1.5 py-0.5 rounded">í•„ìˆ˜ ëˆ„ë½</span>
        )}
        <span className={`text-xs font-bold px-1.5 py-0.5 rounded uppercase ${EXT_COLOR[ext] || "bg-gray-100 text-gray-500"}`}>
          {ext}
        </span>
        {file.uploaded && (
          <button className="opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-brand">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
          </button>
        )}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê³µí†µ ëª¨ë‹¬ ë˜í¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function Modal({ open, onClose, children, maxW = "max-w-lg" }) {
  useEffect(() => {
    const fn = e => e.key === "Escape" && onClose();
    if (open) document.addEventListener("keydown", fn);
    return () => document.removeEventListener("keydown", fn);
  }, [open]);
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60"
         onClick={onClose}>
      <div className={`relative w-full ${maxW} bg-white rounded-2xl shadow`}
           onClick={e => e.stopPropagation()}>
        {children}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª©ëŒ€ íƒ­ â€” Section A: ë°œì£¼ ì„œë¥˜ & ë²„ì „ íˆìŠ¤í† ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function MokdaeSectionA({ versions: initVersions, activeVer: initActive, onToast, onStatusChange, silcheukImages = [], onMokdaeSchedule, uploadedFiles: initUploadedFiles = {}, onVersionsChange, silcheukFinalDate = "", mokdaeProductionStarted = false, mokdaeConfirmedAt = null, onCadReset, onUrgentChange, onSectionCReset }) {
  const [versions, setVersions]     = useState(initVersions);
  const [activeVer, setActiveVer]   = useState(initActive);
  const [uploadedFiles, setUploadedFiles] = useState(initUploadedFiles); // versionNo â†’ [{id,name,size,url,isImage}]
  const [dragging, setDragging]     = useState(false);
  const [silcheukOpen, setSilcheukOpen] = useState(true);
  const [lightbox, setLightbox]     = useState(null); // { url, name } | null
  const fileInputRef = useRef(null);
  const [urgentConfirmOpen, setUrgentConfirmOpen] = useState(false);

  const current       = versions.find(v => v.versionNo === activeVer);
  const isNewVersion  = current?.isNew === true;
  const currentFiles  = uploadedFiles[activeVer] || [];
  const submittedVers = versions.filter(v => !v.isNew);
  const badgeStatus   = submittedVers.length > 0 ? "ë°œì£¼ìš”ì²­ì™„ë£Œ" : "ë°œì£¼ìš”ì²­ëŒ€ê¸°";

  /* ESC â†’ ë¼ì´íŠ¸ë°•ìŠ¤ ë‹«ê¸° */
  useEffect(() => {
    const fn = (e) => { if (e.key === "Escape") setLightbox(null); };
    document.addEventListener("keydown", fn);
    return () => document.removeEventListener("keydown", fn);
  }, []);

  /* ë°œì£¼ ìƒíƒœ ë³€ê²½ ì‹œ ë¶€ëª¨ì— ì•Œë¦¼ â†’ ëŒ€ì‹œë³´ë“œ ìë™ ì—°ë™ */
  useEffect(() => {
    onStatusChange && onStatusChange("mokdae", badgeStatus);
  }, [badgeStatus]);

  /* ê³µì¥ ìŠ¹ì¸(factoryChecked)ëœ ìµœì‹  ë²„ì „ì˜ ëª©ëŒ€ ì¼ì •ì„ ë¶€ëª¨ì— ì „ë‹¬
     â†’ Appì´ schedule.mokdae + mokdaeFinalDateì— ì €ì¥ â†’ LeftPanelÂ·index.html ìë™ ë°˜ì˜ */
  useEffect(() => {
    if (!onMokdaeSchedule) return;
    const approved = versions
      .filter(v => !v.isNew && v.factoryChecked)
      .sort((a, b) => b.versionNo - a.versionNo);
    const date = (approved.length > 0 && approved[0].mokdaeDate) || "";
    onMokdaeSchedule(date);
  }, [versions]);

  /* â”€â”€ ë°ì´í„° ì˜ì†í™”: ë³€ê²½ â†’ ë¶€ëª¨(App)ë¡œ ì „ë‹¬ â†’ localStorage ì €ì¥ â”€â”€ */
  const didMountA = useRef(false);
  useEffect(() => {
    if (!didMountA.current) { didMountA.current = true; return; }
    if (onVersionsChange) onVersionsChange(versions, uploadedFiles);
  }, [versions, uploadedFiles]);

  /* â”€â”€ cross-tab ë™ê¸°í™”: factory.htmlì—ì„œ factoryChecked ë“± ë³€ê²½ ì‹œ ë°˜ì˜ â”€â”€ */
  useEffect(() => {
    if (JSON.stringify(initVersions) !== JSON.stringify(versions)) setVersions(initVersions);
  }, [JSON.stringify(initVersions)]);
  useEffect(() => {
    if (JSON.stringify(initUploadedFiles) !== JSON.stringify(uploadedFiles)) setUploadedFiles(initUploadedFiles);
  }, [JSON.stringify(initUploadedFiles)]);

  /* ë‚ ì§œ ì…ë ¥ ì œí•œ: ì˜¤ëŠ˜ ì´ì „ ë¶ˆê°€ + ì‹¤ì¸¡ ì¼ì • ì´í›„ë§Œ ê°€ëŠ¥ */
  const today = new Date().toISOString().slice(0, 10);
  const minMokdaeDate = silcheukFinalDate && silcheukFinalDate > today ? silcheukFinalDate : today;

  const CheckIcon = () => (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
    </svg>
  );

  /* â”€â”€ ìƒˆ ë²„ì „ ì¶”ê°€ â”€â”€ */
  const handleAddVersion = () => {
    /* ë°œì£¼ í™•ì • í›„ ë²„ì „ ì¶”ê°€ â†’ ê¸´ê¸‰ë°œì£¼ í™•ì¸ */
    if (mokdaeConfirmedAt) {
      setUrgentConfirmOpen(true);
      return;
    }
    doAddVersion();
  };
  const doAddVersion = () => {
    const maxNo = versions.length > 0 ? Math.max(...versions.map(v => v.versionNo)) : 0;
    const newVer = { versionNo: maxNo + 1, files: [], factoryChecked: false, sentAt: "", sentBy: "", memo: "", mokdaeDate: "", isNew: true };
    setVersions(prev => [...prev, newVer]);
    setActiveVer(maxNo + 1);
    setUrgentConfirmOpen(false);
  };

  /* â”€â”€ íŒŒì¼ ì—…ë¡œë“œ (canvas ë¦¬ì‚¬ì´ì¦ˆ â†’ dataURL â†’ localStorage ì˜ì†í™”) â”€â”€ */
  const handleDragOver  = (e) => { e.preventDefault(); setDragging(true); };
  const handleDragLeave = (e) => { e.preventDefault(); setDragging(false); };
  const handleDrop = (e) => { e.preventDefault(); setDragging(false); handleAddFiles(Array.from(e.dataTransfer.files)); };
  const handleFileInputChange = (e) => { handleAddFiles(Array.from(e.target.files)); e.target.value = ""; };
  const handleAddFiles = async (fileList) => {
    if (!fileList.length) return;
    const toStorable = (f) => new Promise((resolve) => {
      const sizeStr = f.size > 1024 * 1024 ? `${(f.size / 1024 / 1024).toFixed(1)} MB` : `${Math.round(f.size / 1024)} KB`;
      if (!f.type.startsWith("image/")) {
        resolve({ id: Date.now() + Math.random(), name: f.name, size: sizeStr, url: null, isImage: false });
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const MAX = 900;
          let { width, height } = img;
          if (width > MAX || height > MAX) {
            if (width >= height) { height = Math.round(height * MAX / width); width = MAX; }
            else                 { width  = Math.round(width  * MAX / height); height = MAX; }
          }
          const canvas = document.createElement("canvas");
          canvas.width = width; canvas.height = height;
          canvas.getContext("2d").drawImage(img, 0, 0, width, height);
          resolve({
            id: Date.now() + Math.random(), name: f.name, size: sizeStr,
            url: canvas.toDataURL("image/jpeg", 0.75), isImage: true,
          });
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(f);
    });
    const newItems = await Promise.all(fileList.map(toStorable));
    setUploadedFiles(prev => ({ ...prev, [activeVer]: [...(prev[activeVer] || []), ...newItems] }));
    onToast({ type: "success", title: "íŒŒì¼ ì¶”ê°€ë¨", message: `${fileList.length}ê°œ íŒŒì¼ì´ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.` });
  };
  const handleRemoveFile = (fileId) => {
    setUploadedFiles(prev => ({ ...prev, [activeVer]: (prev[activeVer] || []).filter(f => f.id !== fileId) }));
  };

  /* â”€â”€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ â”€â”€ */
  const handleDownloadFile = (f) => {
    if (!f.url) return;
    const a = document.createElement('a');
    a.href = f.url;
    a.download = f.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  /* â”€â”€ ë°œì£¼ ìš”ì²­ ì „ì†¡ â”€â”€ */
  const doSendRequest = () => {
    const now = new Date().toLocaleString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, isNew: false, factoryChecked: false, sentAt: now, sentBy: "ê´€ë¦¬ì" } : v
    ));
    /* ë°œì£¼ì„œ ì¬ë°œì†¡ ì‹œ ê¸°ì¡´ CAD ìŠ¹ì¸ í•´ì œ */
    if (onCadReset) onCadReset();
    /* ë°œì£¼ í™•ì • í›„ ìˆ˜ì • â†’ ê¸´ê¸‰ë°œì£¼ ìƒíƒœ + Section C ë¦¬ì…‹ */
    if (mokdaeConfirmedAt) {
      if (onUrgentChange) onUrgentChange();
      if (onSectionCReset) onSectionCReset();
      onToast({ type: "warning", title: `ë°œì£¼ V${activeVer} ê¸´ê¸‰ ë°œì†¡`, message: "í™•ì • í›„ ìˆ˜ì • ë°œì†¡ â€” ê¸´ê¸‰ë°œì£¼ ìƒíƒœë¡œ ë³€ê²½ë˜ë©°, ì†Œë¹„ì ìŠ¹ì¸ ë° ë°œì£¼ í™•ì •ì´ ë¦¬ì…‹ë©ë‹ˆë‹¤.", duration: 5000 });
    } else {
      onToast({ type: "success", title: `ë°œì£¼ V${activeVer} ìš”ì²­ ì™„ë£Œ`, message: "ê³µì¥ìœ¼ë¡œ ë°œì£¼ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤." });
    }
  };

  return (
    <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
      {/* í—¤ë” (ë²„ì „ ì¶”ê°€ ë²„íŠ¼ í¬í•¨) */}
      <div className="flex items-center justify-between px-5 py-3 bg-brand-weak border-b border-brand/10">
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 rounded-lg bg-brand flex items-center justify-center flex-shrink-0">
            <svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <div>
            <h4 className="text-sm font-bold text-gray-800">Section A Â· ë°œì£¼ ì„œë¥˜</h4>
            <p className="text-xs text-gray-400 mt-0.5">ë²„ì „ë³„ ì„œë¥˜ í˜„í™© Â· ê³µì¥ í™•ì¸ ìƒíƒœ</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <MokdaeStatusBadge status={badgeStatus} />
          {!mokdaeProductionStarted && (
            <button
              onClick={handleAddVersion}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-white bg-brand hover:bg-[#0090e6] rounded-lg shadow-sm transition-all active:scale-95"
            >
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>
              ë²„ì „ ì¶”ê°€
            </button>
          )}
          {mokdaeProductionStarted && (
            <span className="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold text-teal-700 bg-teal-50 border border-teal-200 rounded-lg">
              <span className="w-1.5 h-1.5 rounded-full bg-teal-500 animate-pulse"></span>
              ì œì‘ ì§„í–‰ ì¤‘
            </span>
          )}
        </div>
      </div>

      <div className="flex" style={{ minHeight: 340 }}>
        {/* â”€â”€ ì¢Œì¸¡: ë²„ì „ íˆìŠ¤í† ë¦¬ ì‚¬ì´ë“œë°” â”€â”€ */}
        <div className="w-44 flex-shrink-0 border-r border-gray-100 py-3 flex flex-col">
          <p className="text-xs font-semibold text-gray-400 px-4 mb-2 uppercase tracking-wide">ë²„ì „ íˆìŠ¤í† ë¦¬</p>
          {versions.length === 0 && (
            <div className="flex-1 flex flex-col items-center justify-center px-4 text-center gap-2">
              <svg className="w-8 h-8 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p className="text-xs text-gray-300 leading-relaxed">ìƒë‹¨ [ë²„ì „ ì¶”ê°€]ë¥¼<br/>ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</p>
            </div>
          )}
          {versions.map(v => (
            <button
              key={v.versionNo}
              onClick={() => setActiveVer(v.versionNo)}
              className={`w-full text-left px-4 py-2.5 flex flex-col gap-1 transition-colors border-l-2 ${
                activeVer === v.versionNo ? "border-brand bg-brand-weak" : "border-transparent hover:bg-gray-50"
              }`}
            >
              <div className="flex items-center gap-1.5 flex-wrap">
                <span className={`text-sm font-bold ${activeVer === v.versionNo ? "text-brand" : "text-gray-700"}`}>
                  ë°œì£¼ V{v.versionNo}
                </span>
                {v.versionNo === Math.max(...versions.map(x => x.versionNo)) && (
                  <span className="text-xs bg-brand text-white px-1.5 py-0.5 rounded font-bold leading-none">ìµœì‹ </span>
                )}
              </div>
              {v.isNew ? (
                <span className="inline-flex text-xs font-semibold px-2 py-0.5 rounded-full w-fit bg-orange-100 text-orange-600 border border-orange-200">ì‘ì„±ì¤‘</span>
              ) : (
                <span className={`inline-flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full w-fit ${
                  v.factoryChecked ? "bg-emerald-100 text-emerald-700" : "bg-gray-100 text-gray-400"
                }`}>
                  {v.factoryChecked ? <><CheckIcon />ê³µì¥í™•ì¸</> : "ê³µì¥ ë¯¸í™•ì¸"}
                </span>
              )}
              {v.sentAt && <span className="text-xs text-gray-400">{String(v.sentAt).slice(0, 10)}</span>}
            </button>
          ))}
        </div>

        {/* â”€â”€ ìš°ì¸¡: ë²„ì „ ìƒì„¸ â”€â”€ */}
        {versions.length === 0 ? (
          <div className="flex-1 flex flex-col items-center justify-center gap-3 text-gray-300">
            <svg className="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p className="text-sm font-medium text-gray-400">ì•„ì§ ë“±ë¡ëœ ë°œì£¼ ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <p className="text-xs">ì¢Œì¸¡ ìƒë‹¨ [ë²„ì „ ì¶”ê°€] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>
          </div>

        ) : current && isNewVersion ? (
          /* â”€â”€ ì‹ ê·œ ë²„ì „ ì‘ì„± UI â”€â”€ */
          <div className="flex-1 min-w-0 px-5 py-4 space-y-4 overflow-y-auto">

            {/* 1. ë“œë˜ê·¸ì•¤ë“œë¡­ ì—…ë¡œë“œ */}
            <div>
              <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">ë°œì£¼ì„œ íŒŒì¼ ì—…ë¡œë“œ</p>
              <div
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                onClick={() => fileInputRef.current?.click()}
                className={`relative flex flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed transition-all cursor-pointer py-8 ${
                  dragging ? "border-brand bg-brand-weak scale-[1.01]" : "border-gray-300 bg-gray-50/50 hover:border-brand hover:bg-brand-weak/30"
                }`}
              >
                <input ref={fileInputRef} type="file" multiple className="hidden" onChange={handleFileInputChange} />
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${dragging ? "bg-brand-weak" : "bg-white border border-gray-200"}`}>
                  <svg className={`w-5 h-5 transition-colors ${dragging ? "text-brand" : "text-gray-400"}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                </div>
                <div className="text-center">
                  <p className={`text-sm font-semibold transition-colors ${dragging ? "text-brand" : "text-gray-600"}`}>
                    {dragging ? "ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”!" : "íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ"}
                  </p>
                  {!dragging && <p className="text-xs text-gray-400 mt-1">ë°œì£¼ì„œ, ë„ë©´, ì‚¬ì§„ ë“± ëª¨ë“  íŒŒì¼ í˜•ì‹ ì§€ì›</p>}
                </div>
              </div>
            </div>

            {/* 2. ì‹¤ì¸¡ ì°¸ê³  ì´ë¯¸ì§€ (í† ê¸€ ì ‘ê¸°/í¼ì¹˜ê¸°) â€” silcheukImages propìœ¼ë¡œ ì‹¤ì¸¡ íƒ­ ì—…ë¡œë“œ ê²°ê³¼ í‘œì‹œ */}
            <div className="border border-gray-200 rounded-xl overflow-hidden">
              <button
                onClick={() => setSilcheukOpen(p => !p)}
                className="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors"
              >
                <div className="flex items-center gap-2">
                  <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">ì‹¤ì¸¡ ì‚¬ì§„ / ì‹¤ì¸¡ì§€ ì°¸ê³  ì´ë¯¸ì§€</span>
                  <span className={`text-xs px-1.5 py-0.5 rounded-full ${silcheukImages.length > 0 ? "bg-brand-weak text-brand font-bold" : "text-gray-400 bg-gray-200"}`}>{silcheukImages.length}ì¥</span>
                </div>
                <svg className={`w-4 h-4 text-gray-400 transition-transform duration-200 ${silcheukOpen ? "rotate-180" : ""}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              {silcheukOpen && (
                silcheukImages.length > 0 ? (
                  <div className="p-3 grid grid-cols-3 gap-2 border-t border-gray-100">
                    {silcheukImages.map(img => (
                      <div key={img.id} className="relative aspect-[4/3] rounded-lg overflow-hidden border border-gray-200 group cursor-zoom-in"
                           onClick={() => img.isImage && img.url && setLightbox({ url: img.url, name: img.label || img.name })}>
                        {img.isImage && img.url ? (
                          <React.Fragment>
                            <img src={img.url} alt={img.label || img.name} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy" />
                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                          </React.Fragment>
                        ) : (
                          <div className="w-full h-full bg-gray-100 flex flex-col items-center justify-center gap-1 p-2">
                            <svg className="w-7 h-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p className="text-xs text-gray-500 truncate w-full text-center">{img.name}</p>
                          </div>
                        )}
                        <div className="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/50 to-transparent px-2 py-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                          <p className="text-white text-xs truncate">{img.label || img.name}</p>
                          {img.category && <span className="text-white/70 text-xs">{img.category}</span>}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="px-4 py-8 flex flex-col items-center gap-2 text-gray-300 border-t border-gray-100">
                    <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p className="text-sm font-medium text-center">ì‹¤ì¸¡ íƒ­ì—ì„œ ì—…ë¡œë“œëœ ì‚¬ì§„/ì‹¤ì¸¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p className="text-xs text-center">ì‹¤ì¸¡ íƒ­ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                  </div>
                )
              )}
            </div>

            {/* 3. ì—…ë¡œë“œëœ ë°œì£¼ì„œ íŒŒì¼ í”„ë¦¬ë·° */}
            {currentFiles.length > 0 && (
              <div>
                <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">
                  ì—…ë¡œë“œëœ ë°œì£¼ì„œ
                  <span className="ml-1.5 text-gray-300 font-normal normal-case tracking-normal">({currentFiles.length}ê°œ)</span>
                </p>
                <div className="grid grid-cols-2 gap-3">
                  {currentFiles.map(f => (
                    <div key={f.id} className="border border-gray-200 rounded-xl overflow-hidden bg-white hover:border-brand/30 transition-colors group">
                      {f.isImage ? (
                        <div className="relative h-28 bg-gray-100 cursor-zoom-in" onClick={() => setLightbox({ url: f.url, name: f.name })}>
                          <img src={f.url} alt={f.name} className="w-full h-full object-cover" />
                          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                            <svg className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 drop-shadow transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0zm0 0l3 3"/>
                            </svg>
                          </div>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleRemoveFile(f.id); }}
                            className="absolute top-1.5 right-1.5 w-6 h-6 bg-black/50 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all"
                          >
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12"/></svg>
                          </button>
                        </div>
                      ) : (
                        <div className="relative h-28 bg-gray-50 flex flex-col items-center justify-center gap-1.5 cursor-pointer hover:bg-gray-100 transition-colors" onClick={() => handleDownloadFile(f)}>
                          <svg className="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                          <span className="text-xs text-gray-400 font-semibold uppercase">{f.name.split('.').pop()}</span>
                          <span className="text-xs text-brand/60 font-medium">í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ</span>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleRemoveFile(f.id); }}
                            className="absolute top-1.5 right-1.5 w-6 h-6 bg-black/30 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all"
                          >
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12"/></svg>
                          </button>
                        </div>
                      )}
                      <div className="px-3 py-2">
                        <p className="text-xs font-medium text-gray-700 truncate" title={f.name}>{f.name}</p>
                        <p className="text-xs text-gray-400">{f.size}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* 4. ëª©ëŒ€ ì˜ˆì • ì¼ì • ì…ë ¥ */}
            <div className="bg-gray-50 rounded-xl p-3 border border-gray-200">
              <label className="flex items-center gap-3">
                <div className="flex items-center gap-1.5 w-28 flex-shrink-0">
                  <svg className="w-3.5 h-3.5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">ëª©ëŒ€ ì˜ˆì • ì¼ì •</span>
                </div>
                <input
                  type="date"
                  value={current.mokdaeDate || ""}
                  min={minMokdaeDate}
                  onChange={e => setVersions(prev => prev.map(v => v.versionNo === activeVer ? { ...v, mokdaeDate: e.target.value } : v))}
                  className="flex-1 px-2.5 py-1.5 text-xs border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand bg-white text-gray-700"
                />
              </label>
            </div>

            {/* ë°œì£¼ ìš”ì²­ ë²„íŠ¼ */}
            <div className="flex items-center justify-between pt-2 border-t border-gray-100">
              {currentFiles.length === 0 && (
                <p className="text-xs text-gray-400 flex items-center gap-1.5">
                  <svg className="w-3.5 h-3.5 text-amber-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„ ë°œì£¼ ìš”ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤
                </p>
              )}
              <button
                onClick={doSendRequest}
                disabled={currentFiles.length === 0}
                className={`ml-auto flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-xl shadow-sm transition-all ${
                  currentFiles.length === 0 ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-brand hover:bg-[#0090e6] text-white"
                }`}
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                ë°œì£¼ ìš”ì²­
              </button>
            </div>
          </div>

        ) : current ? (
          /* â”€â”€ ê¸°ì¡´ ë²„ì „ ìƒì„¸ (ì½ê¸° ì „ìš©) â”€â”€ */
          <div className="flex-1 min-w-0 px-5 py-4 space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-bold text-gray-800">ë°œì£¼ V{current.versionNo} ìƒì„¸</p>
                <p className="text-xs text-gray-400">ë°œì†¡: {current.sentBy} Â· {current.sentAt}</p>
              </div>
              {current.factoryChecked && (
                <div className="flex items-center gap-2 text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg px-2 py-1.5">
                  <CheckIcon /> ê³µì¥ ì—´ëŒ {current.factoryCheckedAt}
                </div>
              )}
            </div>
            {/* ì—…ë¡œë“œëœ íŒŒì¼ í”„ë¦¬ë·° (ìˆì„ ê²½ìš°) */}
            {(uploadedFiles[current.versionNo] || []).length > 0 ? (
              <div className="grid grid-cols-2 gap-3">
                {(uploadedFiles[current.versionNo] || []).map(f => (
                  <div key={f.id} className="border border-gray-200 rounded-xl overflow-hidden bg-white group">
                    {f.isImage ? (
                      <div className="relative h-28 bg-gray-100 cursor-zoom-in" onClick={() => setLightbox({ url: f.url, name: f.name })}>
                        <img src={f.url} alt={f.name} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                          <svg className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 drop-shadow transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
                          </svg>
                        </div>
                      </div>
                    ) : (
                      <div className="w-full h-28 bg-gray-50 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-gray-100 transition-colors" onClick={() => handleDownloadFile(f)}>
                        <svg className="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span className="text-xs text-gray-400 font-semibold uppercase">{f.name.split('.').pop()}</span>
                        <span className="text-xs text-brand/60 font-medium">í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ</span>
                      </div>
                    )}
                    <div className="px-3 py-2">
                      <p className="text-xs font-medium text-gray-700 truncate">{f.name}</p>
                      <p className="text-xs text-gray-400">{f.size}</p>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="space-y-2">
                {current.files.map(f => <FileItem key={f.id} file={f} showRequired />)}
              </div>
            )}
            {/* ëª©ëŒ€ ì˜ˆì • ì¼ì • (ì½ê¸° ì „ìš©) */}
            {current.mokdaeDate && (
              <div className="bg-gray-50 rounded-xl p-3 border border-gray-200 flex items-center gap-3">
                <div className="flex items-center gap-1.5">
                  <svg className="w-3.5 h-3.5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">ëª©ëŒ€ ì˜ˆì • ì¼ì •</span>
                </div>
                <span className="text-xs font-bold text-gray-800">{current.mokdaeDate}</span>
              </div>
            )}
            {current.memo && (
              <div className="bg-gray-50 rounded-lg px-3 py-2 border border-gray-200">
                <p className="text-xs text-gray-500 font-medium mb-1">ë°œì£¼ ë©”ëª¨</p>
                <p className="text-sm text-gray-700 leading-relaxed">{current.memo}</p>
              </div>
            )}
          </div>
        ) : null}
      </div>

      {/* â”€â”€ ì´ë¯¸ì§€ ë¼ì´íŠ¸ë°•ìŠ¤ â”€â”€ */}
      {lightbox && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center p-6"
          style={{ background: "rgba(0,0,0,0.88)" }}
          onClick={() => setLightbox(null)}
        >
          <div className="relative flex flex-col items-center max-w-[92vw]" onClick={e => e.stopPropagation()}>
            {/* ë‹«ê¸° ë²„íŠ¼ */}
            <button
              onClick={() => setLightbox(null)}
              className="absolute -top-4 -right-4 z-10 w-9 h-9 bg-white/20 hover:bg-white/40 text-white rounded-full flex items-center justify-center transition-colors shadow-lg"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            {/* ì´ë¯¸ì§€ */}
            <img
              src={lightbox.url}
              alt={lightbox.name}
              className="max-w-full rounded-xl object-contain shadow-2xl"
              style={{ maxHeight: "80vh" }}
            />
            {/* í•˜ë‹¨ íŒŒì¼ëª… + ESC ì•ˆë‚´ */}
            <div className="mt-3 flex items-center gap-4 w-full px-1">
              <p className="flex-1 text-white/70 text-sm truncate">{lightbox.name}</p>
              <span className="flex-shrink-0 text-xs text-white/40 bg-white/10 px-2 py-1 rounded">ESCë¡œ ë‹«ê¸°</span>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ ê¸´ê¸‰ë°œì£¼ í™•ì¸ ëª¨ë‹¬ â”€â”€ */}
      {urgentConfirmOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40" onClick={() => setUrgentConfirmOpen(false)}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="px-6 pt-6 pb-4">
              <div className="flex items-center gap-3 mb-3">
                <div className="w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center flex-shrink-0">
                  <svg className="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z" />
                  </svg>
                </div>
                <div>
                  <h3 className="text-base font-bold text-gray-900">ê¸´ê¸‰ë°œì£¼ ìš”ì²­</h3>
                  <p className="text-xs text-gray-400 mt-0.5">ìµœì¢… ë°œì£¼ í™•ì • ê±´</p>
                </div>
              </div>
              <p className="text-sm text-gray-600 leading-relaxed">
                í•´ë‹¹ ê±´ì€ <span className="font-bold text-red-600">ìµœì¢… ë°œì£¼ê°€ í™•ì •</span>ëœ ìƒíƒœì…ë‹ˆë‹¤.<br/>
                ë²„ì „ì„ ì¶”ê°€í•˜ë©´ <span className="font-bold text-red-600">ê¸´ê¸‰ë°œì£¼ ìš”ì²­</span>ì´ ë“¤ì–´ê°€ê²Œ ë©ë‹ˆë‹¤.<br/>
                ê·¸ë˜ë„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
              </p>
            </div>
            <div className="flex border-t border-gray-100">
              <button onClick={() => setUrgentConfirmOpen(false)}
                className="flex-1 py-3.5 text-sm font-semibold text-gray-500 hover:bg-gray-50 transition-colors">
                ì·¨ì†Œ
              </button>
              <div className="w-px bg-gray-100"></div>
              <button onClick={doAddVersion}
                className="flex-1 py-3.5 text-sm font-bold text-red-600 hover:bg-red-50 transition-colors">
                ê¸´ê¸‰ë°œì£¼ ì§„í–‰
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª©ëŒ€ íƒ­ â€” Section B: CAD ë„ë©´ ë·°ì–´ & ë²„ì „ ì‚¬ì´ë“œë°”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function MokdaeSectionB({ cadVersions: initVersions, activeVer: initActive, onToast, onCadChange }) {
  const [versions, setVersions]   = useState(initVersions);
  const [activeVer, setActiveVer] = useState(initActive);
  const [lightbox, setLightbox]   = useState(null);
  const [showRevModal, setShowRevModal] = useState(false);
  const [revisionText, setRevisionText] = useState("");

  /* â”€â”€ ë°ì´í„° ì˜ì†í™”: ë³€ê²½ â†’ ë¶€ëª¨(App)ë¡œ ì „ë‹¬ â†’ localStorage ì €ì¥ â”€â”€ */
  const didMountB = useRef(false);
  useEffect(() => {
    if (!didMountB.current) { didMountB.current = true; return; }
    if (onCadChange) onCadChange(versions);
  }, [versions]);

  /* â”€â”€ cross-tab ë™ê¸°í™”: factory.htmlì—ì„œ CAD ì—…ë¡œë“œ ì‹œ ë°˜ì˜ â”€â”€ */
  useEffect(() => {
    if (JSON.stringify(initVersions) !== JSON.stringify(versions)) {
      setVersions(initVersions);
      if (initVersions.length > 0) setActiveVer(initVersions[initVersions.length - 1].versionNo);
    }
  }, [JSON.stringify(initVersions)]);

  const current = versions.find(v => v.versionNo === activeVer);

  const cadStatusStyle = {
    "ìŠ¹ì¸":       "bg-emerald-100 text-emerald-700 border-emerald-200",
    "ìŠ¹ì¸í•´ì œ":   "bg-red-100 text-red-700 border-red-200",
    "CADìˆ˜ì •ìš”ì²­":"bg-orange-100 text-orange-700 border-orange-200",
    "CADë„ë©´ê²€í† ì¤‘":"bg-brand-weak text-brand border-brand/20",
  };

  const handleApprove = () => {
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, status: "ìŠ¹ì¸", approvedAt: "2026-02-25 (ë°©ê¸ˆ)" } : v
    ));
    onToast({ type: "success", title: "CAD ìŠ¹ì¸ ì™„ë£Œ", message: `CAD V${activeVer} ë„ë©´ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, duration: 4000 });
  };

  const handleRevisionSubmit = () => {
    if (!revisionText.trim()) {
      onToast({ type: "warning", title: "ì‚¬ìœ  ì…ë ¥ í•„ìš”", message: "ìˆ˜ì • ìš”ì²­ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
      return;
    }
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, status: "CADìˆ˜ì •ìš”ì²­", revisionNote: revisionText } : v
    ));
    setShowRevModal(false);
    setRevisionText("");
    onToast({ type: "info", title: "ìˆ˜ì • ìš”ì²­ ì „ì†¡", message: "ê³µì¥ìœ¼ë¡œ CAD ìˆ˜ì • ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤." });
  };

  return (
    <>
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <SectionHeader
          color="orange"
          icon={<svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>}
          title="Section B Â· CAD ë„ë©´ ê²€í† "
          sub="ë²„ì „ í´ë¦­ â†’ ë·°ì–´ ì „í™˜ Â· ìŠ¹ì¸ ë˜ëŠ” ìˆ˜ì • ìš”ì²­"
          badge={<MokdaeStatusBadge status={versions.length === 0 ? "ë°œì£¼ìš”ì²­ëŒ€ê¸°" : (current?.status || "CADë„ë©´ê²€í† ì¤‘")} />}
        />

        <div className="flex min-h-[300px]">
          {versions.length === 0 ? (
            <div className="flex-1 flex flex-col items-center justify-center py-14 gap-3 text-gray-300">
              <svg className="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p className="text-sm font-medium text-gray-400">ì•„ì§ ë“±ë¡ëœ CAD ë„ë©´ì´ ì—†ìŠµë‹ˆë‹¤</p>
              <p className="text-xs">ë°œì£¼ ì„œë¥˜ê°€ ì „ë‹¬ë˜ë©´ ê³µì¥ì—ì„œ ë„ë©´ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.</p>
            </div>
          ) : (<>
          {/* ì¢Œì¸¡: CAD ë²„ì „ ì‚¬ì´ë“œë°” */}
          <div className="w-44 flex-shrink-0 border-r border-gray-100 py-3">
            <p className="text-xs font-semibold text-gray-400 px-4 mb-2 uppercase tracking-wide">ë„ë©´ ë²„ì „</p>
            {versions.map(v => (
              <button
                key={v.versionNo}
                onClick={() => setActiveVer(v.versionNo)}
                className={`w-full text-left px-4 py-3 flex flex-col gap-2 transition-colors border-l-2 ${
                  activeVer === v.versionNo
                    ? "border-orange-500 bg-orange-50"
                    : "border-transparent hover:bg-gray-50"
                }`}
              >
                <div className="flex items-center gap-2">
                  <span className={`text-sm font-bold ${activeVer === v.versionNo ? "text-orange-700" : "text-gray-700"}`}>
                    CAD V{v.versionNo}
                  </span>
                  {v.versionNo === versions.length && (
                    <span className="text-xs bg-orange-500 text-white px-1.5 py-0.5 rounded font-bold leading-none">ìµœì‹ </span>
                  )}
                </div>
                <span className={`inline-block text-xs font-semibold px-2 py-0.5 rounded-full border w-fit ${cadStatusStyle[v.status] || "bg-gray-100 text-gray-500 border-gray-200"}`}>
                  {v.status}
                </span>
                <span className="text-xs text-gray-400">{v.uploadedAt.slice(5,10)}</span>
              </button>
            ))}
          </div>

          {/* ì¤‘ì•™: ë„ë©´ ë·°ì–´ */}
          {current && (
            <div className="flex-1 min-w-0 flex flex-col" style={{minHeight: 300}}>
              {/* ì´ë¯¸ì§€ ë·°ì–´ */}
              <div className="relative flex-1 bg-gray-100 cursor-zoom-in group"
                   style={{ minHeight: "220px" }}
                   onClick={() => setLightbox(current.previewUrl)}>
                <img
                  src={current.previewUrl}
                  alt={`CAD V${current.versionNo}`}
                  className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-[1.02]"
                  style={{ maxHeight: "260px", objectFit: "cover" }}
                />

                {/* ìŠ¹ì¸ í•´ì œ ì›Œí„°ë§ˆí¬ */}
                {current.status === "ìŠ¹ì¸í•´ì œ" && (
                  <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-red-900/20"></div>
                    <div className="relative z-10 select-none" style={{ transform: "rotate(-22deg)" }}>
                      <span className="text-red-600/75 font-black tracking-[0.2em] whitespace-nowrap"
                            style={{ fontSize:"clamp(18px,3vw,32px)", textShadow:"0 0 12px rgba(255,255,255,0.9)", WebkitTextStroke:"0.5px rgba(180,0,0,0.4)" }}>
                        ìŠ¹ì¸ ì·¨ì†Œë¨
                      </span>
                    </div>
                    <div className="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded shadow">VOID</div>
                  </div>
                )}

                {/* ìŠ¹ì¸ ì™„ë£Œ ì˜¤ë²„ë ˆì´ */}
                {current.status === "ìŠ¹ì¸" && (
                  <div className="absolute top-2 left-2 flex items-center gap-2 bg-emerald-600/90 text-white text-xs font-bold px-2 py-1 rounded-lg shadow-md">
                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                    </svg>
                    ìŠ¹ì¸ë¨ Â· {current.approvedAt}
                  </div>
                )}

                {/* í™•ëŒ€ íŒíŠ¸ */}
                <div className="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                  í´ë¦­í•˜ì—¬ í™•ëŒ€
                </div>
              </div>

              {/* ì—…ë¡œë“œ ë‚ ì§œ + ë‘ ë²ˆì§¸ ë„ë©´ ë²„íŠ¼ */}
              <div className="flex items-center gap-2 px-4 py-2 bg-gray-50 border-t border-gray-100 text-xs text-gray-500">
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                ê³µì¥ ì—…ë¡œë“œ: {current.uploadedAt}
                <button onClick={() => setLightbox(current.previewUrl2)}
                        className="ml-auto flex items-center gap-1 text-brand hover:text-[#0090e6] font-medium">
                  ìƒì„¸ë„ ë³´ê¸° â†’
                </button>
              </div>

              {/* ìˆ˜ì • ìš”ì²­ ë‚´ìš© (ìˆì„ ê²½ìš°) */}
              {current.revisionNote && (
                <div className="mx-4 mb-3 mt-1 flex items-start gap-2 bg-orange-50 border border-orange-200 rounded-xl px-4 py-3">
                  <svg className="w-4 h-4 text-orange-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  <div>
                    <p className="text-xs font-semibold text-orange-700 mb-1">ìˆ˜ì • ìš”ì²­ ë‚´ìš©</p>
                    <p className="text-sm text-gray-700 leading-relaxed">{current.revisionNote}</p>
                  </div>
                </div>
              )}

              {/* ìŠ¹ì¸ í•´ì œ ì‚¬ìœ  */}
              {current.status === "ìŠ¹ì¸í•´ì œ" && (
                <div className="mx-4 mb-3 flex items-start gap-2 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
                  <svg className="w-4 h-4 text-red-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    <p className="text-xs font-semibold text-red-600 mb-1">ìŠ¹ì¸ í•´ì œ ì‚¬ìœ </p>
                    <p className="text-sm text-gray-700">ìƒˆë¡œìš´ ë°œì£¼ì„œ(V2) ì—…ë¡œë“œë¡œ ì¸í•´ ê¸°ì¡´ ìŠ¹ì¸ì´ ìë™ í•´ì œë¨. ({current.approvalCancelledAt})</p>
                  </div>
                </div>
              )}

              {/* ì•¡ì…˜ ë²„íŠ¼ */}
              <div className="flex gap-2 px-4 pb-4 mt-auto">
                <button
                  onClick={handleApprove}
                  disabled={current.status === "ìŠ¹ì¸"}
                  className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-semibold transition-all ${
                    current.status === "ìŠ¹ì¸"
                      ? "bg-emerald-100 text-emerald-500 cursor-default"
                      : "bg-emerald-600 hover:bg-emerald-700 text-white shadow-sm"
                  }`}
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  {current.status === "ìŠ¹ì¸" ? "ìŠ¹ì¸ ì™„ë£Œ" : "ìŠ¹ì¸"}
                </button>
                <button
                  onClick={() => setShowRevModal(true)}
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-semibold
                             bg-red-500 hover:bg-red-600 text-white shadow-sm shadow-red-200 transition-all"
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  ìˆ˜ì • ìš”ì²­
                </button>
              </div>
            </div>
          )}
          </>)}
        </div>
      </div>

      {/* â”€â”€ ìˆ˜ì • ìš”ì²­ ì‚¬ìœ  ëª¨ë‹¬ â”€â”€ */}
      <Modal open={showRevModal} onClose={() => setShowRevModal(false)}>
        <div className="px-6 py-5 space-y-4">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-xl bg-red-100 flex items-center justify-center flex-shrink-0">
              <svg className="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </div>
            <div>
              <h3 className="text-base font-bold text-gray-800">CAD ìˆ˜ì • ìš”ì²­</h3>
              <p className="text-xs text-gray-400">CAD V{activeVer} Â· ê³µì¥ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤</p>
            </div>
          </div>
          <div>
            <label className="block text-xs font-semibold text-gray-600 mb-1.5">ìˆ˜ì • ìš”ì²­ ì‚¬ìœ  <span className="text-red-500">*</span></label>
            <textarea
              value={revisionText}
              onChange={e => setRevisionText(e.target.value)}
              rows={4}
              placeholder="ì˜ˆ) ëƒ‰ì¥ê³  ìš°ì¸¡ í‹ˆìƒˆ í­ 340mmë¡œ ìˆ˜ì •, ìƒë¶€ì¥ ë†’ì´ 2,300mm ì¬í™•ì¸ í•„ìš”"
              className="w-full px-3 py-2 text-sm border border-gray-300 rounded-xl resize-none
                         focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent
                         text-gray-700 leading-relaxed placeholder:text-gray-300"
            />
          </div>
          <div className="flex gap-3 justify-end">
            <button onClick={() => setShowRevModal(false)}
                    className="px-4 py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">
              ì·¨ì†Œ
            </button>
            <button onClick={handleRevisionSubmit}
                    className="px-4 py-2 text-sm font-bold text-white bg-red-500 hover:bg-red-600 rounded-xl transition-colors flex items-center gap-2">
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              ìˆ˜ì • ìš”ì²­ ì „ì†¡
            </button>
          </div>
        </div>
      </Modal>

      {/* â”€â”€ ì´ë¯¸ì§€ ë¼ì´íŠ¸ë°•ìŠ¤ â”€â”€ */}
      <Modal open={!!lightbox} onClose={() => setLightbox(null)} maxW="max-w-4xl">
        <div className="relative">
          <div className="relative">
            <img src={lightbox} alt="CAD í™•ëŒ€" className="w-full object-contain rounded-t-2xl max-h-[80vh]" />
            {current?.status === "ìŠ¹ì¸í•´ì œ" && (
              <div className="absolute inset-0 flex items-center justify-center pointer-events-none rounded-t-2xl">
                <div className="absolute inset-0 bg-red-900/15 rounded-t-2xl"></div>
                <div className="relative z-10" style={{ transform: "rotate(-22deg)" }}>
                  <span className="text-red-600/65 font-black tracking-[0.3em] text-5xl"
                        style={{ textShadow:"0 0 20px rgba(255,255,255,0.95)", WebkitTextStroke:"1px rgba(180,0,0,0.3)" }}>
                    ìŠ¹ì¸ ì·¨ì†Œë¨
                  </span>
                </div>
              </div>
            )}
          </div>
          <div className="px-4 py-2 bg-gray-50 text-xs text-gray-400 text-center rounded-b-2xl">
            ë°”ê¹¥ í´ë¦­ ë˜ëŠ” ESCë¡œ ë‹«ê¸°
          </div>
          <button onClick={() => setLightbox(null)}
                  className="absolute top-3 right-3 w-8 h-8 bg-black/40 hover:bg-black/60 text-white rounded-full flex items-center justify-center transition-colors">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </Modal>
    </>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª©ëŒ€ íƒ­ â€” Section C: ìµœì¢… í™•ì • & ì˜ˆì™¸ ì²˜ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function MokdaeSectionC({ data, onToast, onConfirmChange, mokdaeProductionStarted = false }) {
  const [approved, setApproved]   = useState(data.consumerApproved);
  const [confirmed, setConfirmed] = useState(!!data.confirmedAt);

  /* â”€â”€ cross-tab ë™ê¸°í™”: factory.html ë“±ì—ì„œ ë°ì´í„° ë³€ê²½ ì‹œ ë°˜ì˜ â”€â”€ */
  useEffect(() => { setApproved(data.consumerApproved); }, [data.consumerApproved]);
  useEffect(() => { setConfirmed(!!data.confirmedAt); },  [data.confirmedAt]);

  /* â”€â”€ approved ë³€ê²½ â†’ ë¶€ëª¨ì— ì•Œë¦¼ (mount ìŠ¤í‚µ) â”€â”€ */
  const didMountC = useRef(false);
  useEffect(() => {
    if (!didMountC.current) { didMountC.current = true; return; }
    if (onConfirmChange) onConfirmChange({ consumerApproved: approved, confirmedAt: confirmed ? (data.confirmedAt || null) : null });
  }, [approved]);

  const handleConfirm = () => {
    if (!approved) {
      onToast({ type: "warning", title: "ì†Œë¹„ì ìŠ¹ì¸ í•„ìš”", message: "ì†Œë¹„ì ìŠ¹ì¸ ì²´í¬ë°•ìŠ¤ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”." });
      return;
    }
    setConfirmed(true);
    const now = new Date().toISOString();
    if (onConfirmChange) onConfirmChange({ consumerApproved: true, confirmedAt: now });
    onToast({ type: "success", title: "ìµœì¢… ë°œì£¼ í™•ì •", message: "ëŒ€ì‹œë³´ë“œ ëª©ëŒ€ ë°œì£¼ ìƒíƒœê°€ [ë°œì£¼í™•ì •]ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", duration: 5000 });
  };

  return (
    <div className={`rounded-xl overflow-hidden border-2 bg-white ${confirmed ? "border-emerald-300" : "border-brand/20"}`}>
      <SectionHeader
        color={confirmed ? "green" : "blue"}
        icon={<svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>}
        title="Section C Â· ì†Œë¹„ì ìµœì¢… ìŠ¹ì¸ ë° ë°œì£¼ í™•ì •"
        badge={confirmed ? <MokdaeStatusBadge status="ë°œì£¼í™•ì •" /> : null}
      />

      <div className="px-5 py-5 space-y-4">
        {/* ì†Œë¹„ì ìŠ¹ì¸ ì²´í¬ë°•ìŠ¤ */}
        <label className={`flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all ${
          approved ? "border-brand bg-brand-weak" : "border-gray-200 bg-gray-50 hover:border-brand/30 hover:bg-brand-weak/40"
        }`}>
          <div className="relative mt-1 flex-shrink-0">
            <input type="checkbox" checked={approved} onChange={e => setApproved(e.target.checked)}
                   disabled={confirmed} className="sr-only" />
            <div className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${
              approved ? "bg-brand border-brand" : "bg-white border-gray-400"
            }`}>
              {approved && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7"/></svg>}
            </div>
          </div>
          <div>
            <p className={`text-sm font-semibold ${approved ? "text-gray-800" : "text-gray-600"}`}>
              ì†Œë¹„ìê°€ ìµœì¢… ë„ë©´ì„ í™•ì¸í•˜ê³  ìŠ¹ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.
            </p>
            <p className="text-xs text-gray-400 mt-1">ì´ í•­ëª©ì„ ì²´í¬í•´ì•¼ ìµœì¢… ë°œì£¼ í™•ì • ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</p>
          </div>
        </label>

        {/* í™•ì • ë²„íŠ¼ */}
        <button onClick={handleConfirm} disabled={confirmed}
          className={`w-full py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300 ${
            confirmed
              ? "bg-emerald-500 text-white cursor-default shadow-sm shadow-emerald-100"
              : approved
              ? "bg-brand hover:bg-[#0090e6] text-white shadow-sm  hover:-translate-y-0.5"
              : "bg-gray-100 text-gray-400 cursor-not-allowed"
          }`}>
          {confirmed ? (
            <><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>ìµœì¢… ë°œì£¼ í™•ì • ì™„ë£Œ</>
          ) : (
            <><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>ìµœì¢… ë°œì£¼ í™•ì •</>
          )}
        </button>

        {/* ğŸ­ ì œì‘ ì§„í–‰ ì¤‘ ë°°ë„ˆ */}
        {mokdaeProductionStarted && confirmed && (
          <div className="flex items-center gap-3 bg-teal-50 border-2 border-teal-200 rounded-xl px-4 py-3.5">
            <div className="w-8 h-8 rounded-lg bg-teal-500 flex items-center justify-center flex-shrink-0">
              <svg className="w-4.5 h-4.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
            </div>
            <div>
              <p className="text-sm font-bold text-teal-800">ê³µì¥ì—ì„œ ì œì‘ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤</p>
              <p className="text-xs text-teal-600 mt-0.5">ì œì‘ ì§„í–‰ ì¤‘ì—ëŠ” ë°œì£¼ ë‚´ìš© ìˆ˜ì •ì´ ì œí•œë©ë‹ˆë‹¤. ê³µì¥ì—ì„œ ì œì‘ ì¤‘ë‹¨ ì‹œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
          </div>
        )}

        {/* ê¸´ê¸‰ ì¡°ì • Alert */}
        <div className="flex items-start gap-3 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
          <svg className="w-4 h-4 text-red-500 mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
          </svg>
          <p className="text-xs text-red-700 leading-relaxed">
            <span className="font-bold">âš ï¸ ì£¼ì˜</span>{"  "}ê³µì¥ ì œì‘ ì‹œì‘ ì „ê¹Œì§€ëŠ” ë‚´ìš© ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ë©°, ìˆ˜ì • ì‹œ{" "}
            <span className="font-bold text-red-800">'í™•ì • í›„ ì¡°ì •(ê¸´ê¸‰)'</span>{" "}ìƒíƒœë¡œ ì „í™˜ë©ë‹ˆë‹¤.
          </p>
        </div>

        {/* í™•ì • í›„ ì¡°ì¹˜ ë²„íŠ¼ë“¤ */}
        {confirmed && (
          <div className="pt-1">
            <p className="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wide">ë°œì£¼ í™•ì • í›„ ì¡°ì¹˜</p>
            <div className="flex gap-3">
              <button
                onClick={() => onToast({ type: "warning", title: "ê¸´ê¸‰ ì¡°ì • ìš”ì²­", message: "ê¸´ê¸‰ ì¡°ì • ìš”ì²­ì´ ê³µì¥ìœ¼ë¡œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.", duration: 4000 })}
                className="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-semibold
                           text-red-700 bg-red-50 hover:bg-red-100 border-2 border-red-200 hover:border-red-300
                           rounded-xl transition-all"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                </svg>
                ê¸´ê¸‰ ì¡°ì •
              </button>
              <button
                onClick={() => document.getElementById("section-d-anchor")?.scrollIntoView({ behavior: "smooth" })}
                className="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-semibold
                           text-amber-700 bg-amber-50 hover:bg-amber-100 border-2 border-amber-200 hover:border-amber-300
                           rounded-xl transition-all"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                ì¬ë§ˆê° ìš”ì²­ â†’
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª©ëŒ€ íƒ­ â€” Section D: ì¬ë§ˆê° ìš”ì²­ ì•„ì½”ë””ì–¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function MokdaeSectionD({ claims: initClaims, onToast, onClaimsChange }) {
  const [open, setOpen]     = useState(true);
  const [claims, setClaims] = useState(initClaims);

  /* â”€â”€ ë°ì´í„° ì˜ì†í™”: ë³€ê²½ â†’ ë¶€ëª¨(App)ë¡œ ì „ë‹¬ â†’ localStorage ì €ì¥ â”€â”€ */
  const didMountD = useRef(false);
  useEffect(() => {
    if (!didMountD.current) { didMountD.current = true; return; }
    if (onClaimsChange) onClaimsChange(claims);
  }, [claims]);

  /* â”€â”€ cross-tab ë™ê¸°í™” â”€â”€ */
  useEffect(() => {
    if (JSON.stringify(initClaims) !== JSON.stringify(claims)) setClaims(initClaims);
  }, [JSON.stringify(initClaims)]);
  const [newDate, setNewDate]       = useState("");
  const [newContent, setNewContent] = useState("");
  const [sending, setSending]       = useState(false);

  const statusStyle = {
    "ì¬ë§ˆê°ìš”ì²­": "bg-orange-100 text-orange-700 border-orange-200",
    "ì¬ë§ˆê°ì¡°ì •": "bg-amber-100 text-amber-700 border-amber-200",
    "ì¬ë§ˆê°í™•ì •": "bg-emerald-100 text-emerald-700 border-emerald-200",
  };

  const handleSend = () => {
    if (!newDate || !newContent.trim()) {
      onToast({ type: "warning", title: "ì…ë ¥ í™•ì¸", message: "í¬ë§ ì¼ì •ê³¼ ìš”ì²­ ì‚¬í•­ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”." });
      return;
    }
    setSending(true);
    setTimeout(() => {
      setClaims(prev => [...prev, {
        id: prev.length + 1, status: "ì¬ë§ˆê°ìš”ì²­",
        requestDate: newDate, requestContent: newContent,
        sentAt: "2026-02-25 (ë°©ê¸ˆ)", factoryReply: null,
      }]);
      setNewDate(""); setNewContent(""); setSending(false);
      onToast({ type: "success", title: "ì¬ë§ˆê° ìš”ì²­ ì „ì†¡ ì™„ë£Œ", message: "ê³µì¥ìœ¼ë¡œ ì¬ë§ˆê° ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤." });
    }, 800);
  };

  return (
    <div id="section-d-anchor" className="rounded-xl overflow-hidden border-2 border-dashed border-gray-300 bg-white">
      <button onClick={() => setOpen(p => !p)}
              className="w-full flex items-center justify-between px-5 py-4 hover:bg-gray-50 transition-colors">
        <div className="flex items-center gap-3">
          <div className="w-7 h-7 rounded-lg bg-amber-100 border border-amber-200 flex items-center justify-center flex-shrink-0">
            <svg className="w-4 h-4 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </div>
          <div className="text-left">
            <div className="flex items-center gap-2">
              <span className="text-sm font-bold text-gray-800">Section D Â· í˜„ì¥ ì¬ë§ˆê° ìš”ì²­</span>
              {claims.length > 0 && (
                <span className="text-xs font-bold px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 border border-amber-200">{claims.length}ê±´</span>
              )}
            </div>
            <p className="text-xs text-gray-400 mt-1">í•­ìƒ ì¶”ê°€ ìš”ì²­ ê°€ëŠ¥ Â· ê³µì¥ìœ¼ë¡œ ì§ì ‘ ì „ì†¡</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {claims.some(c => c.status === "ì¬ë§ˆê°ì¡°ì •") && (
            <span className="flex items-center gap-2 text-xs font-bold text-amber-700 bg-amber-100 border border-amber-200 px-2 py-1 rounded-full">
              <span className="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span>
              ì¬ë§ˆê° ì¡°ì • (ê³µì¥ í™•ì¸ ëŒ€ê¸°ì¤‘)
            </span>
          )}
          <svg className={`w-5 h-5 text-gray-400 transition-transform duration-200 ${open ? "rotate-180" : ""}`}
               fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>

      {open && (
        <div className="border-t border-gray-200">
          {/* ê¸°ì¡´ ìš”ì²­ */}
          {claims.length > 0 && (
            <div className="px-5 pt-4 pb-2 space-y-3">
              <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide">ì „ì†¡ëœ ì¬ë§ˆê° ìš”ì²­</p>
              {claims.map(claim => (
                <div key={claim.id} className="rounded-xl border border-gray-200 overflow-hidden">
                  <div className="flex items-center justify-between px-4 py-2 bg-gray-50 border-b border-gray-100">
                    <div className="flex items-center gap-2 text-xs text-gray-500">
                      <span className="font-semibold text-gray-700">#{claim.id}</span>
                      <span>Â·</span>
                      <span>í¬ë§ì¼: <b className="text-gray-700">{claim.requestDate}</b></span>
                      <span>Â·</span>
                      <span>{claim.sentAt}</span>
                    </div>
                    <span className={`text-xs font-semibold px-2 py-1 rounded-full border ${statusStyle[claim.status] || ""}`}>
                      {claim.status}
                    </span>
                  </div>
                  <div className="px-4 py-3 bg-white space-y-2">
                    <p className="text-sm text-gray-700">{claim.requestContent}</p>
                    {claim.factoryReply && (
                      <div className="flex items-start gap-2 bg-brand-weak border border-brand/10 rounded-lg px-3 py-2">
                        <svg className="w-3.5 h-3.5 text-brand mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                        <p className="text-xs text-gray-600 leading-relaxed">{claim.factoryReply}</p>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
          {claims.length > 0 && <div className="mx-5 my-3 border-t border-dashed border-gray-200"></div>}

          {/* ì‹ ê·œ í¼ */}
          <div className="px-5 pb-5 space-y-3">
            <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide flex items-center gap-2">
              <svg className="w-3.5 h-3.5 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>ì‹ ê·œ ì¬ë§ˆê° ìš”ì²­ ì‘ì„±
            </p>
            <div>
              <label className="block text-xs text-gray-500 font-medium mb-1.5">ì¬ë§ˆê° í¬ë§ ì¼ì •</label>
              <input type="date" value={newDate} onChange={e => setNewDate(e.target.value)}
                     className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent" />
            </div>
            <div>
              <label className="block text-xs text-gray-500 font-medium mb-1.5">ìš”ì²­ ì‚¬í•­</label>
              <textarea value={newContent} onChange={e => setNewContent(e.target.value)} rows={3}
                        placeholder="ê³µì¥ì— ì „ë‹¬í•  ì¬ë§ˆê° ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."
                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent text-gray-700 leading-relaxed placeholder:text-gray-300" />
            </div>
            <div className="flex justify-end">
              <button onClick={handleSend} disabled={sending}
                      className="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-amber-500 hover:bg-amber-600 disabled:bg-amber-300 rounded-xl shadow-sm transition-all">
                {sending ? (
                  <><svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>ì „ì†¡ ì¤‘â€¦</>
                ) : (
                  <><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>ê³µì¥ìœ¼ë¡œ ì „ì†¡</>
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê¸°ê¸° íƒ­ â€” ìì¬ DB (Supabaseì—ì„œ ë¡œë“œ, ì‹¤íŒ¨ ì‹œ í•˜ë“œì½”ë”© í´ë°±)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GIGI_DB_FALLBACK = {};

const SUPABASE_URL = "https://ykifurzrrbjrgjrznimk.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlraWZ1cnpycmJqcmdqcnpuaW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjE3NTcsImV4cCI6MjA4NzY5Nzc1N30.BVTlrG_Q_cXqj6qOa_rZPXrCs7MhwuR9o8koncGoUU0";

function useGigiDb() {
  const [gigiDb, setGigiDb] = useState({});
  const [loading, setLoading] = useState(true);
  const [dbSource, setDbSource] = useState("empty"); // "db" or "empty"

  useEffect(() => {
    (async () => {
      const GIGI_MAIN_CATEGORIES = ["ì‹±í¬ë³¼", "ìˆ˜ì „", "í›„ë“œ", "ì¿¡íƒ‘"];
      try {
        // ê¸°ê¸° 4ê°œ ì¹´í…Œê³ ë¦¬ + ë‚˜ë¨¸ì§€(ê¸°íƒ€)ë¥¼ ê°ê° ë¡œë“œ (1000í–‰ ì œí•œ ìš°íšŒ)
        const gigiFilter = GIGI_MAIN_CATEGORIES.map(c => `category.eq.${c}`).join(",");
        const etcFilter = GIGI_MAIN_CATEGORIES.map(c => `category.neq.${c}`).join("&");
        const headers = { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` };
        const [gigiRes, etcRes] = await Promise.all([
          fetch(`${SUPABASE_URL}/rest/v1/materials?select=category,item_name&or=(${gigiFilter})&order=category,item_name&limit=5000`, { headers }),
          fetch(`${SUPABASE_URL}/rest/v1/materials?select=category,item_name&${etcFilter}&order=category,item_name&limit=5000`, { headers }),
        ]);
        if (!gigiRes.ok || !etcRes.ok) throw new Error("fetch failed");
        const rows = [...(await gigiRes.json()), ...(await etcRes.json())];
        if (rows.length === 0) {
          setDbSource("empty");
          setLoading(false);
          return;
        }
        // Group by category â€” ì‹±í¬ë³¼/ìˆ˜ì „/í›„ë“œ/ì¿¡íƒ‘ ì€ ê°œë³„, ë‚˜ë¨¸ì§€ëŠ” ê¸°íƒ€
        const grouped = {};
        rows.forEach(r => {
          const cat = GIGI_MAIN_CATEGORIES.includes(r.category) ? r.category : "ê¸°íƒ€";
          if (!grouped[cat]) grouped[cat] = [];
          // item_name = ê±´ìì¬í•­ëª©(ë“œë¡­ë‹¤ìš´ìš©) ì¹¼ëŸ¼ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          grouped[cat].push(r.item_name);
        });
        // ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³´ì¥: ì¿¡íƒ‘, í›„ë“œ, ìˆ˜ì „, ì‹±í¬ë³¼, ê¸°íƒ€
        const ordered = {};
        [...GIGI_MAIN_CATEGORIES, "ê¸°íƒ€"].forEach(cat => {
          if (grouped[cat]) ordered[cat] = grouped[cat];
        });
        setGigiDb(ordered);
        setDbSource("db");
      } catch (e) {
        console.warn("ìì¬ DB ë¡œë“œ ì‹¤íŒ¨:", e);
        setDbSource("empty");
      }
      setLoading(false);
    })();
  }, []);

  return { gigiDb, loading, dbSource };
}

/* â”€â”€ ê¸°ê¸° íƒ­ ì´ˆê¸° ì„ íƒ ìƒíƒœ (ë™ì  ì¹´í…Œê³ ë¦¬ ê¸°ë°˜) â”€â”€ */
function buildInitialSelections(gigiDb) {
  const init = {};
  Object.keys(gigiDb).forEach(key => {
    init[key] = { mode: "select", value: "", custom: "" };
  });
  return init;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê¸°ê¸° íƒ­ â€” SearchableSelect ì½¤ë³´ë°•ìŠ¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SearchableSelect({ category, options, state, onChange, onToast }) {
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState("");
  const [showCustomInput, setShowCustomInput] = useState(state.mode === "custom");
  const [customText, setCustomText] = useState(state.custom || "");
  const [selectedValue, setSelectedValue] = useState(state.value || "");
  const containerRef = useRef(null);
  const inputRef = useRef(null);
  const customInputRef = useRef(null);

  /* ì™¸ë¶€ í´ë¦­ ë‹«ê¸° */
  useEffect(() => {
    const fn = e => {
      if (containerRef.current && !containerRef.current.contains(e.target)) {
        setOpen(false);
        setQuery("");
      }
    };
    document.addEventListener("mousedown", fn);
    return () => document.removeEventListener("mousedown", fn);
  }, []);

  /* ì—´ë¦´ ë•Œ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ */
  useEffect(() => {
    if (open && inputRef.current) inputRef.current.focus();
  }, [open]);

  /* ì§ì ‘ì…ë ¥ ì „í™˜ ì‹œ í¬ì»¤ìŠ¤ */
  useEffect(() => {
    if (showCustomInput && customInputRef.current) {
      setTimeout(() => customInputRef.current?.focus(), 60);
    }
  }, [showCustomInput]);

  const filtered = query.trim()
    ? options.filter(o => o.toLowerCase().includes(query.toLowerCase()))
    : options;

  const handleSelectOption = (opt) => {
    setSelectedValue(opt);
    setShowCustomInput(false);
    setCustomText("");
    setOpen(false);
    setQuery("");
    onChange({ mode: "select", value: opt, custom: "" });
  };

  const handleSelectCustom = () => {
    setSelectedValue("__custom__");
    setShowCustomInput(true);
    setOpen(false);
    setQuery("");
    onChange({ mode: "custom", value: "__custom__", custom: customText });
  };

  const handleClear = () => {
    setSelectedValue("");
    setCustomText("");
    setShowCustomInput(false);
    onChange({ mode: "select", value: "", custom: "" });
  };

  const handleCustomChange = (val) => {
    setCustomText(val);
    onChange({ mode: "custom", value: "__custom__", custom: val });
  };

  /* í‘œì‹œ í…ìŠ¤íŠ¸ */
  const displayLabel = selectedValue === "__custom__"
    ? (customText || "ì§ì ‘ ì…ë ¥ ì¤‘â€¦")
    : selectedValue || null;

  const isCustomMode = selectedValue === "__custom__";
  const isEmpty = !selectedValue;

  /* ë°°ì§€ ìƒ‰ìƒ */
  const triggerBorder = isCustomMode
    ? "border-purple-400 bg-purple-50"
    : isEmpty
      ? "border-gray-300 bg-white"
      : "border-emerald-400 bg-emerald-50";

  return (
    <div ref={containerRef} className="relative">
      {/* â”€â”€ íŠ¸ë¦¬ê±° ë²„íŠ¼ â”€â”€ */}
      <button
        type="button"
        onClick={() => { setOpen(o => !o); setQuery(""); }}
        className={`w-full flex items-center gap-2 px-4 py-3 rounded-xl border-2 text-sm text-left transition-all
          ${triggerBorder}
          ${open ? "ring-2 ring-brand ring-offset-1" : "hover:border-gray-400"}
        `}
      >
        {/* ìƒíƒœ ë„íŠ¸ */}
        <span className={`w-2 h-2 rounded-full flex-shrink-0 ${
          isCustomMode ? "bg-purple-500" : isEmpty ? "bg-gray-300" : "bg-emerald-500"
        }`}></span>

        <span className={`flex-1 min-w-0 break-words whitespace-normal text-left ${isEmpty ? "text-gray-400" : isCustomMode ? "text-purple-700 font-medium" : "text-gray-800 font-medium"}`}>
          {displayLabel ?? "ë¯¸ë°œì£¼"}
        </span>

        {/* í´ë¦¬ì–´ ë²„íŠ¼ */}
        {!isEmpty && (
          <span
            role="button"
            onClick={e => { e.stopPropagation(); handleClear(); }}
            className="flex-shrink-0 w-5 h-5 flex items-center justify-center rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors"
          >
            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </span>
        )}

        {/* í™”ì‚´í‘œ */}
        <svg
          className={`w-4 h-4 text-gray-400 flex-shrink-0 transition-transform duration-200 ${open ? "rotate-180" : ""}`}
          fill="none" viewBox="0 0 24 24" stroke="currentColor"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {/* â”€â”€ ë“œë¡­ë‹¤ìš´ íŒ¨ë„ â”€â”€ */}
      {open && (
        <div className="absolute z-30 mt-1.5 w-full min-w-[320px] bg-white border border-gray-200 rounded-xl shadow overflow-hidden"
          style={{ maxHeight: 320 }}>

          {/* ê²€ìƒ‰ ì…ë ¥ */}
          <div className="px-3 py-2 border-b border-gray-100 sticky top-0 bg-white">
            <div className="relative">
              <svg className="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z" />
              </svg>
              <input
                ref={inputRef}
                type="text"
                value={query}
                onChange={e => setQuery(e.target.value)}
                placeholder={`${category} ê²€ìƒ‰â€¦`}
                className="w-full pl-8 pr-3 py-1.5 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
              />
            </div>
          </div>

          {/* ì˜µì…˜ ëª©ë¡ */}
          <div className="overflow-y-auto" style={{ maxHeight: 240 }}>
            {/* ë¯¸ë°œì£¼ (ê¸°ë³¸ê°’) */}
            <button
              type="button"
              onClick={() => handleClear()}
              className={`w-full text-left px-4 py-2 text-sm flex items-center gap-2 transition-colors
                ${isEmpty ? "bg-gray-100 font-semibold text-gray-700" : "text-gray-400 hover:bg-gray-50"}`}
            >
              <span className="w-1.5 h-1.5 rounded-full bg-gray-300 flex-shrink-0"></span>
              ë¯¸ë°œì£¼
              {isEmpty && (
                <svg className="w-3.5 h-3.5 text-gray-500 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                </svg>
              )}
            </button>

            {/* êµ¬ë¶„ì„  */}
            <div className="mx-3 border-t border-gray-100"></div>

            {/* í•„í„°ëœ ì˜µì…˜ */}
            {filtered.length === 0 && (
              <p className="px-4 py-3 text-xs text-gray-400 text-center">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>
            )}
            {filtered.map(opt => {
              const isSelected = selectedValue === opt;
              return (
                <button
                  key={opt}
                  type="button"
                  onClick={() => handleSelectOption(opt)}
                  className={`w-full text-left px-4 py-2 text-sm flex items-start gap-2 transition-colors
                    ${isSelected
                      ? "bg-emerald-50 text-emerald-800 font-semibold"
                      : "text-gray-700 hover:bg-brand-weak hover:text-[#0090e6]"
                    }`}
                >
                  <span className={`w-1.5 h-1.5 rounded-full mt-1.5 flex-shrink-0 ${isSelected ? "bg-emerald-500" : "bg-gray-300"}`}></span>
                  <span className="leading-snug break-words">{opt}</span>
                  {isSelected && (
                    <svg className="w-3.5 h-3.5 text-emerald-600 ml-auto flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                    </svg>
                  )}
                </button>
              );
            })}

            {/* êµ¬ë¶„ì„  */}
            <div className="mx-3 border-t border-gray-100"></div>

            {/* [+ ì§ì ‘ ì…ë ¥] ê³ ì • ì˜µì…˜ */}
            <button
              type="button"
              onClick={handleSelectCustom}
              className={`w-full text-left px-4 py-2 text-sm flex items-center gap-2 transition-colors
                ${isCustomMode
                  ? "bg-purple-50 text-purple-700 font-semibold"
                  : "text-purple-600 hover:bg-purple-50"
                }`}
            >
              <span className="w-1.5 h-1.5 rounded-full bg-purple-400 flex-shrink-0"></span>
              <span>+ ì§ì ‘ ì…ë ¥</span>
              {isCustomMode && (
                <svg className="w-3.5 h-3.5 text-purple-600 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                </svg>
              )}
            </button>
          </div>
        </div>
      )}

      {/* â”€â”€ ì§ì ‘ ì…ë ¥ í…ìŠ¤íŠ¸ í•„ë“œ (Transition) â”€â”€ */}
      <div
        className="overflow-hidden transition-all duration-300 ease-in-out"
        style={{
          maxHeight: showCustomInput ? "120px" : "0px",
          opacity: showCustomInput ? 1 : 0,
          marginTop: showCustomInput ? "8px" : "0px",
        }}
      >
        <div className="flex items-center gap-2 px-4 py-3 rounded-xl border-2 border-purple-300 bg-purple-50 focus-within:ring-2 focus-within:ring-purple-400 focus-within:ring-offset-1 transition-all">
          <svg className="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          <input
            ref={customInputRef}
            type="text"
            value={customText}
            onChange={e => handleCustomChange(e.target.value)}
            placeholder="ëª¨ë¸ëª… ë˜ëŠ” ìŠ¤í™ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”â€¦"
            className="flex-1 text-sm bg-transparent focus:outline-none text-purple-800 placeholder:text-purple-300 font-medium"
          />
          {customText && (
            <button
              type="button"
              onClick={() => handleCustomChange("")}
              className="flex-shrink-0 text-purple-300 hover:text-purple-600 transition-colors"
            >
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê¸°ê¸° íƒ­ â€” GigiTab
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GIGI_CATEGORY_ICONS = {
  ì¿¡íƒ‘:   { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 14v6m-3-3h6M6 10h.01M6 14h.01M10 12h.01M14 12h.01M10 8h.01M6 6h12a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2z" /></svg>, color: "text-rose-600", bg: "bg-rose-100" },
  í›„ë“œ:   { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h18v4l-6 6v6H9v-6L3 8V4z" /></svg>, color: "text-sky-600", bg: "bg-sky-100" },
  ìˆ˜ì „:   { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m7-9h1M3 12H2m15.07-6.07.71-.71M6.93 17.07l-.71.71M17.07 17.07l.71.71M6.93 6.93l-.71-.71M12 8a4 4 0 100 8 4 4 0 000-8z" /></svg>, color: "text-teal-600", bg: "bg-teal-100" },
  ì‹±í¬ë³¼: { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5zm7-10v6m0 0l-2-2m2 2l2-2" /></svg>, color: "text-brand", bg: "bg-brand-weak" },
  ê¸°íƒ€:   { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2zm7 4v6m0 0l-2-2m2 2l2-2" /></svg>, color: "text-amber-600", bg: "bg-amber-100" },
};
const DEFAULT_CAT_STYLE = { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>, color: "text-gray-600", bg: "bg-gray-100" };

function GigiTab({ onToast, onGigiOrderSubmit, gigiOrderData }) {
  const { gigiDb, loading, dbSource } = useGigiDb();
  const [selections, setSelections] = useState({});
  const [submitting, setSubmitting] = useState(false);
  const [gigiDate, setGigiDate] = useState("");

  /* ë°œì£¼ ìƒíƒœ íŒŒìƒ */
  const orderStatus = gigiOrderData?.status || null; // null | "ë°œì£¼ìš”ì²­ì™„ë£Œ" | "ë°œì£¼í™•ì •" | "ë°œì£¼ìš”ì²­ë°˜ë ¤"
  const isSubmitted = orderStatus === "ë°œì£¼ìš”ì²­ì™„ë£Œ";
  const isApproved  = orderStatus === "ë°œì£¼í™•ì •";
  const isRejected  = orderStatus === "ë°œì£¼ìš”ì²­ë°˜ë ¤";
  const isLocked    = isSubmitted || isApproved; // ìˆ˜ì • ë¶ˆê°€
  const canSubmit   = !isLocked; // ìµœì´ˆ ë˜ëŠ” ë°˜ë ¤ í›„ ì¬ë°œì£¼ ê°€ëŠ¥

  /* gigiDb ë¡œë“œ ì™„ë£Œ ì‹œ selections ì´ˆê¸°í™” */
  useEffect(() => {
    if (gigiOrderData?.items && Object.keys(gigiDb).length > 0) {
      // ê¸°ì¡´ ë°œì£¼ ë°ì´í„° ë³µì›
      const restored = {};
      gigiOrderData.items.forEach(item => {
        restored[item.category] = { mode: item.mode, value: item.value, custom: item.custom || "" };
      });
      // DBì˜ ì¹´í…Œê³ ë¦¬ ì¤‘ ë³µì›ë˜ì§€ ì•Šì€ ê²ƒ ì´ˆê¸°í™”
      Object.keys(gigiDb).forEach(k => {
        if (!restored[k]) restored[k] = { mode: "select", value: "", custom: "" };
      });
      setSelections(restored);
      setGigiDate(gigiOrderData.requestedDate || "");
    } else {
      setSelections(buildInitialSelections(gigiDb));
    }
  }, [gigiDb]);

  /* ë°˜ë ¤ ì‹œ selections/date ìœ ì§€í•˜ë˜ í¸ì§‘ ê°€ëŠ¥ */

  const handleChange = useCallback((cat, newState) => {
    setSelections(prev => ({ ...prev, [cat]: newState }));
  }, []);

  /* ì„ íƒëœ í•­ëª© ìš”ì•½ */
  const selectedItems = Object.entries(selections).filter(([_, s]) =>
    (s.mode === "select" && s.value) || (s.mode === "custom" && s.custom.trim())
  );
  const selectedCount = selectedItems.length;

  const handleDateChange = (val) => setGigiDate(val);

  const handleSubmit = () => {
    if (!canSubmit) return;
    if (selectedCount === 0) {
      onToast({ type: "warning", title: "ì„ íƒ í•­ëª© ì—†ìŒ", message: "ìµœì†Œ 1ê°œ ì´ìƒì˜ ê¸°ê¸°ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”." });
      return;
    }
    if (!gigiDate) {
      onToast({ type: "warning", title: "ë‚©ê¸° ì¼ì • ë¯¸ì„ íƒ", message: "ê¸°ê¸° ë‚©ê¸° ì¼ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”." });
      return;
    }
    setSubmitting(true);
    setTimeout(() => {
      setSubmitting(false);
      const items = selectedItems.map(([cat, s]) => ({
        category: cat,
        mode: s.mode,
        value: s.value,
        custom: s.custom || "",
      }));
      if (onGigiOrderSubmit) onGigiOrderSubmit({
        items,
        requestedDate: gigiDate,
        status: "ë°œì£¼ìš”ì²­ì™„ë£Œ",
        submittedAt: new Date().toISOString(),
        rejectionReason: "",
        rejectedAt: "",
      });
      onToast({
        type: "success",
        title: "ê¸°ê¸° ë°œì£¼ ìš”ì²­ ì™„ë£Œ",
        message: `${selectedCount}ê°œ ê¸°ê¸°ì˜ ë°œì£¼ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. í¬ë§ ë‚©ê¸°: ${gigiDate}`,
        duration: 5000,
      });
    }, 1800);
  };

  const today = new Date().toISOString().slice(0, 10);

  return (
    <div className="p-5 max-w-2xl space-y-5">

      {/* â”€â”€ ì„¹ì…˜ í—¤ë” â”€â”€ */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="w-7 h-7 rounded-xl bg-gray-800 flex items-center justify-center flex-shrink-0">
            <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18" />
            </svg>
          </div>
          <div>
            <h3 className="text-sm font-bold text-gray-800">ê¸°ê¸° ë°œì£¼ ì„ íƒ</h3>
            <p className="text-xs text-gray-400 mt-1">ìì¬ DBì—ì„œ ê¸°ê¸°ë¥¼ ê²€ìƒ‰í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {selectedCount > 0 && (
            <span className="flex items-center gap-2 text-xs font-bold text-emerald-700 bg-emerald-100 border border-emerald-200 px-3 py-1 rounded-full">
              <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
              {selectedCount}ê°œ ì„ íƒë¨
            </span>
          )}
          {orderStatus && (
            <span className={`text-xs font-bold px-2.5 py-1 rounded-full border ${
              isApproved ? "bg-emerald-100 text-emerald-700 border-emerald-200" :
              isRejected ? "bg-red-100 text-red-700 border-red-200" :
              "bg-brand-weak text-brand border-brand/20"
            }`}>
              {orderStatus}
            </span>
          )}
        </div>
      </div>

      {/* â”€â”€ ë°˜ë ¤ ì‚¬ìœ  ë°°ë„ˆ â”€â”€ */}
      {isRejected && gigiOrderData?.rejectionReason && (
        <div className="bg-red-50 border-2 border-red-200 rounded-xl px-5 py-4 space-y-2">
          <div className="flex items-center gap-2">
            <svg className="w-5 h-5 text-red-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
            <p className="text-sm font-bold text-red-700">ë°œì£¼ê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤</p>
          </div>
          <div className="bg-white/80 rounded-lg px-4 py-3 border border-red-100">
            <p className="text-xs font-semibold text-red-600 mb-1">ë°˜ë ¤ ì‚¬ìœ </p>
            <p className="text-sm text-gray-700 leading-relaxed">{gigiOrderData.rejectionReason}</p>
          </div>
          {gigiOrderData.rejectedAt && (
            <p className="text-xs text-red-400">ë°˜ë ¤ ì¼ì‹œ: {new Date(gigiOrderData.rejectedAt).toLocaleString("ko-KR")}</p>
          )}
          <p className="text-xs text-red-600 font-medium">ì•„ë˜ í•­ëª©ì„ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ë°œì£¼ ìš”ì²­í•´ì£¼ì„¸ìš”.</p>
        </div>
      )}

      {/* â”€â”€ ìŠ¹ì¸ ì™„ë£Œ ë°°ë„ˆ â”€â”€ */}
      {isApproved && (
        <div className="flex items-center gap-3 bg-emerald-50 border-2 border-emerald-200 rounded-xl px-5 py-4">
          <div className="w-10 h-10 rounded-xl bg-emerald-500 flex items-center justify-center flex-shrink-0">
            <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div>
            <p className="text-sm font-bold text-emerald-800">ê¸°ê¸° ë°œì£¼ í™•ì •</p>
            <p className="text-xs text-emerald-600 mt-0.5">ê³µê¸‰ì—…ì²´ê°€ ë°œì£¼ë¥¼ ìŠ¹ì¸í–ˆìŠµë‹ˆë‹¤. ë‚©ê¸° ì¼ì •: <span className="font-bold">{gigiOrderData?.requestedDate}</span></p>
          </div>
        </div>
      )}

      {/* â”€â”€ ë°œì£¼ ìš”ì²­ ì¤‘ ë°°ë„ˆ â”€â”€ */}
      {isSubmitted && (
        <div className="flex items-center gap-2 bg-brand-weak border border-brand/20 rounded-xl px-4 py-3">
          <svg className="w-4 h-4 text-brand flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p className="text-xs text-brand leading-relaxed">
            <span className="font-bold">ë°œì£¼ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.</span> ê³µê¸‰ì—…ì²´ì˜ ìŠ¹ì¸ì„ ëŒ€ê¸°í•˜ê³  ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
      )}

      {/* â”€â”€ ì•ˆë‚´ ë°°ë„ˆ â”€â”€ */}
      {canSubmit && (
        <div className="flex items-start gap-2 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3">
          <svg className="w-4 h-4 text-gray-400 mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p className="text-xs text-gray-500 leading-relaxed">
            ê¸°ë³¸ê°’ì€ <span className="font-semibold text-gray-700">ë¯¸ë°œì£¼</span>ì…ë‹ˆë‹¤. ë“œë¡­ë‹¤ìš´ì„ ëˆŒëŸ¬ ìì¬ DBì—ì„œ ê²€ìƒ‰í•˜ê±°ë‚˜,
            ëª©ë¡ í•˜ë‹¨ì˜ <span className="font-semibold text-purple-700">+ ì§ì ‘ ì…ë ¥</span>ìœ¼ë¡œ ëª¨ë¸ëª…ì„ ì§ì ‘ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
      )}

      {/* â”€â”€ DB ì¶œì²˜ ì•ˆë‚´ â”€â”€ */}
      {dbSource === "db" && (
        <div className="flex items-center gap-2 text-xs text-emerald-600 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2">
          <svg className="w-3.5 h-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
          <span>ì—…ë¡œë“œëœ ìì¬ DBë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.</span>
        </div>
      )}
      {dbSource === "empty" && !loading && canSubmit && (
        <div className="flex items-start gap-3 bg-amber-50 border border-amber-200 rounded-xl px-4 py-4">
          <svg className="w-5 h-5 text-amber-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
          </svg>
          <div>
            <p className="text-sm font-semibold text-amber-800">ìì¬ DBê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤</p>
            <p className="text-xs text-amber-600 mt-1">ëŒ€ì‹œë³´ë“œ ìƒë‹¨ì˜ <span className="font-bold">ìì¬ DB ì—…ë°ì´íŠ¸</span> ë²„íŠ¼ìœ¼ë¡œ ì—‘ì…€/CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
          </div>
        </div>
      )}

      {/* â”€â”€ ë¡œë”© â”€â”€ */}
      {loading && (
        <div className="flex items-center justify-center py-8 gap-2 text-gray-400 text-sm">
          <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          ìì¬ DB ë¡œë”© ì¤‘â€¦
        </div>
      )}

      {/* â”€â”€ ì¹´í…Œê³ ë¦¬ í¼ â”€â”€ */}
      {!loading && (
      <div className={`bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm divide-y divide-gray-100 ${isLocked ? "opacity-60 pointer-events-none" : ""}`}>
        {Object.keys(gigiDb).map(catKey => {
          const sel = selections[catKey] || { mode: "select", value: "", custom: "" };
          const isSet = sel.value && (sel.mode === "select" || sel.custom.trim());
          const catStyle = GIGI_CATEGORY_ICONS[catKey] || DEFAULT_CAT_STYLE;

          return (
            <div key={catKey} className={`px-5 py-4 transition-colors ${isSet ? "bg-white" : "bg-gray-50/50"}`}>
              {/* ì¹´í…Œê³ ë¦¬ ë¼ë²¨ */}
              <div className="flex items-center gap-2 mb-3">
                <span className={`w-6 h-6 rounded-lg ${catStyle.bg} ${catStyle.color} flex items-center justify-center flex-shrink-0`}>
                  {catStyle.icon}
                </span>
                <span className="text-sm font-bold text-gray-800">{catKey}</span>

                {/* ìƒíƒœ ë±ƒì§€ */}
                {sel.mode === "custom" && sel.custom.trim() ? (
                  <span className="ml-auto text-xs font-semibold text-purple-600 bg-purple-100 border border-purple-200 px-2 py-0.5 rounded-full">
                    ì§ì ‘ ì…ë ¥
                  </span>
                ) : sel.value ? (
                  <span className="ml-auto text-xs font-semibold text-emerald-600 bg-emerald-100 border border-emerald-200 px-2 py-0.5 rounded-full">
                    ì„ íƒë¨
                  </span>
                ) : (
                  <span className="ml-auto text-xs text-gray-400 bg-gray-100 border border-gray-200 px-2 py-0.5 rounded-full">
                    ë¯¸ë°œì£¼
                  </span>
                )}
              </div>

              {/* Searchable Select */}
              <SearchableSelect
                category={catKey}
                options={gigiDb[catKey] || []}
                state={sel}
                onChange={newState => handleChange(catKey, newState)}
                onToast={onToast}
              />
            </div>
          );
        })}
      </div>
      )}

      {/* â”€â”€ ë‚©ê¸° ì¼ì • ì„ íƒ â”€â”€ */}
      <div className={`bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm ${isLocked ? "opacity-60 pointer-events-none" : ""}`}>
        <div className="px-5 py-4">
          <div className="flex items-center gap-2 mb-3">
            <span className="w-6 h-6 rounded-lg bg-brand-weak text-brand flex items-center justify-center flex-shrink-0">
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </span>
            <span className="text-sm font-bold text-gray-800">í¬ë§ ë‚©ê¸° ì¼ì •</span>
            {gigiDate && (
              <span className="ml-auto text-xs font-semibold text-brand bg-brand-weak border border-brand/20 px-2 py-0.5 rounded-full">
                {gigiDate}
              </span>
            )}
          </div>
          <input
            type="date"
            value={gigiDate}
            min={today}
            onChange={e => handleDateChange(e.target.value)}
            className="w-full px-3 py-2 text-sm border border-gray-200 bg-white text-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
          />
          {!gigiDate && (
            <p className="text-xs text-gray-400 mt-2">ê³µê¸‰ì—…ì²´ê°€ ìŠ¹ì¸í•˜ë©´ ì´ ì¼ì •ì´ ê³µì •ì¼ì •ì— í™•ì • ë°˜ì˜ë©ë‹ˆë‹¤.</p>
          )}
        </div>
      </div>

      {/* â”€â”€ ë°œì£¼ ìš”ì²­ ë²„íŠ¼ â”€â”€ */}
      <div className="pt-1">
        <button
          onClick={handleSubmit}
          disabled={submitting || isLocked}
          className={`w-full py-4 rounded-2xl text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300
            ${isApproved
              ? "btn-confirm-done text-white cursor-default shadow-sm"
              : isSubmitted
                ? "bg-gray-200 text-gray-400 cursor-default"
                : submitting
                  ? "bg-brand text-white cursor-wait shadow-md"
                  : "bg-brand hover:bg-[#0090e6] text-white shadow-sm hover:shadow hover:-translate-y-0.5"
            }`}
        >
          {submitting ? (
            <>
              <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              ë°œì£¼ ìš”ì²­ ì²˜ë¦¬ ì¤‘â€¦
            </>
          ) : isApproved ? (
            <>
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              ë°œì£¼ í™•ì • ì™„ë£Œ
            </>
          ) : isSubmitted ? (
            <>
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
            </>
          ) : isRejected ? (
            <>
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              ìˆ˜ì • í›„ ì¬ë°œì£¼ ìš”ì²­
            </>
          ) : (
            <>
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              ê¸°ê¸° ë°œì£¼ ìš”ì²­
            </>
          )}
        </button>
      </div>

      <div className="h-4"></div>
    </div>
  );
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒíŒ íƒ­ â€” Section A: ë°œì£¼ ì„œë¥˜ ì—…ë¡œë“œ + ë²„ì „ ê´€ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SangpanSectionA({ versions: initVersions, activeVer: initActive, onToast, onStatusChange, silcheukImages = [], onSangpanSchedule, uploadedFiles: initUploadedFiles = {}, onVersionsChange, silcheukFinalDate = "", sangpanProductionStarted = false }) {
  const [versions, setVersions]     = useState(initVersions);
  const [activeVer, setActiveVer]   = useState(initActive);
  const [uploadedFiles, setUploadedFiles] = useState(initUploadedFiles); // versionNo â†’ [{id,name,size,url,isImage}]
  const [dragging, setDragging]     = useState(false);
  const [silcheukOpen, setSilcheukOpen] = useState(true);
  const [lightbox, setLightbox]     = useState(null); // { url, name } | null
  const fileInputRef = useRef(null);

  const current       = versions.find(v => v.versionNo === activeVer);
  const isNewVersion  = current?.isNew === true;
  const currentFiles  = uploadedFiles[activeVer] || [];
  const submittedVers = versions.filter(v => !v.isNew);
  const badgeStatus   = submittedVers.length > 0 ? "ë°œì£¼ìš”ì²­ì™„ë£Œ" : "ë°œì£¼ìš”ì²­ëŒ€ê¸°";

  /* ESC â†’ ë¼ì´íŠ¸ë°•ìŠ¤ ë‹«ê¸° */
  useEffect(() => {
    const fn = (e) => { if (e.key === "Escape") setLightbox(null); };
    document.addEventListener("keydown", fn);
    return () => document.removeEventListener("keydown", fn);
  }, []);

  /* ë°œì£¼ ìƒíƒœ ë³€ê²½ ì‹œ ë¶€ëª¨ì— ì•Œë¦¼ â†’ ëŒ€ì‹œë³´ë“œ ìë™ ì—°ë™ */
  useEffect(() => {
    onStatusChange && onStatusChange("sangpan", badgeStatus);
  }, [badgeStatus]);

  /* ê³µì¥ ìŠ¹ì¸(factoryChecked)ëœ ìµœì‹  ë²„ì „ì˜ ìƒíŒ ì¼ì •ì„ ë¶€ëª¨ì— ì „ë‹¬
     â†’ Appì´ schedule.mokdae + mokdaeFinalDateì— ì €ì¥ â†’ LeftPanelÂ·index.html ìë™ ë°˜ì˜ */
  useEffect(() => {
    if (!onSangpanSchedule) return;
    const approved = versions
      .filter(v => !v.isNew && v.factoryChecked)
      .sort((a, b) => b.versionNo - a.versionNo);
    const date = (approved.length > 0 && approved[0].sangpanDate) || "";
    onSangpanSchedule(date);
  }, [versions]);

  /* â”€â”€ ë°ì´í„° ì˜ì†í™”: ë³€ê²½ â†’ ë¶€ëª¨(App)ë¡œ ì „ë‹¬ â†’ localStorage ì €ì¥ â”€â”€ */
  const didMountA = useRef(false);
  useEffect(() => {
    if (!didMountA.current) { didMountA.current = true; return; }
    if (onVersionsChange) onVersionsChange(versions, uploadedFiles);
  }, [versions, uploadedFiles]);

  /* â”€â”€ cross-tab ë™ê¸°í™”: factory.htmlì—ì„œ factoryChecked ë“± ë³€ê²½ ì‹œ ë°˜ì˜ â”€â”€ */
  useEffect(() => {
    if (JSON.stringify(initVersions) !== JSON.stringify(versions)) setVersions(initVersions);
  }, [JSON.stringify(initVersions)]);
  useEffect(() => {
    if (JSON.stringify(initUploadedFiles) !== JSON.stringify(uploadedFiles)) setUploadedFiles(initUploadedFiles);
  }, [JSON.stringify(initUploadedFiles)]);

  /* ë‚ ì§œ ì…ë ¥ ì œí•œ: ì˜¤ëŠ˜ ì´ì „ ë¶ˆê°€ + ì‹¤ì¸¡ ì¼ì • ì´í›„ë§Œ ê°€ëŠ¥ */
  const today = new Date().toISOString().slice(0, 10);
  const minSangpanDate = silcheukFinalDate && silcheukFinalDate > today ? silcheukFinalDate : today;

  const CheckIcon = () => (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
    </svg>
  );

  /* â”€â”€ ìƒˆ ë²„ì „ ì¶”ê°€ â”€â”€ */
  const handleAddVersion = () => {
    const maxNo = versions.length > 0 ? Math.max(...versions.map(v => v.versionNo)) : 0;
    const newVer = { versionNo: maxNo + 1, files: [], factoryChecked: false, sentAt: "", sentBy: "", memo: "", sangpanDate: "", isNew: true };
    setVersions(prev => [...prev, newVer]);
    setActiveVer(maxNo + 1);
  };

  /* â”€â”€ íŒŒì¼ ì—…ë¡œë“œ (canvas ë¦¬ì‚¬ì´ì¦ˆ â†’ dataURL â†’ localStorage ì˜ì†í™”) â”€â”€ */
  const handleDragOver  = (e) => { e.preventDefault(); setDragging(true); };
  const handleDragLeave = (e) => { e.preventDefault(); setDragging(false); };
  const handleDrop = (e) => { e.preventDefault(); setDragging(false); handleAddFiles(Array.from(e.dataTransfer.files)); };
  const handleFileInputChange = (e) => { handleAddFiles(Array.from(e.target.files)); e.target.value = ""; };
  const handleAddFiles = async (fileList) => {
    if (!fileList.length) return;
    const toStorable = (f) => new Promise((resolve) => {
      const sizeStr = f.size > 1024 * 1024 ? `${(f.size / 1024 / 1024).toFixed(1)} MB` : `${Math.round(f.size / 1024)} KB`;
      if (!f.type.startsWith("image/")) {
        resolve({ id: Date.now() + Math.random(), name: f.name, size: sizeStr, url: null, isImage: false });
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const MAX = 900;
          let { width, height } = img;
          if (width > MAX || height > MAX) {
            if (width >= height) { height = Math.round(height * MAX / width); width = MAX; }
            else                 { width  = Math.round(width  * MAX / height); height = MAX; }
          }
          const canvas = document.createElement("canvas");
          canvas.width = width; canvas.height = height;
          canvas.getContext("2d").drawImage(img, 0, 0, width, height);
          resolve({
            id: Date.now() + Math.random(), name: f.name, size: sizeStr,
            url: canvas.toDataURL("image/jpeg", 0.75), isImage: true,
          });
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(f);
    });
    const newItems = await Promise.all(fileList.map(toStorable));
    setUploadedFiles(prev => ({ ...prev, [activeVer]: [...(prev[activeVer] || []), ...newItems] }));
    onToast({ type: "success", title: "íŒŒì¼ ì¶”ê°€ë¨", message: `${fileList.length}ê°œ íŒŒì¼ì´ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.` });
  };
  const handleRemoveFile = (fileId) => {
    setUploadedFiles(prev => ({ ...prev, [activeVer]: (prev[activeVer] || []).filter(f => f.id !== fileId) }));
  };

  /* â”€â”€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ â”€â”€ */
  const handleDownloadFile = (f) => {
    if (!f.url) return;
    const a = document.createElement('a');
    a.href = f.url;
    a.download = f.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  /* â”€â”€ ë°œì£¼ ìš”ì²­ ì „ì†¡ â”€â”€ */
  const doSendRequest = () => {
    const now = new Date().toLocaleString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, isNew: false, factoryChecked: false, sentAt: now, sentBy: "ê´€ë¦¬ì" } : v
    ));
    onToast({ type: "success", title: `ë°œì£¼ V${activeVer} ìš”ì²­ ì™„ë£Œ`, message: "ê³µì¥ìœ¼ë¡œ ë°œì£¼ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤." });
  };

  return (
    <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
      {/* í—¤ë” (ë²„ì „ ì¶”ê°€ ë²„íŠ¼ í¬í•¨) */}
      <div className="flex items-center justify-between px-5 py-3 bg-brand-weak border-b border-brand/10">
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 rounded-lg bg-brand flex items-center justify-center flex-shrink-0">
            <svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <div>
            <h4 className="text-sm font-bold text-gray-800">Section A Â· ë°œì£¼ ì„œë¥˜</h4>
            <p className="text-xs text-gray-400 mt-0.5">ë²„ì „ë³„ ì„œë¥˜ í˜„í™© Â· ê³µì¥ í™•ì¸ ìƒíƒœ</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <MokdaeStatusBadge status={badgeStatus} />
          {!sangpanProductionStarted && (
            <button
              onClick={handleAddVersion}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-white bg-brand hover:bg-[#0090e6] rounded-lg shadow-sm transition-all active:scale-95"
            >
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>
              ë²„ì „ ì¶”ê°€
            </button>
          )}
          {sangpanProductionStarted && (
            <span className="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold text-teal-700 bg-teal-50 border border-teal-200 rounded-lg">
              <span className="w-1.5 h-1.5 rounded-full bg-teal-500 animate-pulse"></span>
              ì œì‘ ì§„í–‰ ì¤‘
            </span>
          )}
        </div>
      </div>

      <div className="flex" style={{ minHeight: 340 }}>
        {/* â”€â”€ ì¢Œì¸¡: ë²„ì „ íˆìŠ¤í† ë¦¬ ì‚¬ì´ë“œë°” â”€â”€ */}
        <div className="w-44 flex-shrink-0 border-r border-gray-100 py-3 flex flex-col">
          <p className="text-xs font-semibold text-gray-400 px-4 mb-2 uppercase tracking-wide">ë²„ì „ íˆìŠ¤í† ë¦¬</p>
          {versions.length === 0 && (
            <div className="flex-1 flex flex-col items-center justify-center px-4 text-center gap-2">
              <svg className="w-8 h-8 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p className="text-xs text-gray-300 leading-relaxed">ìƒë‹¨ [ë²„ì „ ì¶”ê°€]ë¥¼<br/>ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</p>
            </div>
          )}
          {versions.map(v => (
            <button
              key={v.versionNo}
              onClick={() => setActiveVer(v.versionNo)}
              className={`w-full text-left px-4 py-2.5 flex flex-col gap-1 transition-colors border-l-2 ${
                activeVer === v.versionNo ? "border-brand bg-brand-weak" : "border-transparent hover:bg-gray-50"
              }`}
            >
              <div className="flex items-center gap-1.5 flex-wrap">
                <span className={`text-sm font-bold ${activeVer === v.versionNo ? "text-brand" : "text-gray-700"}`}>
                  ë°œì£¼ V{v.versionNo}
                </span>
                {v.versionNo === Math.max(...versions.map(x => x.versionNo)) && (
                  <span className="text-xs bg-brand text-white px-1.5 py-0.5 rounded font-bold leading-none">ìµœì‹ </span>
                )}
              </div>
              {v.isNew ? (
                <span className="inline-flex text-xs font-semibold px-2 py-0.5 rounded-full w-fit bg-orange-100 text-orange-600 border border-orange-200">ì‘ì„±ì¤‘</span>
              ) : (
                <span className={`inline-flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full w-fit ${
                  v.factoryChecked ? "bg-emerald-100 text-emerald-700" : "bg-gray-100 text-gray-400"
                }`}>
                  {v.factoryChecked ? <><CheckIcon />ê³µì¥í™•ì¸</> : "ê³µì¥ ë¯¸í™•ì¸"}
                </span>
              )}
              {v.sentAt && <span className="text-xs text-gray-400">{String(v.sentAt).slice(0, 10)}</span>}
            </button>
          ))}
        </div>

        {/* â”€â”€ ìš°ì¸¡: ë²„ì „ ìƒì„¸ â”€â”€ */}
        {versions.length === 0 ? (
          <div className="flex-1 flex flex-col items-center justify-center gap-3 text-gray-300">
            <svg className="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p className="text-sm font-medium text-gray-400">ì•„ì§ ë“±ë¡ëœ ë°œì£¼ ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <p className="text-xs">ì¢Œì¸¡ ìƒë‹¨ [ë²„ì „ ì¶”ê°€] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>
          </div>

        ) : current && isNewVersion ? (
          /* â”€â”€ ì‹ ê·œ ë²„ì „ ì‘ì„± UI â”€â”€ */
          <div className="flex-1 min-w-0 px-5 py-4 space-y-4 overflow-y-auto">

            {/* 1. ë“œë˜ê·¸ì•¤ë“œë¡­ ì—…ë¡œë“œ */}
            <div>
              <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">ë°œì£¼ì„œ íŒŒì¼ ì—…ë¡œë“œ</p>
              <div
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                onClick={() => fileInputRef.current?.click()}
                className={`relative flex flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed transition-all cursor-pointer py-8 ${
                  dragging ? "border-brand bg-brand-weak scale-[1.01]" : "border-gray-300 bg-gray-50/50 hover:border-brand hover:bg-brand-weak/30"
                }`}
              >
                <input ref={fileInputRef} type="file" multiple className="hidden" onChange={handleFileInputChange} />
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${dragging ? "bg-brand-weak" : "bg-white border border-gray-200"}`}>
                  <svg className={`w-5 h-5 transition-colors ${dragging ? "text-brand" : "text-gray-400"}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                </div>
                <div className="text-center">
                  <p className={`text-sm font-semibold transition-colors ${dragging ? "text-brand" : "text-gray-600"}`}>
                    {dragging ? "ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”!" : "íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ"}
                  </p>
                  {!dragging && <p className="text-xs text-gray-400 mt-1">ë°œì£¼ì„œ, ë„ë©´, ì‚¬ì§„ ë“± ëª¨ë“  íŒŒì¼ í˜•ì‹ ì§€ì›</p>}
                </div>
              </div>
            </div>

            {/* 2. ì‹¤ì¸¡ ì°¸ê³  ì´ë¯¸ì§€ (í† ê¸€ ì ‘ê¸°/í¼ì¹˜ê¸°) â€” silcheukImages propìœ¼ë¡œ ì‹¤ì¸¡ íƒ­ ì—…ë¡œë“œ ê²°ê³¼ í‘œì‹œ */}
            <div className="border border-gray-200 rounded-xl overflow-hidden">
              <button
                onClick={() => setSilcheukOpen(p => !p)}
                className="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors"
              >
                <div className="flex items-center gap-2">
                  <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">ì‹¤ì¸¡ ì‚¬ì§„ / ì‹¤ì¸¡ì§€ ì°¸ê³  ì´ë¯¸ì§€</span>
                  <span className={`text-xs px-1.5 py-0.5 rounded-full ${silcheukImages.length > 0 ? "bg-brand-weak text-brand font-bold" : "text-gray-400 bg-gray-200"}`}>{silcheukImages.length}ì¥</span>
                </div>
                <svg className={`w-4 h-4 text-gray-400 transition-transform duration-200 ${silcheukOpen ? "rotate-180" : ""}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              {silcheukOpen && (
                silcheukImages.length > 0 ? (
                  <div className="p-3 grid grid-cols-3 gap-2 border-t border-gray-100">
                    {silcheukImages.map(img => (
                      <div key={img.id} className="relative aspect-[4/3] rounded-lg overflow-hidden border border-gray-200 group cursor-zoom-in"
                           onClick={() => img.isImage && img.url && setLightbox({ url: img.url, name: img.label || img.name })}>
                        {img.isImage && img.url ? (
                          <React.Fragment>
                            <img src={img.url} alt={img.label || img.name} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy" />
                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                          </React.Fragment>
                        ) : (
                          <div className="w-full h-full bg-gray-100 flex flex-col items-center justify-center gap-1 p-2">
                            <svg className="w-7 h-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p className="text-xs text-gray-500 truncate w-full text-center">{img.name}</p>
                          </div>
                        )}
                        <div className="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/50 to-transparent px-2 py-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                          <p className="text-white text-xs truncate">{img.label || img.name}</p>
                          {img.category && <span className="text-white/70 text-xs">{img.category}</span>}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="px-4 py-8 flex flex-col items-center gap-2 text-gray-300 border-t border-gray-100">
                    <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p className="text-sm font-medium text-center">ì‹¤ì¸¡ íƒ­ì—ì„œ ì—…ë¡œë“œëœ ì‚¬ì§„/ì‹¤ì¸¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p className="text-xs text-center">ì‹¤ì¸¡ íƒ­ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                  </div>
                )
              )}
            </div>

            {/* 3. ì—…ë¡œë“œëœ ë°œì£¼ì„œ íŒŒì¼ í”„ë¦¬ë·° */}
            {currentFiles.length > 0 && (
              <div>
                <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">
                  ì—…ë¡œë“œëœ ë°œì£¼ì„œ
                  <span className="ml-1.5 text-gray-300 font-normal normal-case tracking-normal">({currentFiles.length}ê°œ)</span>
                </p>
                <div className="grid grid-cols-2 gap-3">
                  {currentFiles.map(f => (
                    <div key={f.id} className="border border-gray-200 rounded-xl overflow-hidden bg-white hover:border-brand/30 transition-colors group">
                      {f.isImage ? (
                        <div className="relative h-28 bg-gray-100 cursor-zoom-in" onClick={() => setLightbox({ url: f.url, name: f.name })}>
                          <img src={f.url} alt={f.name} className="w-full h-full object-cover" />
                          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                            <svg className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 drop-shadow transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0zm0 0l3 3"/>
                            </svg>
                          </div>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleRemoveFile(f.id); }}
                            className="absolute top-1.5 right-1.5 w-6 h-6 bg-black/50 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all"
                          >
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12"/></svg>
                          </button>
                        </div>
                      ) : (
                        <div className="relative h-28 bg-gray-50 flex flex-col items-center justify-center gap-1.5 cursor-pointer hover:bg-gray-100 transition-colors" onClick={() => handleDownloadFile(f)}>
                          <svg className="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                          <span className="text-xs text-gray-400 font-semibold uppercase">{f.name.split('.').pop()}</span>
                          <span className="text-xs text-brand/60 font-medium">í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ</span>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleRemoveFile(f.id); }}
                            className="absolute top-1.5 right-1.5 w-6 h-6 bg-black/30 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all"
                          >
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12"/></svg>
                          </button>
                        </div>
                      )}
                      <div className="px-3 py-2">
                        <p className="text-xs font-medium text-gray-700 truncate" title={f.name}>{f.name}</p>
                        <p className="text-xs text-gray-400">{f.size}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* 4. ìƒíŒ ì˜ˆì • ì¼ì • ì…ë ¥ */}
            <div className="bg-gray-50 rounded-xl p-3 border border-gray-200">
              <label className="flex items-center gap-3">
                <div className="flex items-center gap-1.5 w-28 flex-shrink-0">
                  <svg className="w-3.5 h-3.5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">ìƒíŒ ì˜ˆì • ì¼ì •</span>
                </div>
                <input
                  type="date"
                  value={current.sangpanDate || ""}
                  min={minSangpanDate}
                  onChange={e => setVersions(prev => prev.map(v => v.versionNo === activeVer ? { ...v, sangpanDate: e.target.value } : v))}
                  className="flex-1 px-2.5 py-1.5 text-xs border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand bg-white text-gray-700"
                />
              </label>
            </div>

            {/* ë°œì£¼ ìš”ì²­ ë²„íŠ¼ */}
            <div className="flex items-center justify-between pt-2 border-t border-gray-100">
              {currentFiles.length === 0 && (
                <p className="text-xs text-gray-400 flex items-center gap-1.5">
                  <svg className="w-3.5 h-3.5 text-amber-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„ ë°œì£¼ ìš”ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤
                </p>
              )}
              <button
                onClick={doSendRequest}
                disabled={currentFiles.length === 0}
                className={`ml-auto flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-xl shadow-sm transition-all ${
                  currentFiles.length === 0 ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-brand hover:bg-[#0090e6] text-white"
                }`}
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                ë°œì£¼ ìš”ì²­
              </button>
            </div>
          </div>

        ) : current ? (
          /* â”€â”€ ê¸°ì¡´ ë²„ì „ ìƒì„¸ (ì½ê¸° ì „ìš©) â”€â”€ */
          <div className="flex-1 min-w-0 px-5 py-4 space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-bold text-gray-800">ë°œì£¼ V{current.versionNo} ìƒì„¸</p>
                <p className="text-xs text-gray-400">ë°œì†¡: {current.sentBy} Â· {current.sentAt}</p>
              </div>
              {current.factoryChecked && (
                <div className="flex items-center gap-2 text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg px-2 py-1.5">
                  <CheckIcon /> ê³µì¥ ì—´ëŒ {current.factoryCheckedAt}
                </div>
              )}
            </div>
            {/* ì—…ë¡œë“œëœ íŒŒì¼ í”„ë¦¬ë·° (ìˆì„ ê²½ìš°) */}
            {(uploadedFiles[current.versionNo] || []).length > 0 ? (
              <div className="grid grid-cols-2 gap-3">
                {(uploadedFiles[current.versionNo] || []).map(f => (
                  <div key={f.id} className="border border-gray-200 rounded-xl overflow-hidden bg-white group">
                    {f.isImage ? (
                      <div className="relative h-28 bg-gray-100 cursor-zoom-in" onClick={() => setLightbox({ url: f.url, name: f.name })}>
                        <img src={f.url} alt={f.name} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                          <svg className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 drop-shadow transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
                          </svg>
                        </div>
                      </div>
                    ) : (
                      <div className="w-full h-28 bg-gray-50 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-gray-100 transition-colors" onClick={() => handleDownloadFile(f)}>
                        <svg className="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span className="text-xs text-gray-400 font-semibold uppercase">{f.name.split('.').pop()}</span>
                        <span className="text-xs text-brand/60 font-medium">í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ</span>
                      </div>
                    )}
                    <div className="px-3 py-2">
                      <p className="text-xs font-medium text-gray-700 truncate">{f.name}</p>
                      <p className="text-xs text-gray-400">{f.size}</p>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="space-y-2">
                {current.files.map(f => <FileItem key={f.id} file={f} showRequired />)}
              </div>
            )}
            {/* ìƒíŒ ì˜ˆì • ì¼ì • (ì½ê¸° ì „ìš©) */}
            {current.sangpanDate && (
              <div className="bg-gray-50 rounded-xl p-3 border border-gray-200 flex items-center gap-3">
                <div className="flex items-center gap-1.5">
                  <svg className="w-3.5 h-3.5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">ìƒíŒ ì˜ˆì • ì¼ì •</span>
                </div>
                <span className="text-xs font-bold text-gray-800">{current.sangpanDate}</span>
              </div>
            )}
            {current.memo && (
              <div className="bg-gray-50 rounded-lg px-3 py-2 border border-gray-200">
                <p className="text-xs text-gray-500 font-medium mb-1">ë°œì£¼ ë©”ëª¨</p>
                <p className="text-sm text-gray-700 leading-relaxed">{current.memo}</p>
              </div>
            )}
          </div>
        ) : null}
      </div>

      {/* â”€â”€ ì´ë¯¸ì§€ ë¼ì´íŠ¸ë°•ìŠ¤ â”€â”€ */}
      {lightbox && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center p-6"
          style={{ background: "rgba(0,0,0,0.88)" }}
          onClick={() => setLightbox(null)}
        >
          <div className="relative flex flex-col items-center max-w-[92vw]" onClick={e => e.stopPropagation()}>
            {/* ë‹«ê¸° ë²„íŠ¼ */}
            <button
              onClick={() => setLightbox(null)}
              className="absolute -top-4 -right-4 z-10 w-9 h-9 bg-white/20 hover:bg-white/40 text-white rounded-full flex items-center justify-center transition-colors shadow-lg"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            {/* ì´ë¯¸ì§€ */}
            <img
              src={lightbox.url}
              alt={lightbox.name}
              className="max-w-full rounded-xl object-contain shadow-2xl"
              style={{ maxHeight: "80vh" }}
            />
            {/* í•˜ë‹¨ íŒŒì¼ëª… + ESC ì•ˆë‚´ */}
            <div className="mt-3 flex items-center gap-4 w-full px-1">
              <p className="flex-1 text-white/70 text-sm truncate">{lightbox.name}</p>
              <span className="flex-shrink-0 text-xs text-white/40 bg-white/10 px-2 py-1 rounded">ESCë¡œ ë‹«ê¸°</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒíŒ íƒ­ â€” Section B: ìƒíŒ ë„ë©´ ë·°ì–´ & ë²„ì „ ì‚¬ì´ë“œë°”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SangpanSectionB({ drawingVersions: initVersions, activeVer: initActive, onToast, onDrawingChange }) {
  const [versions, setVersions]   = useState(initVersions);
  const [activeVer, setActiveVer] = useState(initActive);
  const [lightbox, setLightbox]   = useState(null);
  const [showRevModal, setShowRevModal] = useState(false);
  const [revisionText, setRevisionText] = useState("");

  /* â”€â”€ ë°ì´í„° ì˜ì†í™”: ë³€ê²½ â†’ ë¶€ëª¨(App)ë¡œ ì „ë‹¬ â†’ localStorage ì €ì¥ â”€â”€ */
  const didMountB = useRef(false);
  useEffect(() => {
    if (!didMountB.current) { didMountB.current = true; return; }
    if (onDrawingChange) onDrawingChange(versions);
  }, [versions]);

  /* â”€â”€ cross-tab ë™ê¸°í™”: factory.htmlì—ì„œ CAD ì—…ë¡œë“œ ì‹œ ë°˜ì˜ â”€â”€ */
  useEffect(() => {
    if (JSON.stringify(initVersions) !== JSON.stringify(versions)) {
      setVersions(initVersions);
      if (initVersions.length > 0) setActiveVer(initVersions[initVersions.length - 1].versionNo);
    }
  }, [JSON.stringify(initVersions)]);

  const current = versions.find(v => v.versionNo === activeVer);

  const cadStatusStyle = {
    "ìŠ¹ì¸":       "bg-emerald-100 text-emerald-700 border-emerald-200",
    "ìŠ¹ì¸í•´ì œ":   "bg-red-100 text-red-700 border-red-200",
    "ë„ë©´ìˆ˜ì •ìš”ì²­":"bg-orange-100 text-orange-700 border-orange-200",
    "ë„ë©´ê²€í† ì¤‘":"bg-brand-weak text-brand border-brand/20",
  };

  const handleApprove = () => {
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, status: "ìŠ¹ì¸", approvedAt: "2026-02-25 (ë°©ê¸ˆ)" } : v
    ));
    onToast({ type: "success", title: "ìƒíŒ ë„ë©´ ìŠ¹ì¸ ì™„ë£Œ", message: `ë„ë©´ V${activeVer} ë„ë©´ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, duration: 4000 });
  };

  const handleRevisionSubmit = () => {
    if (!revisionText.trim()) {
      onToast({ type: "warning", title: "ì‚¬ìœ  ì…ë ¥ í•„ìš”", message: "ìˆ˜ì • ìš”ì²­ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
      return;
    }
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, status: "ë„ë©´ìˆ˜ì •ìš”ì²­", revisionNote: revisionText } : v
    ));
    setShowRevModal(false);
    setRevisionText("");
    onToast({ type: "info", title: "ìˆ˜ì • ìš”ì²­ ì „ì†¡", message: "ê³µì¥ìœ¼ë¡œ ìƒíŒ ë„ë©´ ìˆ˜ì • ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤." });
  };

  return (
    <>
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <SectionHeader
          color="orange"
          icon={<svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>}
          title="Section B Â· ìƒíŒ ë„ë©´ ê²€í† "
          sub="ë²„ì „ í´ë¦­ â†’ ë·°ì–´ ì „í™˜ Â· ìŠ¹ì¸ ë˜ëŠ” ìˆ˜ì • ìš”ì²­"
          badge={<MokdaeStatusBadge status={versions.length === 0 ? "ë°œì£¼ìš”ì²­ëŒ€ê¸°" : (current?.status || "ë„ë©´ê²€í† ì¤‘")} />}
        />

        <div className="flex min-h-[300px]">
          {versions.length === 0 ? (
            <div className="flex-1 flex flex-col items-center justify-center py-14 gap-3 text-gray-300">
              <svg className="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p className="text-sm font-medium text-gray-400">ì•„ì§ ë“±ë¡ëœ ìƒíŒ ë„ë©´ì´ ì—†ìŠµë‹ˆë‹¤</p>
              <p className="text-xs">ë°œì£¼ ì„œë¥˜ê°€ ì „ë‹¬ë˜ë©´ ê³µì¥ì—ì„œ ë„ë©´ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.</p>
            </div>
          ) : (<>
          {/* ì¢Œì¸¡: CAD ë²„ì „ ì‚¬ì´ë“œë°” */}
          <div className="w-44 flex-shrink-0 border-r border-gray-100 py-3">
            <p className="text-xs font-semibold text-gray-400 px-4 mb-2 uppercase tracking-wide">ë„ë©´ ë²„ì „</p>
            {versions.map(v => (
              <button
                key={v.versionNo}
                onClick={() => setActiveVer(v.versionNo)}
                className={`w-full text-left px-4 py-3 flex flex-col gap-2 transition-colors border-l-2 ${
                  activeVer === v.versionNo
                    ? "border-orange-500 bg-orange-50"
                    : "border-transparent hover:bg-gray-50"
                }`}
              >
                <div className="flex items-center gap-2">
                  <span className={`text-sm font-bold ${activeVer === v.versionNo ? "text-orange-700" : "text-gray-700"}`}>
                    ë„ë©´ V{v.versionNo}
                  </span>
                  {v.versionNo === versions.length && (
                    <span className="text-xs bg-orange-500 text-white px-1.5 py-0.5 rounded font-bold leading-none">ìµœì‹ </span>
                  )}
                </div>
                <span className={`inline-block text-xs font-semibold px-2 py-0.5 rounded-full border w-fit ${cadStatusStyle[v.status] || "bg-gray-100 text-gray-500 border-gray-200"}`}>
                  {v.status}
                </span>
                <span className="text-xs text-gray-400">{v.uploadedAt.slice(5,10)}</span>
              </button>
            ))}
          </div>

          {/* ì¤‘ì•™: ë„ë©´ ë·°ì–´ */}
          {current && (
            <div className="flex-1 min-w-0 flex flex-col" style={{minHeight: 300}}>
              {/* ì´ë¯¸ì§€ ë·°ì–´ */}
              <div className="relative flex-1 bg-gray-100 cursor-zoom-in group"
                   style={{ minHeight: "220px" }}
                   onClick={() => setLightbox(current.previewUrl)}>
                <img
                  src={current.previewUrl}
                  alt={`ë„ë©´ V${current.versionNo}`}
                  className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-[1.02]"
                  style={{ maxHeight: "260px", objectFit: "cover" }}
                />

                {/* ìŠ¹ì¸ í•´ì œ ì›Œí„°ë§ˆí¬ */}
                {current.status === "ìŠ¹ì¸í•´ì œ" && (
                  <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-red-900/20"></div>
                    <div className="relative z-10 select-none" style={{ transform: "rotate(-22deg)" }}>
                      <span className="text-red-600/75 font-black tracking-[0.2em] whitespace-nowrap"
                            style={{ fontSize:"clamp(18px,3vw,32px)", textShadow:"0 0 12px rgba(255,255,255,0.9)", WebkitTextStroke:"0.5px rgba(180,0,0,0.4)" }}>
                        ìŠ¹ì¸ ì·¨ì†Œë¨
                      </span>
                    </div>
                    <div className="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded shadow">VOID</div>
                  </div>
                )}

                {/* ìŠ¹ì¸ ì™„ë£Œ ì˜¤ë²„ë ˆì´ */}
                {current.status === "ìŠ¹ì¸" && (
                  <div className="absolute top-2 left-2 flex items-center gap-2 bg-emerald-600/90 text-white text-xs font-bold px-2 py-1 rounded-lg shadow-md">
                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                    </svg>
                    ìŠ¹ì¸ë¨ Â· {current.approvedAt}
                  </div>
                )}

                {/* í™•ëŒ€ íŒíŠ¸ */}
                <div className="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                  í´ë¦­í•˜ì—¬ í™•ëŒ€
                </div>
              </div>

              {/* ì—…ë¡œë“œ ë‚ ì§œ + ë‘ ë²ˆì§¸ ë„ë©´ ë²„íŠ¼ */}
              <div className="flex items-center gap-2 px-4 py-2 bg-gray-50 border-t border-gray-100 text-xs text-gray-500">
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                ê³µì¥ ì—…ë¡œë“œ: {current.uploadedAt}
                <button onClick={() => setLightbox(current.previewUrl2)}
                        className="ml-auto flex items-center gap-1 text-brand hover:text-[#0090e6] font-medium">
                  ìƒì„¸ë„ ë³´ê¸° â†’
                </button>
              </div>

              {/* ìˆ˜ì • ìš”ì²­ ë‚´ìš© (ìˆì„ ê²½ìš°) */}
              {current.revisionNote && (
                <div className="mx-4 mb-3 mt-1 flex items-start gap-2 bg-orange-50 border border-orange-200 rounded-xl px-4 py-3">
                  <svg className="w-4 h-4 text-orange-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  <div>
                    <p className="text-xs font-semibold text-orange-700 mb-1">ìˆ˜ì • ìš”ì²­ ë‚´ìš©</p>
                    <p className="text-sm text-gray-700 leading-relaxed">{current.revisionNote}</p>
                  </div>
                </div>
              )}

              {/* ìŠ¹ì¸ í•´ì œ ì‚¬ìœ  */}
              {current.status === "ìŠ¹ì¸í•´ì œ" && (
                <div className="mx-4 mb-3 flex items-start gap-2 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
                  <svg className="w-4 h-4 text-red-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    <p className="text-xs font-semibold text-red-600 mb-1">ìŠ¹ì¸ í•´ì œ ì‚¬ìœ </p>
                    <p className="text-sm text-gray-700">ìƒˆë¡œìš´ ë°œì£¼ì„œ(V2) ì—…ë¡œë“œë¡œ ì¸í•´ ê¸°ì¡´ ìŠ¹ì¸ì´ ìë™ í•´ì œë¨. ({current.approvalCancelledAt})</p>
                  </div>
                </div>
              )}

              {/* ì•¡ì…˜ ë²„íŠ¼ */}
              <div className="flex gap-2 px-4 pb-4 mt-auto">
                <button
                  onClick={handleApprove}
                  disabled={current.status === "ìŠ¹ì¸"}
                  className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-semibold transition-all ${
                    current.status === "ìŠ¹ì¸"
                      ? "bg-emerald-100 text-emerald-500 cursor-default"
                      : "bg-emerald-600 hover:bg-emerald-700 text-white shadow-sm"
                  }`}
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  {current.status === "ìŠ¹ì¸" ? "ìŠ¹ì¸ ì™„ë£Œ" : "ìŠ¹ì¸"}
                </button>
                <button
                  onClick={() => setShowRevModal(true)}
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-semibold
                             bg-red-500 hover:bg-red-600 text-white shadow-sm shadow-red-200 transition-all"
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  ìˆ˜ì • ìš”ì²­
                </button>
              </div>
            </div>
          )}
          </>)}
        </div>
      </div>

      {/* â”€â”€ ìˆ˜ì • ìš”ì²­ ì‚¬ìœ  ëª¨ë‹¬ â”€â”€ */}
      <Modal open={showRevModal} onClose={() => setShowRevModal(false)}>
        <div className="px-6 py-5 space-y-4">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-xl bg-red-100 flex items-center justify-center flex-shrink-0">
              <svg className="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </div>
            <div>
              <h3 className="text-base font-bold text-gray-800">ìƒíŒ ë„ë©´ ìˆ˜ì • ìš”ì²­</h3>
              <p className="text-xs text-gray-400">ë„ë©´ V{activeVer} Â· ê³µì¥ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤</p>
            </div>
          </div>
          <div>
            <label className="block text-xs font-semibold text-gray-600 mb-1.5">ìˆ˜ì • ìš”ì²­ ì‚¬ìœ  <span className="text-red-500">*</span></label>
            <textarea
              value={revisionText}
              onChange={e => setRevisionText(e.target.value)}
              rows={4}
              placeholder="ì˜ˆ) ëƒ‰ì¥ê³  ìš°ì¸¡ í‹ˆìƒˆ í­ 340mmë¡œ ìˆ˜ì •, ìƒë¶€ì¥ ë†’ì´ 2,300mm ì¬í™•ì¸ í•„ìš”"
              className="w-full px-3 py-2 text-sm border border-gray-300 rounded-xl resize-none
                         focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent
                         text-gray-700 leading-relaxed placeholder:text-gray-300"
            />
          </div>
          <div className="flex gap-3 justify-end">
            <button onClick={() => setShowRevModal(false)}
                    className="px-4 py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">
              ì·¨ì†Œ
            </button>
            <button onClick={handleRevisionSubmit}
                    className="px-4 py-2 text-sm font-bold text-white bg-red-500 hover:bg-red-600 rounded-xl transition-colors flex items-center gap-2">
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              ìˆ˜ì • ìš”ì²­ ì „ì†¡
            </button>
          </div>
        </div>
      </Modal>

      {/* â”€â”€ ì´ë¯¸ì§€ ë¼ì´íŠ¸ë°•ìŠ¤ â”€â”€ */}
      <Modal open={!!lightbox} onClose={() => setLightbox(null)} maxW="max-w-4xl">
        <div className="relative">
          <div className="relative">
            <img src={lightbox} alt="ìƒíŒ ë„ë©´ í™•ëŒ€" className="w-full object-contain rounded-t-2xl max-h-[80vh]" />
            {current?.status === "ìŠ¹ì¸í•´ì œ" && (
              <div className="absolute inset-0 flex items-center justify-center pointer-events-none rounded-t-2xl">
                <div className="absolute inset-0 bg-red-900/15 rounded-t-2xl"></div>
                <div className="relative z-10" style={{ transform: "rotate(-22deg)" }}>
                  <span className="text-red-600/65 font-black tracking-[0.3em] text-5xl"
                        style={{ textShadow:"0 0 20px rgba(255,255,255,0.95)", WebkitTextStroke:"1px rgba(180,0,0,0.3)" }}>
                    ìŠ¹ì¸ ì·¨ì†Œë¨
                  </span>
                </div>
              </div>
            )}
          </div>
          <div className="px-4 py-2 bg-gray-50 text-xs text-gray-400 text-center rounded-b-2xl">
            ë°”ê¹¥ í´ë¦­ ë˜ëŠ” ESCë¡œ ë‹«ê¸°
          </div>
          <button onClick={() => setLightbox(null)}
                  className="absolute top-3 right-3 w-8 h-8 bg-black/40 hover:bg-black/60 text-white rounded-full flex items-center justify-center transition-colors">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </Modal>
    </>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒíŒ íƒ­ â€” Section C: ìµœì¢… í™•ì • & ì˜ˆì™¸ ì²˜ë¦¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SangpanSectionC({ data, onToast, onConfirmChange, sangpanProductionStarted = false }) {
  const [approved, setApproved]   = useState(data.consumerApproved);
  const [confirmed, setConfirmed] = useState(!!data.confirmedAt);

  /* â”€â”€ cross-tab ë™ê¸°í™”: factory.html ë“±ì—ì„œ ë°ì´í„° ë³€ê²½ ì‹œ ë°˜ì˜ â”€â”€ */
  useEffect(() => { setApproved(data.consumerApproved); }, [data.consumerApproved]);
  useEffect(() => { setConfirmed(!!data.confirmedAt); },  [data.confirmedAt]);

  /* â”€â”€ approved ë³€ê²½ â†’ ë¶€ëª¨ì— ì•Œë¦¼ (mount ìŠ¤í‚µ) â”€â”€ */
  const didMountC = useRef(false);
  useEffect(() => {
    if (!didMountC.current) { didMountC.current = true; return; }
    if (onConfirmChange) onConfirmChange({ consumerApproved: approved, confirmedAt: confirmed ? (data.confirmedAt || null) : null });
  }, [approved]);

  const handleConfirm = () => {
    if (!approved) {
      onToast({ type: "warning", title: "ì†Œë¹„ì ìŠ¹ì¸ í•„ìš”", message: "ì†Œë¹„ì ìŠ¹ì¸ ì²´í¬ë°•ìŠ¤ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”." });
      return;
    }
    setConfirmed(true);
    const now = new Date().toISOString();
    if (onConfirmChange) onConfirmChange({ consumerApproved: true, confirmedAt: now });
    onToast({ type: "success", title: "ìµœì¢… ë°œì£¼ í™•ì •", message: "ëŒ€ì‹œë³´ë“œ ìƒíŒ ë°œì£¼ ìƒíƒœê°€ [ë°œì£¼í™•ì •]ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", duration: 5000 });
  };

  return (
    <div className={`rounded-xl overflow-hidden border-2 bg-white ${confirmed ? "border-emerald-300" : "border-brand/20"}`}>
      <SectionHeader
        color={confirmed ? "green" : "blue"}
        icon={<svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>}
        title="Section C Â· ì†Œë¹„ì ìµœì¢… ìŠ¹ì¸ ë° ë°œì£¼ í™•ì •"
        badge={confirmed ? <MokdaeStatusBadge status="ë°œì£¼í™•ì •" /> : null}
      />

      <div className="px-5 py-5 space-y-4">
        {/* ì†Œë¹„ì ìŠ¹ì¸ ì²´í¬ë°•ìŠ¤ */}
        <label className={`flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all ${
          approved ? "border-brand bg-brand-weak" : "border-gray-200 bg-gray-50 hover:border-brand/30 hover:bg-brand-weak/40"
        }`}>
          <div className="relative mt-1 flex-shrink-0">
            <input type="checkbox" checked={approved} onChange={e => setApproved(e.target.checked)}
                   disabled={confirmed} className="sr-only" />
            <div className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${
              approved ? "bg-brand border-brand" : "bg-white border-gray-400"
            }`}>
              {approved && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7"/></svg>}
            </div>
          </div>
          <div>
            <p className={`text-sm font-semibold ${approved ? "text-gray-800" : "text-gray-600"}`}>
              ì†Œë¹„ìê°€ ìµœì¢… ë„ë©´ì„ í™•ì¸í•˜ê³  ìŠ¹ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.
            </p>
            <p className="text-xs text-gray-400 mt-1">ì´ í•­ëª©ì„ ì²´í¬í•´ì•¼ ìµœì¢… ë°œì£¼ í™•ì • ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</p>
          </div>
        </label>

        {/* í™•ì • ë²„íŠ¼ */}
        <button onClick={handleConfirm} disabled={confirmed}
          className={`w-full py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300 ${
            confirmed
              ? "bg-emerald-500 text-white cursor-default shadow-sm shadow-emerald-100"
              : approved
              ? "bg-brand hover:bg-[#0090e6] text-white shadow-sm  hover:-translate-y-0.5"
              : "bg-gray-100 text-gray-400 cursor-not-allowed"
          }`}>
          {confirmed ? (
            <><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>ìµœì¢… ë°œì£¼ í™•ì • ì™„ë£Œ</>
          ) : (
            <><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>ìµœì¢… ë°œì£¼ í™•ì •</>
          )}
        </button>

        {/* ğŸ­ ì œì‘ ì§„í–‰ ì¤‘ ë°°ë„ˆ */}
        {sangpanProductionStarted && confirmed && (
          <div className="flex items-center gap-3 bg-teal-50 border-2 border-teal-200 rounded-xl px-4 py-3.5">
            <div className="w-8 h-8 rounded-lg bg-teal-500 flex items-center justify-center flex-shrink-0">
              <svg className="w-4.5 h-4.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
            </div>
            <div>
              <p className="text-sm font-bold text-teal-800">ê³µì¥ì—ì„œ ì œì‘ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤</p>
              <p className="text-xs text-teal-600 mt-0.5">ì œì‘ ì§„í–‰ ì¤‘ì—ëŠ” ë°œì£¼ ë‚´ìš© ìˆ˜ì •ì´ ì œí•œë©ë‹ˆë‹¤. ê³µì¥ì—ì„œ ì œì‘ ì¤‘ë‹¨ ì‹œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
          </div>
        )}

        {/* ê¸´ê¸‰ ì¡°ì • Alert */}
        <div className="flex items-start gap-3 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
          <svg className="w-4 h-4 text-red-500 mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
          </svg>
          <p className="text-xs text-red-700 leading-relaxed">
            <span className="font-bold">âš ï¸ ì£¼ì˜</span>{"  "}ê³µì¥ ì œì‘ ì‹œì‘ ì „ê¹Œì§€ëŠ” ë‚´ìš© ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ë©°, ìˆ˜ì • ì‹œ{" "}
            <span className="font-bold text-red-800">'í™•ì • í›„ ì¡°ì •(ê¸´ê¸‰)'</span>{" "}ìƒíƒœë¡œ ì „í™˜ë©ë‹ˆë‹¤.
          </p>
        </div>

        {/* í™•ì • í›„ ì¡°ì¹˜ ë²„íŠ¼ë“¤ */}
        {confirmed && (
          <div className="pt-1">
            <p className="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wide">ë°œì£¼ í™•ì • í›„ ì¡°ì¹˜</p>
            <div className="flex gap-3">
              <button
                onClick={() => onToast({ type: "warning", title: "ê¸´ê¸‰ ì¡°ì • ìš”ì²­", message: "ê¸´ê¸‰ ì¡°ì • ìš”ì²­ì´ ê³µì¥ìœ¼ë¡œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.", duration: 4000 })}
                className="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-semibold
                           text-red-700 bg-red-50 hover:bg-red-100 border-2 border-red-200 hover:border-red-300
                           rounded-xl transition-all"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                </svg>
                ê¸´ê¸‰ ì¡°ì •
              </button>
              <button
                onClick={() => document.getElementById("section-d-sangpan-anchor")?.scrollIntoView({ behavior: "smooth" })}
                className="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-semibold
                           text-amber-700 bg-amber-50 hover:bg-amber-100 border-2 border-amber-200 hover:border-amber-300
                           rounded-xl transition-all"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                ì¬ë§ˆê° ìš”ì²­ â†’
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒíŒ íƒ­ â€” Section D: ì¬ë§ˆê° ìš”ì²­ ì•„ì½”ë””ì–¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SangpanSectionD({ claims: initClaims, onToast, onClaimsChange }) {
  const [open, setOpen]     = useState(true);
  const [claims, setClaims] = useState(initClaims);

  /* â”€â”€ ë°ì´í„° ì˜ì†í™”: ë³€ê²½ â†’ ë¶€ëª¨(App)ë¡œ ì „ë‹¬ â†’ localStorage ì €ì¥ â”€â”€ */
  const didMountD = useRef(false);
  useEffect(() => {
    if (!didMountD.current) { didMountD.current = true; return; }
    if (onClaimsChange) onClaimsChange(claims);
  }, [claims]);

  /* â”€â”€ cross-tab ë™ê¸°í™” â”€â”€ */
  useEffect(() => {
    if (JSON.stringify(initClaims) !== JSON.stringify(claims)) setClaims(initClaims);
  }, [JSON.stringify(initClaims)]);
  const [newDate, setNewDate]       = useState("");
  const [newContent, setNewContent] = useState("");
  const [sending, setSending]       = useState(false);

  const statusStyle = {
    "ì¬ë§ˆê°ìš”ì²­": "bg-orange-100 text-orange-700 border-orange-200",
    "ì¬ë§ˆê°ì¡°ì •": "bg-amber-100 text-amber-700 border-amber-200",
    "ì¬ë§ˆê°í™•ì •": "bg-emerald-100 text-emerald-700 border-emerald-200",
  };

  const handleSend = () => {
    if (!newDate || !newContent.trim()) {
      onToast({ type: "warning", title: "ì…ë ¥ í™•ì¸", message: "í¬ë§ ì¼ì •ê³¼ ìš”ì²­ ì‚¬í•­ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”." });
      return;
    }
    setSending(true);
    setTimeout(() => {
      setClaims(prev => [...prev, {
        id: prev.length + 1, status: "ì¬ë§ˆê°ìš”ì²­",
        requestDate: newDate, requestContent: newContent,
        sentAt: "2026-02-25 (ë°©ê¸ˆ)", factoryReply: null,
      }]);
      setNewDate(""); setNewContent(""); setSending(false);
      onToast({ type: "success", title: "ì¬ë§ˆê° ìš”ì²­ ì „ì†¡ ì™„ë£Œ", message: "ê³µì¥ìœ¼ë¡œ ì¬ë§ˆê° ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤." });
    }, 800);
  };

  return (
    <div id="section-d-sangpan-anchor" className="rounded-xl overflow-hidden border-2 border-dashed border-gray-300 bg-white">
      <button onClick={() => setOpen(p => !p)}
              className="w-full flex items-center justify-between px-5 py-4 hover:bg-gray-50 transition-colors">
        <div className="flex items-center gap-3">
          <div className="w-7 h-7 rounded-lg bg-amber-100 border border-amber-200 flex items-center justify-center flex-shrink-0">
            <svg className="w-4 h-4 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </div>
          <div className="text-left">
            <div className="flex items-center gap-2">
              <span className="text-sm font-bold text-gray-800">Section D Â· í˜„ì¥ ì¬ë§ˆê° ìš”ì²­</span>
              {claims.length > 0 && (
                <span className="text-xs font-bold px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 border border-amber-200">{claims.length}ê±´</span>
              )}
            </div>
            <p className="text-xs text-gray-400 mt-1">í•­ìƒ ì¶”ê°€ ìš”ì²­ ê°€ëŠ¥ Â· ê³µì¥ìœ¼ë¡œ ì§ì ‘ ì „ì†¡</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {claims.some(c => c.status === "ì¬ë§ˆê°ì¡°ì •") && (
            <span className="flex items-center gap-2 text-xs font-bold text-amber-700 bg-amber-100 border border-amber-200 px-2 py-1 rounded-full">
              <span className="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span>
              ì¬ë§ˆê° ì¡°ì • (ê³µì¥ í™•ì¸ ëŒ€ê¸°ì¤‘)
            </span>
          )}
          <svg className={`w-5 h-5 text-gray-400 transition-transform duration-200 ${open ? "rotate-180" : ""}`}
               fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>

      {open && (
        <div className="border-t border-gray-200">
          {/* ê¸°ì¡´ ìš”ì²­ */}
          {claims.length > 0 && (
            <div className="px-5 pt-4 pb-2 space-y-3">
              <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide">ì „ì†¡ëœ ì¬ë§ˆê° ìš”ì²­</p>
              {claims.map(claim => (
                <div key={claim.id} className="rounded-xl border border-gray-200 overflow-hidden">
                  <div className="flex items-center justify-between px-4 py-2 bg-gray-50 border-b border-gray-100">
                    <div className="flex items-center gap-2 text-xs text-gray-500">
                      <span className="font-semibold text-gray-700">#{claim.id}</span>
                      <span>Â·</span>
                      <span>í¬ë§ì¼: <b className="text-gray-700">{claim.requestDate}</b></span>
                      <span>Â·</span>
                      <span>{claim.sentAt}</span>
                    </div>
                    <span className={`text-xs font-semibold px-2 py-1 rounded-full border ${statusStyle[claim.status] || ""}`}>
                      {claim.status}
                    </span>
                  </div>
                  <div className="px-4 py-3 bg-white space-y-2">
                    <p className="text-sm text-gray-700">{claim.requestContent}</p>
                    {claim.factoryReply && (
                      <div className="flex items-start gap-2 bg-brand-weak border border-brand/10 rounded-lg px-3 py-2">
                        <svg className="w-3.5 h-3.5 text-brand mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                        <p className="text-xs text-gray-600 leading-relaxed">{claim.factoryReply}</p>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
          {claims.length > 0 && <div className="mx-5 my-3 border-t border-dashed border-gray-200"></div>}

          {/* ì‹ ê·œ í¼ */}
          <div className="px-5 pb-5 space-y-3">
            <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide flex items-center gap-2">
              <svg className="w-3.5 h-3.5 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>ì‹ ê·œ ì¬ë§ˆê° ìš”ì²­ ì‘ì„±
            </p>
            <div>
              <label className="block text-xs text-gray-500 font-medium mb-1.5">ì¬ë§ˆê° í¬ë§ ì¼ì •</label>
              <input type="date" value={newDate} onChange={e => setNewDate(e.target.value)}
                     className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent" />
            </div>
            <div>
              <label className="block text-xs text-gray-500 font-medium mb-1.5">ìš”ì²­ ì‚¬í•­</label>
              <textarea value={newContent} onChange={e => setNewContent(e.target.value)} rows={3}
                        placeholder="ê³µì¥ì— ì „ë‹¬í•  ì¬ë§ˆê° ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."
                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent text-gray-700 leading-relaxed placeholder:text-gray-300" />
            </div>
            <div className="flex justify-end">
              <button onClick={handleSend} disabled={sending}
                      className="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-amber-500 hover:bg-amber-600 disabled:bg-amber-300 rounded-xl shadow-sm transition-all">
                {sending ? (
                  <><svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>ì „ì†¡ ì¤‘â€¦</>
                ) : (
                  <><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>ê³µì¥ìœ¼ë¡œ ì „ì†¡</>
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒíŒ íƒ­ â€” ì „ì²´ ë ˆì´ì•„ì›ƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SangpanTab({ onToast, onStatusChange, silcheukImages, onSangpanSchedule, sangpanData = {}, onSangpanVersionsChange, onDrawingChange, silcheukFinalDate = "", onSectionCChange, onClaimsChange, sangpanProductionStarted = false }) {
  const sd = sangpanData;
  return (
    <div className="p-5 space-y-5 max-w-4xl">

      <SangpanSectionA
        versions={sd.versions || []}
        activeVer={(sd.versions && sd.versions.length > 0) ? sd.versions[sd.versions.length - 1].versionNo : 1}
        onToast={onToast}
        onStatusChange={onStatusChange}
        silcheukImages={silcheukImages || []}
        onSangpanSchedule={onSangpanSchedule}
        uploadedFiles={sd.uploadedFiles || {}}
        onVersionsChange={onSangpanVersionsChange}
        silcheukFinalDate={silcheukFinalDate}
        sangpanProductionStarted={sangpanProductionStarted}
      />
      <SangpanSectionB
        drawingVersions={sd.drawingVersions || []}
        activeVer={(sd.drawingVersions && sd.drawingVersions.length > 0) ? sd.drawingVersions[sd.drawingVersions.length - 1].versionNo : 1}
        onToast={onToast}
        onDrawingChange={onDrawingChange}
      />
      <SangpanSectionC
        data={{ consumerApproved: sd.consumerApproved || false, confirmedAt: sd.confirmedAt || null }}
        onToast={onToast}
        onConfirmChange={onSectionCChange}
        sangpanProductionStarted={sangpanProductionStarted}
      />
      <SangpanSectionD
        claims={sd.claims || []}
        onToast={onToast}
        onClaimsChange={onClaimsChange}
      />

      <div className="h-4"></div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª©ëŒ€ íƒ­ â€” ì „ì²´ ë ˆì´ì•„ì›ƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function MokdaeTab({ onToast, onStatusChange, silcheukImages, onMokdaeSchedule, mokdaeData = {}, onMokdaeVersionsChange, onCadChange, silcheukFinalDate = "", onSectionCChange, onClaimsChange, mokdaeProductionStarted = false, onUrgentChange }) {
  const md = mokdaeData;

  /* ë°œì£¼ì„œ ì¬ë°œì†¡ ì‹œ CAD ìŠ¹ì¸ ìƒíƒœ ì „ë¶€ í•´ì œ */
  const handleCadReset = useCallback(() => {
    const cadVersions = md.cadVersions || [];
    if (cadVersions.length > 0) {
      const resetCad = cadVersions.map(v => ({ ...v, status: "ìŠ¹ì¸í•´ì œ" }));
      if (onCadChange) onCadChange(resetCad);
    }
  }, [md.cadVersions, onCadChange]);

  /* ê¸´ê¸‰ë°œì£¼ ì‹œ Section C (ì†Œë¹„ì ìŠ¹ì¸ & ë°œì£¼ í™•ì •) ë¦¬ì…‹ */
  const handleSectionCReset = useCallback(() => {
    if (onSectionCChange) onSectionCChange({ consumerApproved: false, confirmedAt: null });
  }, [onSectionCChange]);

  return (
    <div className="p-5 space-y-5 max-w-4xl">

      <MokdaeSectionA
        versions={md.versions || []}
        activeVer={(md.versions && md.versions.length > 0) ? md.versions[md.versions.length - 1].versionNo : 1}
        onToast={onToast}
        onStatusChange={onStatusChange}
        silcheukImages={silcheukImages || []}
        onMokdaeSchedule={onMokdaeSchedule}
        uploadedFiles={md.uploadedFiles || {}}
        onVersionsChange={onMokdaeVersionsChange}
        silcheukFinalDate={silcheukFinalDate}
        mokdaeProductionStarted={mokdaeProductionStarted}
        mokdaeConfirmedAt={md.confirmedAt || null}
        onCadReset={handleCadReset}
        onUrgentChange={onUrgentChange}
        onSectionCReset={handleSectionCReset}
      />
      <MokdaeSectionB
        cadVersions={md.cadVersions || []}
        activeVer={(md.cadVersions && md.cadVersions.length > 0) ? md.cadVersions[md.cadVersions.length - 1].versionNo : 1}
        onToast={onToast}
        onCadChange={onCadChange}
      />
      <MokdaeSectionC
        data={{ consumerApproved: md.consumerApproved || false, confirmedAt: md.confirmedAt || null }}
        onToast={onToast}
        onConfirmChange={onSectionCChange}
        mokdaeProductionStarted={mokdaeProductionStarted}
      />
      <MokdaeSectionD
        claims={md.claims || []}
        onToast={onToast}
        onClaimsChange={onClaimsChange}
      />

      <div className="h-4"></div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIGHT PANEL â€” íƒ­ + ì»¨í…ì¸ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TABS = ["ì‹¤ì¸¡", "ëª©ëŒ€", "ê¸°ê¸°", "ìƒíŒ"];
const TAB_ICONS = {
  ì‹¤ì¸¡: (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 11h.01M12 11h.01M15 11h.01M4 19h16a2 2 0 002-2V7a2 2 0 00-2-2H4a2 2 0 00-2 2v10a2 2 0 002 2z" />
    </svg>
  ),
  ëª©ëŒ€: (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
    </svg>
  ),
  ê¸°ê¸°: (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18" />
    </svg>
  ),
  ìƒíŒ: (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />
    </svg>
  ),
};

const TAB_ALERT = {
  ì‹¤ì¸¡: { icon: "!", cls: "bg-brand-weak text-brand" },
  ëª©ëŒ€: { icon: "!", cls: "bg-orange-100 text-orange-600" },
  ìƒíŒ: { icon: "!", cls: "bg-purple-100 text-purple-600" },
};

const TAB_STATUS_KEYS = { ì‹¤ì¸¡: "silcheuk", ëª©ëŒ€: "mokdae", ê¸°ê¸°: "gigi", ìƒíŒ: "sangpan" };

function getTabStatusStyle(text) {
  if (!text) return "text-gray-400";
  const t = text.toLowerCase();
  if (t.includes("ë°˜ë ¤") || t.includes("ìˆ˜ì •ìš”ì²­") || t.includes("ê¸´ê¸‰")) return "text-red-500 font-semibold";
  if (t.includes("í™•ì •") || t.includes("ì™„ë£Œ")) return "text-emerald-600 font-semibold";
  if (t.includes("ê²€í† ") || t.includes("ì§„í–‰") || t.includes("ì˜ˆì •") || t.includes("ì¤‘")) return "text-brand";
  return "text-gray-400";
}

function RightPanel({ onToast, onScheduleUnlock, caseStatus, onStatusChange, silcheukData, onProposalsSend, onFinalConfirm, onResultConfirm, onMokdaeSchedule, mokdaeData, onMokdaeVersionsChange, onCadChange, onSectionCChange, onClaimsChange, mokdaeProductionStarted, onGigiSchedule, onGigiOrderSubmit, gigiOrderData, onSangpanSchedule, sangpanData, onSangpanVersionsChange, onDrawingChange, onSangpanSectionCChange, onSangpanClaimsChange, sangpanProductionStarted, onMokdaeUrgentChange }) {
  const [activeTab, setActiveTab] = useState("ëª©ëŒ€");

  return (
    <main className="flex-1 flex flex-col min-w-0 h-full overflow-hidden">
      {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
      <div className="bg-white border-b border-gray-200 flex-shrink-0">
        <div className="flex px-4">
          {TABS.map(tab => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`flex flex-col items-center gap-0.5 px-5 py-2 text-sm transition-all duration-150
                ${activeTab === tab ? "tab-active" : "tab-inactive"}`}
            >
              <div className="flex items-center gap-1.5">
                {TAB_ICONS[tab]}
                <span>{tab}</span>
                {TAB_ALERT[tab] && (
                  <span className={`flex items-center justify-center w-4 h-4 rounded-full text-xs font-bold ${TAB_ALERT[tab].cls}`}>
                    {TAB_ALERT[tab].icon}
                  </span>
                )}
              </div>
              {caseStatus && (
                <span className={`text-xs font-normal whitespace-nowrap ${getTabStatusStyle(caseStatus[TAB_STATUS_KEYS[tab]])}`}>
                  {caseStatus[TAB_STATUS_KEYS[tab]] || "-"}
                </span>
              )}
            </button>
          ))}
        </div>
      </div>

      {/* íƒ­ ì»¨í…ì¸  â€” ëª¨ë“  íƒ­ì„ ìƒì‹œ ë§ˆìš´íŠ¸í•´ ìƒíƒœ ìœ ì‹¤ ë°©ì§€, inline styleë¡œ ê°€ì‹œì„± ì œì–´ */}
      <div className="flex-1 overflow-y-auto">
        <div style={{ display: activeTab !== "ì‹¤ì¸¡" ? "none" : "" }} className="p-5 space-y-6 max-w-4xl">
          <SectionSchedule
            data={silcheukData || { proposals: [], sent: false, engResponse: null }}
            onToast={onToast}
            onScheduleUnlock={onScheduleUnlock}
            onStatusChange={onStatusChange}
            onProposalsSend={onProposalsSend}
            onFinalConfirm={onFinalConfirm}
            resultDone={silcheukData?.resultDone || false}
          />
          <hr className="border-gray-200" />
          <SectionResult
            data={{
              images: [
                ...(silcheukData?.uploadResult?.drawings || []).map(f => ({ ...f, label: f.name, category: "ë„ë©´" })),
                ...(silcheukData?.uploadResult?.photos   || []).map(f => ({ ...f, label: f.name, category: "ì‚¬ì§„" })),
              ],
              memo:        silcheukData?.uploadResult?.memo        || "",
              submittedAt: silcheukData?.uploadResult?.submittedAt || null,
              isDone:      silcheukData?.resultDone || false,
            }}
            onToast={onToast}
            onConfirm={onResultConfirm}
          />
        </div>
        <div style={{ display: activeTab !== "ëª©ëŒ€" ? "none" : "" }}>
          <MokdaeTab
            onToast={onToast}
            onStatusChange={onStatusChange}
            silcheukImages={[
              ...(silcheukData?.uploadResult?.drawings || []).map(f => ({ ...f, label: f.name, category: "ë„ë©´" })),
              ...(silcheukData?.uploadResult?.photos   || []).map(f => ({ ...f, label: f.name, category: "ì‚¬ì§„" })),
            ]}
            onMokdaeSchedule={onMokdaeSchedule}
            mokdaeData={mokdaeData}
            onMokdaeVersionsChange={onMokdaeVersionsChange}
            onCadChange={onCadChange}
            silcheukFinalDate={silcheukData?.finalDate || ""}
            onSectionCChange={onSectionCChange}
            onClaimsChange={onClaimsChange}
            mokdaeProductionStarted={mokdaeProductionStarted}
            onUrgentChange={onMokdaeUrgentChange}
          />
        </div>
        <div style={{ display: activeTab !== "ìƒíŒ" ? "none" : "" }}>
          <SangpanTab
            onToast={onToast}
            onStatusChange={onStatusChange}
            silcheukImages={[
              ...(silcheukData?.uploadResult?.drawings || []).map(f => ({ ...f, label: f.name, category: "ë„ë©´" })),
              ...(silcheukData?.uploadResult?.photos   || []).map(f => ({ ...f, label: f.name, category: "ì‚¬ì§„" })),
            ]}
            onSangpanSchedule={onSangpanSchedule}
            sangpanData={sangpanData}
            onSangpanVersionsChange={onSangpanVersionsChange}
            onDrawingChange={onDrawingChange}
            silcheukFinalDate={silcheukData?.finalDate || ""}
            onSectionCChange={onSangpanSectionCChange}
            onClaimsChange={onSangpanClaimsChange}
            sangpanProductionStarted={sangpanProductionStarted}
          />
        </div>
        <div style={{ display: activeTab !== "ê¸°ê¸°" ? "none" : "" }}>
          <GigiTab onToast={onToast} onGigiOrderSubmit={onGigiOrderSubmit} gigiOrderData={gigiOrderData} />
        </div>
      </div>
    </main>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP ROOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function App() {
  const { toasts, add: addToast, remove: removeToast } = useToast();

  /* URLì—ì„œ ID ì½ì–´ localStorage ë°ì´í„° ë¡œë“œ */
  const caseId = getCaseId();
  const getInitialCase = () => {
    /* ì‹ ê·œ í˜„ì¥ ìƒì„± ëª¨ë“œ (?new=1) â€” localStorageì— ì•„ì§ ì €ì¥ ì•ˆ ëœ ìƒíƒœ */
    if (isNewCaseMode()) {
      return {
        id: "", archived: false,
        manager: "", customer: "", phone: "", address: "",
        schedule: { silcheuk: "", mokdae: "", gigi: "", sangpan: "" },
        status:   { silcheuk: "", mokdae: "", gigi: "", sangpan: "" },
        silcheukProposals: [], silcheukSent: false, silcheukEngResponse: null,
        silcheukFinalized: false, silcheukFinalDate: "", silcheukFinalTime: "",
      };
    }
    if (caseId) {
      const loaded = loadItemById(caseId);
      if (loaded) return loaded;
      /* IDëŠ” ìˆìœ¼ë‚˜ ë°ì´í„° ì—†ìŒ â€” ë¹ˆ ì¼€ì´ìŠ¤ ë°˜í™˜ */
      return {
        id: caseId, archived: false,
        manager: "", customer: "", phone: "", address: "",
        schedule: { silcheuk: "", mokdae: "", gigi: "", sangpan: "" },
        status:   { silcheuk: "", mokdae: "", gigi: "", sangpan: "" },
        silcheukProposals: [], silcheukSent: false, silcheukEngResponse: null,
        silcheukFinalized: false, silcheukFinalDate: "", silcheukFinalTime: "",
      };
    }
    /* URL íŒŒë¼ë¯¸í„° ì—†ì„ ê²½ìš° indexë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ */
    window.location.replace('index.html');
    return null;
  };

  const [caseData, setCaseData] = useState(getInitialCase);
  const [isNew, setIsNew] = useState(isNewCaseMode);

  /* â”€â”€ gigi_storeì—ì„œ ê¸°ê¸° ë°œì£¼ ë°ì´í„° ë¡œë“œ â”€â”€ */
  useEffect(() => {
    if (!caseId || isNewCaseMode()) return;
    (async () => {
      try {
        const res = await fetch(
          `${SUPABASE_URL}/rest/v1/gigi_store?case_id=eq.${encodeURIComponent(caseId)}&select=data`,
          { headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` } }
        );
        if (!res.ok) return;
        const rows = await res.json();
        if (rows.length > 0 && rows[0].data) {
          setCaseData(prev => {
            const updated = { ...prev, gigiOrderData: rows[0].data };
            if (rows[0].data.status) {
              updated.status = { ...prev.status, gigi: rows[0].data.status };
            }
            persistItem(updated);
            return updated;
          });
        }
      } catch (e) {
        console.warn("ê¸°ê¸° ë°œì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
      }
    })();
  }, [caseId]);

  /* ì‹¤ì¸¡ ì¼ì • ì ê¸ˆ: ì‹¤ì¸¡ íƒ­ ê³ ê° ì „ë‹¬ ì™„ë£Œ í›„ ìµœì¢… ì¼ì • ìë™ ì…ë ¥ */
  /* scheduleEditable ì œê±°: ì‹¤ì¸¡Â·ëª©ëŒ€ ì¼ì • í‘œì‹œê°€ *FinalDate ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì „í™˜ë¨ */

  /* engineer.htmlì´ localStorageë¥¼ ìˆ˜ì •í•˜ë©´ caseData ìë™ ê°±ì‹ 
     - storage ì´ë²¤íŠ¸: ë‹¤ë¥¸ íƒ­ì—ì„œ ë³€ê²½ëì„ ë•Œ
     - visibilitychange: ì´ íƒ­ì´ ë‹¤ì‹œ í™œì„±í™”ë  ë•Œ (ê°™ì€ origin íƒ­ ì „í™˜ ì‹œ) */
  useEffect(() => {
    if (!caseId) return;
    const refresh = () => {
      const fresh = loadItemById(caseId);
      if (fresh) setCaseData(fresh);
    };
    const onStorage = (e) => {
      if (e.key !== LS_KEY) return;
      refresh();
    };
    const onVisible = () => {
      if (document.visibilityState === 'visible') refresh();
    };
    window.addEventListener('storage', onStorage);
    document.addEventListener('visibilitychange', onVisible);
    return () => {
      window.removeEventListener('storage', onStorage);
      document.removeEventListener('visibilitychange', onVisible);
    };
  }, [caseId]);

  /* ì €ì¥ í•¸ë“¤ëŸ¬ â€” localStorage ë™ê¸°í™” í›„ í—¤ë”ë„ ê°±ì‹  */
  const handleSaveCase = useCallback((formData) => {
    /* ì‹ ê·œ í˜„ì¥: ì¤‘ë³µ ìƒë‹´ ID ê²€ì‚¬ */
    if (isNew) {
      const allItems = loadAllItems() || [];
      if (allItems.some(i => i.id === formData.id)) {
        addToast({ type: "error", title: "ì €ì¥ ì‹¤íŒ¨", message: "ë™ì¼í•œ ìƒë‹´ IDë¡œ ë“±ë¡ëœ í˜„ì¥ì´ ìˆìŠµë‹ˆë‹¤." });
        return false;
      }
      persistItem(formData);
      sessionStorage.setItem('CURRENT_CASE_ID', formData.id);
      setIsNew(false);
      setCaseData(formData);
      addToast({ type: "success", title: "ì €ì¥ ì™„ë£Œ", message: "ìƒˆ í˜„ì¥ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤." });
      return true;
    }
    /* ê¸°ì¡´ í˜„ì¥: LeftPanel form ë°ì´í„°(ê¸°ë³¸ì •ë³´Â·ì¼ì •Â·ìƒíƒœ)ë¥¼ ê¸°ì¡´ caseDataì— ë³‘í•©
       â†’ silcheuk*, mokdae* ë“± RightPanelì´ ê´€ë¦¬í•˜ëŠ” í•„ë“œë¥¼ ë³´ì¡´ */
    setCaseData(prev => {
      const merged = { ...prev, ...formData };
      persistItem(merged);
      return merged;
    });
    addToast({ type: "success", title: "ì €ì¥ ì™„ë£Œ", message: "ë³€ê²½ì‚¬í•­ì´ ëŒ€ì‹œë³´ë“œì— ë°˜ì˜ë©ë‹ˆë‹¤." });
    return true;
  }, [addToast, isNew]);

  useEffect(() => {
    if (caseData) document.title = `í˜„ì¥ ìƒì„¸ - ${caseData.id} | ì§ì‹œê³µ ë°œì£¼ ê´€ë¦¬ ì‹œìŠ¤í…œ`;
  }, [caseData?.id]);

  /* ì‹¤ì¸¡ í¬ë§ ì¼ì • ë°œì†¡ / ì´ˆê¸°í™” â†’ localStorage ì˜ì†í™” */
  const handleProposalsSend = useCallback((proposals, sent = true) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, silcheukProposals: proposals, silcheukSent: sent };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* ì‹¤ì¸¡ ê²°ê³¼ ê²€ìˆ˜ ì™„ë£Œ â†’ silcheuk ìƒíƒœ "ì™„ë£Œ" + localStorage ì˜ì†í™” */
  const handleResultConfirm = useCallback(() => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        silcheukResultDone: true,
        status: { ...prev.status, silcheuk: "ì™„ë£Œ" },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* ìµœì¢… ì¼ì • í™•ì • (ê³ ê° ì•ˆë‚´ ì „ë‹¬ ì™„ë£Œ) â†’ localStorage ì˜ì†í™” â†’ engineer.html ì—°ë™
     í•µì‹¬: schedule.silcheuk ì—ë„ ë™ì¼ ì¼ì •ì„ ê¸°ë¡í•´ì•¼
     index.html ëŒ€ì‹œë³´ë“œì™€ detail.html ê³µì •ì¼ì • ì¢Œì¸¡íŒ¨ë„ì— ìë™ ë°˜ì˜ë¨ */
  const handleFinalConfirm = useCallback((date, time) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        silcheukFinalized:  true,
        silcheukFinalDate:  date,
        silcheukFinalTime:  time,
        schedule: {
          ...(prev.schedule || {}),
          silcheuk: date,          // â† ê³µì •ì¼ì •Â·ëŒ€ì‹œë³´ë“œ ê³µìš© í•„ë“œì— í™•ì •ì¼ ê¸°ë¡
        },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* ëª©ëŒ€ ë°œì£¼ì„œ ê³µì¥ ìŠ¹ì¸ í™•ì • ì¼ì • â†’ schedule.mokdaeì— ê¸°ë¡ â†’ LeftPanelÂ·index.html ìë™ ë°˜ì˜ */
  const handleMokdaeSchedule = useCallback((date) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      /* ë™ì¼ ê°’ì´ë©´ ë¬´í•œ ë£¨í”„ ë°©ì§€ */
      if (prev.mokdaeFinalDate === date) return prev;
      const updated = {
        ...prev,
        mokdaeFinalDate: date,
        schedule: { ...(prev.schedule || {}), mokdae: date },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* ëª©ëŒ€ ë°œì£¼ì„œ ë²„ì „Â·íŒŒì¼ ë³€ê²½ â†’ localStorage ì˜ì†í™” */
  const handleMokdaeVersionsChange = useCallback((versions, uploadedFiles) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, mokdaeVersions: versions, mokdaeUploadedFiles: uploadedFiles };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* CAD ë„ë©´ ë²„ì „ ë³€ê²½ â†’ localStorage ì˜ì†í™” */
  const handleCadVersionsChange = useCallback((cadVersions) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, cadVersions };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* ëª©ëŒ€ SectionC ì†Œë¹„ì ìŠ¹ì¸ / ë°œì£¼ í™•ì • â†’ localStorage ì˜ì†í™” */
  const handleSectionCChange = useCallback(({ consumerApproved, confirmedAt }) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        mokdaeConsumerApproved: consumerApproved,
        mokdaeConfirmedAt: confirmedAt,
      };
      if (confirmedAt && prev.status?.mokdae !== "ì œì‘ì§„í–‰") {
        updated.status = { ...updated.status, mokdae: "ë°œì£¼í™•ì •" };
      }
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* ëª©ëŒ€ ê¸´ê¸‰ë°œì£¼ (í™•ì • í›„ ìˆ˜ì •) â†’ status.mokdae = "í™•ì •í›„ì¡°ì •(ê¸´ê¸‰)" â†’ localStorage ì˜ì†í™” */
  const handleMokdaeUrgentChange = useCallback(() => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        status: { ...prev.status, mokdae: "í™•ì •í›„ì¡°ì •(ê¸´ê¸‰)" },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* ëª©ëŒ€ SectionD ì¬ë§ˆê° ìš”ì²­ â†’ localStorage ì˜ì†í™” */
  const handleClaimsChange = useCallback((claims) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, mokdaeClaims: claims };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* â•â•â• ê¸°ê¸° Handlers â•â•â• */
  const handleGigiSchedule = useCallback((date) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      if (prev.gigiFinalDate === date) return prev;
      const updated = {
        ...prev,
        gigiFinalDate: date,
        schedule: { ...(prev.schedule || {}), gigi: date },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleGigiOrderSubmit = useCallback((orderData) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        gigiOrderData: orderData,
        status: { ...prev.status, gigi: orderData.status },
      };
      persistItem(updated);

      /* DB(gigi_store)ì—ë„ ì €ì¥ */
      const cid = prev.id;
      (async () => {
        try {
          // upsert: case_idê°€ PKì´ë¯€ë¡œ conflict ì‹œ update
          await fetch(`${SUPABASE_URL}/rest/v1/gigi_store`, {
            method: "POST",
            headers: {
              "apikey": SUPABASE_KEY,
              "Authorization": `Bearer ${SUPABASE_KEY}`,
              "Content-Type": "application/json",
              "Prefer": "resolution=merge-duplicates",
            },
            body: JSON.stringify({ case_id: cid, data: orderData }),
          });
        } catch (e) {
          console.warn("ê¸°ê¸° ë°œì£¼ DB ì €ì¥ ì‹¤íŒ¨:", e);
        }
      })();

      return updated;
    });
  }, [isNew]);

  /* â•â•â• ìƒíŒ Handlers (ëª©ëŒ€ì™€ ë™ì¼ íŒ¨í„´) â•â•â• */

  const handleSangpanSchedule = useCallback((date) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      if (prev.sangpanFinalDate === date) return prev;
      const updated = {
        ...prev,
        sangpanFinalDate: date,
        schedule: { ...(prev.schedule || {}), sangpan: date },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleSangpanVersionsChange = useCallback((versions, uploadedFiles) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, sangpanVersions: versions, sangpanUploadedFiles: uploadedFiles };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleSangpanDrawingChange = useCallback((drawingVersions) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, sangpanDrawingVersions: drawingVersions };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleSangpanSectionCChange = useCallback(({ consumerApproved, confirmedAt }) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        sangpanConsumerApproved: consumerApproved,
        sangpanConfirmedAt: confirmedAt,
      };
      if (confirmedAt && prev.status?.sangpan !== "ì œì‘ì§„í–‰") {
        updated.status = { ...updated.status, sangpan: "ë°œì£¼í™•ì •" };
      }
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleSangpanClaimsChange = useCallback((claims) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, sangpanClaims: claims };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* íƒ­ ì»´í¬ë„ŒíŠ¸ ìƒíƒœ ë³€ê²½ â†’ localStorage ìë™ ì €ì¥ â†’ ëŒ€ì‹œë³´ë“œ ì—°ë™ */
  const handleStatusChange = useCallback((tabKey, status) => {
    if (isNew) return; // ì‹ ê·œ í˜„ì¥ì€ ID ë¯¸í™•ì • ìƒíƒœì´ë¯€ë¡œ ìƒëµ
    setCaseData(prev => {
      if (!prev || prev.status[tabKey] === status) return prev; // ë³€ê²½ ì—†ìœ¼ë©´ ìŠ¤í‚µ
      const updated = { ...prev, status: { ...prev.status, [tabKey]: status } };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  if (!caseData) return null;

  const customerInitial = caseData.customer ? caseData.customer[0] : "?";

  return (
    <div className="flex flex-col h-full">
      {/* â”€â”€ ê¸€ë¡œë²Œ í—¤ë” â”€â”€ */}
      <header className="bg-gray-900 text-white flex-shrink-0 flex items-center px-5 py-2 gap-4 shadow z-20">
        {/* ë’¤ë¡œê°€ê¸° */}
        <button
          onClick={() => {
            sessionStorage.removeItem('CURRENT_CASE_ID');
            window.location.href = 'index.html';
          }}
          className="flex items-center gap-2 text-gray-400 hover:text-white text-sm transition-colors px-2 py-1 rounded-lg hover:bg-white/10"
        >
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
          </svg>
          ëª©ë¡ìœ¼ë¡œ
        </button>

        <div className="w-px h-5 bg-gray-700"></div>

        {/* ì‹œìŠ¤í…œ ë¡œê³  */}
        <div className="flex items-center gap-2">
          <div className="w-7 h-7 bg-brand rounded-lg flex items-center justify-center">
            <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
          </div>
          <span className="text-sm font-semibold text-gray-200 hidden sm:block">ì§ì‹œê³µ ë°œì£¼ ê´€ë¦¬</span>
        </div>

        {/* ë¹µë¶€ìŠ¤ëŸ¬ê¸° + ìƒë‹´ID */}
        <div className="flex items-center gap-2 text-sm text-gray-400">
          <span>í˜„ì¥ ìƒì„¸</span>
          <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
          </svg>
          <span className="font-mono text-brand font-semibold">{caseData.id}</span>
        </div>

        {/* ê³ ê°ëª… ë±ƒì§€ */}
        <div className="flex items-center gap-2 bg-white/10 rounded-lg px-3 py-1.5">
          <div className="w-5 h-5 rounded-full bg-brand flex items-center justify-center text-white text-xs font-bold">
            {customerInitial}
          </div>
          <span className="text-sm text-white font-medium">
            {caseData.customer || "ì‹ ê·œ í˜„ì¥"} ê³ ê°
          </span>
        </div>

        <div className="ml-auto flex items-center gap-3 text-xs text-gray-400">
          <span>ë§ˆì§€ë§‰ ìˆ˜ì •: 2026-02-25 14:32</span>
        </div>
      </header>

      {/* â”€â”€ Split View â”€â”€ */}
      <div className="flex flex-1 min-h-0">
        <LeftPanel data={caseData} onSave={handleSaveCase} isNew={isNew} silcheukFinalDate={caseData.silcheukFinalDate || ""} mokdaeFinalDate={caseData.mokdaeFinalDate || ""} gigiFinalDate={caseData.gigiFinalDate || ""} />
        <RightPanel
          onToast={addToast}
          onScheduleUnlock={() => { /* no-op: ì¼ì • í‘œì‹œê°€ *FinalDate ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì „í™˜ë¨ */ }}
          caseStatus={caseData.status}
          onStatusChange={handleStatusChange}
          silcheukData={{
            proposals:    caseData.silcheukProposals    || [],
            sent:         caseData.silcheukSent          || false,
            engResponse:  caseData.silcheukEngResponse  || null,
            finalized:    caseData.silcheukFinalized     || false,
            finalDate:    caseData.silcheukFinalDate     || "",
            finalTime:    caseData.silcheukFinalTime     || "",
            uploadResult: caseData.silcheukUploadResult  || null,
            resultDone:   caseData.silcheukResultDone    || false,
          }}
          onProposalsSend={handleProposalsSend}
          onFinalConfirm={handleFinalConfirm}
          onResultConfirm={handleResultConfirm}
          onMokdaeSchedule={handleMokdaeSchedule}
          mokdaeData={{
            versions:         caseData.mokdaeVersions         || [],
            uploadedFiles:    caseData.mokdaeUploadedFiles     || {},
            cadVersions:      caseData.cadVersions             || [],
            consumerApproved: caseData.mokdaeConsumerApproved  || false,
            confirmedAt:      caseData.mokdaeConfirmedAt       || null,
            claims:           caseData.mokdaeClaims            || [],
          }}
          onMokdaeVersionsChange={handleMokdaeVersionsChange}
          onCadChange={handleCadVersionsChange}
          onSectionCChange={handleSectionCChange}
          onClaimsChange={handleClaimsChange}
          mokdaeProductionStarted={caseData.mokdaeProductionStarted || false}
          onGigiSchedule={handleGigiSchedule}
          onGigiOrderSubmit={handleGigiOrderSubmit}
          gigiOrderData={caseData.gigiOrderData || null}
          onSangpanSchedule={handleSangpanSchedule}
          sangpanData={{
            versions:         caseData.sangpanVersions          || [],
            uploadedFiles:    caseData.sangpanUploadedFiles      || {},
            drawingVersions:  caseData.sangpanDrawingVersions    || [],
            consumerApproved: caseData.sangpanConsumerApproved   || false,
            confirmedAt:      caseData.sangpanConfirmedAt        || null,
            claims:           caseData.sangpanClaims             || [],
          }}
          onSangpanVersionsChange={handleSangpanVersionsChange}
          onDrawingChange={handleSangpanDrawingChange}
          onSangpanSectionCChange={handleSangpanSectionCChange}
          onSangpanClaimsChange={handleSangpanClaimsChange}
          sangpanProductionStarted={caseData.sangpanProductionStarted || false}
          onMokdaeUrgentChange={handleMokdaeUrgentChange}
        />
      </div>

      {/* â”€â”€ Toast ì»¨í…Œì´ë„ˆ â”€â”€ */}
      <ToastContainer toasts={toasts} onRemove={removeToast} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
