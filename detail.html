<!-- v2 -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>현장 상세 - C-2026-001 | 직시공 발주 관리 시스템</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["'Pretendard Variable'", "Pretendard", "Inter", "sans-serif"],
          },
          colors: {
            brand: '#00A1FF',
            'brand-weak': '#F0F8FC',
            'genuine-blue': { 50:'#F0F8FC',100:'#D9EFFF',200:'#9ED7FF',300:'#5EBFFF',400:'#00A1FF',500:'#0A78C0',600:'#095890' },
            success: { DEFAULT:'#16a34a', weak:'#f0fdf4', foreground:'#15803d' },
            warning: { DEFAULT:'#fbbf24', weak:'#fffbeb', foreground:'#b45309' },
            destructive: { DEFAULT:'#dc2626', weak:'#fef2f2', foreground:'#fef2f2' },
            muted: { DEFAULT:'#f3f4f6', foreground:'#6b7280' },
            accent: { DEFAULT:'#f3f4f6', foreground:'#111827' },
          },
          borderRadius: { '2xl':'1rem', '3xl':'1.25rem' },
          animation: {
            'slide-in-right': 'slideInRight 0.3s ease-out',
            'fade-out': 'fadeOut 0.4s ease-in forwards',
            'toast-in': 'toastIn 0.35s cubic-bezier(0.21, 1.02, 0.73, 1) forwards',
            'toast-out': 'toastOut 0.25s ease-in forwards',
          },
          keyframes: {
            slideInRight: {
              '0%': { transform: 'translateX(20px)', opacity: '0' },
              '100%': { transform: 'translateX(0)', opacity: '1' },
            },
            toastIn: {
              '0%': { transform: 'translateY(100%) scale(0.9)', opacity: '0' },
              '100%': { transform: 'translateY(0) scale(1)', opacity: '1' },
            },
            toastOut: {
              '0%': { transform: 'translateY(0) scale(1)', opacity: '1' },
              '100%': { transform: 'translateY(20px) scale(0.95)', opacity: '0' },
            },
          },
        },
      },
    };
  </script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: 'Pretendard Variable', 'Pretendard', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; letter-spacing: -0.3px; word-break: keep-all; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #F9FAFB; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

    /* Typography */
    .body-xs  { font-size: 0.625rem; line-height: 1.375; font-weight: 400; }
    .body-sm  { font-size: 0.75rem;  line-height: 1.375; font-weight: 400; }
    .body-md  { font-size: 0.875rem; line-height: 1.375; font-weight: 400; }
    .body-lg  { font-size: 1rem;     line-height: 1.375; font-weight: 400; }
    .heading-xs { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-sm { font-size: 0.875rem; line-height: 1.25; font-weight: 600; }
    .heading-md { font-size: 1.125rem; line-height: 1.25; font-weight: 600; }
    .heading-lg { font-size: 1.25rem;  line-height: 1.25; font-weight: 600; }

    .tab-active {
      border-bottom: 2px solid #00A1FF;
      color: #00A1FF;
      font-weight: 600;
    }
    .tab-inactive {
      border-bottom: 2px solid transparent;
      color: #6B7280;
    }
    .tab-inactive:hover {
      color: #374151;
      border-bottom-color: #E5E7EB;
    }

    /* ping-pong 연결선 */
    .flow-arrow::before {
      content: '';
      display: block;
      width: 2px;
      background: linear-gradient(to bottom, #E5E7EB, #F0F8FC);
      height: 24px;
      margin: 0 auto;
    }

    /* 이미지 썸네일 호버 */
    .thumb-wrap:hover .thumb-overlay {
      opacity: 1;
    }

    /* 토스트 */
    @keyframes toastIn {
      0% { transform: translateY(100%) scale(0.9); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    @keyframes toastOut {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(20px) scale(0.95); opacity: 0; }
    }
    .toast-enter { animation: toastIn 0.35s cubic-bezier(0.21,1.02,0.73,1) forwards; }
    .toast-exit { animation: toastOut 0.25s ease-in forwards; }

    /* 확정 버튼 shimmer */
    @keyframes shimmer {
      0% { background-position: -400px 0; }
      100% { background-position: 400px 0; }
    }
    .btn-confirm-done {
      background: linear-gradient(90deg, #059669 25%, #10b981 50%, #059669 75%);
      background-size: 400px 100%;
      animation: shimmer 2.5s infinite linear;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col overflow-hidden" style="height:100vh;">
<div id="root" class="flex flex-col h-full"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

/* ── localStorage 유틸 ── */
const LS_KEY = 'JIKSIGONG_DATA';
function loadAllItems() {
  try { const r = localStorage.getItem(LS_KEY); return r ? JSON.parse(r) : null; } catch(e) { return null; }
}
function loadItemById(id) {
  const items = loadAllItems();
  return items ? (items.find(i => i.id === id) || null) : null;
}
function persistItem(updated) {
  const items = loadAllItems() || [];
  const idx = items.findIndex(i => i.id === updated.id);
  if (idx >= 0) items[idx] = updated; else items.push(updated);
  try { localStorage.setItem(LS_KEY, JSON.stringify(items)); } catch(e) {}
  // DB sync (fire-and-forget)
  syncCaseToDB(updated);
}

/* ── Supabase DB 유틸 ── */
const SUPABASE_URL = "https://ykifurzrrbjrgjrznimk.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlraWZ1cnpycmJqcmdqcnpuaW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjE3NTcsImV4cCI6MjA4NzY5Nzc1N30.BVTlrG_Q_cXqj6qOa_rZPXrCs7MhwuR9o8koncGoUU0";
const SB_HEADERS = { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" };
const STORAGE_BUCKET = "case-files";

/* ── Storage 업로드 유틸 ── */
async function uploadFileToStorage(file, caseId, section) {
  const timestamp = Date.now();
  const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
  const storagePath = `${caseId}/${section}/${timestamp}_${safeName}`;
  
  const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${STORAGE_BUCKET}/${storagePath}`, {
    method: "POST",
    headers: {
      "apikey": SUPABASE_KEY,
      "Authorization": `Bearer ${SUPABASE_KEY}`,
      "Content-Type": file.type || "application/octet-stream",
      "x-upsert": "true",
    },
    body: file,
  });
  
  if (!res.ok) {
    console.error("Storage upload failed:", await res.text());
    return null;
  }
  
  // Public URL for the file
  const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${storagePath}`;
  return { storagePath, publicUrl };
}

/* ── 이미지 리사이즈 후 Blob 변환 ── */
function resizeImageToBlob(file, maxSize = 900) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        let { width, height } = img;
        if (width > maxSize || height > maxSize) {
          if (width >= height) { height = Math.round(height * maxSize / width); width = maxSize; }
          else { width = Math.round(width * maxSize / height); height = maxSize; }
        }
        const canvas = document.createElement("canvas");
        canvas.width = width; canvas.height = height;
        canvas.getContext("2d").drawImage(img, 0, 0, width, height);
        canvas.toBlob((blob) => resolve(blob), "image/jpeg", 0.75);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function caseToDbRow(c) {
  return {
    id: c.id,
    customer: c.customer || null,
    phone: c.phone || null,
    address: c.address || null,
    manager: c.manager || null,
    schedule: c.schedule || {},
    status: c.status || {},
    archived: c.archived || false,
    cancelled: c.cancelled || false,
    silcheuk_proposals: c.silcheukProposals || [],
    silcheuk_sent: c.silcheukSent || false,
    silcheuk_eng_response: c.silcheukEngResponse || null,
    silcheuk_finalized: c.silcheukFinalized || false,
    silcheuk_final_date: c.silcheukFinalDate || null,
    silcheuk_final_time: c.silcheukFinalTime || null,
    silcheuk_upload_result: c.silcheukUploadResult || null,
    silcheuk_result_done: c.silcheukResultDone || false,
    mokdae_versions: c.mokdaeVersions || [],
    mokdae_uploaded_files: c.mokdaeUploadedFiles || {},
    cad_versions: c.cadVersions || [],
    mokdae_consumer_approved: c.mokdaeConsumerApproved || false,
    mokdae_confirmed_at: c.mokdaeConfirmedAt || null,
    mokdae_claims: c.mokdaeClaims || [],
    mokdae_production_started: c.mokdaeProductionStarted || false,
    mokdae_production_started_at: c.mokdaeProductionStartedAt || null,
    mokdae_final_date: c.mokdaeFinalDate || null,
    sangpan_versions: c.sangpanVersions || [],
    sangpan_uploaded_files: c.sangpanUploadedFiles || {},
    sangpan_drawing_versions: c.sangpanDrawingVersions || [],
    sangpan_consumer_approved: c.sangpanConsumerApproved || false,
    sangpan_confirmed_at: c.sangpanConfirmedAt || null,
    sangpan_claims: c.sangpanClaims || [],
    sangpan_production_started: c.sangpanProductionStarted || false,
    sangpan_production_started_at: c.sangpanProductionStartedAt || null,
    sangpan_final_date: c.sangpanFinalDate || null,
    gigi_final_date: c.gigiFinalDate || null,
  };
}

function dbRowToCase(r) {
  return {
    id: r.id,
    customer: r.customer,
    phone: r.phone,
    address: r.address,
    manager: r.manager,
    schedule: r.schedule || {},
    status: r.status || {},
    archived: r.archived || false,
    cancelled: r.cancelled || false,
    silcheukProposals: r.silcheuk_proposals || [],
    silcheukSent: r.silcheuk_sent || false,
    silcheukEngResponse: r.silcheuk_eng_response || null,
    silcheukFinalized: r.silcheuk_finalized || false,
    silcheukFinalDate: r.silcheuk_final_date || "",
    silcheukFinalTime: r.silcheuk_final_time || "",
    silcheukUploadResult: r.silcheuk_upload_result || null,
    silcheukResultDone: r.silcheuk_result_done || false,
    mokdaeVersions: r.mokdae_versions || [],
    mokdaeUploadedFiles: r.mokdae_uploaded_files || {},
    cadVersions: r.cad_versions || [],
    mokdaeConsumerApproved: r.mokdae_consumer_approved || false,
    mokdaeConfirmedAt: r.mokdae_confirmed_at || null,
    mokdaeClaims: r.mokdae_claims || [],
    mokdaeProductionStarted: r.mokdae_production_started || false,
    mokdaeProductionStartedAt: r.mokdae_production_started_at || null,
    mokdaeFinalDate: r.mokdae_final_date || "",
    sangpanVersions: r.sangpan_versions || [],
    sangpanUploadedFiles: r.sangpan_uploaded_files || {},
    sangpanDrawingVersions: r.sangpan_drawing_versions || [],
    sangpanConsumerApproved: r.sangpan_consumer_approved || false,
    sangpanConfirmedAt: r.sangpan_confirmed_at || null,
    sangpanClaims: r.sangpan_claims || [],
    sangpanProductionStarted: r.sangpan_production_started || false,
    sangpanProductionStartedAt: r.sangpan_production_started_at || null,
    sangpanFinalDate: r.sangpan_final_date || "",
    gigiFinalDate: r.gigi_final_date || "",
  };
}

let _syncTimer = null;
function syncCaseToDB(caseData) {
  // Debounce: 300ms 이내 연속 호출 시 마지막만 실행
  clearTimeout(_syncTimer);
  _syncTimer = setTimeout(async () => {
    try {
      const row = caseToDbRow(caseData);
      await fetch(`${SUPABASE_URL}/rest/v1/cases`, {
        method: "POST",
        headers: { ...SB_HEADERS, "Prefer": "resolution=merge-duplicates" },
        body: JSON.stringify(row),
      });
    } catch (e) { console.warn("DB sync failed:", e); }
  }, 300);
}

async function loadCaseFromDB(id) {
  try {
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/cases?id=eq.${encodeURIComponent(id)}&select=*`,
      { headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` } }
    );
    if (!res.ok) return null;
    const rows = await res.json();
    return rows.length > 0 ? dbRowToCase(rows[0]) : null;
  } catch (e) { console.warn("DB load failed:", e); return null; }
}

async function fetchGigiOrderFromDB(caseId) {
  try {
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/gigi_store?case_id=eq.${encodeURIComponent(caseId)}&select=data`,
      { headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` } }
    );
    if (!res.ok) return null;
    const rows = await res.json();
    return rows.length > 0 && rows[0]?.data ? rows[0].data : null;
  } catch (e) {
    console.warn("기기 DB 로드 실패:", e);
    return null;
  }
}

async function upsertGigiOrderToDB(caseId, orderData) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/gigi_store?on_conflict=case_id`, {
    method: "POST",
    headers: {
      ...SB_HEADERS,
      "Prefer": "resolution=merge-duplicates,return=representation",
    },
    body: JSON.stringify({ case_id: caseId, data: orderData }),
  });

  if (!res.ok) {
    throw new Error(`기기 발주 DB 저장 실패 (${res.status})`);
  }

  const rows = await res.json().catch(() => []);
  if (rows.length > 0 && rows[0]?.data) return rows[0].data;

  const reloaded = await fetchGigiOrderFromDB(caseId);
  if (!reloaded) throw new Error("기기 발주 저장 후 재조회 실패");
  return reloaded;
}
function getCaseId() {
  // sessionStorage 우선, 없으면 URL query param 폴백 (직접 URL 접근 시)
  try {
    const fromSession = sessionStorage.getItem('CURRENT_CASE_ID');
    if (fromSession) return fromSession;
    return new URLSearchParams(window.location.search).get('id');
  } catch(e) { return null; }
}
function isNewCaseMode() {
  try { return new URLSearchParams(window.location.search).get('new') === '1'; } catch(e) { return false; }
}


const MANAGERS = ["김민준", "이서연", "박현우", "정유나", "한소희"];

/* ═══════════════════════════════════════════════════════
   TOAST SYSTEM
═══════════════════════════════════════════════════════ */
function ToastContainer({ toasts, onRemove }) {
  return (
    <div className="fixed bottom-6 right-6 z-50 flex flex-col gap-2 items-end pointer-events-none">
      {toasts.map(t => (
        <Toast key={t.id} toast={t} onRemove={onRemove} />
      ))}
    </div>
  );
}

function Toast({ toast, onRemove }) {
  const [exiting, setExiting] = useState(false);

  useEffect(() => {
    const timer = setTimeout(() => {
      setExiting(true);
      setTimeout(() => onRemove(toast.id), 280);
    }, toast.duration || 4000);
    return () => clearTimeout(timer);
  }, []);

  const iconMap = {
    success: (
      <svg className="w-5 h-5 text-emerald-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    info: (
      <svg className="w-5 h-5 text-brand flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    warning: (
      <svg className="w-5 h-5 text-amber-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
      </svg>
    ),
  };

  const borderMap = {
    success: "border-l-4 border-emerald-500",
    info: "border-l-4 border-brand",
    warning: "border-l-4 border-amber-500",
  };

  return (
    <div
      className={`
        pointer-events-auto
        ${exiting ? "toast-exit" : "toast-enter"}
        ${borderMap[toast.type] || borderMap.info}
        bg-white rounded-xl shadow px-4 py-3 flex items-start gap-3 min-w-[320px] max-w-sm
      `}
    >
      {iconMap[toast.type] || iconMap.info}
      <div className="flex-1 min-w-0">
        {toast.title && <p className="text-sm font-semibold text-gray-800">{toast.title}</p>}
        <p className="text-sm text-gray-600 mt-1">{toast.message}</p>
      </div>
      <button
        onClick={() => { setExiting(true); setTimeout(() => onRemove(toast.id), 280); }}
        className="text-gray-300 hover:text-gray-500 transition-colors flex-shrink-0 mt-1"
      >
        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  );
}

function useToast() {
  const [toasts, setToasts] = useState([]);
  const add = useCallback(({ type = "info", title, message, duration = 4000 }) => {
    const id = Date.now() + Math.random();
    setToasts(prev => [...prev, { id, type, title, message, duration }]);
  }, []);
  const remove = useCallback((id) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);
  return { toasts, add, remove };
}

/* ═══════════════════════════════════════════════════════
   LEFT PANEL — 기본 정보 + 일정 + 진행 상태
═══════════════════════════════════════════════════════ */
const SILCHEUK_STATUS_OPTS = ["실측예정","실측중","완료","반려"];
const MOKDAE_STATUS_OPTS   = ["발주요청대기","CAD도면검토중","발주요청완료","발주확정","제작진행","발주요청반려","재마감확정","확정후조정(긴급)","CAD수정요청"];
const GIGI_STATUS_OPTS     = ["발주요청대기","발주요청완료","발주확정","발주요청반려","재마감확정","확정후조정(긴급)"];
const SANGPAN_STATUS_OPTS  = ["발주요청대기","상판도면검토중","발주요청완료","발주확정","제작진행","발주요청반려","재마감확정","확정후조정(긴급)","상판도면수정요청"];

function LeftPanel({ data, onSave, isNew, silcheukFinalDate, mokdaeFinalDate, gigiFinalDate, sangpanFinalDate }) {
  const [form, setForm] = useState({
    id:       data.id || "",
    manager:  data.manager || "",
    customer: data.customer || "",
    phone:    data.phone || "",
    address:  data.address || "",
    archived: data.archived || false,
    schedule: {
      silcheuk: (data.schedule && data.schedule.silcheuk) || "",
      mokdae:   (data.schedule && data.schedule.mokdae)   || "",
      gigi:     (data.schedule && data.schedule.gigi)     || "",
      sangpan:  (data.schedule && data.schedule.sangpan)  || "",
    },
    status: {
      silcheuk: (data.status && data.status.silcheuk) || "",
      mokdae:   (data.status && data.status.mokdae)   || "",
      gigi:     (data.status && data.status.gigi)     || "",
      sangpan:  (data.status && data.status.sangpan)  || "",
    },
  });
  const [saved, setSaved] = useState(false);

  /* data prop이 외부에서 바뀌면 form도 동기화 (status, schedule 포함) */
  useEffect(() => {
    setForm(prev => ({
      ...prev,
      id:       data.id || "",
      manager:  data.manager || "",
      customer: data.customer || "",
      phone:    data.phone || "",
      address:  data.address || "",
      archived: data.archived || false,
      schedule: {
        silcheuk: (data.schedule && data.schedule.silcheuk) || "",
        mokdae:   (data.schedule && data.schedule.mokdae)   || "",
        gigi:     (data.schedule && data.schedule.gigi)     || "",
        sangpan:  (data.schedule && data.schedule.sangpan)  || "",
      },
      status: {
        silcheuk: (data.status && data.status.silcheuk) || "",
        mokdae:   (data.status && data.status.mokdae)   || "",
        gigi:     (data.status && data.status.gigi)     || "",
        sangpan:  (data.status && data.status.sangpan)  || "",
      },
    }));
  }, [data.id, data.status?.mokdae, data.status?.gigi, data.status?.sangpan, data.status?.silcheuk, data.schedule?.mokdae, data.schedule?.gigi, data.schedule?.sangpan, data.schedule?.silcheuk]);

  /* 실측 탭 전달 완료 시 silcheukFinalDate가 채워지면 form에 자동 반영 */
  useEffect(() => {
    if (silcheukFinalDate) {
      setForm(prev => ({ ...prev, schedule: { ...prev.schedule, silcheuk: silcheukFinalDate } }));
    }
  }, [silcheukFinalDate]);

  /* 목대 발주서 공장 승인 시 mokdaeFinalDate가 채워지면 form에 자동 반영 */
  useEffect(() => {
    setForm(prev => ({ ...prev, schedule: { ...prev.schedule, mokdae: mokdaeFinalDate || "" } }));
  }, [mokdaeFinalDate]);

  /* 기기 탭에서 일정 확정 시 gigiFinalDate가 채워지면 form에 자동 반영 */
  useEffect(() => {
    setForm(prev => ({ ...prev, schedule: { ...prev.schedule, gigi: gigiFinalDate || "" } }));
  }, [gigiFinalDate]);

  /* 상판 발주서 공장 승인 시 sangpanFinalDate가 채워지면 form에 자동 반영 */
  useEffect(() => {
    setForm(prev => ({ ...prev, schedule: { ...prev.schedule, sangpan: sangpanFinalDate || "" } }));
  }, [sangpanFinalDate]);

  const handleChange   = (k, v)  => { setForm(prev => ({ ...prev, [k]: v })); setSaved(false); };
  const handleSchedule = (k, v)  => { setForm(prev => ({ ...prev, schedule: { ...prev.schedule, [k]: v } })); setSaved(false); };
  const handleStatus   = (k, v)  => { setForm(prev => ({ ...prev, status:   { ...prev.status,   [k]: v } })); setSaved(false); };

  /* 날짜 입력 제한: 오늘 이전 불가 + 기기/상판은 실측 일정 이후만 가능 */
  const today = new Date().toISOString().slice(0, 10);
  const minScheduleDate = silcheukFinalDate && silcheukFinalDate > today ? silcheukFinalDate : today;

  /* 신규 현장 모드: 5개 필수 항목이 모두 입력되어야 저장 가능 */
  const requiredFilled = !isNew || (
    form.id.trim() && form.manager.trim() && form.customer.trim() &&
    form.phone.trim() && form.address.trim()
  );

  const handleSave = () => {
    const ok = onSave(form);
    if (ok !== false) {
      setSaved(true);
      setTimeout(() => setSaved(false), 2500);
    }
  };

  return (
    <aside className="w-[30%] min-w-[280px] bg-white border-r border-gray-200 flex flex-col h-full overflow-hidden">
      {/* 패널 헤더 */}
      <div className="px-5 py-4 border-b border-gray-200 flex-shrink-0">
        <div className="flex items-center gap-2 mb-1">
          <span className="w-1.5 h-5 rounded-full bg-brand inline-block"></span>
          <h2 className="text-base font-bold text-gray-800">기본 정보</h2>
        </div>
        {isNew
          ? <p className="text-xs text-orange-500 pl-3.5 font-medium">필수 항목(*)을 모두 입력한 후 저장하세요.</p>
          : <p className="text-xs text-gray-400 pl-3.5">수정 후 하단 [저장] 버튼을 눌러야 반영됩니다.</p>
        }
      </div>

      {/* 폼 영역 */}
      <div className="flex-1 overflow-y-auto px-5 py-5 space-y-5">

        {/* 취소된 현장 배너 */}
        {data.cancelled && (
          <div className="flex items-start gap-3 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
            <svg className="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
            <div>
              <p className="text-sm font-bold text-red-700">취소된 현장</p>
              <p className="text-xs text-red-500 mt-0.5">이 현장은 삭제 처리되었습니다. 공급업체·기사 화면에서 취소된 요청으로 표시됩니다.</p>
            </div>
          </div>
        )}

        {/* 상담 ID */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            상담 ID {isNew && <span className="text-red-500">*</span>}
          </label>
          <input
            type="text"
            value={form.id}
            onChange={e => handleChange("id", e.target.value)}
            className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg font-mono
                       focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                       text-gray-800 transition-shadow"
            placeholder="C-2026-001"
          />
        </div>

        {/* 영업 담당자 */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            영업 담당자 <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <select
              value={form.manager}
              onChange={e => handleChange("manager", e.target.value)}
              className="w-full appearance-none px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                         text-gray-800 cursor-pointer transition-shadow"
            >
              <option value="">담당자 선택</option>
              {MANAGERS.map(m => <option key={m} value={m}>{m}</option>)}
            </select>
            <svg className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>

        {/* 고객명 */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            고객명 <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <input
              type="text"
              value={form.customer}
              onChange={e => handleChange("customer", e.target.value)}
              className="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                         text-gray-800 transition-shadow"
            />
          </div>
        </div>

        {/* 고객 전화번호 */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            고객 전화번호 {isNew && <span className="text-red-500">*</span>}
          </label>
          <div className="relative">
            <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            <input
              type="tel"
              value={form.phone}
              onChange={e => handleChange("phone", e.target.value)}
              className="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                         text-gray-800 font-mono transition-shadow"
            />
          </div>
        </div>

        {/* 현장 주소 */}
        <div>
          <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wide">
            현장 주소 {isNew && <span className="text-red-500">*</span>}
          </label>
          <div className="relative">
            <svg className="absolute left-3 top-3 w-4 h-4 text-gray-400"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <textarea
              value={form.address}
              onChange={e => handleChange("address", e.target.value)}
              rows={3}
              className="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent
                         text-gray-800 resize-none leading-relaxed transition-shadow"
            />
          </div>
        </div>

        {/* 공정 일정 */}
        <div className="bg-gray-50 rounded-xl p-4 border border-gray-200 space-y-3">
          <p className="text-sm font-bold text-gray-700 flex items-center gap-1.5 pb-2 border-b border-gray-200">
            <svg className="w-4 h-4 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            공정 일정
          </p>

          {/* 실측 일정: 실측 탭 최종 확정 일정 자동 반영 (read-only, 데이터 기반 표시) */}
          <div className="flex items-center gap-3">
            <span className="text-xs text-gray-500 font-semibold w-8 flex-shrink-0">실측</span>
            {!silcheukFinalDate ? (
              <div className="flex-1 flex items-center gap-2 px-2 py-1.5 bg-gray-100 border border-gray-100 rounded-lg">
                <svg className="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span className="text-xs text-gray-400">실측 탭 전달 완료 후 자동 입력</span>
              </div>
            ) : (
              <input
                type="date"
                value={form.schedule.silcheuk}
                disabled
                className="flex-1 px-2 py-1.5 text-xs border border-gray-100 rounded-lg bg-gray-50 text-gray-500 cursor-default"
              />
            )}
          </div>

          {/* 목대 일정: 발주서 공장 승인 후 자동 입력 (read-only) */}
          <div className="flex items-center gap-3">
            <span className="text-xs text-gray-500 font-semibold w-8 flex-shrink-0">목대</span>
            {!mokdaeFinalDate ? (
              <div className="flex-1 flex items-center gap-2 px-2 py-1.5 bg-gray-100 border border-gray-100 rounded-lg">
                <svg className="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span className="text-xs text-gray-400">발주서 공장 승인 후 자동 입력</span>
              </div>
            ) : (
              <input
                type="date"
                value={form.schedule.mokdae}
                disabled
                className="flex-1 px-2 py-1.5 text-xs border border-gray-100 rounded-lg bg-gray-50 text-gray-500 cursor-default"
              />
            )}
          </div>

          {/* 기기 일정: 기기탭에서 확정 → read-only */}
          <div className="flex items-center gap-3">
            <span className="text-xs text-gray-500 font-semibold w-8 flex-shrink-0">기기</span>
            {gigiFinalDate ? (
              <input
                type="date"
                value={form.schedule.gigi}
                disabled
                className="flex-1 px-2 py-1.5 text-xs border border-gray-100 rounded-lg bg-gray-50 text-gray-500 cursor-default"
              />
            ) : (
              <span className="flex-1 text-xs text-gray-300 px-2 py-1.5">기기 탭에서 일정을 선택하세요</span>
            )}
          </div>

          {/* 상판 일정: 발주서 공장 승인 후 자동 입력 (read-only) */}
          <div className="flex items-center gap-3">
            <span className="text-xs text-gray-500 font-semibold w-8 flex-shrink-0">상판</span>
            {!sangpanFinalDate ? (
              <div className="flex-1 flex items-center gap-2 px-2 py-1.5 bg-gray-100 border border-gray-100 rounded-lg">
                <svg className="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span className="text-xs text-gray-400">발주서 공장 승인 후 자동 입력</span>
              </div>
            ) : (
              <input
                type="date"
                value={form.schedule.sangpan}
                disabled
                className="flex-1 px-2 py-1.5 text-xs border border-gray-100 rounded-lg bg-gray-50 text-gray-500 cursor-default"
              />
            )}
          </div>
        </div>

      </div>

      {/* 저장 버튼 */}
      <div className="px-5 py-4 border-t border-gray-100 flex-shrink-0">
        <button
          onClick={handleSave}
          disabled={!requiredFilled}
          className={`w-full py-2 rounded-xl text-sm font-semibold transition-all duration-200 flex items-center justify-center gap-2 ${
            !requiredFilled
              ? "bg-gray-200 text-gray-400 cursor-not-allowed"
              : saved
              ? "bg-emerald-500 text-white shadow-sm"
              : "bg-brand hover:bg-[#0090e6] text-white shadow-sm hover:shadow"
          }`}
        >
          {saved ? (
            <>
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
              저장 완료 — 대시보드에 반영됨
            </>
          ) : (
            <>
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
              저장하기
            </>
          )}
        </button>
      </div>
    </aside>
  );
}

/* ═══════════════════════════════════════════════════════
   SECTION A — 실측 일정 (Ping-pong)
═══════════════════════════════════════════════════════ */
let nextId = 3;

function SectionSchedule({ data, onToast, onScheduleUnlock, onStatusChange, onProposalsSend, onFinalConfirm, resultDone }) {
  /* 날짜 입력 제한: 오늘 이전 불가 */
  const today = new Date().toISOString().slice(0, 10);

  /* ── Step 1: 고객 희망 일정 ── */
  const [proposals, setProposals] = useState(
    data.proposals && data.proposals.length > 0
      ? data.proposals
      : [{ id: 1, date: "", time: "10:00" }]
  );
  const [sent, setSent] = useState(data.sent || false);

  /* ── Step 2: 기사 응답 (engineer.html에서 localStorage로 수신) ── */
  const engResponse = data.engResponse || null; // { type:"accepted"|"counter", date, time, counterProposals:[{date,time}] }

  /* ── Step 3: 최종 확정 — localStorage에서 복원 (페이지 리로드 시 휘발 방지) ── */
  const [finalStatus, setFinalStatus]               = useState(data.finalized ? "done" : "waiting");
  const [selectedScheduleKey, setSelectedScheduleKey] = useState(
    data.finalized && data.finalDate ? `${data.finalDate}|${data.finalTime}` : ""
  );

  /* scheduleOptions: 기사 응답 기반 선택 가능 일정 */
  const scheduleOptions = (() => {
    if (!engResponse) return [];
    if (engResponse.type === "accepted") return [{ date: engResponse.date, time: engResponse.time }];
    if (engResponse.type === "counter") return (engResponse.counterProposals || [{ date: engResponse.date, time: engResponse.time }]).filter(p => p.date);
    return [];
  })();

  /* scheduleOptions 생성되면 첫 항목 자동 선택 */
  useEffect(() => {
    if (scheduleOptions.length > 0 && !selectedScheduleKey) {
      const opt = scheduleOptions[0];
      setSelectedScheduleKey(`${opt.date}|${opt.time}`);
    }
  }, [scheduleOptions.length]);

  /* ── Step 1 핸들러 ── */
  const addProposal    = () => setProposals(prev => [...prev, { id: Date.now(), date: "", time: "10:00" }]);
  const removeProposal = (id) => { setProposals(prev => prev.filter(p => p.id !== id)); setSent(false); };
  const updateProposal = (id, key, value) => {
    setProposals(prev => prev.map(p => p.id === id ? { ...p, [key]: value } : p));
    setSent(false);
  };
  const handleSend = () => {
    if (proposals.some(p => !p.date)) {
      onToast({ type: "warning", title: "입력 확인 필요", message: "날짜가 비어있는 항목이 있습니다." });
      return;
    }
    setSent(true);
    onProposalsSend && onProposalsSend(proposals, true);
    onToast({ type: "success", title: "기사 전달 완료", message: "고객 희망 일정이 기사에게 발송되었습니다." });
  };
  const handleReset = () => {
    const fresh = [{ id: 1, date: "", time: "10:00" }];
    setProposals(fresh);
    setSent(false);
    onProposalsSend && onProposalsSend(fresh, false);
    setFinalStatus("waiting");
    setSelectedScheduleKey("");
  };

  /* ── Step 3 핸들러 ── */
  const handleFinalStatusChange = (v) => {
    setFinalStatus(v);
    if (v === "done") {
      onScheduleUnlock && onScheduleUnlock();
      const [selDate, selTime] = (selectedScheduleKey || "").split("|");
      /* 최종 확정 일정을 App → localStorage → engineer.html 로 전달 */
      onFinalConfirm && onFinalConfirm(selDate || "", selTime || "");
      onToast({
        type: "success",
        title: "고객 전달 완료",
        message: `${selDate || ""} ${selTime || ""} 일정이 고객과 기사에게 동시 전달되었습니다.`,
        duration: 5000,
      });
    }
  };

  /* ── 실측 상태 뱃지 ── */
  /* resultDone(검수 완료)가 최우선 — 리마운트 시 "실측 예정"이 "완료"를 덮어쓰는 버그 방지 */
  const scheduleStatus =
    resultDone                              ? "완료"
    : finalStatus === "done"               ? "실측 예정"
    : (sent && proposals.length > 0)       ? "일정 조율중"
    : "실측 요청 대기";
  const scheduleStatusStyle = {
    "실측 요청 대기": "bg-gray-100 text-gray-500 border border-gray-200",
    "일정 조율중":    "bg-amber-100 text-amber-700 border border-amber-200",
    "실측 예정":      "bg-brand-weak text-brand border border-brand/20",
    "완료":           "bg-emerald-100 text-emerald-700 border border-emerald-200",
  }[scheduleStatus] || "bg-gray-100 text-gray-500 border border-gray-200";

  /* 실측 상태 변경 시 부모에 알림 → 대시보드 자동 연동 */
  useEffect(() => {
    onStatusChange && onStatusChange("silcheuk", scheduleStatus);
  }, [scheduleStatus]);

  return (
    <div className="space-y-4">
      {/* 헤더 */}
      <div className="flex items-center gap-2">
        <div className="w-1 h-5 rounded-full bg-brand"></div>
        <h3 className="font-bold text-gray-800 text-sm">실측 일정 조율</h3>
        <span className={`ml-auto text-xs font-semibold px-2.5 py-1 rounded-full ${scheduleStatusStyle}`}>
          {scheduleStatus}
        </span>
      </div>

      {/* ── STEP 1: 고객 희망 일정 ── */}
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <div className="flex items-center justify-between px-4 py-3 bg-gray-50 border-b border-gray-100">
          <div className="flex items-center gap-2">
            <span className="flex items-center justify-center w-5 h-5 rounded-full bg-brand text-white text-xs font-bold">1</span>
            <span className="text-sm font-semibold text-gray-700">고객 희망 일정</span>
            <span className="text-xs text-gray-400">(관리자 입력 → 기사 전달)</span>
          </div>
          {sent && (
            <span className="flex items-center gap-1 text-xs text-emerald-600 font-semibold">
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
              발송 완료
            </span>
          )}
        </div>

        <div className="px-4 py-4 space-y-2.5">
          {/* 최종 확정(고객 전달) 완료 시 입력 비활성화 */}
          {finalStatus === "done" && (
            <div className="flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg mb-1">
              <svg className="w-3.5 h-3.5 text-emerald-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <span className="text-xs text-emerald-700 font-medium">최종 일정이 확정되어 수정할 수 없습니다</span>
            </div>
          )}
          {proposals.map((p, idx) => (
            <div key={p.id} className="flex items-center gap-2">
              <span className="text-xs font-medium text-gray-400 w-7 text-center">{idx + 1}안</span>
              <input
                type="date" value={p.date}
                min={today}
                disabled={finalStatus === "done"}
                onChange={e => updateProposal(p.id, "date", e.target.value)}
                className={`flex-1 px-3 py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-gray-700 ${finalStatus === "done" ? "bg-gray-50 border-gray-100 cursor-default" : "border-gray-300 bg-white"}`}
              />
              <input
                type="time" value={p.time}
                disabled={finalStatus === "done"}
                onChange={e => updateProposal(p.id, "time", e.target.value)}
                className={`w-28 px-3 py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-gray-700 ${finalStatus === "done" ? "bg-gray-50 border-gray-100 cursor-default" : "border-gray-300 bg-white"}`}
              />
              {proposals.length > 1 && finalStatus !== "done" && (
                <button onClick={() => removeProposal(p.id)}
                  className="w-7 h-7 flex items-center justify-center rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors">
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              )}
            </div>
          ))}
          {finalStatus !== "done" && (
            <button onClick={addProposal}
              className="flex items-center gap-2 text-xs text-brand hover:text-[#0090e6] font-medium px-2 py-1.5 rounded-lg hover:bg-brand-weak transition-colors mt-1">
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>
              일정 안 추가
            </button>
          )}
        </div>

        <div className="px-4 py-3 bg-gray-50 border-t border-gray-100 flex justify-end gap-2">
          <button onClick={handleReset}
            disabled={finalStatus === "done"}
            className={`px-3 py-1.5 text-xs font-medium border rounded-lg transition-colors ${finalStatus === "done" ? "text-gray-300 border-gray-200 cursor-not-allowed" : "text-gray-500 hover:text-gray-700 border-gray-300 hover:bg-white"}`}>
            초기화
          </button>
          <button onClick={handleSend}
            disabled={finalStatus === "done"}
            className={`px-4 py-1.5 text-xs font-semibold rounded-lg transition-colors flex items-center gap-2 shadow-sm ${finalStatus === "done" ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "text-white bg-brand hover:bg-[#0090e6]"}`}>
            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
            기사에게 발송
          </button>
        </div>
      </div>

      {/* ── 연결 화살표 ── */}
      <div className="flex items-center gap-2 px-4">
        <div className="flex-1 h-px bg-gradient-to-r from-brand/30 to-gray-200"></div>
        <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
        </svg>
        <div className="flex-1 h-px bg-gradient-to-l from-gray-200 to-amber-200"></div>
      </div>

      {/* ── STEP 2: 기사 확인 · 응답 ── */}
      <div className={`border rounded-xl overflow-hidden transition-colors ${
        !sent                               ? "border-gray-200 bg-white"
        : engResponse?.type === "accepted"  ? "border-emerald-200 bg-emerald-50/30"
        : engResponse?.type === "counter"   ? "border-red-200 bg-red-50/30"
        : "border-amber-200 bg-amber-50/20"
      }`}>
        <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 bg-white/70">
          <div className="flex items-center gap-2">
            <span className="flex items-center justify-center w-5 h-5 rounded-full bg-amber-500 text-white text-xs font-bold">2</span>
            <span className="text-sm font-semibold text-gray-700">기사 확인 · 응답</span>
          </div>
          <span className={`text-xs font-bold px-3 py-1 rounded-full border ${
            !sent                               ? "bg-gray-100 text-gray-400 border-gray-200"
            : engResponse?.type === "accepted"  ? "bg-emerald-100 text-emerald-700 border-emerald-300"
            : engResponse?.type === "counter"   ? "bg-red-100 text-red-700 border-red-300"
            : "bg-amber-100 text-amber-700 border-amber-300"
          }`}>
            {!sent ? "전달 전" : engResponse?.type === "accepted" ? "일정 수락 ✓" : engResponse?.type === "counter" ? "대체 제안" : "응답 대기중"}
          </span>
        </div>

        <div className="px-4 py-4">
          {/* 발송 전 */}
          {!sent && (
            <div className="flex items-center justify-center gap-2 py-6 text-sm text-gray-400">
              <svg className="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              고객 희망 일정을 입력하고 기사에게 발송하면 이 화면에서 확인할 수 있습니다
            </div>
          )}

          {/* 발송 후 · 기사 응답 대기 */}
          {sent && !engResponse && (
            <div className="space-y-3">
              <div>
                <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">전달된 고객 희망 일정</p>
                <div className="space-y-1.5">
                  {proposals.map((p, idx) => (
                    <div key={p.id} className="flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
                      <span className="text-xs font-bold text-gray-400 w-5 text-center">{idx + 1}</span>
                      <svg className="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span className="text-sm font-semibold text-gray-700">{p.date || "날짜 미입력"}</span>
                      <span className="text-sm text-gray-500">{p.time}</span>
                    </div>
                  ))}
                </div>
              </div>
              <div className="flex items-center gap-2 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2.5">
                <svg className="w-4 h-4 text-amber-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span className="text-xs text-amber-700 font-semibold">기사 앱에서 응답을 대기 중입니다</span>
              </div>
            </div>
          )}

          {/* 발송 후 · 기사 수락 */}
          {sent && engResponse?.type === "accepted" && (
            <div className="flex items-start gap-3 bg-emerald-50 border border-emerald-200 rounded-xl px-4 py-3">
              <div className="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center flex-shrink-0 mt-0.5">
                <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <p className="text-sm font-semibold text-emerald-700">기사 — 일정 수락</p>
                <p className="text-xs text-emerald-600 mt-1">
                  수락 일정: <span className="font-bold">{engResponse.date}  {engResponse.time}</span>
                </p>
              </div>
            </div>
          )}

          {/* 발송 후 · 기사 대체 제안 */}
          {sent && engResponse?.type === "counter" && (
            <div className="space-y-3">
              <div className="flex items-start gap-3 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
                <div className="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center flex-shrink-0 mt-0.5">
                  <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </div>
                <div>
                  <p className="text-sm font-semibold text-red-700">기사 — 일정 불가</p>
                  <p className="text-xs text-red-500 mt-0.5">아래 대체 일정으로 역제안했습니다</p>
                </div>
              </div>
              <div>
                <p className="text-xs font-semibold text-gray-500 mb-2 flex items-center gap-1">
                  <svg className="w-3.5 h-3.5 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                  </svg>
                  기사 역제안 일시
                </p>
                <div className="flex flex-wrap gap-2">
                  {(engResponse.counterProposals || [{ date: engResponse.date, time: engResponse.time }]).map((cp, i) => (
                    <div key={i} className="flex items-center gap-2 bg-amber-50 border-2 border-amber-400 rounded-lg px-3 py-2">
                      <svg className="w-3.5 h-3.5 text-amber-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span className="text-sm font-bold text-amber-800">{cp.date}</span>
                      <span className="text-sm text-amber-700 font-medium">{cp.time}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* ── 연결 화살표 ── */}
      <div className="flex items-center gap-2 px-4">
        <div className="flex-1 h-px bg-gradient-to-r from-amber-200 to-gray-200"></div>
        <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
        </svg>
        <div className="flex-1 h-px bg-gradient-to-l from-gray-200 to-emerald-200"></div>
      </div>

      {/* ── STEP 3: 최종 확정 일정 ── */}
      <div className="bg-white border border-emerald-200 rounded-xl overflow-hidden">
        <div className="flex items-center justify-between px-4 py-3 bg-emerald-50 border-b border-emerald-100">
          <div className="flex items-center gap-2">
            <span className="flex items-center justify-center w-5 h-5 rounded-full bg-emerald-600 text-white text-xs font-bold">3</span>
            <span className="text-sm font-semibold text-gray-700">최종 확정 일정</span>
          </div>
          {scheduleOptions.length > 0 && (
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-500">고객 안내:</span>
              <div className="relative">
                <select
                  value={finalStatus} onChange={e => handleFinalStatusChange(e.target.value)}
                  className={`appearance-none text-xs font-semibold px-3 py-1.5 pr-7 rounded-lg border cursor-pointer focus:outline-none focus:ring-2 focus:ring-emerald-400 transition-all ${
                    finalStatus === "done"
                      ? "bg-emerald-100 text-emerald-700 border-emerald-300"
                      : "bg-gray-100 text-gray-600 border-gray-300"
                  }`}
                >
                  <option value="waiting">📢 전달 대기</option>
                  <option value="done">✅ 전달 완료</option>
                </select>
                <svg className="absolute right-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-current pointer-events-none opacity-60"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          )}
        </div>

        <div className="px-4 py-4">
          {scheduleOptions.length === 0 ? (
            <div className="flex items-center gap-3 bg-gray-50 border border-dashed border-gray-300 rounded-xl px-4 py-3">
              <svg className="w-4 h-4 text-gray-300 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <span className="text-sm text-gray-400">기사 응답 수신 후 일정 선택 가능합니다</span>
            </div>
          ) : (
            <div className="space-y-3">
              <div className="flex items-center gap-3">
                <div className="flex-1">
                  <p className="text-xs font-semibold text-gray-500 mb-1.5">
                    {engResponse?.type === "accepted" ? "기사 승낙 일정" : "기사 역제안 일시 선택"}
                  </p>
                  <div className="relative">
                    <select
                      value={selectedScheduleKey} onChange={e => setSelectedScheduleKey(e.target.value)}
                      disabled={finalStatus === "done"}
                      className={`w-full appearance-none text-sm font-bold px-4 py-2.5 pr-9 rounded-xl border focus:outline-none focus:ring-2 focus:ring-emerald-400 transition-all ${
                        finalStatus === "done"
                          ? "bg-emerald-50 text-emerald-700 border-emerald-200 cursor-default"
                          : "bg-white text-gray-800 border-gray-300 hover:border-emerald-400 cursor-pointer"
                      }`}
                    >
                      {scheduleOptions.map((opt, i) => (
                        <option key={`${opt.date}|${opt.time}`} value={`${opt.date}|${opt.time}`}>
                          {opt.date}  {opt.time}{engResponse?.type === "counter" ? `  (${i + 1}안 · 기사 역제안)` : "  (기사 승낙)"}
                        </option>
                      ))}
                    </select>
                    {finalStatus !== "done" && (
                      <svg className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    )}
                  </div>
                </div>
              </div>
              {finalStatus === "done" && (
                <div className="flex items-center gap-2 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2 text-xs text-emerald-700 font-semibold">
                  <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                  </svg>
                  고객과 기사에게 동시 전달 완료
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   SECTION B — 실측 결과
═══════════════════════════════════════════════════════ */
function SectionResult({ data, onToast, onConfirm }) {
  const [isDone, setIsDone] = useState(data.isDone);
  const [selectedImg, setSelectedImg] = useState(null);

  /* 업로드 시각 포맷 */
  const fmtSubmittedAt = (iso) => {
    if (!iso) return null;
    try {
      const d = new Date(iso);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    } catch { return null; }
  };
  const submittedLabel = fmtSubmittedAt(data.submittedAt);
  const hasImages = data.images && data.images.length > 0;

  const handleConfirm = () => {
    setIsDone(true);
    onConfirm?.(); // localStorage 저장 + status.silcheuk → "완료" 처리
    onToast({
      type: "success",
      title: "대시보드 상태 변경",
      message: "대시보드 실측 상태가 [완료]로 변경되었습니다.",
      duration: 5000,
    });
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center gap-2">
        <div className="w-1 h-5 rounded-full bg-brand"></div>
        <h3 className="font-bold text-gray-800 text-base">실측 결과 검수</h3>
        {isDone && (
          <span className="ml-auto flex items-center gap-1 text-xs font-bold text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full">
            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
            </svg>
            검수 완료
          </span>
        )}
      </div>

      {/* 실측지 & 사진 그리드 */}
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <div className="px-4 py-3 bg-gray-50 border-b border-gray-100 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span className="text-sm font-semibold text-gray-700">실측지 및 현장 사진</span>
            {hasImages && <span className="text-xs text-gray-400">({data.images.length}장 · 클릭하면 확대)</span>}
          </div>
          {submittedLabel && (
            <span className="text-xs text-gray-400">업로드: {submittedLabel}</span>
          )}
        </div>

        {hasImages ? (
          <div className="p-4 grid grid-cols-4 gap-3">
            {data.images.map(img => (
              <div
                key={img.id}
                className="thumb-wrap relative aspect-[4/3] rounded-lg overflow-hidden cursor-zoom-in group border border-gray-200"
                onClick={() => setSelectedImg(img)}
              >
                {img.isImage ? (
                  <img
                    src={img.url}
                    alt={img.label}
                    className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                    loading="lazy"
                  />
                ) : (
                  <div className="w-full h-full bg-gray-100 flex flex-col items-center justify-center gap-1 p-2">
                    <svg className="w-7 h-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5}
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p className="text-xs text-gray-500 truncate w-full text-center">{img.name}</p>
                  </div>
                )}
                <div className="thumb-overlay absolute inset-0 bg-gray-900/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-end">
                  <p className="text-white text-xs font-medium p-2 w-full truncate">{img.label}</p>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="p-8 flex flex-col items-center gap-2 text-center">
            <svg className="w-10 h-10 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5}
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p className="text-sm text-gray-400 font-medium">아직 업로드된 자료가 없습니다</p>
            <p className="text-xs text-gray-300">기사가 실측 결과를 업로드하면 여기에 표시됩니다.</p>
          </div>
        )}
      </div>

      {/* 실측 메모 */}
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <div className="px-4 py-3 bg-gray-50 border-b border-gray-100 flex items-center gap-2">
          <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <span className="text-sm font-semibold text-gray-700">실측 메모</span>
          <span className="text-xs text-gray-400">(기사 작성 · Read-only)</span>
        </div>
        <div className="px-4 py-4">
          {data.memo ? (
            <pre className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap font-sans bg-gray-50 rounded-lg p-4 border border-gray-100">
              {data.memo}
            </pre>
          ) : (
            <p className="text-sm text-gray-300 italic">메모 없음</p>
          )}
        </div>
      </div>

      {/* 확정 버튼 */}
      <button
        onClick={handleConfirm}
        disabled={isDone}
        className={`w-full py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2
          ${isDone
            ? "btn-confirm-done text-white cursor-default shadow-sm"
            : "bg-brand hover:bg-[#0090e6] text-white shadow-sm  hover:shadow-sm hover:-translate-y-0.5"
          }`}
      >
        {isDone ? (
          <>
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            실측 결과 검수 완료됨
          </>
        ) : (
          <>
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
            실측 결과 확인 완료
          </>
        )}
      </button>

      {/* 이미지 라이트박스 */}
      {selectedImg && (
        <div
          className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-6"
          onClick={() => setSelectedImg(null)}
        >
          <div
            className="relative max-w-3xl w-full bg-white rounded-2xl overflow-hidden shadow"
            onClick={e => e.stopPropagation()}
          >
            <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
              <p className="text-sm font-semibold text-gray-800">{selectedImg.label}</p>
              <button
                onClick={() => setSelectedImg(null)}
                className="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500 transition-colors"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <img src={selectedImg.url} alt={selectedImg.label} className="w-full object-contain max-h-[70vh]" />
            <div className="px-4 py-2 bg-gray-50 text-xs text-gray-400 text-center">
              클릭하거나 ESC를 눌러 닫기
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


/* ───── 공통 헬퍼 ───── */
function SectionHeader({ color, icon, title, sub, badge }) {
  const colorMap = {
    blue:   { bg: "bg-brand-weak",   border: "border-brand/10",   dot: "bg-brand",   icon: "bg-brand"   },
    orange: { bg: "bg-orange-50", border: "border-orange-100", dot: "bg-orange-600", icon: "bg-orange-600" },
    green:  { bg: "bg-emerald-50",border: "border-emerald-100",dot: "bg-emerald-600",icon: "bg-emerald-600" },
    amber:  { bg: "bg-amber-50",  border: "border-amber-100",  dot: "bg-amber-600",  icon: "bg-amber-600"  },
  };
  const c = colorMap[color] || colorMap.blue;
  return (
    <div className={`flex items-center justify-between px-5 py-3 ${c.bg} border-b ${c.border}`}>
      <div className="flex items-center gap-2">
        <div className={`w-6 h-6 rounded-lg ${c.icon} flex items-center justify-center flex-shrink-0`}>
          {icon}
        </div>
        <div>
          <h4 className="text-base font-bold text-gray-800">{title}</h4>
          {sub && <p className="text-xs text-gray-400 mt-1">{sub}</p>}
        </div>
      </div>
      {badge}
    </div>
  );
}

/* ───── 상태 뱃지 스타일 (목대 전용) ───── */
function MokdaeStatusBadge({ status, large = false }) {
  const map = {
    "발주요청대기":     { cls: "bg-gray-100 text-gray-500 border-gray-200",          dot: "bg-gray-400" },
    "발주요청완료":     { cls: "bg-brand-weak text-brand border-brand/20",              dot: "bg-brand" },
    "발주요청반려":     { cls: "bg-red-100 text-red-700 border-red-200",                 dot: "bg-red-500" },
    "CAD도면검토중":    { cls: "bg-brand-weak text-brand border-brand/20",              dot: "bg-brand" },
    "CAD수정요청":      { cls: "bg-orange-100 text-orange-700 border-orange-200",        dot: "bg-orange-500" },
    "발주확정":         { cls: "bg-emerald-100 text-emerald-700 border-emerald-200",     dot: "bg-emerald-500" },
    "확정후조정긴급":   { cls: "bg-red-100 text-red-700 border-red-200",                 dot: "bg-red-500 animate-pulse" },
    "재마감요청":       { cls: "bg-orange-100 text-orange-700 border-orange-200",        dot: "bg-orange-500" },
    "재마감조정":       { cls: "bg-amber-100 text-amber-700 border-amber-200",           dot: "bg-amber-500" },
    "재마감확정":       { cls: "bg-emerald-100 text-emerald-700 border-emerald-200",     dot: "bg-emerald-500" },
    "제작진행":         { cls: "bg-teal-100 text-teal-700 border-teal-200",             dot: "bg-teal-500" },
    "도면검토중":         { cls: "bg-brand-weak text-brand border-brand/20",              dot: "bg-brand" },
    "도면수정요청":       { cls: "bg-orange-100 text-orange-700 border-orange-200",        dot: "bg-orange-500" },
  };
  const s = map[status] || { cls: "bg-gray-100 text-gray-500 border-gray-200", dot: "bg-gray-400" };
  const sizeBase = large ? "text-sm px-3 py-1.5 gap-2" : "text-xs px-2 py-1 gap-2";
  return (
    <span className={`inline-flex items-center rounded-full border font-semibold ${sizeBase} ${s.cls}`}>
      <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${s.dot}`}></span>
      {status}
    </span>
  );
}

/* ───── 파일 아이템 (업그레이드) ───── */
const FILE_TYPE_META = {
  "실측지":   { color: "bg-rose-100 text-rose-600 border-rose-200",    icon: "📐" },
  "현장사진": { color: "bg-purple-100 text-purple-600 border-purple-200", icon: "📷" },
  "3D도면":   { color: "bg-brand-weak text-brand border-brand/20",     icon: "🧊" },
  "기기스펙": { color: "bg-amber-100 text-amber-700 border-amber-200",  icon: "⚙️" },
};
const EXT_COLOR = {
  pdf: "bg-red-100 text-red-700", xlsx: "bg-emerald-100 text-emerald-700",
  zip: "bg-purple-100 text-purple-700", skp: "bg-cyan-100 text-cyan-700",
  dwg: "bg-brand-weak text-brand",
};

function FileItem({ file, showRequired = false }) {
  const ext = file.name.split(".").pop().toLowerCase();
  const meta = FILE_TYPE_META[file.type] || { color: "bg-gray-100 text-gray-600 border-gray-200", icon: "📄" };
  return (
    <div className={`flex items-center gap-3 px-3 py-2 rounded-lg border transition-colors group
      ${!file.uploaded ? "border-dashed border-red-300 bg-red-50/40" : "border-gray-200 bg-white hover:border-brand/30 hover:bg-brand-weak/20"}`}>
      {/* 파일 유형 태그 */}
      <span className={`flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full border whitespace-nowrap ${meta.color}`}>
        <span className="text-base leading-none">{meta.icon}</span>
        {file.type}
      </span>
      <div className="flex-1 min-w-0">
        {file.uploaded ? (
          <>
            <p className="text-sm text-gray-700 font-medium truncate">{file.name}</p>
            <p className="text-xs text-gray-400">{file.size}</p>
          </>
        ) : (
          <>
            <p className="text-sm text-red-500 font-medium">미업로드</p>
            <p className="text-xs text-red-400">{file.required ? "필수 서류" : "선택 서류"}</p>
          </>
        )}
      </div>
      <div className="flex items-center gap-2 flex-shrink-0">
        {showRequired && file.required && !file.uploaded && (
          <span className="text-xs font-bold text-red-600 bg-red-100 px-1.5 py-0.5 rounded">필수 누락</span>
        )}
        <span className={`text-xs font-bold px-1.5 py-0.5 rounded uppercase ${EXT_COLOR[ext] || "bg-gray-100 text-gray-500"}`}>
          {ext}
        </span>
        {file.uploaded && (
          <button className="opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-brand">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
          </button>
        )}
      </div>
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   공통 모달 래퍼
═══════════════════════════════════════════════════════ */
function Modal({ open, onClose, children, maxW = "max-w-lg" }) {
  useEffect(() => {
    const fn = e => e.key === "Escape" && onClose();
    if (open) document.addEventListener("keydown", fn);
    return () => document.removeEventListener("keydown", fn);
  }, [open]);
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60"
         onClick={onClose}>
      <div className={`relative w-full ${maxW} bg-white rounded-2xl shadow`}
           onClick={e => e.stopPropagation()}>
        {children}
      </div>
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   목대 탭 — Section A: 발주 서류 & 버전 히스토리
═══════════════════════════════════════════════════════ */
function MokdaeSectionA({ versions: initVersions, activeVer: initActive, onToast, onStatusChange, silcheukImages = [], onMokdaeSchedule, uploadedFiles: initUploadedFiles = {}, onVersionsChange, silcheukFinalDate = "", mokdaeProductionStarted = false, mokdaeConfirmedAt = null, onCadReset, onUrgentChange, onSectionCReset }) {
  const [versions, setVersions]     = useState(initVersions);
  const [activeVer, setActiveVer]   = useState(initActive);
  const [uploadedFiles, setUploadedFiles] = useState(initUploadedFiles); // versionNo → [{id,name,size,url,isImage}]
  const [dragging, setDragging]     = useState(false);
  const [silcheukOpen, setSilcheukOpen] = useState(true);
  const [lightbox, setLightbox]     = useState(null); // { url, name } | null
  const fileInputRef = useRef(null);
  const [urgentConfirmOpen, setUrgentConfirmOpen] = useState(false);

  const current       = versions.find(v => v.versionNo === activeVer);
  const isNewVersion  = current?.isNew === true;
  const currentFiles  = uploadedFiles[activeVer] || [];
  const submittedVers = versions.filter(v => !v.isNew);
  const badgeStatus   = submittedVers.length > 0 ? "발주요청완료" : "발주요청대기";

  /* ESC → 라이트박스 닫기 */
  useEffect(() => {
    const fn = (e) => { if (e.key === "Escape") setLightbox(null); };
    document.addEventListener("keydown", fn);
    return () => document.removeEventListener("keydown", fn);
  }, []);

  /* 발주 상태 변경 시 부모에 알림 → 대시보드 자동 연동
     제작진행/발주확정/확정후조정(긴급) 등 상위 상태를 적극 반영 */
  useEffect(() => {
    if (!onStatusChange) return;
    if (mokdaeProductionStarted) {
      onStatusChange("mokdae", "제작진행");
      return;
    }
    if (mokdaeConfirmedAt) {
      onStatusChange("mokdae", "발주확정");
      return;
    }
    onStatusChange("mokdae", badgeStatus);
  }, [badgeStatus, mokdaeProductionStarted, mokdaeConfirmedAt]);

  /* 공장 승인(factoryChecked)된 최신 버전의 목대 일정을 부모에 전달
     → App이 schedule.mokdae + mokdaeFinalDate에 저장 → LeftPanel·index.html 자동 반영 */
  useEffect(() => {
    if (!onMokdaeSchedule) return;
    const approved = versions
      .filter(v => !v.isNew && v.factoryChecked)
      .sort((a, b) => b.versionNo - a.versionNo);
    const date = (approved.length > 0 && approved[0].mokdaeDate) || "";
    onMokdaeSchedule(date);
  }, [versions]);

  /* ── 데이터 영속화: 변경 → 부모(App)로 전달 → localStorage 저장 ── */
  const didMountA = useRef(false);
  useEffect(() => {
    if (!didMountA.current) { didMountA.current = true; return; }
    if (onVersionsChange) onVersionsChange(versions, uploadedFiles);
  }, [versions, uploadedFiles]);

  /* ── cross-tab 동기화: factory.html에서 factoryChecked 등 변경 시 반영 ── */
  useEffect(() => {
    if (JSON.stringify(initVersions) !== JSON.stringify(versions)) setVersions(initVersions);
  }, [JSON.stringify(initVersions)]);
  useEffect(() => {
    if (JSON.stringify(initUploadedFiles) !== JSON.stringify(uploadedFiles)) setUploadedFiles(initUploadedFiles);
  }, [JSON.stringify(initUploadedFiles)]);

  /* 날짜 입력 제한: 오늘 이전 불가 + 실측 일정 이후만 가능 */
  const today = new Date().toISOString().slice(0, 10);
  const minMokdaeDate = silcheukFinalDate && silcheukFinalDate > today ? silcheukFinalDate : today;

  const CheckIcon = () => (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
    </svg>
  );

  /* ── 새 버전 추가 ── */
  const handleAddVersion = () => {
    /* 발주 확정 후 버전 추가 → 긴급발주 확인 */
    if (mokdaeConfirmedAt) {
      setUrgentConfirmOpen(true);
      return;
    }
    doAddVersion();
  };
  const doAddVersion = () => {
    const maxNo = versions.length > 0 ? Math.max(...versions.map(v => v.versionNo)) : 0;
    const newVer = { versionNo: maxNo + 1, files: [], factoryChecked: false, sentAt: "", sentBy: "", memo: "", mokdaeDate: "", isNew: true };
    setVersions(prev => [...prev, newVer]);
    setActiveVer(maxNo + 1);
    setUrgentConfirmOpen(false);
  };

  /* ── 파일 업로드 (Storage 업로드) ── */
  const handleDragOver  = (e) => { e.preventDefault(); setDragging(true); };
  const handleDragLeave = (e) => { e.preventDefault(); setDragging(false); };
  const handleDrop = (e) => { e.preventDefault(); setDragging(false); handleAddFiles(Array.from(e.dataTransfer.files)); };
  const handleFileInputChange = (e) => { handleAddFiles(Array.from(e.target.files)); e.target.value = ""; };
  const [uploading, setUploading] = useState(false);
  const handleAddFiles = async (fileList) => {
    if (!fileList.length) return;
    const caseId = getCaseId();
    if (!caseId) { onToast({ type: "warning", message: "케이스 ID를 찾을 수 없습니다." }); return; }
    setUploading(true);
    try {
      const results = [];
      for (const f of fileList) {
        const sizeStr = f.size > 1024 * 1024 ? `${(f.size / 1024 / 1024).toFixed(1)} MB` : `${Math.round(f.size / 1024)} KB`;
        const isImage = f.type.startsWith("image/");
        let uploadFile = f;
        if (isImage) {
          const resizedBlob = await resizeImageToBlob(f);
          if (resizedBlob) uploadFile = new File([resizedBlob], f.name, { type: "image/jpeg" });
        }
        const uploaded = await uploadFileToStorage(uploadFile, caseId, "mokdae");
        if (uploaded) {
          results.push({ id: Date.now() + Math.random(), name: f.name, size: sizeStr, url: uploaded.publicUrl, storagePath: uploaded.storagePath, isImage });
        } else {
          results.push({ id: Date.now() + Math.random(), name: f.name, size: sizeStr, url: null, isImage: false, uploadFailed: true });
        }
      }
      setUploadedFiles(prev => ({ ...prev, [activeVer]: [...(prev[activeVer] || []), ...results] }));
      const failCount = results.filter(r => r.uploadFailed).length;
      if (failCount > 0) {
        onToast({ type: "warning", title: "일부 업로드 실패", message: `${fileList.length - failCount}개 성공, ${failCount}개 실패` });
      } else {
        onToast({ type: "success", title: "파일 추가됨", message: `${fileList.length}개 파일이 업로드되었습니다.` });
      }
    } catch (e) {
      console.error("File upload error:", e);
      onToast({ type: "warning", message: "파일 업로드 중 오류가 발생했습니다." });
    } finally {
      setUploading(false);
    }
  };
  const handleRemoveFile = (fileId) => {
    setUploadedFiles(prev => ({ ...prev, [activeVer]: (prev[activeVer] || []).filter(f => f.id !== fileId) }));
  };

  /* ── 파일 다운로드 ── */
  const handleDownloadFile = (f) => {
    if (!f.url) return;
    const a = document.createElement('a');
    a.href = f.url;
    a.download = f.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  /* ── 발주 요청 전송 ── */
  const doSendRequest = () => {
    const now = new Date().toLocaleString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, isNew: false, factoryChecked: false, sentAt: now, sentBy: "관리자" } : v
    ));
    /* 발주서 재발송 시 기존 CAD 승인 해제 */
    if (onCadReset) onCadReset();
    /* 발주 확정 후 수정 → 긴급발주 상태 + Section C 리셋 */
    if (mokdaeConfirmedAt) {
      if (onUrgentChange) onUrgentChange();
      if (onSectionCReset) onSectionCReset();
      onToast({ type: "warning", title: `발주 V${activeVer} 긴급 발송`, message: "확정 후 수정 발송 — 긴급발주 상태로 변경되며, 소비자 승인 및 발주 확정이 리셋됩니다.", duration: 5000 });
    } else {
      onToast({ type: "success", title: `발주 V${activeVer} 요청 완료`, message: "공장으로 발주 요청이 전송되었습니다." });
    }
  };

  return (
    <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
      {/* 헤더 (버전 추가 버튼 포함) */}
      <div className="flex items-center justify-between px-5 py-3 bg-brand-weak border-b border-brand/10">
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 rounded-lg bg-brand flex items-center justify-center flex-shrink-0">
            <svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <div>
            <h4 className="text-base font-bold text-gray-800">Section A · 발주 서류</h4>
            <p className="text-xs text-gray-400 mt-0.5">버전별 서류 현황 · 공장 확인 상태</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <MokdaeStatusBadge status={badgeStatus} />
          {!mokdaeProductionStarted && (
            <button
              onClick={handleAddVersion}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-white bg-brand hover:bg-[#0090e6] rounded-lg shadow-sm transition-all active:scale-95"
            >
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>
              버전 추가
            </button>
          )}
          {mokdaeProductionStarted && (
            <span className="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold text-teal-700 bg-teal-50 border border-teal-200 rounded-lg">
              <span className="w-1.5 h-1.5 rounded-full bg-teal-500 animate-pulse"></span>
              제작 진행 중
            </span>
          )}
        </div>
      </div>

      <div className="flex" style={{ minHeight: 340 }}>
        {/* ── 좌측: 버전 히스토리 사이드바 ── */}
        <div className="w-44 flex-shrink-0 border-r border-gray-100 py-3 flex flex-col">
          <p className="text-xs font-semibold text-gray-400 px-4 mb-2 uppercase tracking-wide">버전 히스토리</p>
          {versions.length === 0 && (
            <div className="flex-1 flex flex-col items-center justify-center px-4 text-center gap-2">
              <svg className="w-8 h-8 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p className="text-xs text-gray-300 leading-relaxed">상단 [버전 추가]를<br/>눌러 시작하세요</p>
            </div>
          )}
          {versions.map(v => (
            <button
              key={v.versionNo}
              onClick={() => setActiveVer(v.versionNo)}
              className={`w-full text-left px-4 py-2.5 flex flex-col gap-1 transition-colors border-l-2 ${
                activeVer === v.versionNo ? "border-brand bg-brand-weak" : "border-transparent hover:bg-gray-50"
              }`}
            >
              <div className="flex items-center gap-1.5 flex-wrap">
                <span className={`text-sm font-bold ${activeVer === v.versionNo ? "text-brand" : "text-gray-700"}`}>
                  발주 V{v.versionNo}
                </span>
                {v.versionNo === Math.max(...versions.map(x => x.versionNo)) && (
                  <span className="text-xs bg-brand text-white px-1.5 py-0.5 rounded font-bold leading-none">최신</span>
                )}
              </div>
              {v.isNew ? (
                <span className="inline-flex text-xs font-semibold px-2 py-0.5 rounded-full w-fit bg-orange-100 text-orange-600 border border-orange-200">작성중</span>
              ) : (
                <span className={`inline-flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full w-fit ${
                  v.factoryChecked ? "bg-emerald-100 text-emerald-700" : "bg-gray-100 text-gray-400"
                }`}>
                  {v.factoryChecked ? <><CheckIcon />공장확인</> : "공장 미확인"}
                </span>
              )}
              {v.sentAt && <span className="text-xs text-gray-400">{String(v.sentAt).slice(0, 10)}</span>}
            </button>
          ))}
        </div>

        {/* ── 우측: 버전 상세 ── */}
        {versions.length === 0 ? (
          <div className="flex-1 flex flex-col items-center justify-center gap-3 text-gray-300">
            <svg className="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p className="text-sm font-medium text-gray-400">아직 등록된 발주 버전이 없습니다</p>
            <p className="text-xs">좌측 상단 [버전 추가] 버튼을 눌러 시작하세요.</p>
          </div>

        ) : current && isNewVersion ? (
          /* ── 신규 버전 작성 UI ── */
          <div className="flex-1 min-w-0 px-5 py-4 space-y-4 overflow-y-auto">

            {/* 1. 드래그앤드롭 업로드 */}
            <div>
              <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">발주서 파일 업로드</p>
              <div
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                onClick={() => fileInputRef.current?.click()}
                className={`relative flex flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed transition-all cursor-pointer py-8 ${
                  dragging ? "border-brand bg-brand-weak scale-[1.01]" : "border-gray-300 bg-gray-50/50 hover:border-brand hover:bg-brand-weak/30"
                }`}
              >
                <input ref={fileInputRef} type="file" multiple className="hidden" onChange={handleFileInputChange} />
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${dragging ? "bg-brand-weak" : "bg-white border border-gray-200"}`}>
                  <svg className={`w-5 h-5 transition-colors ${dragging ? "text-brand" : "text-gray-400"}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                </div>
                <div className="text-center">
                  <p className={`text-sm font-semibold transition-colors ${dragging ? "text-brand" : "text-gray-600"}`}>
                    {dragging ? "여기에 놓으세요!" : "파일을 드래그하거나 클릭하여 업로드"}
                  </p>
                  {!dragging && <p className="text-xs text-gray-400 mt-1">발주서, 도면, 사진 등 모든 파일 형식 지원</p>}
                </div>
              </div>
            </div>

            {/* 2. 실측 참고 이미지 (토글 접기/펼치기) — silcheukImages prop으로 실측 탭 업로드 결과 표시 */}
            <div className="border border-gray-200 rounded-xl overflow-hidden">
              <button
                onClick={() => setSilcheukOpen(p => !p)}
                className="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors"
              >
                <div className="flex items-center gap-2">
                  <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">실측 사진 / 실측지 참고 이미지</span>
                  <span className={`text-xs px-1.5 py-0.5 rounded-full ${silcheukImages.length > 0 ? "bg-brand-weak text-brand font-bold" : "text-gray-400 bg-gray-200"}`}>{silcheukImages.length}장</span>
                </div>
                <svg className={`w-4 h-4 text-gray-400 transition-transform duration-200 ${silcheukOpen ? "rotate-180" : ""}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              {silcheukOpen && (
                silcheukImages.length > 0 ? (
                  <div className="p-3 grid grid-cols-3 gap-2 border-t border-gray-100">
                    {silcheukImages.map(img => (
                      <div key={img.id} className="relative aspect-[4/3] rounded-lg overflow-hidden border border-gray-200 group cursor-zoom-in"
                           onClick={() => img.isImage && img.url && setLightbox({ url: img.url, name: img.label || img.name })}>
                        {img.isImage && img.url ? (
                          <React.Fragment>
                            <img src={img.url} alt={img.label || img.name} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy" />
                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                          </React.Fragment>
                        ) : (
                          <div className="w-full h-full bg-gray-100 flex flex-col items-center justify-center gap-1 p-2">
                            <svg className="w-7 h-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p className="text-xs text-gray-500 truncate w-full text-center">{img.name}</p>
                          </div>
                        )}
                        <div className="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/50 to-transparent px-2 py-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                          <p className="text-white text-xs truncate">{img.label || img.name}</p>
                          {img.category && <span className="text-white/70 text-xs">{img.category}</span>}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="px-4 py-8 flex flex-col items-center gap-2 text-gray-300 border-t border-gray-100">
                    <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p className="text-sm font-medium text-center">실측 탭에서 업로드된 사진/실측지가 없습니다</p>
                    <p className="text-xs text-center">실측 탭에서 이미지를 업로드하면 이곳에 표시됩니다.</p>
                  </div>
                )
              )}
            </div>

            {/* 3. 업로드된 발주서 파일 프리뷰 */}
            {currentFiles.length > 0 && (
              <div>
                <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">
                  업로드된 발주서
                  <span className="ml-1.5 text-gray-300 font-normal normal-case tracking-normal">({currentFiles.length}개)</span>
                </p>
                <div className="grid grid-cols-2 gap-3">
                  {currentFiles.map(f => (
                    <div key={f.id} className="border border-gray-200 rounded-xl overflow-hidden bg-white hover:border-brand/30 transition-colors group">
                      {f.isImage ? (
                        <div className="relative h-28 bg-gray-100 cursor-zoom-in" onClick={() => setLightbox({ url: f.url, name: f.name })}>
                          <img src={f.url} alt={f.name} className="w-full h-full object-cover" />
                          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                            <svg className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 drop-shadow transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0zm0 0l3 3"/>
                            </svg>
                          </div>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleRemoveFile(f.id); }}
                            className="absolute top-1.5 right-1.5 w-6 h-6 bg-black/50 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all"
                          >
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12"/></svg>
                          </button>
                        </div>
                      ) : (
                        <div className="relative h-28 bg-gray-50 flex flex-col items-center justify-center gap-1.5 cursor-pointer hover:bg-gray-100 transition-colors" onClick={() => handleDownloadFile(f)}>
                          <svg className="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                          <span className="text-xs text-gray-400 font-semibold uppercase">{f.name.split('.').pop()}</span>
                          <span className="text-xs text-brand/60 font-medium">클릭하여 다운로드</span>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleRemoveFile(f.id); }}
                            className="absolute top-1.5 right-1.5 w-6 h-6 bg-black/30 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all"
                          >
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12"/></svg>
                          </button>
                        </div>
                      )}
                      <div className="px-3 py-2">
                        <p className="text-xs font-medium text-gray-700 truncate" title={f.name}>{f.name}</p>
                        <p className="text-xs text-gray-400">{f.size}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* 4. 목대 예정 일정 입력 */}
            <div className="bg-gray-50 rounded-xl p-3 border border-gray-200">
              <label className="flex items-center gap-3">
                <div className="flex items-center gap-1.5 w-28 flex-shrink-0">
                  <svg className="w-3.5 h-3.5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">목대 예정 일정</span>
                </div>
                <input
                  type="date"
                  value={current.mokdaeDate || ""}
                  min={minMokdaeDate}
                  onChange={e => setVersions(prev => prev.map(v => v.versionNo === activeVer ? { ...v, mokdaeDate: e.target.value } : v))}
                  className="flex-1 px-2.5 py-1.5 text-xs border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand bg-white text-gray-700"
                />
              </label>
            </div>

            {/* 발주 요청 버튼 */}
            <div className="flex items-center justify-between pt-2 border-t border-gray-100">
              {currentFiles.length === 0 && (
                <p className="text-xs text-gray-400 flex items-center gap-1.5">
                  <svg className="w-3.5 h-3.5 text-amber-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  파일을 업로드한 후 발주 요청이 가능합니다
                </p>
              )}
              <button
                onClick={doSendRequest}
                disabled={currentFiles.length === 0}
                className={`ml-auto flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-xl shadow-sm transition-all ${
                  currentFiles.length === 0 ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-brand hover:bg-[#0090e6] text-white"
                }`}
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                발주 요청
              </button>
            </div>
          </div>

        ) : current ? (
          /* ── 기존 버전 상세 (읽기 전용) ── */
          <div className="flex-1 min-w-0 px-5 py-4 space-y-4 overflow-y-auto">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-bold text-gray-800">발주 V{current.versionNo} 상세</p>
                <p className="text-xs text-gray-400">발송: {current.sentBy} · {current.sentAt}</p>
              </div>
              {current.factoryChecked && (
                <div className="flex items-center gap-2 text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg px-2 py-1.5">
                  <CheckIcon /> 공장 열람 {current.factoryCheckedAt}
                </div>
              )}
            </div>

            {/* 실측 참고 이미지 (읽기 전용) */}
            {silcheukImages.length > 0 && (
              <div className="border border-gray-200 rounded-xl overflow-hidden">
                <div className="w-full flex items-center justify-between px-4 py-3 bg-gray-50">
                  <div className="flex items-center gap-2">
                    <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span className="text-xs font-semibold text-gray-600">실측 사진 / 실측지 참고 이미지</span>
                    <span className="text-xs px-1.5 py-0.5 rounded-full bg-brand-weak text-brand font-bold">{silcheukImages.length}장</span>
                  </div>
                </div>
                <div className="p-3 grid grid-cols-3 gap-2 border-t border-gray-100">
                  {silcheukImages.map(img => (
                    <div key={img.id} className="relative aspect-[4/3] rounded-lg overflow-hidden border border-gray-200 group cursor-zoom-in"
                         onClick={() => img.isImage && img.url && setLightbox({ url: img.url, name: img.label || img.name })}>
                      {img.isImage && img.url ? (
                        <React.Fragment>
                          <img src={img.url} alt={img.label || img.name} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy" />
                          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                        </React.Fragment>
                      ) : (
                        <div className="w-full h-full bg-gray-100 flex flex-col items-center justify-center gap-1 p-2">
                          <svg className="w-7 h-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                          <p className="text-xs text-gray-500 truncate w-full text-center">{img.name}</p>
                        </div>
                      )}
                      <div className="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/50 to-transparent px-2 py-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                        <p className="text-white text-xs truncate">{img.label || img.name}</p>
                        {img.category && <span className="text-white/70 text-xs">{img.category}</span>}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* 업로드된 발주서 파일 프리뷰 (있을 경우) */}
            {(uploadedFiles[current.versionNo] || []).length > 0 ? (
              <div className="grid grid-cols-2 gap-3">
                {(uploadedFiles[current.versionNo] || []).map(f => (
                  <div key={f.id} className="border border-gray-200 rounded-xl overflow-hidden bg-white group">
                    {f.isImage ? (
                      <div className="relative h-28 bg-gray-100 cursor-zoom-in" onClick={() => setLightbox({ url: f.url, name: f.name })}>
                        <img src={f.url} alt={f.name} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                          <svg className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 drop-shadow transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
                          </svg>
                        </div>
                      </div>
                    ) : (
                      <div className="w-full h-28 bg-gray-50 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-gray-100 transition-colors" onClick={() => handleDownloadFile(f)}>
                        <svg className="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span className="text-xs text-gray-400 font-semibold uppercase">{f.name.split('.').pop()}</span>
                        <span className="text-xs text-brand/60 font-medium">클릭하여 다운로드</span>
                      </div>
                    )}
                    <div className="px-3 py-2">
                      <p className="text-xs font-medium text-gray-700 truncate">{f.name}</p>
                      <p className="text-xs text-gray-400">{f.size}</p>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="space-y-2">
                {current.files.map(f => <FileItem key={f.id} file={f} showRequired />)}
              </div>
            )}
            {/* 목대 예정 일정 (읽기 전용) */}
            {current.mokdaeDate && (
              <div className="bg-gray-50 rounded-xl p-3 border border-gray-200 flex items-center gap-3">
                <div className="flex items-center gap-1.5">
                  <svg className="w-3.5 h-3.5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">목대 예정 일정</span>
                </div>
                <span className="text-xs font-bold text-gray-800">{current.mokdaeDate}</span>
              </div>
            )}
            {current.memo && (
              <div className="bg-gray-50 rounded-lg px-3 py-2 border border-gray-200">
                <p className="text-xs text-gray-500 font-medium mb-1">발주 메모</p>
                <p className="text-sm text-gray-700 leading-relaxed">{current.memo}</p>
              </div>
            )}
          </div>
        ) : null}
      </div>

      {/* ── 이미지 라이트박스 ── */}
      {lightbox && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center p-6"
          style={{ background: "rgba(0,0,0,0.88)" }}
          onClick={() => setLightbox(null)}
        >
          <div className="relative flex flex-col items-center max-w-[92vw]" onClick={e => e.stopPropagation()}>
            {/* 닫기 버튼 */}
            <button
              onClick={() => setLightbox(null)}
              className="absolute -top-4 -right-4 z-10 w-9 h-9 bg-white/20 hover:bg-white/40 text-white rounded-full flex items-center justify-center transition-colors shadow-lg"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            {/* 이미지 */}
            <img
              src={lightbox.url}
              alt={lightbox.name}
              className="max-w-full rounded-xl object-contain shadow-2xl"
              style={{ maxHeight: "80vh" }}
            />
            {/* 하단 파일명 + ESC 안내 */}
            <div className="mt-3 flex items-center gap-4 w-full px-1">
              <p className="flex-1 text-white/70 text-sm truncate">{lightbox.name}</p>
              <span className="flex-shrink-0 text-xs text-white/40 bg-white/10 px-2 py-1 rounded">ESC로 닫기</span>
            </div>
          </div>
        </div>
      )}

      {/* ── 긴급발주 확인 모달 ── */}
      {urgentConfirmOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40" onClick={() => setUrgentConfirmOpen(false)}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="px-6 pt-6 pb-4">
              <div className="flex items-center gap-3 mb-3">
                <div className="w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center flex-shrink-0">
                  <svg className="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z" />
                  </svg>
                </div>
                <div>
                  <h3 className="text-base font-bold text-gray-900">긴급발주 요청</h3>
                  <p className="text-xs text-gray-400 mt-0.5">최종 발주 확정 건</p>
                </div>
              </div>
              <p className="text-sm text-gray-600 leading-relaxed">
                해당 건은 <span className="font-bold text-red-600">최종 발주가 확정</span>된 상태입니다.<br/>
                버전을 추가하면 <span className="font-bold text-red-600">긴급발주 요청</span>이 들어가게 됩니다.<br/>
                그래도 진행하시겠습니까?
              </p>
            </div>
            <div className="flex border-t border-gray-100">
              <button onClick={() => setUrgentConfirmOpen(false)}
                className="flex-1 py-3.5 text-sm font-semibold text-gray-500 hover:bg-gray-50 transition-colors">
                취소
              </button>
              <div className="w-px bg-gray-100"></div>
              <button onClick={doAddVersion}
                className="flex-1 py-3.5 text-sm font-bold text-red-600 hover:bg-red-50 transition-colors">
                긴급발주 진행
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   목대 탭 — Section B: CAD 도면 뷰어 & 버전 사이드바
═══════════════════════════════════════════════════════ */
function MokdaeSectionB({ cadVersions: initVersions, activeVer: initActive, onToast, onCadChange }) {
  const [versions, setVersions]   = useState(initVersions);
  const [activeVer, setActiveVer] = useState(initActive);
  const [lightbox, setLightbox]   = useState(null);
  const [showRevModal, setShowRevModal] = useState(false);
  const [revisionText, setRevisionText] = useState("");

  /* ── 데이터 영속화: 변경 → 부모(App)로 전달 → localStorage 저장 ── */
  const didMountB = useRef(false);
  useEffect(() => {
    if (!didMountB.current) { didMountB.current = true; return; }
    if (onCadChange) onCadChange(versions);
  }, [versions]);

  /* ── cross-tab 동기화: factory.html에서 CAD 업로드 시 반영 ── */
  useEffect(() => {
    if (JSON.stringify(initVersions) !== JSON.stringify(versions)) {
      setVersions(initVersions);
      if (initVersions.length > 0) setActiveVer(initVersions[initVersions.length - 1].versionNo);
    }
  }, [JSON.stringify(initVersions)]);

  const current = versions.find(v => v.versionNo === activeVer);

  const cadStatusStyle = {
    "승인":       "bg-emerald-100 text-emerald-700 border-emerald-200",
    "승인해제":   "bg-red-100 text-red-700 border-red-200",
    "CAD수정요청":"bg-orange-100 text-orange-700 border-orange-200",
    "CAD도면검토중":"bg-brand-weak text-brand border-brand/20",
  };

  const handleApprove = () => {
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, status: "승인", approvedAt: "2026-02-25 (방금)" } : v
    ));
    onToast({ type: "success", title: "CAD 승인 완료", message: `CAD V${activeVer} 도면이 승인되었습니다.`, duration: 4000 });
  };

  const handleRevisionSubmit = () => {
    if (!revisionText.trim()) {
      onToast({ type: "warning", title: "사유 입력 필요", message: "수정 요청 사유를 입력해주세요." });
      return;
    }
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, status: "CAD수정요청", revisionNote: revisionText } : v
    ));
    setShowRevModal(false);
    setRevisionText("");
    onToast({ type: "info", title: "수정 요청 전송", message: "공장으로 CAD 수정 요청이 전송되었습니다." });
  };

  return (
    <>
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <SectionHeader
          color="orange"
          icon={<svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>}
          title="Section B · CAD 도면 검토"
          sub="버전 클릭 → 뷰어 전환 · 승인 또는 수정 요청"
          badge={<MokdaeStatusBadge status={versions.length === 0 ? "발주요청대기" : (current?.status || "CAD도면검토중")} />}
        />

        <div className="flex min-h-[300px]">
          {versions.length === 0 ? (
            <div className="flex-1 flex flex-col items-center justify-center py-14 gap-3 text-gray-300">
              <svg className="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p className="text-sm font-medium text-gray-400">아직 등록된 CAD 도면이 없습니다</p>
              <p className="text-xs">발주 서류가 전달되면 공장에서 도면을 업로드합니다.</p>
            </div>
          ) : (<>
          {/* 좌측: CAD 버전 사이드바 */}
          <div className="w-44 flex-shrink-0 border-r border-gray-100 py-3">
            <p className="text-xs font-semibold text-gray-400 px-4 mb-2 uppercase tracking-wide">도면 버전</p>
            {versions.map(v => (
              <button
                key={v.versionNo}
                onClick={() => setActiveVer(v.versionNo)}
                className={`w-full text-left px-4 py-3 flex flex-col gap-2 transition-colors border-l-2 ${
                  activeVer === v.versionNo
                    ? "border-orange-500 bg-orange-50"
                    : "border-transparent hover:bg-gray-50"
                }`}
              >
                <div className="flex items-center gap-2">
                  <span className={`text-sm font-bold ${activeVer === v.versionNo ? "text-orange-700" : "text-gray-700"}`}>
                    CAD V{v.versionNo}
                  </span>
                  {v.versionNo === versions.length && (
                    <span className="text-xs bg-orange-500 text-white px-1.5 py-0.5 rounded font-bold leading-none">최신</span>
                  )}
                </div>
                <span className={`inline-block text-xs font-semibold px-2 py-0.5 rounded-full border w-fit ${cadStatusStyle[v.status] || "bg-gray-100 text-gray-500 border-gray-200"}`}>
                  {v.status}
                </span>
                <span className="text-xs text-gray-400">{v.uploadedAt.slice(5,10)}</span>
              </button>
            ))}
          </div>

          {/* 중앙: 도면 뷰어 */}
          {current && (
            <div className="flex-1 min-w-0 flex flex-col" style={{minHeight: 300}}>
              {/* 이미지 뷰어 */}
              <div className="relative flex-1 bg-gray-100 cursor-zoom-in group"
                   style={{ minHeight: "220px" }}
                   onClick={() => setLightbox(current.previewUrl)}>
                <img
                  src={current.previewUrl}
                  alt={`CAD V${current.versionNo}`}
                  className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-[1.02]"
                  style={{ maxHeight: "260px", objectFit: "cover" }}
                />

                {/* 승인 해제 워터마크 */}
                {current.status === "승인해제" && (
                  <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-red-900/20"></div>
                    <div className="relative z-10 select-none" style={{ transform: "rotate(-22deg)" }}>
                      <span className="text-red-600/75 font-black tracking-[0.2em] whitespace-nowrap"
                            style={{ fontSize:"clamp(18px,3vw,32px)", textShadow:"0 0 12px rgba(255,255,255,0.9)", WebkitTextStroke:"0.5px rgba(180,0,0,0.4)" }}>
                        승인 취소됨
                      </span>
                    </div>
                    <div className="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded shadow">VOID</div>
                  </div>
                )}

                {/* 승인 완료 오버레이 */}
                {current.status === "승인" && (
                  <div className="absolute top-2 left-2 flex items-center gap-2 bg-emerald-600/90 text-white text-xs font-bold px-2 py-1 rounded-lg shadow-md">
                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                    </svg>
                    승인됨 · {current.approvedAt}
                  </div>
                )}

                {/* 확대 힌트 */}
                <div className="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                  클릭하여 확대
                </div>
              </div>

              {/* 업로드 날짜 + 두 번째 도면 버튼 */}
              <div className="flex items-center gap-2 px-4 py-2 bg-gray-50 border-t border-gray-100 text-xs text-gray-500">
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                공장 업로드: {current.uploadedAt}
                <button onClick={() => setLightbox(current.previewUrl2)}
                        className="ml-auto flex items-center gap-1 text-brand hover:text-[#0090e6] font-medium">
                  상세도 보기 →
                </button>
              </div>

              {/* 수정 요청 내용 (있을 경우) */}
              {current.revisionNote && (
                <div className="mx-4 mb-3 mt-1 flex items-start gap-2 bg-orange-50 border border-orange-200 rounded-xl px-4 py-3">
                  <svg className="w-4 h-4 text-orange-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  <div>
                    <p className="text-xs font-semibold text-orange-700 mb-1">수정 요청 내용</p>
                    <p className="text-sm text-gray-700 leading-relaxed">{current.revisionNote}</p>
                  </div>
                </div>
              )}

              {/* 승인 해제 사유 */}
              {current.status === "승인해제" && (
                <div className="mx-4 mb-3 flex items-start gap-2 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
                  <svg className="w-4 h-4 text-red-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    <p className="text-xs font-semibold text-red-600 mb-1">승인 해제 사유</p>
                    <p className="text-sm text-gray-700">새로운 발주서(V2) 업로드로 인해 기존 승인이 자동 해제됨. ({current.approvalCancelledAt})</p>
                  </div>
                </div>
              )}

              {/* 액션 버튼 */}
              <div className="flex gap-2 px-4 pb-4 mt-auto">
                <button
                  onClick={handleApprove}
                  disabled={current.status === "승인"}
                  className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-semibold transition-all ${
                    current.status === "승인"
                      ? "bg-emerald-100 text-emerald-500 cursor-default"
                      : "bg-emerald-600 hover:bg-emerald-700 text-white shadow-sm"
                  }`}
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  {current.status === "승인" ? "승인 완료" : "승인"}
                </button>
                <button
                  onClick={() => setShowRevModal(true)}
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-semibold
                             bg-red-500 hover:bg-red-600 text-white shadow-sm shadow-red-200 transition-all"
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  수정 요청
                </button>
              </div>
            </div>
          )}
          </>)}
        </div>
      </div>

      {/* ── 수정 요청 사유 모달 ── */}
      <Modal open={showRevModal} onClose={() => setShowRevModal(false)}>
        <div className="px-6 py-5 space-y-4">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-xl bg-red-100 flex items-center justify-center flex-shrink-0">
              <svg className="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </div>
            <div>
              <h3 className="text-base font-bold text-gray-800">CAD 수정 요청</h3>
              <p className="text-xs text-gray-400">CAD V{activeVer} · 공장으로 전달됩니다</p>
            </div>
          </div>
          <div>
            <label className="block text-xs font-semibold text-gray-600 mb-1.5">수정 요청 사유 <span className="text-red-500">*</span></label>
            <textarea
              value={revisionText}
              onChange={e => setRevisionText(e.target.value)}
              rows={4}
              placeholder="예) 냉장고 우측 틈새 폭 340mm로 수정, 상부장 높이 2,300mm 재확인 필요"
              className="w-full px-3 py-2 text-sm border border-gray-300 rounded-xl resize-none
                         focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent
                         text-gray-700 leading-relaxed placeholder:text-gray-300"
            />
          </div>
          <div className="flex gap-3 justify-end">
            <button onClick={() => setShowRevModal(false)}
                    className="px-4 py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">
              취소
            </button>
            <button onClick={handleRevisionSubmit}
                    className="px-4 py-2 text-sm font-bold text-white bg-red-500 hover:bg-red-600 rounded-xl transition-colors flex items-center gap-2">
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              수정 요청 전송
            </button>
          </div>
        </div>
      </Modal>

      {/* ── 이미지 라이트박스 ── */}
      <Modal open={!!lightbox} onClose={() => setLightbox(null)} maxW="max-w-4xl">
        <div className="relative">
          <div className="relative">
            <img src={lightbox} alt="CAD 확대" className="w-full object-contain rounded-t-2xl max-h-[80vh]" />
            {current?.status === "승인해제" && (
              <div className="absolute inset-0 flex items-center justify-center pointer-events-none rounded-t-2xl">
                <div className="absolute inset-0 bg-red-900/15 rounded-t-2xl"></div>
                <div className="relative z-10" style={{ transform: "rotate(-22deg)" }}>
                  <span className="text-red-600/65 font-black tracking-[0.3em] text-5xl"
                        style={{ textShadow:"0 0 20px rgba(255,255,255,0.95)", WebkitTextStroke:"1px rgba(180,0,0,0.3)" }}>
                    승인 취소됨
                  </span>
                </div>
              </div>
            )}
          </div>
          <div className="px-4 py-2 bg-gray-50 text-xs text-gray-400 text-center rounded-b-2xl">
            바깥 클릭 또는 ESC로 닫기
          </div>
          <button onClick={() => setLightbox(null)}
                  className="absolute top-3 right-3 w-8 h-8 bg-black/40 hover:bg-black/60 text-white rounded-full flex items-center justify-center transition-colors">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </Modal>
    </>
  );
}

/* ═══════════════════════════════════════════════════════
   목대 탭 — Section C: 최종 확정 & 예외 처리
═══════════════════════════════════════════════════════ */
function MokdaeSectionC({ data, onToast, onConfirmChange, mokdaeProductionStarted = false }) {
  const [approved, setApproved]   = useState(data.consumerApproved);
  const [confirmed, setConfirmed] = useState(!!data.confirmedAt);

  /* ── cross-tab 동기화: factory.html 등에서 데이터 변경 시 반영 ── */
  useEffect(() => { setApproved(data.consumerApproved); }, [data.consumerApproved]);
  useEffect(() => { setConfirmed(!!data.confirmedAt); },  [data.confirmedAt]);

  /* ── approved 변경 → 부모에 알림 (mount 스킵) ── */
  const didMountC = useRef(false);
  useEffect(() => {
    if (!didMountC.current) { didMountC.current = true; return; }
    if (onConfirmChange) onConfirmChange({ consumerApproved: approved, confirmedAt: confirmed ? (data.confirmedAt || null) : null });
  }, [approved]);

  const handleConfirm = () => {
    if (!approved) {
      onToast({ type: "warning", title: "소비자 승인 필요", message: "소비자 승인 체크박스를 먼저 확인해주세요." });
      return;
    }
    setConfirmed(true);
    const now = new Date().toISOString();
    if (onConfirmChange) onConfirmChange({ consumerApproved: true, confirmedAt: now });
    onToast({ type: "success", title: "최종 발주 확정", message: "대시보드 목대 발주 상태가 [발주확정]으로 변경되었습니다.", duration: 5000 });
  };

  return (
    <div className={`rounded-xl overflow-hidden border-2 bg-white ${confirmed ? "border-emerald-300" : "border-brand/20"}`}>
      <SectionHeader
        color={confirmed ? "green" : "blue"}
        icon={<svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>}
        title="Section C · 소비자 최종 승인 및 발주 확정"
        badge={confirmed ? <MokdaeStatusBadge status="발주확정" /> : null}
      />

      <div className="px-5 py-5 space-y-4">
        {/* 소비자 승인 체크박스 */}
        <label className={`flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all ${
          approved ? "border-brand bg-brand-weak" : "border-gray-200 bg-gray-50 hover:border-brand/30 hover:bg-brand-weak/40"
        }`}>
          <div className="relative mt-1 flex-shrink-0">
            <input type="checkbox" checked={approved} onChange={e => setApproved(e.target.checked)}
                   disabled={confirmed} className="sr-only" />
            <div className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${
              approved ? "bg-brand border-brand" : "bg-white border-gray-400"
            }`}>
              {approved && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7"/></svg>}
            </div>
          </div>
          <div>
            <p className={`text-sm font-semibold ${approved ? "text-gray-800" : "text-gray-600"}`}>
              소비자가 최종 도면을 확인하고 승인하였습니다.
            </p>
            <p className="text-xs text-gray-400 mt-1">이 항목을 체크해야 최종 발주 확정 버튼이 활성화됩니다.</p>
          </div>
        </label>

        {/* 확정 버튼 */}
        <button onClick={handleConfirm} disabled={confirmed}
          className={`w-full py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300 ${
            confirmed
              ? "bg-emerald-500 text-white cursor-default shadow-sm shadow-emerald-100"
              : approved
              ? "bg-brand hover:bg-[#0090e6] text-white shadow-sm  hover:-translate-y-0.5"
              : "bg-gray-100 text-gray-400 cursor-not-allowed"
          }`}>
          {confirmed ? (
            <><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>최종 발주 확정 완료</>
          ) : (
            <><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>최종 발주 확정</>
          )}
        </button>

        {/* 🏭 제작 진행 중 배너 */}
        {mokdaeProductionStarted && confirmed && (
          <div className="flex items-center gap-3 bg-teal-50 border-2 border-teal-200 rounded-xl px-4 py-3.5">
            <div className="w-8 h-8 rounded-lg bg-teal-500 flex items-center justify-center flex-shrink-0">
              <svg className="w-4.5 h-4.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
            </div>
            <div>
              <p className="text-sm font-bold text-teal-800">공장에서 제작이 진행 중입니다</p>
              <p className="text-xs text-teal-600 mt-0.5">제작 진행 중에는 발주 내용 수정이 제한됩니다. 공장에서 제작 중단 시 수정 가능합니다.</p>
            </div>
          </div>
        )}

        {/* 긴급 조정 Alert */}
        <div className="flex items-start gap-3 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
          <svg className="w-4 h-4 text-red-500 mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
          </svg>
          <p className="text-xs text-red-700 leading-relaxed">
            <span className="font-bold">⚠️ 주의</span>{"  "}공장 제작 시작 전까지는 내용 수정이 가능하며, 수정 시{" "}
            <span className="font-bold text-red-800">'확정 후 조정(긴급)'</span>{" "}상태로 전환됩니다.
          </p>
        </div>

        {/* 확정 후 조치 버튼들 */}
        {confirmed && (
          <div className="pt-1">
            <p className="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wide">발주 확정 후 조치</p>
            <div className="flex gap-3">
              <button
                onClick={() => onToast({ type: "warning", title: "긴급 조정 요청", message: "긴급 조정 요청이 공장으로 전달되었습니다.", duration: 4000 })}
                className="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-semibold
                           text-red-700 bg-red-50 hover:bg-red-100 border-2 border-red-200 hover:border-red-300
                           rounded-xl transition-all"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                </svg>
                긴급 조정
              </button>
              <button
                onClick={() => document.getElementById("section-d-anchor")?.scrollIntoView({ behavior: "smooth" })}
                className="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-semibold
                           text-amber-700 bg-amber-50 hover:bg-amber-100 border-2 border-amber-200 hover:border-amber-300
                           rounded-xl transition-all"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                재마감 요청 →
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   목대 탭 — Section D: 재마감 요청 아코디언
═══════════════════════════════════════════════════════ */
function MokdaeSectionD({ claims: initClaims, onToast, onClaimsChange }) {
  const [open, setOpen]     = useState(true);
  const [claims, setClaims] = useState(initClaims);

  /* ── 데이터 영속화: 변경 → 부모(App)로 전달 → localStorage 저장 ── */
  const didMountD = useRef(false);
  useEffect(() => {
    if (!didMountD.current) { didMountD.current = true; return; }
    if (onClaimsChange) onClaimsChange(claims);
  }, [claims]);

  /* ── cross-tab 동기화 ── */
  useEffect(() => {
    if (JSON.stringify(initClaims) !== JSON.stringify(claims)) setClaims(initClaims);
  }, [JSON.stringify(initClaims)]);
  const [newDate, setNewDate]       = useState("");
  const [newContent, setNewContent] = useState("");
  const [sending, setSending]       = useState(false);

  const statusStyle = {
    "재마감요청": "bg-orange-100 text-orange-700 border-orange-200",
    "재마감조정": "bg-amber-100 text-amber-700 border-amber-200",
    "재마감확정": "bg-emerald-100 text-emerald-700 border-emerald-200",
  };

  const handleSend = () => {
    if (!newDate || !newContent.trim()) {
      onToast({ type: "warning", title: "입력 확인", message: "희망 일정과 요청 사항을 모두 입력해주세요." });
      return;
    }
    setSending(true);
    setTimeout(() => {
      setClaims(prev => [...prev, {
        id: prev.length + 1, status: "재마감요청",
        requestDate: newDate, requestContent: newContent,
        sentAt: "2026-02-25 (방금)", factoryReply: null,
      }]);
      setNewDate(""); setNewContent(""); setSending(false);
      onToast({ type: "success", title: "재마감 요청 전송 완료", message: "공장으로 재마감 요청이 전송되었습니다." });
    }, 800);
  };

  return (
    <div id="section-d-anchor" className="rounded-xl overflow-hidden border-2 border-dashed border-gray-300 bg-white">
      <button onClick={() => setOpen(p => !p)}
              className="w-full flex items-center justify-between px-5 py-4 hover:bg-gray-50 transition-colors">
        <div className="flex items-center gap-3">
          <div className="w-7 h-7 rounded-lg bg-amber-100 border border-amber-200 flex items-center justify-center flex-shrink-0">
            <svg className="w-4 h-4 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </div>
          <div className="text-left">
            <div className="flex items-center gap-2">
              <span className="text-base font-bold text-gray-800">Section D · 현장 재마감 요청</span>
              {claims.length > 0 && (
                <span className="text-xs font-bold px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 border border-amber-200">{claims.length}건</span>
              )}
            </div>
            <p className="text-xs text-gray-400 mt-1">항상 추가 요청 가능 · 공장으로 직접 전송</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {claims.some(c => c.status === "재마감조정") && (
            <span className="flex items-center gap-2 text-xs font-bold text-amber-700 bg-amber-100 border border-amber-200 px-2 py-1 rounded-full">
              <span className="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span>
              재마감 조정 (공장 확인 대기중)
            </span>
          )}
          <svg className={`w-5 h-5 text-gray-400 transition-transform duration-200 ${open ? "rotate-180" : ""}`}
               fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>

      {open && (
        <div className="border-t border-gray-200">
          {/* 기존 요청 */}
          {claims.length > 0 && (
            <div className="px-5 pt-4 pb-2 space-y-3">
              <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide">전송된 재마감 요청</p>
              {claims.map(claim => (
                <div key={claim.id} className="rounded-xl border border-gray-200 overflow-hidden">
                  <div className="flex items-center justify-between px-4 py-2 bg-gray-50 border-b border-gray-100">
                    <div className="flex items-center gap-2 text-xs text-gray-500">
                      <span className="font-semibold text-gray-700">#{claim.id}</span>
                      <span>·</span>
                      <span>희망일: <b className="text-gray-700">{claim.requestDate}</b></span>
                      <span>·</span>
                      <span>{claim.sentAt}</span>
                    </div>
                    <span className={`text-xs font-semibold px-2 py-1 rounded-full border ${statusStyle[claim.status] || ""}`}>
                      {claim.status}
                    </span>
                  </div>
                  <div className="px-4 py-3 bg-white space-y-2">
                    <p className="text-sm text-gray-700">{claim.requestContent}</p>
                    {claim.factoryReply && (
                      <div className="flex items-start gap-2 bg-brand-weak border border-brand/10 rounded-lg px-3 py-2">
                        <svg className="w-3.5 h-3.5 text-brand mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                        <p className="text-xs text-gray-600 leading-relaxed">{claim.factoryReply}</p>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
          {claims.length > 0 && <div className="mx-5 my-3 border-t border-dashed border-gray-200"></div>}

          {/* 신규 폼 */}
          <div className="px-5 pb-5 space-y-3">
            <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide flex items-center gap-2">
              <svg className="w-3.5 h-3.5 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>신규 재마감 요청 작성
            </p>
            <div>
              <label className="block text-xs text-gray-500 font-medium mb-1.5">재마감 희망 일정</label>
              <input type="date" value={newDate} onChange={e => setNewDate(e.target.value)}
                     className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent" />
            </div>
            <div>
              <label className="block text-xs text-gray-500 font-medium mb-1.5">요청 사항</label>
              <textarea value={newContent} onChange={e => setNewContent(e.target.value)} rows={3}
                        placeholder="공장에 전달할 재마감 요청 내용을 입력하세요."
                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent text-gray-700 leading-relaxed placeholder:text-gray-300" />
            </div>
            <div className="flex justify-end">
              <button onClick={handleSend} disabled={sending}
                      className="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-amber-500 hover:bg-amber-600 disabled:bg-amber-300 rounded-xl shadow-sm transition-all">
                {sending ? (
                  <><svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>전송 중…</>
                ) : (
                  <><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>공장으로 전송</>
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   기기 탭 — 자재 DB (Supabase에서 로드, 실패 시 하드코딩 폴백)
═══════════════════════════════════════════════════════ */
const GIGI_DB_FALLBACK = {};

// SUPABASE_URL, SUPABASE_KEY — already declared at top of file

function useGigiDb() {
  const [gigiDb, setGigiDb] = useState({});
  const [loading, setLoading] = useState(true);
  const [dbSource, setDbSource] = useState("empty"); // "db" or "empty"

  useEffect(() => {
    (async () => {
      const GIGI_MAIN_CATEGORIES = ["싱크볼", "수전", "후드", "쿡탑"];
      try {
        // 기기 4개 카테고리 + 나머지(기타)를 각각 로드 (1000행 제한 우회)
        const gigiFilter = GIGI_MAIN_CATEGORIES.map(c => `category.eq.${c}`).join(",");
        const etcFilter = GIGI_MAIN_CATEGORIES.map(c => `category.neq.${c}`).join("&");
        const headers = { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` };
        const [gigiRes, etcRes] = await Promise.all([
          fetch(`${SUPABASE_URL}/rest/v1/materials?select=category,item_name&or=(${gigiFilter})&order=category,item_name&limit=5000`, { headers }),
          fetch(`${SUPABASE_URL}/rest/v1/materials?select=category,item_name&${etcFilter}&order=category,item_name&limit=5000`, { headers }),
        ]);
        if (!gigiRes.ok || !etcRes.ok) throw new Error("fetch failed");
        const rows = [...(await gigiRes.json()), ...(await etcRes.json())];
        if (rows.length === 0) {
          setDbSource("empty");
          setLoading(false);
          return;
        }
        // Group by category — 싱크볼/수전/후드/쿡탑 은 개별, 나머지는 기타
        const grouped = {};
        rows.forEach(r => {
          const cat = GIGI_MAIN_CATEGORIES.includes(r.category) ? r.category : "기타";
          if (!grouped[cat]) grouped[cat] = [];
          // item_name = 건자재항목(드롭다운용) 칼럼 값 그대로 사용
          grouped[cat].push(r.item_name);
        });
        // 카테고리 순서 보장: 쿡탑, 후드, 수전, 싱크볼, 기타
        const ordered = {};
        [...GIGI_MAIN_CATEGORIES, "기타"].forEach(cat => {
          if (grouped[cat]) ordered[cat] = grouped[cat];
        });
        setGigiDb(ordered);
        setDbSource("db");
      } catch (e) {
        console.warn("자재 DB 로드 실패:", e);
        setDbSource("empty");
      }
      setLoading(false);
    })();
  }, []);

  return { gigiDb, loading, dbSource };
}

/* ── 기기 탭 초기 선택 상태 (동적 카테고리 기반) ── */
function buildInitialSelections(gigiDb) {
  const init = {};
  Object.keys(gigiDb).forEach(key => {
    init[key] = { mode: "select", value: "", custom: "" };
  });
  return init;
}

/* ═══════════════════════════════════════════════════════
   기기 탭 — SearchableSelect 콤보박스
═══════════════════════════════════════════════════════ */
function SearchableSelect({ category, options, state, onChange, onToast }) {
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState("");
  const [showCustomInput, setShowCustomInput] = useState(state.mode === "custom");
  const [customText, setCustomText] = useState(state.custom || "");
  const [selectedValue, setSelectedValue] = useState(state.value || "");
  const containerRef = useRef(null);
  const inputRef = useRef(null);
  const customInputRef = useRef(null);

  /* 외부 클릭 닫기 */
  useEffect(() => {
    const fn = e => {
      if (containerRef.current && !containerRef.current.contains(e.target)) {
        setOpen(false);
        setQuery("");
      }
    };
    document.addEventListener("mousedown", fn);
    return () => document.removeEventListener("mousedown", fn);
  }, []);

  /* 열릴 때 검색창 포커스 */
  useEffect(() => {
    if (open && inputRef.current) inputRef.current.focus();
  }, [open]);

  /* 직접입력 전환 시 포커스 */
  useEffect(() => {
    if (showCustomInput && customInputRef.current) {
      setTimeout(() => customInputRef.current?.focus(), 60);
    }
  }, [showCustomInput]);

  const filtered = query.trim()
    ? options.filter(o => o.toLowerCase().includes(query.toLowerCase()))
    : options;

  const handleSelectOption = (opt) => {
    setSelectedValue(opt);
    setShowCustomInput(false);
    setCustomText("");
    setOpen(false);
    setQuery("");
    onChange({ mode: "select", value: opt, custom: "" });
  };

  const handleSelectCustom = () => {
    setSelectedValue("__custom__");
    setShowCustomInput(true);
    setOpen(false);
    setQuery("");
    onChange({ mode: "custom", value: "__custom__", custom: customText });
  };

  const handleClear = () => {
    setSelectedValue("");
    setCustomText("");
    setShowCustomInput(false);
    onChange({ mode: "select", value: "", custom: "" });
  };

  const handleCustomChange = (val) => {
    setCustomText(val);
    onChange({ mode: "custom", value: "__custom__", custom: val });
  };

  /* 표시 텍스트 */
  const displayLabel = selectedValue === "__custom__"
    ? (customText || "직접 입력 중…")
    : selectedValue || null;

  const isCustomMode = selectedValue === "__custom__";
  const isEmpty = !selectedValue;

  /* 배지 색상 */
  const triggerBorder = isCustomMode
    ? "border-purple-400 bg-purple-50"
    : isEmpty
      ? "border-gray-300 bg-white"
      : "border-emerald-400 bg-emerald-50";

  return (
    <div ref={containerRef} className="relative">
      {/* ── 트리거 버튼 ── */}
      <button
        type="button"
        onClick={() => { setOpen(o => !o); setQuery(""); }}
        className={`w-full flex items-center gap-2 px-4 py-3 rounded-xl border-2 text-sm text-left transition-all
          ${triggerBorder}
          ${open ? "ring-2 ring-brand ring-offset-1" : "hover:border-gray-400"}
        `}
      >
        {/* 상태 도트 */}
        <span className={`w-2 h-2 rounded-full flex-shrink-0 ${
          isCustomMode ? "bg-purple-500" : isEmpty ? "bg-gray-300" : "bg-emerald-500"
        }`}></span>

        <span className={`flex-1 min-w-0 break-words whitespace-normal text-left ${isEmpty ? "text-gray-400" : isCustomMode ? "text-purple-700 font-medium" : "text-gray-800 font-medium"}`}>
          {displayLabel ?? "미발주"}
        </span>

        {/* 클리어 버튼 */}
        {!isEmpty && (
          <span
            role="button"
            onClick={e => { e.stopPropagation(); handleClear(); }}
            className="flex-shrink-0 w-5 h-5 flex items-center justify-center rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors"
          >
            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </span>
        )}

        {/* 화살표 */}
        <svg
          className={`w-4 h-4 text-gray-400 flex-shrink-0 transition-transform duration-200 ${open ? "rotate-180" : ""}`}
          fill="none" viewBox="0 0 24 24" stroke="currentColor"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {/* ── 드롭다운 패널 ── */}
      {open && (
        <div className="absolute z-[9999] mt-1.5 w-full min-w-[320px] bg-white border border-gray-200 rounded-xl shadow-lg"
          style={{ maxHeight: 320, overflowY: 'auto' }}>

          {/* 검색 입력 */}
          <div className="px-3 py-2 border-b border-gray-100 sticky top-0 bg-white">
            <div className="relative">
              <svg className="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z" />
              </svg>
              <input
                ref={inputRef}
                type="text"
                value={query}
                onChange={e => setQuery(e.target.value)}
                placeholder={`${category} 검색…`}
                className="w-full pl-8 pr-3 py-1.5 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
              />
            </div>
          </div>

          {/* 옵션 목록 */}
          <div className="overflow-y-auto" style={{ maxHeight: 240 }}>
            {/* 미발주 (기본값) */}
            <button
              type="button"
              onClick={() => handleClear()}
              className={`w-full text-left px-4 py-2 text-sm flex items-center gap-2 transition-colors
                ${isEmpty ? "bg-gray-100 font-semibold text-gray-700" : "text-gray-400 hover:bg-gray-50"}`}
            >
              <span className="w-1.5 h-1.5 rounded-full bg-gray-300 flex-shrink-0"></span>
              미발주
              {isEmpty && (
                <svg className="w-3.5 h-3.5 text-gray-500 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                </svg>
              )}
            </button>

            {/* 구분선 */}
            <div className="mx-3 border-t border-gray-100"></div>

            {/* 필터된 옵션 */}
            {filtered.length === 0 && (
              <p className="px-4 py-3 text-xs text-gray-400 text-center">검색 결과 없음</p>
            )}
            {filtered.map(opt => {
              const isSelected = selectedValue === opt;
              return (
                <button
                  key={opt}
                  type="button"
                  onClick={() => handleSelectOption(opt)}
                  className={`w-full text-left px-4 py-2 text-sm flex items-start gap-2 transition-colors
                    ${isSelected
                      ? "bg-emerald-50 text-emerald-800 font-semibold"
                      : "text-gray-700 hover:bg-brand-weak hover:text-[#0090e6]"
                    }`}
                >
                  <span className={`w-1.5 h-1.5 rounded-full mt-1.5 flex-shrink-0 ${isSelected ? "bg-emerald-500" : "bg-gray-300"}`}></span>
                  <span className="leading-snug break-words">{opt}</span>
                  {isSelected && (
                    <svg className="w-3.5 h-3.5 text-emerald-600 ml-auto flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                    </svg>
                  )}
                </button>
              );
            })}

            {/* 구분선 */}
            <div className="mx-3 border-t border-gray-100"></div>

            {/* [+ 직접 입력] 고정 옵션 */}
            <button
              type="button"
              onClick={handleSelectCustom}
              className={`w-full text-left px-4 py-2 text-sm flex items-center gap-2 transition-colors
                ${isCustomMode
                  ? "bg-purple-50 text-purple-700 font-semibold"
                  : "text-purple-600 hover:bg-purple-50"
                }`}
            >
              <span className="w-1.5 h-1.5 rounded-full bg-purple-400 flex-shrink-0"></span>
              <span>+ 직접 입력</span>
              {isCustomMode && (
                <svg className="w-3.5 h-3.5 text-purple-600 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                </svg>
              )}
            </button>
          </div>
        </div>
      )}

      {/* ── 직접 입력 텍스트 필드 (Transition) ── */}
      <div
        className="overflow-hidden transition-all duration-300 ease-in-out"
        style={{
          maxHeight: showCustomInput ? "120px" : "0px",
          opacity: showCustomInput ? 1 : 0,
          marginTop: showCustomInput ? "8px" : "0px",
        }}
      >
        <div className="flex items-center gap-2 px-4 py-3 rounded-xl border-2 border-purple-300 bg-purple-50 focus-within:ring-2 focus-within:ring-purple-400 focus-within:ring-offset-1 transition-all">
          <svg className="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          <input
            ref={customInputRef}
            type="text"
            value={customText}
            onChange={e => handleCustomChange(e.target.value)}
            placeholder="모델명 또는 스펙을 직접 입력하세요…"
            className="flex-1 text-sm bg-transparent focus:outline-none text-purple-800 placeholder:text-purple-300 font-medium"
          />
          {customText && (
            <button
              type="button"
              onClick={() => handleCustomChange("")}
              className="flex-shrink-0 text-purple-300 hover:text-purple-600 transition-colors"
            >
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   기기 탭 — GigiTab
═══════════════════════════════════════════════════════ */
const GIGI_CATEGORY_ICONS = {
  쿡탑:   { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 14v6m-3-3h6M6 10h.01M6 14h.01M10 12h.01M14 12h.01M10 8h.01M6 6h12a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2z" /></svg>, color: "text-rose-600", bg: "bg-rose-100" },
  후드:   { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h18v4l-6 6v6H9v-6L3 8V4z" /></svg>, color: "text-sky-600", bg: "bg-sky-100" },
  수전:   { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m7-9h1M3 12H2m15.07-6.07.71-.71M6.93 17.07l-.71.71M17.07 17.07l.71.71M6.93 6.93l-.71-.71M12 8a4 4 0 100 8 4 4 0 000-8z" /></svg>, color: "text-teal-600", bg: "bg-teal-100" },
  싱크볼: { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5zm7-10v6m0 0l-2-2m2 2l2-2" /></svg>, color: "text-brand", bg: "bg-brand-weak" },
  기타:   { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2zm7 4v6m0 0l-2-2m2 2l2-2" /></svg>, color: "text-amber-600", bg: "bg-amber-100" },
};
const DEFAULT_CAT_STYLE = { icon: <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>, color: "text-gray-600", bg: "bg-gray-100" };

function GigiTab({ onToast, onGigiOrderSubmit, gigiOrderData }) {
  const { gigiDb, loading, dbSource } = useGigiDb();
  const [selections, setSelections] = useState({});
  const [submitting, setSubmitting] = useState(false);
  const [gigiDate, setGigiDate] = useState("");

  /* 발주 상태 파생 */
  const orderStatus = gigiOrderData?.status || null; // null | "발주요청완료" | "발주확정" | "발주요청반려"
  const isSubmitted = orderStatus === "발주요청완료";
  const isApproved  = orderStatus === "발주확정";
  const isRejected  = orderStatus === "발주요청반려";
  const isLocked    = isSubmitted || isApproved; // 수정 불가
  const canSubmit   = !isLocked; // 최초 또는 반려 후 재발주 가능

  /* gigiDb 로드 완료 시 selections 초기화 */
  useEffect(() => {
    if (gigiOrderData?.items && Object.keys(gigiDb).length > 0) {
      // 기존 발주 데이터 복원
      const restored = {};
      gigiOrderData.items.forEach(item => {
        restored[item.category] = { mode: item.mode, value: item.value, custom: item.custom || "" };
      });
      // DB의 카테고리 중 복원되지 않은 것 초기화
      Object.keys(gigiDb).forEach(k => {
        if (!restored[k]) restored[k] = { mode: "select", value: "", custom: "" };
      });
      setSelections(restored);
      setGigiDate(gigiOrderData.requestedDate || "");
    } else {
      setSelections(buildInitialSelections(gigiDb));
    }
  }, [gigiDb, gigiOrderData]);

  /* 반려 시 selections/date 유지하되 편집 가능 */

  const handleChange = useCallback((cat, newState) => {
    setSelections(prev => ({ ...prev, [cat]: newState }));
  }, []);

  /* 선택된 항목 요약 */
  const selectedItems = Object.entries(selections).filter(([_, s]) =>
    (s.mode === "select" && s.value) || (s.mode === "custom" && s.custom.trim())
  );
  const selectedCount = selectedItems.length;

  const handleDateChange = (val) => setGigiDate(val);

  const handleSubmit = async () => {
    if (!canSubmit) return;
    if (selectedCount === 0) {
      onToast({ type: "warning", title: "선택 항목 없음", message: "최소 1개 이상의 기기를 선택하거나 입력해주세요." });
      return;
    }
    if (!gigiDate) {
      onToast({ type: "warning", title: "납기 일정 미선택", message: "기기 납기 일정을 선택해주세요." });
      return;
    }

    setSubmitting(true);
    const items = selectedItems.map(([cat, s]) => ({
      category: cat,
      mode: s.mode,
      value: s.value,
      custom: s.custom || "",
    }));

    try {
      const submitPayload = {
        items,
        requestedDate: gigiDate,
        status: "발주요청완료",
        submittedAt: new Date().toISOString(),
        rejectionReason: "",
        rejectedAt: "",
      };

      const result = onGigiOrderSubmit ? await onGigiOrderSubmit(submitPayload) : { ok: false };
      if (!result?.ok) return;

      onToast({
        type: "success",
        title: "기기 발주 요청 완료",
        message: `${selectedCount}개 기기의 발주 요청이 DB에 저장되었습니다. 희망 납기: ${gigiDate}`,
        duration: 5000,
      });
    } finally {
      setSubmitting(false);
    }
  };

  const today = new Date().toISOString().slice(0, 10);

  return (
    <div className="p-5 max-w-2xl space-y-5">

      {/* ── 섹션 헤더 ── */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="w-7 h-7 rounded-xl bg-gray-800 flex items-center justify-center flex-shrink-0">
            <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18" />
            </svg>
          </div>
          <div>
            <h3 className="text-base font-bold text-gray-800">기기 발주 선택</h3>
            <p className="text-xs text-gray-400 mt-1">자재 DB에서 기기를 검색하거나 직접 입력하세요.</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {selectedCount > 0 && (
            <span className="flex items-center gap-2 text-xs font-bold text-emerald-700 bg-emerald-100 border border-emerald-200 px-3 py-1 rounded-full">
              <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
              {selectedCount}개 선택됨
            </span>
          )}
          {orderStatus && (
            <span className={`text-xs font-bold px-2.5 py-1 rounded-full border ${
              isApproved ? "bg-emerald-100 text-emerald-700 border-emerald-200" :
              isRejected ? "bg-red-100 text-red-700 border-red-200" :
              "bg-brand-weak text-brand border-brand/20"
            }`}>
              {orderStatus}
            </span>
          )}
        </div>
      </div>
      <div className="border-b border-gray-200"></div>

      {/* ── 반려 사유 배너 ── */}
      {isRejected && gigiOrderData?.rejectionReason && (
        <div className="bg-red-50 border-2 border-red-200 rounded-xl px-5 py-4 space-y-2">
          <div className="flex items-center gap-2">
            <svg className="w-5 h-5 text-red-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
            <p className="text-sm font-bold text-red-700">발주가 반려되었습니다</p>
          </div>
          <div className="bg-white/80 rounded-lg px-4 py-3 border border-red-100">
            <p className="text-xs font-semibold text-red-600 mb-1">반려 사유</p>
            <p className="text-sm text-gray-700 leading-relaxed">{gigiOrderData.rejectionReason}</p>
          </div>
          {gigiOrderData.rejectedAt && (
            <p className="text-xs text-red-400">반려 일시: {new Date(gigiOrderData.rejectedAt).toLocaleString("ko-KR")}</p>
          )}
          <p className="text-xs text-red-600 font-medium">아래 항목을 수정한 후 다시 발주 요청해주세요.</p>
        </div>
      )}

      {/* ── 승인 완료 배너 ── */}
      {isApproved && (
        <div className="flex items-center gap-3 bg-emerald-50 border-2 border-emerald-200 rounded-xl px-5 py-4">
          <div className="w-10 h-10 rounded-xl bg-emerald-500 flex items-center justify-center flex-shrink-0">
            <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div>
            <p className="text-sm font-bold text-emerald-800">기기 발주 확정</p>
            <p className="text-xs text-emerald-600 mt-0.5">공급업체가 발주를 승인했습니다. 납기 일정: <span className="font-bold">{gigiOrderData?.requestedDate}</span></p>
          </div>
        </div>
      )}

      {/* ── 발주 요청 중 배너 ── */}
      {isSubmitted && (
        <div className="flex items-center gap-2 bg-brand-weak border border-brand/20 rounded-xl px-4 py-3">
          <svg className="w-4 h-4 text-brand flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p className="text-xs text-brand leading-relaxed">
            <span className="font-bold">발주 요청이 접수되었습니다.</span> 공급업체의 승인을 대기하고 있습니다.
          </p>
        </div>
      )}

      {/* ── 안내 배너 ── */}
      {canSubmit && (
        <div className="flex items-start gap-2 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3">
          <svg className="w-4 h-4 text-gray-400 mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p className="text-xs text-gray-500 leading-relaxed">
            기본값은 <span className="font-semibold text-gray-700">미발주</span>입니다. 드롭다운을 눌러 자재 DB에서 검색하거나,
            목록 하단의 <span className="font-semibold text-purple-700">+ 직접 입력</span>으로 모델명을 직접 작성할 수 있습니다.
          </p>
        </div>
      )}

      {/* ── DB 출처 안내 ── */}
      {dbSource === "db" && (
        <div className="flex items-center gap-2 text-xs text-emerald-600 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2">
          <svg className="w-3.5 h-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
          <span>업로드된 자재 DB를 사용하고 있습니다.</span>
        </div>
      )}
      {dbSource === "empty" && !loading && canSubmit && (
        <div className="flex items-start gap-3 bg-amber-50 border border-amber-200 rounded-xl px-4 py-4">
          <svg className="w-5 h-5 text-amber-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
          </svg>
          <div>
            <p className="text-sm font-semibold text-amber-800">자재 DB가 비어 있습니다</p>
            <p className="text-xs text-amber-600 mt-1">대시보드 상단의 <span className="font-bold">자재 DB 업데이트</span> 버튼으로 엑셀/CSV 파일을 업로드해주세요.</p>
          </div>
        </div>
      )}

      {/* ── 로딩 ── */}
      {loading && (
        <div className="flex items-center justify-center py-8 gap-2 text-gray-400 text-sm">
          <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          자재 DB 로딩 중…
        </div>
      )}

      {/* ── 카테고리 폼 ── */}
      {!loading && (
      <div className={`bg-white border border-gray-200 rounded-2xl shadow-sm divide-y divide-gray-100 ${isLocked ? "opacity-60 pointer-events-none" : ""}`}>
        {Object.keys(gigiDb).map(catKey => {
          const sel = selections[catKey] || { mode: "select", value: "", custom: "" };
          const isSet = sel.value && (sel.mode === "select" || sel.custom.trim());
          const catStyle = GIGI_CATEGORY_ICONS[catKey] || DEFAULT_CAT_STYLE;

          return (
            <div key={catKey} className={`px-5 py-4 transition-colors ${isSet ? "bg-white" : "bg-gray-50/50"}`}>
              {/* 카테고리 라벨 */}
              <div className="flex items-center gap-2 mb-3">
                <span className={`w-6 h-6 rounded-lg ${catStyle.bg} ${catStyle.color} flex items-center justify-center flex-shrink-0`}>
                  {catStyle.icon}
                </span>
                <span className="text-sm font-bold text-gray-800">{catKey}</span>

                {/* 상태 뱃지 */}
                {sel.mode === "custom" && sel.custom.trim() ? (
                  <span className="ml-auto text-xs font-semibold text-purple-600 bg-purple-100 border border-purple-200 px-2 py-0.5 rounded-full">
                    직접 입력
                  </span>
                ) : sel.value ? (
                  <span className="ml-auto text-xs font-semibold text-emerald-600 bg-emerald-100 border border-emerald-200 px-2 py-0.5 rounded-full">
                    선택됨
                  </span>
                ) : (
                  <span className="ml-auto text-xs text-gray-400 bg-gray-100 border border-gray-200 px-2 py-0.5 rounded-full">
                    미발주
                  </span>
                )}
              </div>

              {/* Searchable Select */}
              <SearchableSelect
                category={catKey}
                options={gigiDb[catKey] || []}
                state={sel}
                onChange={newState => handleChange(catKey, newState)}
                onToast={onToast}
              />
            </div>
          );
        })}
      </div>
      )}

      {/* ── 납기 일정 선택 ── */}
      <div className={`bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm ${isLocked ? "opacity-60 pointer-events-none" : ""}`}>
        <div className="px-5 py-4">
          <div className="flex items-center gap-2 mb-3">
            <span className="w-6 h-6 rounded-lg bg-brand-weak text-brand flex items-center justify-center flex-shrink-0">
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </span>
            <span className="text-sm font-bold text-gray-800">희망 납기 일정</span>
            {gigiDate && (
              <span className="ml-auto text-xs font-semibold text-brand bg-brand-weak border border-brand/20 px-2 py-0.5 rounded-full">
                {gigiDate}
              </span>
            )}
          </div>
          <input
            type="date"
            value={gigiDate}
            min={today}
            onChange={e => handleDateChange(e.target.value)}
            className="w-full px-3 py-2 text-sm border border-gray-200 bg-white text-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
          />
          {!gigiDate && (
            <p className="text-xs text-gray-400 mt-2">공급업체가 승인하면 이 일정이 공정일정에 확정 반영됩니다.</p>
          )}
        </div>
      </div>

      {/* ── 발주 요청 버튼 ── */}
      <div className="pt-1">
        <button
          onClick={handleSubmit}
          disabled={submitting || isLocked}
          className={`w-full py-4 rounded-2xl text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300
            ${isApproved
              ? "btn-confirm-done text-white cursor-default shadow-sm"
              : isSubmitted
                ? "bg-gray-200 text-gray-400 cursor-default"
                : submitting
                  ? "bg-brand text-white cursor-wait shadow-md"
                  : "bg-brand hover:bg-[#0090e6] text-white shadow-sm hover:shadow hover:-translate-y-0.5"
            }`}
        >
          {submitting ? (
            <>
              <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              발주 요청 처리 중…
            </>
          ) : isApproved ? (
            <>
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              발주 확정 완료
            </>
          ) : isSubmitted ? (
            <>
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              승인 대기 중
            </>
          ) : isRejected ? (
            <>
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              수정 후 재발주 요청
            </>
          ) : (
            <>
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              기기 발주 요청
            </>
          )}
        </button>
      </div>

      <div className="h-4"></div>
    </div>
  );
}


/* ═══════════════════════════════════════════════════════
   상판 탭 — Section A: 발주 서류 업로드 + 버전 관리
═══════════════════════════════════════════════════════ */
function SangpanSectionA({ versions: initVersions, activeVer: initActive, onToast, onStatusChange, silcheukImages = [], silcheukResultDone = false, onSangpanSchedule, uploadedFiles: initUploadedFiles = {}, onVersionsChange, silcheukFinalDate = "", sangpanProductionStarted = false, sangpanConfirmedAt = null, onDrawingReset, onUrgentChange, onSectionCReset, mokdaeData = {}, mokdaeProductionStarted = false, gigiOrderData = null }) {
  const [versions, setVersions]     = useState(initVersions);
  const [activeVer, setActiveVer]   = useState(initActive);
  const [uploadedFiles, setUploadedFiles] = useState(initUploadedFiles); // versionNo → [{id,name,size,url,isImage}]
  const [dragging, setDragging]     = useState(false);
  const [silcheukOpen, setSilcheukOpen] = useState(true);
  const [lightbox, setLightbox]     = useState(null); // { url, name } | null
  const fileInputRef = useRef(null);
  const [urgentConfirmOpen, setUrgentConfirmOpen] = useState(false);

  const current       = versions.find(v => v.versionNo === activeVer);
  const isNewVersion  = current?.isNew === true;
  const currentFiles  = uploadedFiles[activeVer] || [];
  const submittedVers = versions.filter(v => !v.isNew);
  const badgeStatus   = submittedVers.length > 0 ? "발주요청완료" : "발주요청대기";

  /* ESC → 라이트박스 닫기 */
  useEffect(() => {
    const fn = (e) => { if (e.key === "Escape") setLightbox(null); };
    document.addEventListener("keydown", fn);
    return () => document.removeEventListener("keydown", fn);
  }, []);

  /* 발주 상태 변경 시 부모에 알림 → 대시보드 자동 연동
     제작진행/발주확정/확정후조정(긴급) 등 상위 상태를 적극 반영 */
  useEffect(() => {
    if (!onStatusChange) return;
    if (sangpanProductionStarted) {
      onStatusChange("sangpan", "제작진행");
      return;
    }
    if (sangpanConfirmedAt) {
      onStatusChange("sangpan", "발주확정");
      return;
    }
    onStatusChange("sangpan", badgeStatus);
  }, [badgeStatus, sangpanProductionStarted, sangpanConfirmedAt]);

  /* 공장 승인(factoryChecked)된 최신 버전의 상판 일정을 부모에 전달
     → App이 schedule.mokdae + mokdaeFinalDate에 저장 → LeftPanel·index.html 자동 반영 */
  useEffect(() => {
    if (!onSangpanSchedule) return;
    const approved = versions
      .filter(v => !v.isNew && v.factoryChecked)
      .sort((a, b) => b.versionNo - a.versionNo);
    const date = (approved.length > 0 && approved[0].sangpanDate) || "";
    onSangpanSchedule(date);
  }, [versions]);

  /* ── 데이터 영속화: 변경 → 부모(App)로 전달 → localStorage 저장 ── */
  const didMountA = useRef(false);
  useEffect(() => {
    if (!didMountA.current) { didMountA.current = true; return; }
    if (onVersionsChange) onVersionsChange(versions, uploadedFiles);
  }, [versions, uploadedFiles]);

  /* ── cross-tab 동기화: factory.html에서 factoryChecked 등 변경 시 반영 ── */
  useEffect(() => {
    if (JSON.stringify(initVersions) !== JSON.stringify(versions)) setVersions(initVersions);
  }, [JSON.stringify(initVersions)]);
  useEffect(() => {
    if (JSON.stringify(initUploadedFiles) !== JSON.stringify(uploadedFiles)) setUploadedFiles(initUploadedFiles);
  }, [JSON.stringify(initUploadedFiles)]);

  /* 날짜 입력 제한: 오늘 이전 불가 + 실측 일정 이후만 가능 */
  const today = new Date().toISOString().slice(0, 10);
  const minSangpanDate = silcheukFinalDate && silcheukFinalDate > today ? silcheukFinalDate : today;

  const CheckIcon = () => (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
    </svg>
  );

  /* ── 새 버전 추가 ── */
  const handleAddVersion = () => {
    /* 발주 확정 후 버전 추가 → 긴급발주 확인 */
    if (sangpanConfirmedAt) {
      setUrgentConfirmOpen(true);
      return;
    }
    doAddVersion();
  };
  const doAddVersion = () => {
    const maxNo = versions.length > 0 ? Math.max(...versions.map(v => v.versionNo)) : 0;
    const newVer = { versionNo: maxNo + 1, files: [], factoryChecked: false, sentAt: "", sentBy: "", memo: "", sangpanDate: "", isNew: true };
    setVersions(prev => [...prev, newVer]);
    setActiveVer(maxNo + 1);
    setUrgentConfirmOpen(false);
  };

  /* ── 파일 업로드 (Storage 업로드) ── */
  const handleDragOver  = (e) => { e.preventDefault(); setDragging(true); };
  const handleDragLeave = (e) => { e.preventDefault(); setDragging(false); };
  const handleDrop = (e) => { e.preventDefault(); setDragging(false); handleAddFiles(Array.from(e.dataTransfer.files)); };
  const handleFileInputChange = (e) => { handleAddFiles(Array.from(e.target.files)); e.target.value = ""; };
  const [uploading, setUploading] = useState(false);
  const handleAddFiles = async (fileList) => {
    if (!fileList.length) return;
    const caseId = getCaseId();
    if (!caseId) { onToast({ type: "warning", message: "케이스 ID를 찾을 수 없습니다." }); return; }
    setUploading(true);
    try {
      const results = [];
      for (const f of fileList) {
        const sizeStr = f.size > 1024 * 1024 ? `${(f.size / 1024 / 1024).toFixed(1)} MB` : `${Math.round(f.size / 1024)} KB`;
        const isImage = f.type.startsWith("image/");
        let uploadFile = f;
        if (isImage) {
          const resizedBlob = await resizeImageToBlob(f);
          if (resizedBlob) uploadFile = new File([resizedBlob], f.name, { type: "image/jpeg" });
        }
        const uploaded = await uploadFileToStorage(uploadFile, caseId, "sangpan");
        if (uploaded) {
          results.push({ id: Date.now() + Math.random(), name: f.name, size: sizeStr, url: uploaded.publicUrl, storagePath: uploaded.storagePath, isImage });
        } else {
          results.push({ id: Date.now() + Math.random(), name: f.name, size: sizeStr, url: null, isImage: false, uploadFailed: true });
        }
      }
      setUploadedFiles(prev => ({ ...prev, [activeVer]: [...(prev[activeVer] || []), ...results] }));
      const failCount = results.filter(r => r.uploadFailed).length;
      if (failCount > 0) {
        onToast({ type: "warning", title: "일부 업로드 실패", message: `${fileList.length - failCount}개 성공, ${failCount}개 실패` });
      } else {
        onToast({ type: "success", title: "파일 추가됨", message: `${fileList.length}개 파일이 업로드되었습니다.` });
      }
    } catch (e) {
      console.error("File upload error:", e);
      onToast({ type: "warning", message: "파일 업로드 중 오류가 발생했습니다." });
    } finally {
      setUploading(false);
    }
  };
  const handleRemoveFile = (fileId) => {
    setUploadedFiles(prev => ({ ...prev, [activeVer]: (prev[activeVer] || []).filter(f => f.id !== fileId) }));
  };

  /* ── 파일 다운로드 ── */
  const handleDownloadFile = (f) => {
    if (!f.url) return;
    const a = document.createElement('a');
    a.href = f.url;
    a.download = f.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  /* ── 발주 요청 전송 ── */
  const doSendRequest = () => {
    const now = new Date().toLocaleString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, isNew: false, factoryChecked: false, sentAt: now, sentBy: "관리자" } : v
    ));
    /* 발주서 재발송 시 기존 도면 승인 해제 */
    if (onDrawingReset) onDrawingReset();
    /* 발주 확정 후 수정 → 긴급발주 상태 + Section C 리셋 */
    if (sangpanConfirmedAt) {
      if (onUrgentChange) onUrgentChange();
      if (onSectionCReset) onSectionCReset();
      onToast({ type: "warning", title: `발주 V${activeVer} 긴급 발송`, message: "확정 후 수정 발송 — 긴급발주 상태로 변경되며, 소비자 승인 및 발주 확정이 리셋됩니다.", duration: 5000 });
    } else {
      onToast({ type: "success", title: `발주 V${activeVer} 요청 완료`, message: "공장으로 발주 요청이 전송되었습니다." });
    }
  };

  return (
    <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
      {/* 헤더 (버전 추가 버튼 포함) */}
      <div className="flex items-center justify-between px-5 py-3 bg-brand-weak border-b border-brand/10">
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 rounded-lg bg-brand flex items-center justify-center flex-shrink-0">
            <svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <div>
            <h4 className="text-base font-bold text-gray-800">Section A · 발주 서류</h4>
            <p className="text-xs text-gray-400 mt-0.5">버전별 서류 현황 · 공장 확인 상태</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <MokdaeStatusBadge status={badgeStatus} />
          {!sangpanProductionStarted && (
            <button
              onClick={handleAddVersion}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-white bg-brand hover:bg-[#0090e6] rounded-lg shadow-sm transition-all active:scale-95"
            >
              <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>
              버전 추가
            </button>
          )}
          {sangpanProductionStarted && (
            <span className="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold text-teal-700 bg-teal-50 border border-teal-200 rounded-lg">
              <span className="w-1.5 h-1.5 rounded-full bg-teal-500 animate-pulse"></span>
              제작 진행 중
            </span>
          )}
        </div>
      </div>

      <div className="flex" style={{ minHeight: 340 }}>
        {/* ── 좌측: 버전 히스토리 사이드바 ── */}
        <div className="w-44 flex-shrink-0 border-r border-gray-100 py-3 flex flex-col">
          <p className="text-xs font-semibold text-gray-400 px-4 mb-2 uppercase tracking-wide">버전 히스토리</p>
          {versions.length === 0 && (
            <div className="flex-1 flex flex-col items-center justify-center px-4 text-center gap-2">
              <svg className="w-8 h-8 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p className="text-xs text-gray-300 leading-relaxed">상단 [버전 추가]를<br/>눌러 시작하세요</p>
            </div>
          )}
          {versions.map(v => (
            <button
              key={v.versionNo}
              onClick={() => setActiveVer(v.versionNo)}
              className={`w-full text-left px-4 py-2.5 flex flex-col gap-1 transition-colors border-l-2 ${
                activeVer === v.versionNo ? "border-brand bg-brand-weak" : "border-transparent hover:bg-gray-50"
              }`}
            >
              <div className="flex items-center gap-1.5 flex-wrap">
                <span className={`text-sm font-bold ${activeVer === v.versionNo ? "text-brand" : "text-gray-700"}`}>
                  발주 V{v.versionNo}
                </span>
                {v.versionNo === Math.max(...versions.map(x => x.versionNo)) && (
                  <span className="text-xs bg-brand text-white px-1.5 py-0.5 rounded font-bold leading-none">최신</span>
                )}
              </div>
              {v.isNew ? (
                <span className="inline-flex text-xs font-semibold px-2 py-0.5 rounded-full w-fit bg-orange-100 text-orange-600 border border-orange-200">작성중</span>
              ) : (
                <span className={`inline-flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full w-fit ${
                  v.factoryChecked ? "bg-emerald-100 text-emerald-700" : "bg-gray-100 text-gray-400"
                }`}>
                  {v.factoryChecked ? <><CheckIcon />공장확인</> : "공장 미확인"}
                </span>
              )}
              {v.sentAt && <span className="text-xs text-gray-400">{String(v.sentAt).slice(0, 10)}</span>}
            </button>
          ))}
        </div>

        {/* ── 우측: 버전 상세 ── */}
        {versions.length === 0 ? (
          <div className="flex-1 flex flex-col items-center justify-center gap-3 text-gray-300">
            <svg className="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p className="text-sm font-medium text-gray-400">아직 등록된 발주 버전이 없습니다</p>
            <p className="text-xs">좌측 상단 [버전 추가] 버튼을 눌러 시작하세요.</p>
          </div>

        ) : current && isNewVersion ? (
          /* ── 신규 버전 작성 UI ── */
          <div className="flex-1 min-w-0 px-5 py-4 space-y-4 overflow-y-auto">

            {/* 1. 드래그앤드롭 업로드 */}
            <div>
              <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">발주서 파일 업로드</p>
              <div
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                onClick={() => fileInputRef.current?.click()}
                className={`relative flex flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed transition-all cursor-pointer py-8 ${
                  dragging ? "border-brand bg-brand-weak scale-[1.01]" : "border-gray-300 bg-gray-50/50 hover:border-brand hover:bg-brand-weak/30"
                }`}
              >
                <input ref={fileInputRef} type="file" multiple className="hidden" onChange={handleFileInputChange} />
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${dragging ? "bg-brand-weak" : "bg-white border border-gray-200"}`}>
                  <svg className={`w-5 h-5 transition-colors ${dragging ? "text-brand" : "text-gray-400"}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.8} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                </div>
                <div className="text-center">
                  <p className={`text-sm font-semibold transition-colors ${dragging ? "text-brand" : "text-gray-600"}`}>
                    {dragging ? "여기에 놓으세요!" : "파일을 드래그하거나 클릭하여 업로드"}
                  </p>
                  {!dragging && <p className="text-xs text-gray-400 mt-1">발주서, 도면, 사진 등 모든 파일 형식 지원</p>}
                </div>
              </div>
            </div>

            {/* ── 전제조건 참고자료 섹션 ── */}
            {(() => {
              /* 전제조건 상태 계산 */
              const silcheukReady = silcheukResultDone && silcheukImages.length > 0;
              const mokdaeVersions = mokdaeData.versions || [];
              const mokdaeFiles = mokdaeData.uploadedFiles || {};
              const mokdaeCadVersions = mokdaeData.cadVersions || [];
              const mokdaeSubmitted = mokdaeVersions.filter(v => !v.isNew);
              const mokdaeReady = mokdaeProductionStarted && mokdaeSubmitted.length > 0;
              const gigiReady = gigiOrderData?.status === "발주확정";
              return null; /* 계산만 — 아래 섹션에서 사용 */
            })()}

            {/* 2-1. 실측자료 (검수 완료 시에만 표시) */}
            <div className="border border-gray-200 rounded-xl overflow-hidden">
              <button
                onClick={() => setSilcheukOpen(p => !p)}
                className="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors"
              >
                <div className="flex items-center gap-2">
                  <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">실측자료</span>
                  {silcheukResultDone ? (
                    <span className="text-xs px-1.5 py-0.5 rounded-full bg-emerald-100 text-emerald-700 font-bold">검수완료 · {silcheukImages.length}장</span>
                  ) : (
                    <span className="text-xs px-1.5 py-0.5 rounded-full bg-amber-100 text-amber-700 font-bold">검수 미완료</span>
                  )}
                </div>
                <svg className={`w-4 h-4 text-gray-400 transition-transform duration-200 ${silcheukOpen ? "rotate-180" : ""}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              {silcheukOpen && (
                silcheukResultDone && silcheukImages.length > 0 ? (
                  <div className="p-3 grid grid-cols-3 gap-2 border-t border-gray-100">
                    {silcheukImages.map(img => (
                      <div key={img.id} className="relative aspect-[4/3] rounded-lg overflow-hidden border border-gray-200 group cursor-zoom-in"
                           onClick={() => img.isImage && img.url && setLightbox({ url: img.url, name: img.label || img.name })}>
                        {img.isImage && img.url ? (
                          <React.Fragment>
                            <img src={img.url} alt={img.label || img.name} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy" />
                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                          </React.Fragment>
                        ) : (
                          <div className="w-full h-full bg-gray-100 flex flex-col items-center justify-center gap-1 p-2">
                            <svg className="w-7 h-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p className="text-xs text-gray-500 truncate w-full text-center">{img.name}</p>
                          </div>
                        )}
                        <div className="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/50 to-transparent px-2 py-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                          <p className="text-white text-xs truncate">{img.label || img.name}</p>
                          {img.category && <span className="text-white/70 text-xs">{img.category}</span>}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="px-4 py-6 flex flex-col items-center gap-2 text-gray-300 border-t border-gray-100">
                    <svg className="w-8 h-8 text-amber-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <p className="text-sm font-medium text-gray-500 text-center">실측 검수가 완료되지 않았습니다</p>
                    <p className="text-xs text-gray-400 text-center">실측 탭에서 검수를 완료해야 자료가 불러와집니다.</p>
                  </div>
                )
              )}
            </div>

            {/* 2-2. 목대 발주서 & CAD 도면 (제작 중 상태일 때만 표시) */}
            {(() => {
              const mokdaeSubmittedVers = (mokdaeData.versions || []).filter(v => !v.isNew);
              const mokdaeCadVers = mokdaeData.cadVersions || [];
              const mokdaeFiles = mokdaeData.uploadedFiles || {};
              const isMokdaeReady = mokdaeProductionStarted && mokdaeSubmittedVers.length > 0;
              const latestMokdaeVer = mokdaeSubmittedVers.length > 0 ? mokdaeSubmittedVers[mokdaeSubmittedVers.length - 1] : null;
              const latestMokdaeFiles = latestMokdaeVer ? (mokdaeFiles[latestMokdaeVer.versionNo] || []) : [];
              const latestCad = mokdaeCadVers.length > 0 ? mokdaeCadVers[mokdaeCadVers.length - 1] : null;

              return (
                <div className="border border-gray-200 rounded-xl overflow-hidden">
                  <div className="w-full flex items-center justify-between px-4 py-3 bg-gray-50">
                    <div className="flex items-center gap-2">
                      <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                      </svg>
                      <span className="text-xs font-semibold text-gray-600">목대 발주서 & CAD 도면</span>
                      {isMokdaeReady ? (
                        <span className="text-xs px-1.5 py-0.5 rounded-full bg-teal-100 text-teal-700 font-bold">제작 중</span>
                      ) : (
                        <span className="text-xs px-1.5 py-0.5 rounded-full bg-amber-100 text-amber-700 font-bold">미준비</span>
                      )}
                    </div>
                  </div>
                  {isMokdaeReady ? (
                    <div className="px-4 py-3 border-t border-gray-100 space-y-2">
                      {latestMokdaeVer && (
                        <div className="flex items-center gap-2 text-xs text-gray-600">
                          <span className="font-semibold">발주서 V{latestMokdaeVer.versionNo}</span>
                          <span className="text-gray-400">· {latestMokdaeVer.sentAt}</span>
                          <span className="text-xs px-1.5 py-0.5 rounded-full bg-emerald-100 text-emerald-700 font-bold">공장확인</span>
                        </div>
                      )}
                      {latestMokdaeFiles.length > 0 && (
                        <div className="flex flex-wrap gap-1.5">
                          {latestMokdaeFiles.map(f => (
                            <span key={f.id} className="inline-flex items-center gap-1 text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors"
                              onClick={() => {
                                if (f.isImage && f.url) {
                                  setLightbox({ url: f.url, name: f.name });
                                } else if (f.url) {
                                  const a = document.createElement('a');
                                  a.href = f.url;
                                  a.download = f.name;
                                  a.target = '_blank';
                                  document.body.appendChild(a);
                                  a.click();
                                  document.body.removeChild(a);
                                }
                              }}>
                              <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                              {f.name}
                            </span>
                          ))}
                        </div>
                      )}
                      {latestCad && (
                        <div className="flex items-center gap-2 text-xs text-gray-600">
                          <span className="font-semibold">CAD V{latestCad.versionNo}</span>
                          <span className={`text-xs px-1.5 py-0.5 rounded-full font-bold ${latestCad.status === "승인" ? "bg-emerald-100 text-emerald-700" : "bg-gray-100 text-gray-400"}`}>{latestCad.status || "대기"}</span>
                          {latestCad.previewUrl && (
                            <span className="inline-flex items-center gap-1 text-xs text-brand cursor-pointer hover:underline"
                              onClick={() => {
                                if (latestCad.previewUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                                  setLightbox({ url: latestCad.previewUrl, name: latestCad.fileName || `CAD V${latestCad.versionNo}` });
                                } else {
                                  window.open(latestCad.previewUrl, '_blank');
                                }
                              }}>
                              <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                              {latestCad.fileName || "파일 보기"}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="px-4 py-6 flex flex-col items-center gap-2 text-gray-300 border-t border-gray-100">
                      <svg className="w-8 h-8 text-amber-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                      <p className="text-sm font-medium text-gray-500 text-center">목대 발주가 제작 중 상태가 아닙니다</p>
                      <p className="text-xs text-gray-400 text-center">목대 탭에서 발주 확정 후 제작이 시작되어야 불러와집니다.</p>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* 2-3. 기기 발주 내역 (발주 확정 시에만 표시) */}
            {(() => {
              const isGigiReady = gigiOrderData?.status === "발주확정";
              const gigiItems = gigiOrderData?.items || [];
              return (
                <div className="border border-gray-200 rounded-xl overflow-hidden">
                  <div className="w-full flex items-center justify-between px-4 py-3 bg-gray-50">
                    <div className="flex items-center gap-2">
                      <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                      </svg>
                      <span className="text-xs font-semibold text-gray-600">기기 발주 내역</span>
                      {isGigiReady ? (
                        <span className="text-xs px-1.5 py-0.5 rounded-full bg-emerald-100 text-emerald-700 font-bold">발주확정</span>
                      ) : (
                        <span className="text-xs px-1.5 py-0.5 rounded-full bg-amber-100 text-amber-700 font-bold">미확정</span>
                      )}
                    </div>
                  </div>
                  {isGigiReady ? (
                    <div className="px-4 py-3 border-t border-gray-100">
                      <div className="space-y-1.5">
                        {gigiItems.map((item, i) => (
                          <div key={i} className="flex items-center justify-between text-xs py-1 border-b border-gray-50 last:border-b-0">
                            <span className="font-semibold text-gray-700">{item.category}</span>
                            <span className="text-gray-500">{item.mode === "skip" ? "미포함" : item.value}{item.custom ? ` (${item.custom})` : ""}</span>
                          </div>
                        ))}
                        {gigiOrderData?.requestedDate && (
                          <div className="flex items-center gap-2 text-xs text-gray-500 mt-2 pt-2 border-t border-gray-100">
                            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            <span>납기: {gigiOrderData.requestedDate}</span>
                          </div>
                        )}
                      </div>
                    </div>
                  ) : (
                    <div className="px-4 py-6 flex flex-col items-center gap-2 text-gray-300 border-t border-gray-100">
                      <svg className="w-8 h-8 text-amber-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                      <p className="text-sm font-medium text-gray-500 text-center">기기 발주가 확정되지 않았습니다</p>
                      <p className="text-xs text-gray-400 text-center">기기 탭에서 발주가 확정되어야 내역이 불러와집니다.</p>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* 3. 업로드된 발주서 파일 프리뷰 */}
            {currentFiles.length > 0 && (
              <div>
                <p className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">
                  업로드된 발주서
                  <span className="ml-1.5 text-gray-300 font-normal normal-case tracking-normal">({currentFiles.length}개)</span>
                </p>
                <div className="grid grid-cols-2 gap-3">
                  {currentFiles.map(f => (
                    <div key={f.id} className="border border-gray-200 rounded-xl overflow-hidden bg-white hover:border-brand/30 transition-colors group">
                      {f.isImage ? (
                        <div className="relative h-28 bg-gray-100 cursor-zoom-in" onClick={() => setLightbox({ url: f.url, name: f.name })}>
                          <img src={f.url} alt={f.name} className="w-full h-full object-cover" />
                          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                            <svg className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 drop-shadow transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0zm0 0l3 3"/>
                            </svg>
                          </div>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleRemoveFile(f.id); }}
                            className="absolute top-1.5 right-1.5 w-6 h-6 bg-black/50 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all"
                          >
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12"/></svg>
                          </button>
                        </div>
                      ) : (
                        <div className="relative h-28 bg-gray-50 flex flex-col items-center justify-center gap-1.5 cursor-pointer hover:bg-gray-100 transition-colors" onClick={() => handleDownloadFile(f)}>
                          <svg className="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                          <span className="text-xs text-gray-400 font-semibold uppercase">{f.name.split('.').pop()}</span>
                          <span className="text-xs text-brand/60 font-medium">클릭하여 다운로드</span>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleRemoveFile(f.id); }}
                            className="absolute top-1.5 right-1.5 w-6 h-6 bg-black/30 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all"
                          >
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12"/></svg>
                          </button>
                        </div>
                      )}
                      <div className="px-3 py-2">
                        <p className="text-xs font-medium text-gray-700 truncate" title={f.name}>{f.name}</p>
                        <p className="text-xs text-gray-400">{f.size}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* 4. 상판 예정 일정 입력 */}
            <div className="bg-gray-50 rounded-xl p-3 border border-gray-200">
              <label className="flex items-center gap-3">
                <div className="flex items-center gap-1.5 w-28 flex-shrink-0">
                  <svg className="w-3.5 h-3.5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">상판 예정 일정</span>
                </div>
                <input
                  type="date"
                  value={current.sangpanDate || ""}
                  min={minSangpanDate}
                  onChange={e => setVersions(prev => prev.map(v => v.versionNo === activeVer ? { ...v, sangpanDate: e.target.value } : v))}
                  className="flex-1 px-2.5 py-1.5 text-xs border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand bg-white text-gray-700"
                />
              </label>
            </div>

            {/* 발주 요청 버튼 */}
            {(() => {
              const prereqSilcheuk = silcheukResultDone && silcheukImages.length > 0;
              const mokdaeSubmittedCheck = (mokdaeData.versions || []).filter(v => !v.isNew);
              const prereqMokdae = mokdaeProductionStarted && mokdaeSubmittedCheck.length > 0;
              const prereqGigi = gigiOrderData?.status === "발주확정";
              const prereqDate = !!(current.sangpanDate);
              const prereqFiles = currentFiles.length > 0;
              const canSubmit = prereqSilcheuk && prereqMokdae && prereqGigi && prereqDate && prereqFiles;

              const missingItems = [];
              if (!prereqSilcheuk) missingItems.push("실측자료(검수완료)");
              if (!prereqMokdae) missingItems.push("목대(제작중)");
              if (!prereqGigi) missingItems.push("기기(발주확정)");
              if (!prereqDate) missingItems.push("상판 예정일정");
              if (!prereqFiles) missingItems.push("발주서 파일");

              return (
                <div className="flex flex-col gap-2 pt-2 border-t border-gray-100">
                  {!canSubmit && (
                    <p className="text-xs text-amber-600 flex items-start gap-1.5">
                      <svg className="w-3.5 h-3.5 text-amber-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <span>다음 항목이 충족되어야 발주 요청이 가능합니다: <strong>{missingItems.join(", ")}</strong></span>
                    </p>
                  )}
                  <div className="flex justify-end">
                    <button
                      onClick={doSendRequest}
                      disabled={!canSubmit}
                      className={`flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-xl shadow-sm transition-all ${
                        !canSubmit ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-brand hover:bg-[#0090e6] text-white"
                      }`}
                    >
                      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                      </svg>
                      발주 요청
                    </button>
                  </div>
                </div>
              );
            })()}
          </div>

        ) : current ? (
          /* ── 기존 버전 상세 (읽기 전용) ── */
          <div className="flex-1 min-w-0 px-5 py-4 space-y-4 overflow-y-auto">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-bold text-gray-800">발주 V{current.versionNo} 상세</p>
                <p className="text-xs text-gray-400">발송: {current.sentBy} · {current.sentAt}</p>
              </div>
              {current.factoryChecked && (
                <div className="flex items-center gap-2 text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg px-2 py-1.5">
                  <CheckIcon /> 공장 열람 {current.factoryCheckedAt}
                </div>
              )}
            </div>

            {/* 전제조건 참고자료 — 실측, 목대, 기기 (읽기 전용) */}
            {/* 2-1. 실측자료 */}
            {silcheukResultDone && silcheukImages.length > 0 && (
              <div className="border border-gray-200 rounded-xl overflow-hidden">
                <div className="w-full flex items-center justify-between px-4 py-3 bg-gray-50">
                  <div className="flex items-center gap-2">
                    <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span className="text-xs font-semibold text-gray-600">실측자료</span>
                    <span className="text-xs px-1.5 py-0.5 rounded-full bg-emerald-100 text-emerald-700 font-bold">검수완료 · {silcheukImages.length}장</span>
                  </div>
                </div>
                <div className="p-3 grid grid-cols-3 gap-2 border-t border-gray-100">
                  {silcheukImages.map(img => (
                    <div key={img.id} className="relative aspect-[4/3] rounded-lg overflow-hidden border border-gray-200 group cursor-zoom-in"
                         onClick={() => img.isImage && img.url && setLightbox({ url: img.url, name: img.label || img.name })}>
                      {img.isImage && img.url ? (
                        <React.Fragment>
                          <img src={img.url} alt={img.label || img.name} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy" />
                          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                        </React.Fragment>
                      ) : (
                        <div className="w-full h-full bg-gray-100 flex flex-col items-center justify-center gap-1 p-2">
                          <svg className="w-7 h-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                          <p className="text-xs text-gray-500 truncate w-full text-center">{img.name}</p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* 2-2. 목대 발주서 & CAD 도면 */}
            {(() => {
              const mokdaeSubmittedVers = (mokdaeData.versions || []).filter(v => !v.isNew);
              const mokdaeCadVers = mokdaeData.cadVersions || [];
              const mokdaeFilesRef = mokdaeData.uploadedFiles || {};
              const isMokdaeReady = mokdaeProductionStarted && mokdaeSubmittedVers.length > 0;
              const latestMokdaeVer = mokdaeSubmittedVers.length > 0 ? mokdaeSubmittedVers[mokdaeSubmittedVers.length - 1] : null;
              const latestMokdaeFiles = latestMokdaeVer ? (mokdaeFilesRef[latestMokdaeVer.versionNo] || []) : [];
              const latestCad = mokdaeCadVers.length > 0 ? mokdaeCadVers[mokdaeCadVers.length - 1] : null;
              if (!isMokdaeReady) return null;
              return (
                <div className="border border-gray-200 rounded-xl overflow-hidden">
                  <div className="w-full flex items-center justify-between px-4 py-3 bg-gray-50">
                    <div className="flex items-center gap-2">
                      <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                      </svg>
                      <span className="text-xs font-semibold text-gray-600">목대 발주서 & CAD 도면</span>
                      <span className="text-xs px-1.5 py-0.5 rounded-full bg-teal-100 text-teal-700 font-bold">제작 중</span>
                    </div>
                  </div>
                  <div className="px-4 py-3 border-t border-gray-100 space-y-2">
                    {latestMokdaeVer && (
                      <div className="flex items-center gap-2 text-xs text-gray-600">
                        <span className="font-semibold">발주서 V{latestMokdaeVer.versionNo}</span>
                        <span className="text-gray-400">· {latestMokdaeVer.sentAt}</span>
                      </div>
                    )}
                    {latestMokdaeFiles.length > 0 && (
                      <div className="flex flex-wrap gap-1.5">
                        {latestMokdaeFiles.map(f => (
                          <span key={f.id} className="inline-flex items-center gap-1 text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors"
                            onClick={() => f.isImage && f.url ? setLightbox({ url: f.url, name: f.name }) : handleDownloadFile(f)}>
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            {f.name}
                          </span>
                        ))}
                      </div>
                    )}
                    {latestCad && (
                      <div className="flex items-center gap-2 text-xs text-gray-600">
                        <span className="font-semibold">CAD V{latestCad.versionNo}</span>
                        <span className={`text-xs px-1.5 py-0.5 rounded-full font-bold ${latestCad.status === "승인" ? "bg-emerald-100 text-emerald-700" : "bg-gray-100 text-gray-400"}`}>{latestCad.status || "대기"}</span>
                        {latestCad.previewUrl && (
                          <span className="inline-flex items-center gap-1 text-xs text-brand cursor-pointer hover:underline"
                            onClick={() => {
                              if (latestCad.previewUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                                setLightbox({ url: latestCad.previewUrl, name: latestCad.fileName || `CAD V${latestCad.versionNo}` });
                              } else {
                                window.open(latestCad.previewUrl, '_blank');
                              }
                            }}>
                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            {latestCad.fileName || "파일 보기"}
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              );
            })()}

            {/* 2-3. 기기 발주 내역 */}
            {gigiOrderData?.status === "발주확정" && (
              <div className="border border-gray-200 rounded-xl overflow-hidden">
                <div className="w-full flex items-center justify-between px-4 py-3 bg-gray-50">
                  <div className="flex items-center gap-2">
                    <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                    <span className="text-xs font-semibold text-gray-600">기기 발주 내역</span>
                    <span className="text-xs px-1.5 py-0.5 rounded-full bg-emerald-100 text-emerald-700 font-bold">발주확정</span>
                  </div>
                </div>
                <div className="px-4 py-3 border-t border-gray-100">
                  <div className="space-y-1.5">
                    {(gigiOrderData?.items || []).map((item, i) => (
                      <div key={i} className="flex items-center justify-between text-xs py-1 border-b border-gray-50 last:border-b-0">
                        <span className="font-semibold text-gray-700">{item.category}</span>
                        <span className="text-gray-500">{item.mode === "skip" ? "미포함" : item.value}{item.custom ? ` (${item.custom})` : ""}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* 업로드된 발주서 파일 프리뷰 */}
            {(uploadedFiles[current.versionNo] || []).length > 0 ? (
              <div className="grid grid-cols-2 gap-3">
                {(uploadedFiles[current.versionNo] || []).map(f => (
                  <div key={f.id} className="border border-gray-200 rounded-xl overflow-hidden bg-white group">
                    {f.isImage ? (
                      <div className="relative h-28 bg-gray-100 cursor-zoom-in" onClick={() => setLightbox({ url: f.url, name: f.name })}>
                        <img src={f.url} alt={f.name} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                          <svg className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 drop-shadow transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
                          </svg>
                        </div>
                      </div>
                    ) : (
                      <div className="w-full h-28 bg-gray-50 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-gray-100 transition-colors" onClick={() => handleDownloadFile(f)}>
                        <svg className="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span className="text-xs text-gray-400 font-semibold uppercase">{f.name.split('.').pop()}</span>
                        <span className="text-xs text-brand/60 font-medium">클릭하여 다운로드</span>
                      </div>
                    )}
                    <div className="px-3 py-2">
                      <p className="text-xs font-medium text-gray-700 truncate">{f.name}</p>
                      <p className="text-xs text-gray-400">{f.size}</p>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="space-y-2">
                {current.files.map(f => <FileItem key={f.id} file={f} showRequired />)}
              </div>
            )}
            {/* 상판 예정 일정 (읽기 전용) */}
            {current.sangpanDate && (
              <div className="bg-gray-50 rounded-xl p-3 border border-gray-200 flex items-center gap-3">
                <div className="flex items-center gap-1.5">
                  <svg className="w-3.5 h-3.5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-xs font-semibold text-gray-600">상판 예정 일정</span>
                </div>
                <span className="text-xs font-bold text-gray-800">{current.sangpanDate}</span>
              </div>
            )}
            {current.memo && (
              <div className="bg-gray-50 rounded-lg px-3 py-2 border border-gray-200">
                <p className="text-xs text-gray-500 font-medium mb-1">발주 메모</p>
                <p className="text-sm text-gray-700 leading-relaxed">{current.memo}</p>
              </div>
            )}
          </div>
        ) : null}
      </div>

      {/* ── 이미지 라이트박스 ── */}
      {lightbox && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center p-6"
          style={{ background: "rgba(0,0,0,0.88)" }}
          onClick={() => setLightbox(null)}
        >
          <div className="relative flex flex-col items-center max-w-[92vw]" onClick={e => e.stopPropagation()}>
            {/* 닫기 버튼 */}
            <button
              onClick={() => setLightbox(null)}
              className="absolute -top-4 -right-4 z-10 w-9 h-9 bg-white/20 hover:bg-white/40 text-white rounded-full flex items-center justify-center transition-colors shadow-lg"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            {/* 이미지 */}
            <img
              src={lightbox.url}
              alt={lightbox.name}
              className="max-w-full rounded-xl object-contain shadow-2xl"
              style={{ maxHeight: "80vh" }}
            />
            {/* 하단 파일명 + ESC 안내 */}
            <div className="mt-3 flex items-center gap-4 w-full px-1">
              <p className="flex-1 text-white/70 text-sm truncate">{lightbox.name}</p>
              <span className="flex-shrink-0 text-xs text-white/40 bg-white/10 px-2 py-1 rounded">ESC로 닫기</span>
            </div>
          </div>
        </div>
      )}

      {/* ── 긴급발주 확인 모달 ── */}
      {urgentConfirmOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40" onClick={() => setUrgentConfirmOpen(false)}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="px-6 pt-6 pb-4">
              <div className="flex items-center gap-3 mb-3">
                <div className="w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center flex-shrink-0">
                  <svg className="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z" />
                  </svg>
                </div>
                <div>
                  <h3 className="text-base font-bold text-gray-900">긴급발주 요청</h3>
                  <p className="text-xs text-gray-400 mt-0.5">최종 발주 확정 건</p>
                </div>
              </div>
              <p className="text-sm text-gray-600 leading-relaxed">
                해당 건은 <span className="font-bold text-red-600">최종 발주가 확정</span>된 상태입니다.<br/>
                버전을 추가하면 <span className="font-bold text-red-600">긴급발주 요청</span>이 들어가게 됩니다.<br/>
                그래도 진행하시겠습니까?
              </p>
            </div>
            <div className="flex border-t border-gray-100">
              <button onClick={() => setUrgentConfirmOpen(false)}
                className="flex-1 py-3.5 text-sm font-semibold text-gray-500 hover:bg-gray-50 transition-colors">
                취소
              </button>
              <div className="w-px bg-gray-100"></div>
              <button onClick={doAddVersion}
                className="flex-1 py-3.5 text-sm font-bold text-red-600 hover:bg-red-50 transition-colors">
                긴급발주 진행
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   상판 탭 — Section B: 상판 도면 뷰어 & 버전 사이드바
═══════════════════════════════════════════════════════ */
function SangpanSectionB({ drawingVersions: initVersions, activeVer: initActive, onToast, onDrawingChange }) {
  const [versions, setVersions]   = useState(initVersions);
  const [activeVer, setActiveVer] = useState(initActive);
  const [lightbox, setLightbox]   = useState(null);
  const [showRevModal, setShowRevModal] = useState(false);
  const [revisionText, setRevisionText] = useState("");

  /* ── 데이터 영속화: 변경 → 부모(App)로 전달 → localStorage 저장 ── */
  const didMountB = useRef(false);
  useEffect(() => {
    if (!didMountB.current) { didMountB.current = true; return; }
    if (onDrawingChange) onDrawingChange(versions);
  }, [versions]);

  /* ── cross-tab 동기화: factory.html에서 CAD 업로드 시 반영 ── */
  useEffect(() => {
    if (JSON.stringify(initVersions) !== JSON.stringify(versions)) {
      setVersions(initVersions);
      if (initVersions.length > 0) setActiveVer(initVersions[initVersions.length - 1].versionNo);
    }
  }, [JSON.stringify(initVersions)]);

  const current = versions.find(v => v.versionNo === activeVer);

  const cadStatusStyle = {
    "승인":       "bg-emerald-100 text-emerald-700 border-emerald-200",
    "승인해제":   "bg-red-100 text-red-700 border-red-200",
    "도면수정요청":"bg-orange-100 text-orange-700 border-orange-200",
    "도면검토중":"bg-brand-weak text-brand border-brand/20",
  };

  const handleApprove = () => {
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, status: "승인", approvedAt: "2026-02-25 (방금)" } : v
    ));
    onToast({ type: "success", title: "상판 도면 승인 완료", message: `도면 V${activeVer} 도면이 승인되었습니다.`, duration: 4000 });
  };

  const handleRevisionSubmit = () => {
    if (!revisionText.trim()) {
      onToast({ type: "warning", title: "사유 입력 필요", message: "수정 요청 사유를 입력해주세요." });
      return;
    }
    setVersions(prev => prev.map(v =>
      v.versionNo === activeVer ? { ...v, status: "도면수정요청", revisionNote: revisionText } : v
    ));
    setShowRevModal(false);
    setRevisionText("");
    onToast({ type: "info", title: "수정 요청 전송", message: "공장으로 상판 도면 수정 요청이 전송되었습니다." });
  };

  return (
    <>
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <SectionHeader
          color="orange"
          icon={<svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>}
          title="Section B · 상판 도면 검토"
          sub="버전 클릭 → 뷰어 전환 · 승인 또는 수정 요청"
          badge={<MokdaeStatusBadge status={versions.length === 0 ? "발주요청대기" : (current?.status || "도면검토중")} />}
        />

        <div className="flex min-h-[300px]">
          {versions.length === 0 ? (
            <div className="flex-1 flex flex-col items-center justify-center py-14 gap-3 text-gray-300">
              <svg className="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p className="text-sm font-medium text-gray-400">아직 등록된 상판 도면이 없습니다</p>
              <p className="text-xs">발주 서류가 전달되면 공장에서 도면을 업로드합니다.</p>
            </div>
          ) : (<>
          {/* 좌측: CAD 버전 사이드바 */}
          <div className="w-44 flex-shrink-0 border-r border-gray-100 py-3">
            <p className="text-xs font-semibold text-gray-400 px-4 mb-2 uppercase tracking-wide">도면 버전</p>
            {versions.map(v => (
              <button
                key={v.versionNo}
                onClick={() => setActiveVer(v.versionNo)}
                className={`w-full text-left px-4 py-3 flex flex-col gap-2 transition-colors border-l-2 ${
                  activeVer === v.versionNo
                    ? "border-orange-500 bg-orange-50"
                    : "border-transparent hover:bg-gray-50"
                }`}
              >
                <div className="flex items-center gap-2">
                  <span className={`text-sm font-bold ${activeVer === v.versionNo ? "text-orange-700" : "text-gray-700"}`}>
                    도면 V{v.versionNo}
                  </span>
                  {v.versionNo === versions.length && (
                    <span className="text-xs bg-orange-500 text-white px-1.5 py-0.5 rounded font-bold leading-none">최신</span>
                  )}
                </div>
                <span className={`inline-block text-xs font-semibold px-2 py-0.5 rounded-full border w-fit ${cadStatusStyle[v.status] || "bg-gray-100 text-gray-500 border-gray-200"}`}>
                  {v.status}
                </span>
                <span className="text-xs text-gray-400">{v.uploadedAt.slice(5,10)}</span>
              </button>
            ))}
          </div>

          {/* 중앙: 도면 뷰어 */}
          {current && (
            <div className="flex-1 min-w-0 flex flex-col" style={{minHeight: 300}}>
              {/* 이미지 뷰어 */}
              <div className="relative flex-1 bg-gray-100 cursor-zoom-in group"
                   style={{ minHeight: "220px" }}
                   onClick={() => setLightbox(current.previewUrl)}>
                <img
                  src={current.previewUrl}
                  alt={`도면 V${current.versionNo}`}
                  className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-[1.02]"
                  style={{ maxHeight: "260px", objectFit: "cover" }}
                />

                {/* 승인 해제 워터마크 */}
                {current.status === "승인해제" && (
                  <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-red-900/20"></div>
                    <div className="relative z-10 select-none" style={{ transform: "rotate(-22deg)" }}>
                      <span className="text-red-600/75 font-black tracking-[0.2em] whitespace-nowrap"
                            style={{ fontSize:"clamp(18px,3vw,32px)", textShadow:"0 0 12px rgba(255,255,255,0.9)", WebkitTextStroke:"0.5px rgba(180,0,0,0.4)" }}>
                        승인 취소됨
                      </span>
                    </div>
                    <div className="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded shadow">VOID</div>
                  </div>
                )}

                {/* 승인 완료 오버레이 */}
                {current.status === "승인" && (
                  <div className="absolute top-2 left-2 flex items-center gap-2 bg-emerald-600/90 text-white text-xs font-bold px-2 py-1 rounded-lg shadow-md">
                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                    </svg>
                    승인됨 · {current.approvedAt}
                  </div>
                )}

                {/* 확대 힌트 */}
                <div className="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                  클릭하여 확대
                </div>
              </div>

              {/* 업로드 날짜 + 두 번째 도면 버튼 */}
              <div className="flex items-center gap-2 px-4 py-2 bg-gray-50 border-t border-gray-100 text-xs text-gray-500">
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                공장 업로드: {current.uploadedAt}
                <button onClick={() => setLightbox(current.previewUrl2)}
                        className="ml-auto flex items-center gap-1 text-brand hover:text-[#0090e6] font-medium">
                  상세도 보기 →
                </button>
              </div>

              {/* 수정 요청 내용 (있을 경우) */}
              {current.revisionNote && (
                <div className="mx-4 mb-3 mt-1 flex items-start gap-2 bg-orange-50 border border-orange-200 rounded-xl px-4 py-3">
                  <svg className="w-4 h-4 text-orange-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  <div>
                    <p className="text-xs font-semibold text-orange-700 mb-1">수정 요청 내용</p>
                    <p className="text-sm text-gray-700 leading-relaxed">{current.revisionNote}</p>
                  </div>
                </div>
              )}

              {/* 승인 해제 사유 */}
              {current.status === "승인해제" && (
                <div className="mx-4 mb-3 flex items-start gap-2 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
                  <svg className="w-4 h-4 text-red-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    <p className="text-xs font-semibold text-red-600 mb-1">승인 해제 사유</p>
                    <p className="text-sm text-gray-700">새로운 발주서(V2) 업로드로 인해 기존 승인이 자동 해제됨. ({current.approvalCancelledAt})</p>
                  </div>
                </div>
              )}

              {/* 액션 버튼 */}
              <div className="flex gap-2 px-4 pb-4 mt-auto">
                <button
                  onClick={handleApprove}
                  disabled={current.status === "승인"}
                  className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-semibold transition-all ${
                    current.status === "승인"
                      ? "bg-emerald-100 text-emerald-500 cursor-default"
                      : "bg-emerald-600 hover:bg-emerald-700 text-white shadow-sm"
                  }`}
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  {current.status === "승인" ? "승인 완료" : "승인"}
                </button>
                <button
                  onClick={() => setShowRevModal(true)}
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-sm font-semibold
                             bg-red-500 hover:bg-red-600 text-white shadow-sm shadow-red-200 transition-all"
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  수정 요청
                </button>
              </div>
            </div>
          )}
          </>)}
        </div>
      </div>

      {/* ── 수정 요청 사유 모달 ── */}
      <Modal open={showRevModal} onClose={() => setShowRevModal(false)}>
        <div className="px-6 py-5 space-y-4">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-xl bg-red-100 flex items-center justify-center flex-shrink-0">
              <svg className="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </div>
            <div>
              <h3 className="text-base font-bold text-gray-800">상판 도면 수정 요청</h3>
              <p className="text-xs text-gray-400">도면 V{activeVer} · 공장으로 전달됩니다</p>
            </div>
          </div>
          <div>
            <label className="block text-xs font-semibold text-gray-600 mb-1.5">수정 요청 사유 <span className="text-red-500">*</span></label>
            <textarea
              value={revisionText}
              onChange={e => setRevisionText(e.target.value)}
              rows={4}
              placeholder="예) 냉장고 우측 틈새 폭 340mm로 수정, 상부장 높이 2,300mm 재확인 필요"
              className="w-full px-3 py-2 text-sm border border-gray-300 rounded-xl resize-none
                         focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent
                         text-gray-700 leading-relaxed placeholder:text-gray-300"
            />
          </div>
          <div className="flex gap-3 justify-end">
            <button onClick={() => setShowRevModal(false)}
                    className="px-4 py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">
              취소
            </button>
            <button onClick={handleRevisionSubmit}
                    className="px-4 py-2 text-sm font-bold text-white bg-red-500 hover:bg-red-600 rounded-xl transition-colors flex items-center gap-2">
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              수정 요청 전송
            </button>
          </div>
        </div>
      </Modal>

      {/* ── 이미지 라이트박스 ── */}
      <Modal open={!!lightbox} onClose={() => setLightbox(null)} maxW="max-w-4xl">
        <div className="relative">
          <div className="relative">
            <img src={lightbox} alt="상판 도면 확대" className="w-full object-contain rounded-t-2xl max-h-[80vh]" />
            {current?.status === "승인해제" && (
              <div className="absolute inset-0 flex items-center justify-center pointer-events-none rounded-t-2xl">
                <div className="absolute inset-0 bg-red-900/15 rounded-t-2xl"></div>
                <div className="relative z-10" style={{ transform: "rotate(-22deg)" }}>
                  <span className="text-red-600/65 font-black tracking-[0.3em] text-5xl"
                        style={{ textShadow:"0 0 20px rgba(255,255,255,0.95)", WebkitTextStroke:"1px rgba(180,0,0,0.3)" }}>
                    승인 취소됨
                  </span>
                </div>
              </div>
            )}
          </div>
          <div className="px-4 py-2 bg-gray-50 text-xs text-gray-400 text-center rounded-b-2xl">
            바깥 클릭 또는 ESC로 닫기
          </div>
          <button onClick={() => setLightbox(null)}
                  className="absolute top-3 right-3 w-8 h-8 bg-black/40 hover:bg-black/60 text-white rounded-full flex items-center justify-center transition-colors">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </Modal>
    </>
  );
}

/* ═══════════════════════════════════════════════════════
   상판 탭 — Section C: 최종 확정 & 예외 처리
═══════════════════════════════════════════════════════ */
function SangpanSectionC({ data, onToast, onConfirmChange, sangpanProductionStarted = false }) {
  const [approved, setApproved]   = useState(data.consumerApproved);
  const [confirmed, setConfirmed] = useState(!!data.confirmedAt);

  /* ── cross-tab 동기화: factory.html 등에서 데이터 변경 시 반영 ── */
  useEffect(() => { setApproved(data.consumerApproved); }, [data.consumerApproved]);
  useEffect(() => { setConfirmed(!!data.confirmedAt); },  [data.confirmedAt]);

  /* ── approved 변경 → 부모에 알림 (mount 스킵) ── */
  const didMountC = useRef(false);
  useEffect(() => {
    if (!didMountC.current) { didMountC.current = true; return; }
    if (onConfirmChange) onConfirmChange({ consumerApproved: approved, confirmedAt: confirmed ? (data.confirmedAt || null) : null });
  }, [approved]);

  const handleConfirm = () => {
    if (!approved) {
      onToast({ type: "warning", title: "소비자 승인 필요", message: "소비자 승인 체크박스를 먼저 확인해주세요." });
      return;
    }
    setConfirmed(true);
    const now = new Date().toISOString();
    if (onConfirmChange) onConfirmChange({ consumerApproved: true, confirmedAt: now });
    onToast({ type: "success", title: "최종 발주 확정", message: "대시보드 상판 발주 상태가 [발주확정]으로 변경되었습니다.", duration: 5000 });
  };

  return (
    <div className={`rounded-xl overflow-hidden border-2 bg-white ${confirmed ? "border-emerald-300" : "border-brand/20"}`}>
      <SectionHeader
        color={confirmed ? "green" : "blue"}
        icon={<svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>}
        title="Section C · 소비자 최종 승인 및 발주 확정"
        badge={confirmed ? <MokdaeStatusBadge status="발주확정" /> : null}
      />

      <div className="px-5 py-5 space-y-4">
        {/* 소비자 승인 체크박스 */}
        <label className={`flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all ${
          approved ? "border-brand bg-brand-weak" : "border-gray-200 bg-gray-50 hover:border-brand/30 hover:bg-brand-weak/40"
        }`}>
          <div className="relative mt-1 flex-shrink-0">
            <input type="checkbox" checked={approved} onChange={e => setApproved(e.target.checked)}
                   disabled={confirmed} className="sr-only" />
            <div className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${
              approved ? "bg-brand border-brand" : "bg-white border-gray-400"
            }`}>
              {approved && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7"/></svg>}
            </div>
          </div>
          <div>
            <p className={`text-sm font-semibold ${approved ? "text-gray-800" : "text-gray-600"}`}>
              소비자가 최종 도면을 확인하고 승인하였습니다.
            </p>
            <p className="text-xs text-gray-400 mt-1">이 항목을 체크해야 최종 발주 확정 버튼이 활성화됩니다.</p>
          </div>
        </label>

        {/* 확정 버튼 */}
        <button onClick={handleConfirm} disabled={confirmed}
          className={`w-full py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all duration-300 ${
            confirmed
              ? "bg-emerald-500 text-white cursor-default shadow-sm shadow-emerald-100"
              : approved
              ? "bg-brand hover:bg-[#0090e6] text-white shadow-sm  hover:-translate-y-0.5"
              : "bg-gray-100 text-gray-400 cursor-not-allowed"
          }`}>
          {confirmed ? (
            <><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>최종 발주 확정 완료</>
          ) : (
            <><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>최종 발주 확정</>
          )}
        </button>

        {/* 🏭 제작 진행 중 배너 */}
        {sangpanProductionStarted && confirmed && (
          <div className="flex items-center gap-3 bg-teal-50 border-2 border-teal-200 rounded-xl px-4 py-3.5">
            <div className="w-8 h-8 rounded-lg bg-teal-500 flex items-center justify-center flex-shrink-0">
              <svg className="w-4.5 h-4.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
            </div>
            <div>
              <p className="text-sm font-bold text-teal-800">공장에서 제작이 진행 중입니다</p>
              <p className="text-xs text-teal-600 mt-0.5">제작 진행 중에는 발주 내용 수정이 제한됩니다. 공장에서 제작 중단 시 수정 가능합니다.</p>
            </div>
          </div>
        )}

        {/* 긴급 조정 Alert */}
        <div className="flex items-start gap-3 bg-red-50 border border-red-200 rounded-xl px-4 py-3">
          <svg className="w-4 h-4 text-red-500 mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
          </svg>
          <p className="text-xs text-red-700 leading-relaxed">
            <span className="font-bold">⚠️ 주의</span>{"  "}공장 제작 시작 전까지는 내용 수정이 가능하며, 수정 시{" "}
            <span className="font-bold text-red-800">'확정 후 조정(긴급)'</span>{" "}상태로 전환됩니다.
          </p>
        </div>

        {/* 확정 후 조치 버튼들 */}
        {confirmed && (
          <div className="pt-1">
            <p className="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wide">발주 확정 후 조치</p>
            <div className="flex gap-3">
              <button
                onClick={() => onToast({ type: "warning", title: "긴급 조정 요청", message: "긴급 조정 요청이 공장으로 전달되었습니다.", duration: 4000 })}
                className="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-semibold
                           text-red-700 bg-red-50 hover:bg-red-100 border-2 border-red-200 hover:border-red-300
                           rounded-xl transition-all"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                </svg>
                긴급 조정
              </button>
              <button
                onClick={() => document.getElementById("section-d-sangpan-anchor")?.scrollIntoView({ behavior: "smooth" })}
                className="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-semibold
                           text-amber-700 bg-amber-50 hover:bg-amber-100 border-2 border-amber-200 hover:border-amber-300
                           rounded-xl transition-all"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                재마감 요청 →
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   상판 탭 — Section D: 재마감 요청 아코디언
═══════════════════════════════════════════════════════ */
function SangpanSectionD({ claims: initClaims, onToast, onClaimsChange }) {
  const [open, setOpen]     = useState(true);
  const [claims, setClaims] = useState(initClaims);

  /* ── 데이터 영속화: 변경 → 부모(App)로 전달 → localStorage 저장 ── */
  const didMountD = useRef(false);
  useEffect(() => {
    if (!didMountD.current) { didMountD.current = true; return; }
    if (onClaimsChange) onClaimsChange(claims);
  }, [claims]);

  /* ── cross-tab 동기화 ── */
  useEffect(() => {
    if (JSON.stringify(initClaims) !== JSON.stringify(claims)) setClaims(initClaims);
  }, [JSON.stringify(initClaims)]);
  const [newDate, setNewDate]       = useState("");
  const [newContent, setNewContent] = useState("");
  const [sending, setSending]       = useState(false);

  const statusStyle = {
    "재마감요청": "bg-orange-100 text-orange-700 border-orange-200",
    "재마감조정": "bg-amber-100 text-amber-700 border-amber-200",
    "재마감확정": "bg-emerald-100 text-emerald-700 border-emerald-200",
  };

  const handleSend = () => {
    if (!newDate || !newContent.trim()) {
      onToast({ type: "warning", title: "입력 확인", message: "희망 일정과 요청 사항을 모두 입력해주세요." });
      return;
    }
    setSending(true);
    setTimeout(() => {
      setClaims(prev => [...prev, {
        id: prev.length + 1, status: "재마감요청",
        requestDate: newDate, requestContent: newContent,
        sentAt: "2026-02-25 (방금)", factoryReply: null,
      }]);
      setNewDate(""); setNewContent(""); setSending(false);
      onToast({ type: "success", title: "재마감 요청 전송 완료", message: "공장으로 재마감 요청이 전송되었습니다." });
    }, 800);
  };

  return (
    <div id="section-d-sangpan-anchor" className="rounded-xl overflow-hidden border-2 border-dashed border-gray-300 bg-white">
      <button onClick={() => setOpen(p => !p)}
              className="w-full flex items-center justify-between px-5 py-4 hover:bg-gray-50 transition-colors">
        <div className="flex items-center gap-3">
          <div className="w-7 h-7 rounded-lg bg-amber-100 border border-amber-200 flex items-center justify-center flex-shrink-0">
            <svg className="w-4 h-4 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </div>
          <div className="text-left">
            <div className="flex items-center gap-2">
              <span className="text-base font-bold text-gray-800">Section D · 현장 재마감 요청</span>
              {claims.length > 0 && (
                <span className="text-xs font-bold px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 border border-amber-200">{claims.length}건</span>
              )}
            </div>
            <p className="text-xs text-gray-400 mt-1">항상 추가 요청 가능 · 공장으로 직접 전송</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {claims.some(c => c.status === "재마감조정") && (
            <span className="flex items-center gap-2 text-xs font-bold text-amber-700 bg-amber-100 border border-amber-200 px-2 py-1 rounded-full">
              <span className="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span>
              재마감 조정 (공장 확인 대기중)
            </span>
          )}
          <svg className={`w-5 h-5 text-gray-400 transition-transform duration-200 ${open ? "rotate-180" : ""}`}
               fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>

      {open && (
        <div className="border-t border-gray-200">
          {/* 기존 요청 */}
          {claims.length > 0 && (
            <div className="px-5 pt-4 pb-2 space-y-3">
              <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide">전송된 재마감 요청</p>
              {claims.map(claim => (
                <div key={claim.id} className="rounded-xl border border-gray-200 overflow-hidden">
                  <div className="flex items-center justify-between px-4 py-2 bg-gray-50 border-b border-gray-100">
                    <div className="flex items-center gap-2 text-xs text-gray-500">
                      <span className="font-semibold text-gray-700">#{claim.id}</span>
                      <span>·</span>
                      <span>희망일: <b className="text-gray-700">{claim.requestDate}</b></span>
                      <span>·</span>
                      <span>{claim.sentAt}</span>
                    </div>
                    <span className={`text-xs font-semibold px-2 py-1 rounded-full border ${statusStyle[claim.status] || ""}`}>
                      {claim.status}
                    </span>
                  </div>
                  <div className="px-4 py-3 bg-white space-y-2">
                    <p className="text-sm text-gray-700">{claim.requestContent}</p>
                    {claim.factoryReply && (
                      <div className="flex items-start gap-2 bg-brand-weak border border-brand/10 rounded-lg px-3 py-2">
                        <svg className="w-3.5 h-3.5 text-brand mt-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                        <p className="text-xs text-gray-600 leading-relaxed">{claim.factoryReply}</p>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
          {claims.length > 0 && <div className="mx-5 my-3 border-t border-dashed border-gray-200"></div>}

          {/* 신규 폼 */}
          <div className="px-5 pb-5 space-y-3">
            <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide flex items-center gap-2">
              <svg className="w-3.5 h-3.5 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
              </svg>신규 재마감 요청 작성
            </p>
            <div>
              <label className="block text-xs text-gray-500 font-medium mb-1.5">재마감 희망 일정</label>
              <input type="date" value={newDate} onChange={e => setNewDate(e.target.value)}
                     className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent" />
            </div>
            <div>
              <label className="block text-xs text-gray-500 font-medium mb-1.5">요청 사항</label>
              <textarea value={newContent} onChange={e => setNewContent(e.target.value)} rows={3}
                        placeholder="공장에 전달할 재마감 요청 내용을 입력하세요."
                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent text-gray-700 leading-relaxed placeholder:text-gray-300" />
            </div>
            <div className="flex justify-end">
              <button onClick={handleSend} disabled={sending}
                      className="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-amber-500 hover:bg-amber-600 disabled:bg-amber-300 rounded-xl shadow-sm transition-all">
                {sending ? (
                  <><svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>전송 중…</>
                ) : (
                  <><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>공장으로 전송</>
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   상판 탭 — 전체 레이아웃
═══════════════════════════════════════════════════════ */
function SangpanTab({ onToast, onStatusChange, silcheukImages, silcheukResultDone = false, onSangpanSchedule, sangpanData = {}, onSangpanVersionsChange, onDrawingChange, silcheukFinalDate = "", onSectionCChange, onClaimsChange, sangpanProductionStarted = false, onUrgentChange, mokdaeData = {}, mokdaeProductionStarted = false, gigiOrderData = null }) {
  const sd = sangpanData;

  /* 발주서 재발송 시 도면 승인 상태 전부 해제 */
  const handleDrawingReset = useCallback(() => {
    const drawingVersions = sd.drawingVersions || [];
    if (drawingVersions.length > 0) {
      const resetDrawing = drawingVersions.map(v => ({ ...v, status: "승인해제" }));
      if (onDrawingChange) onDrawingChange(resetDrawing);
    }
  }, [sd.drawingVersions, onDrawingChange]);

  /* 긴급발주 시 Section C (소비자 승인 & 발주 확정) 리셋 */
  const handleSectionCReset = useCallback(() => {
    if (onSectionCChange) onSectionCChange({ consumerApproved: false, confirmedAt: null });
  }, [onSectionCChange]);

  return (
    <div className="p-5 space-y-5 max-w-4xl">

      <SangpanSectionA
        versions={sd.versions || []}
        activeVer={(sd.versions && sd.versions.length > 0) ? sd.versions[sd.versions.length - 1].versionNo : 1}
        onToast={onToast}
        onStatusChange={onStatusChange}
        silcheukImages={silcheukImages || []}
        silcheukResultDone={silcheukResultDone}
        onSangpanSchedule={onSangpanSchedule}
        uploadedFiles={sd.uploadedFiles || {}}
        onVersionsChange={onSangpanVersionsChange}
        silcheukFinalDate={silcheukFinalDate}
        sangpanProductionStarted={sangpanProductionStarted}
        sangpanConfirmedAt={sd.confirmedAt || null}
        onDrawingReset={handleDrawingReset}
        onUrgentChange={onUrgentChange}
        onSectionCReset={handleSectionCReset}
        mokdaeData={mokdaeData}
        mokdaeProductionStarted={mokdaeProductionStarted}
        gigiOrderData={gigiOrderData}
      />
      <SangpanSectionB
        drawingVersions={sd.drawingVersions || []}
        activeVer={(sd.drawingVersions && sd.drawingVersions.length > 0) ? sd.drawingVersions[sd.drawingVersions.length - 1].versionNo : 1}
        onToast={onToast}
        onDrawingChange={onDrawingChange}
      />
      <SangpanSectionC
        data={{ consumerApproved: sd.consumerApproved || false, confirmedAt: sd.confirmedAt || null }}
        onToast={onToast}
        onConfirmChange={onSectionCChange}
        sangpanProductionStarted={sangpanProductionStarted}
      />
      <SangpanSectionD
        claims={sd.claims || []}
        onToast={onToast}
        onClaimsChange={onClaimsChange}
      />

      <div className="h-4"></div>
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   목대 탭 — 전체 레이아웃
═══════════════════════════════════════════════════════ */
function MokdaeTab({ onToast, onStatusChange, silcheukImages, onMokdaeSchedule, mokdaeData = {}, onMokdaeVersionsChange, onCadChange, silcheukFinalDate = "", onSectionCChange, onClaimsChange, mokdaeProductionStarted = false, onUrgentChange }) {
  const md = mokdaeData;

  /* 발주서 재발송 시 CAD 승인 상태 전부 해제 */
  const handleCadReset = useCallback(() => {
    const cadVersions = md.cadVersions || [];
    if (cadVersions.length > 0) {
      const resetCad = cadVersions.map(v => ({ ...v, status: "승인해제" }));
      if (onCadChange) onCadChange(resetCad);
    }
  }, [md.cadVersions, onCadChange]);

  /* 긴급발주 시 Section C (소비자 승인 & 발주 확정) 리셋 */
  const handleSectionCReset = useCallback(() => {
    if (onSectionCChange) onSectionCChange({ consumerApproved: false, confirmedAt: null });
  }, [onSectionCChange]);

  return (
    <div className="p-5 space-y-5 max-w-4xl">

      <MokdaeSectionA
        versions={md.versions || []}
        activeVer={(md.versions && md.versions.length > 0) ? md.versions[md.versions.length - 1].versionNo : 1}
        onToast={onToast}
        onStatusChange={onStatusChange}
        silcheukImages={silcheukImages || []}
        onMokdaeSchedule={onMokdaeSchedule}
        uploadedFiles={md.uploadedFiles || {}}
        onVersionsChange={onMokdaeVersionsChange}
        silcheukFinalDate={silcheukFinalDate}
        mokdaeProductionStarted={mokdaeProductionStarted}
        mokdaeConfirmedAt={md.confirmedAt || null}
        onCadReset={handleCadReset}
        onUrgentChange={onUrgentChange}
        onSectionCReset={handleSectionCReset}
      />
      <MokdaeSectionB
        cadVersions={md.cadVersions || []}
        activeVer={(md.cadVersions && md.cadVersions.length > 0) ? md.cadVersions[md.cadVersions.length - 1].versionNo : 1}
        onToast={onToast}
        onCadChange={onCadChange}
      />
      <MokdaeSectionC
        data={{ consumerApproved: md.consumerApproved || false, confirmedAt: md.confirmedAt || null }}
        onToast={onToast}
        onConfirmChange={onSectionCChange}
        mokdaeProductionStarted={mokdaeProductionStarted}
      />
      <MokdaeSectionD
        claims={md.claims || []}
        onToast={onToast}
        onClaimsChange={onClaimsChange}
      />

      <div className="h-4"></div>
    </div>
  );
}

/* ═══════════════════════════════════════════════════════
   RIGHT PANEL — 탭 + 컨텐츠
═══════════════════════════════════════════════════════ */
const TABS = ["실측", "목대", "기기", "상판"];
const TAB_ICONS = {
  실측: (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 11h.01M12 11h.01M15 11h.01M4 19h16a2 2 0 002-2V7a2 2 0 00-2-2H4a2 2 0 00-2 2v10a2 2 0 002 2z" />
    </svg>
  ),
  목대: (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
    </svg>
  ),
  기기: (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18" />
    </svg>
  ),
  상판: (
    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />
    </svg>
  ),
};

const TAB_ALERT = {
  실측: { icon: "!", cls: "bg-brand-weak text-brand" },
  목대: { icon: "!", cls: "bg-orange-100 text-orange-600" },
  상판: { icon: "!", cls: "bg-purple-100 text-purple-600" },
};

const TAB_STATUS_KEYS = { 실측: "silcheuk", 목대: "mokdae", 기기: "gigi", 상판: "sangpan" };

function getTabStatusStyle(text) {
  if (!text) return "text-gray-400";
  const t = text.toLowerCase();
  if (t.includes("반려") || t.includes("수정요청") || t.includes("긴급")) return "text-red-500 font-semibold";
  if (t.includes("확정") || t.includes("완료")) return "text-emerald-600 font-semibold";
  if (t.includes("검토") || t.includes("진행") || t.includes("예정") || t.includes("중")) return "text-brand";
  return "text-gray-400";
}

function RightPanel({ onToast, onScheduleUnlock, caseStatus, onStatusChange, silcheukData, onProposalsSend, onFinalConfirm, onResultConfirm, onMokdaeSchedule, mokdaeData, onMokdaeVersionsChange, onCadChange, onSectionCChange, onClaimsChange, mokdaeProductionStarted, onGigiSchedule, onGigiOrderSubmit, gigiOrderData, onSangpanSchedule, sangpanData, onSangpanVersionsChange, onDrawingChange, onSangpanSectionCChange, onSangpanClaimsChange, sangpanProductionStarted, onMokdaeUrgentChange, onSangpanUrgentChange }) {
  const [activeTab, setActiveTab] = useState("목대");

  return (
    <main className="flex-1 flex flex-col min-w-0 h-full overflow-hidden">
      {/* 탭 네비게이션 */}
      <div className="bg-white border-b border-gray-200 flex-shrink-0">
        <div className="flex px-4">
          {TABS.map(tab => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`flex flex-col items-center gap-0.5 px-5 py-2 text-sm transition-all duration-150
                ${activeTab === tab ? "tab-active" : "tab-inactive"}`}
            >
              <div className="flex items-center gap-1.5">
                {TAB_ICONS[tab]}
                <span>{tab}</span>
                {TAB_ALERT[tab] && (
                  <span className={`flex items-center justify-center w-4 h-4 rounded-full text-xs font-bold ${TAB_ALERT[tab].cls}`}>
                    {TAB_ALERT[tab].icon}
                  </span>
                )}
              </div>
              {caseStatus && (
                <span className={`text-xs font-normal whitespace-nowrap ${getTabStatusStyle(caseStatus[TAB_STATUS_KEYS[tab]])}`}>
                  {caseStatus[TAB_STATUS_KEYS[tab]] || "-"}
                </span>
              )}
            </button>
          ))}
        </div>
      </div>

      {/* 탭 컨텐츠 — 모든 탭을 상시 마운트해 상태 유실 방지, inline style로 가시성 제어 */}
      <div className="flex-1 overflow-y-auto">
        <div style={{ display: activeTab !== "실측" ? "none" : "" }} className="p-5 space-y-6 max-w-4xl">
          <SectionSchedule
            data={silcheukData || { proposals: [], sent: false, engResponse: null }}
            onToast={onToast}
            onScheduleUnlock={onScheduleUnlock}
            onStatusChange={onStatusChange}
            onProposalsSend={onProposalsSend}
            onFinalConfirm={onFinalConfirm}
            resultDone={silcheukData?.resultDone || false}
          />
          <hr className="border-gray-200" />
          <SectionResult
            data={{
              images: [
                ...(silcheukData?.uploadResult?.drawings || []).map(f => ({ ...f, label: f.name, category: "도면" })),
                ...(silcheukData?.uploadResult?.photos   || []).map(f => ({ ...f, label: f.name, category: "사진" })),
              ],
              memo:        silcheukData?.uploadResult?.memo        || "",
              submittedAt: silcheukData?.uploadResult?.submittedAt || null,
              isDone:      silcheukData?.resultDone || false,
            }}
            onToast={onToast}
            onConfirm={onResultConfirm}
          />
        </div>
        <div style={{ display: activeTab !== "목대" ? "none" : "" }}>
          <MokdaeTab
            onToast={onToast}
            onStatusChange={onStatusChange}
            silcheukImages={[
              ...(silcheukData?.uploadResult?.drawings || []).map(f => ({ ...f, label: f.name, category: "도면" })),
              ...(silcheukData?.uploadResult?.photos   || []).map(f => ({ ...f, label: f.name, category: "사진" })),
            ]}
            onMokdaeSchedule={onMokdaeSchedule}
            mokdaeData={mokdaeData}
            onMokdaeVersionsChange={onMokdaeVersionsChange}
            onCadChange={onCadChange}
            silcheukFinalDate={silcheukData?.finalDate || ""}
            onSectionCChange={onSectionCChange}
            onClaimsChange={onClaimsChange}
            mokdaeProductionStarted={mokdaeProductionStarted}
            onUrgentChange={onMokdaeUrgentChange}
          />
        </div>
        <div style={{ display: activeTab !== "상판" ? "none" : "" }}>
          <SangpanTab
            onToast={onToast}
            onStatusChange={onStatusChange}
            silcheukImages={[
              ...(silcheukData?.uploadResult?.drawings || []).map(f => ({ ...f, label: f.name, category: "도면" })),
              ...(silcheukData?.uploadResult?.photos   || []).map(f => ({ ...f, label: f.name, category: "사진" })),
            ]}
            silcheukResultDone={silcheukData?.resultDone || false}
            onSangpanSchedule={onSangpanSchedule}
            sangpanData={sangpanData}
            onSangpanVersionsChange={onSangpanVersionsChange}
            onDrawingChange={onDrawingChange}
            silcheukFinalDate={silcheukData?.finalDate || ""}
            onSectionCChange={onSangpanSectionCChange}
            onClaimsChange={onSangpanClaimsChange}
            sangpanProductionStarted={sangpanProductionStarted}
            onUrgentChange={onSangpanUrgentChange}
            mokdaeData={mokdaeData}
            mokdaeProductionStarted={mokdaeProductionStarted}
            gigiOrderData={gigiOrderData}
          />
        </div>
        <div style={{ display: activeTab !== "기기" ? "none" : "" }}>
          <GigiTab onToast={onToast} onGigiOrderSubmit={onGigiOrderSubmit} gigiOrderData={gigiOrderData} />
        </div>
      </div>
    </main>
  );
}

/* ═══════════════════════════════════════════════════════
   APP ROOT
═══════════════════════════════════════════════════════ */
function App() {
  const { toasts, add: addToast, remove: removeToast } = useToast();

  /* URL에서 ID 읽어 localStorage 데이터 로드 */
  const caseId = getCaseId();
  const getInitialCase = () => {
    /* 신규 현장 생성 모드 (?new=1) — localStorage에 아직 저장 안 된 상태 */
    if (isNewCaseMode()) {
      return {
        id: "", archived: false,
        manager: "", customer: "", phone: "", address: "",
        schedule: { silcheuk: "", mokdae: "", gigi: "", sangpan: "" },
        status:   { silcheuk: "", mokdae: "", gigi: "", sangpan: "" },
        silcheukProposals: [], silcheukSent: false, silcheukEngResponse: null,
        silcheukFinalized: false, silcheukFinalDate: "", silcheukFinalTime: "",
      };
    }
    if (caseId) {
      const loaded = loadItemById(caseId);
      if (loaded) return loaded;
      /* ID는 있으나 데이터 없음 — 빈 케이스 반환 */
      return {
        id: caseId, archived: false,
        manager: "", customer: "", phone: "", address: "",
        schedule: { silcheuk: "", mokdae: "", gigi: "", sangpan: "" },
        status:   { silcheuk: "", mokdae: "", gigi: "", sangpan: "" },
        silcheukProposals: [], silcheukSent: false, silcheukEngResponse: null,
        silcheukFinalized: false, silcheukFinalDate: "", silcheukFinalTime: "",
      };
    }
    /* URL 파라미터 없을 경우 index로 리다이렉트 */
    window.location.replace('index.html');
    return null;
  };

  const [caseData, setCaseData] = useState(getInitialCase);
  const [isNew, setIsNew] = useState(isNewCaseMode);

  /* ── DB에서 케이스 데이터 로드 (최초 1회) ── */
  useEffect(() => {
    if (!caseId || isNewCaseMode()) return;
    (async () => {
      try {
        // 케이스 데이터 + 기기 데이터 동시 로드
        const [caseFromDb, gigiOrderFromDb] = await Promise.all([
          loadCaseFromDB(caseId),
          fetchGigiOrderFromDB(caseId),
        ]);

        setCaseData(prev => {
          let merged = caseFromDb ? { ...prev, ...caseFromDb } : prev;
          // 기기 데이터 병합 (DB 기준)
          if (gigiOrderFromDb) {
            merged = { ...merged, gigiOrderData: gigiOrderFromDb };
            if (gigiOrderFromDb.status) {
              merged.status = { ...merged.status, gigi: gigiOrderFromDb.status };
            }
          }
          // localStorage도 동기화
          const items = loadAllItems() || [];
          const idx = items.findIndex(i => i.id === merged.id);
          if (idx >= 0) items[idx] = merged; else items.push(merged);
          try { localStorage.setItem(LS_KEY, JSON.stringify(items)); } catch(e) {}
          return merged;
        });
      } catch (e) {
        console.warn("DB 데이터 로드 실패:", e);
      }
    })();
  }, [caseId]);

  /* 실측 일정 잠금: 실측 탭 고객 전달 완료 후 최종 일정 자동 입력 */
  /* scheduleEditable 제거: 실측·목대 일정 표시가 *FinalDate 데이터 기반으로 전환됨 */

  /* engineer.html이 localStorage를 수정하면 caseData 자동 갱신
     - storage 이벤트: 다른 탭에서 변경됐을 때
     - visibilitychange: 이 탭이 다시 활성화될 때 (같은 origin 탭 전환 시) */
  useEffect(() => {
    if (!caseId) return;
    const refresh = () => {
      const fresh = loadItemById(caseId);
      if (fresh) {
        setCaseData(prev => {
          // Preserve gigiOrderData from DB since localStorage doesn't store it
          const merged = { ...fresh };
          if (prev?.gigiOrderData && !merged.gigiOrderData) {
            merged.gigiOrderData = prev.gigiOrderData;
          }
          return merged;
        });
      }
    };
    const onStorage = (e) => {
      if (e.key !== LS_KEY) return;
      refresh();
    };
    const onVisible = () => {
      if (document.visibilityState === 'visible') {
        // Re-fetch gigi data from DB on tab focus
        (async () => {
          try {
            const gigiOrderFromDb = await fetchGigiOrderFromDB(caseId);

            setCaseData(prev => {
              if (!prev) return prev;
              const fresh = loadItemById(caseId);
              let merged = fresh ? { ...prev, ...fresh } : prev;
              if (gigiOrderFromDb) {
                merged = { ...merged, gigiOrderData: gigiOrderFromDb };
                if (gigiOrderFromDb.status) {
                  merged.status = { ...merged.status, gigi: gigiOrderFromDb.status };
                }
              } else if (prev.gigiOrderData) {
                merged.gigiOrderData = prev.gigiOrderData;
              }
              return merged;
            });
          } catch (e) {
            console.warn("Visibility refresh failed:", e);
          }
        })();
      }
    };
    window.addEventListener('storage', onStorage);
    document.addEventListener('visibilitychange', onVisible);
    return () => {
      window.removeEventListener('storage', onStorage);
      document.removeEventListener('visibilitychange', onVisible);
    };
  }, [caseId]);

  /* 저장 핸들러 — localStorage 동기화 후 헤더도 갱신 */
  const handleSaveCase = useCallback((formData) => {
    /* 신규 현장: 중복 상담 ID 검사 */
    if (isNew) {
      const allItems = loadAllItems() || [];
      if (allItems.some(i => i.id === formData.id)) {
        addToast({ type: "error", title: "저장 실패", message: "동일한 상담 ID로 등록된 현장이 있습니다." });
        return false;
      }
      persistItem(formData);
      sessionStorage.setItem('CURRENT_CASE_ID', formData.id);
      setIsNew(false);
      setCaseData(formData);
      addToast({ type: "success", title: "저장 완료", message: "새 현장이 등록되었습니다." });
      return true;
    }
    /* 기존 현장: LeftPanel form 데이터(기본정보·일정·상태)를 기존 caseData에 병합
       → silcheuk*, mokdae* 등 RightPanel이 관리하는 필드를 보존 */
    setCaseData(prev => {
      const merged = { ...prev, ...formData };
      persistItem(merged);
      return merged;
    });
    addToast({ type: "success", title: "저장 완료", message: "변경사항이 대시보드에 반영됩니다." });
    return true;
  }, [addToast, isNew]);

  useEffect(() => {
    if (caseData) document.title = `현장 상세 - ${caseData.id} | 직시공 발주 관리 시스템`;
  }, [caseData?.id]);

  /* 실측 희망 일정 발송 / 초기화 → localStorage 영속화 */
  const handleProposalsSend = useCallback((proposals, sent = true) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, silcheukProposals: proposals, silcheukSent: sent };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* 실측 결과 검수 완료 → silcheuk 상태 "완료" + localStorage 영속화 */
  const handleResultConfirm = useCallback(() => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        silcheukResultDone: true,
        status: { ...prev.status, silcheuk: "완료" },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* 최종 일정 확정 (고객 안내 전달 완료) → localStorage 영속화 → engineer.html 연동
     핵심: schedule.silcheuk 에도 동일 일정을 기록해야
     index.html 대시보드와 detail.html 공정일정 좌측패널에 자동 반영됨 */
  const handleFinalConfirm = useCallback((date, time) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        silcheukFinalized:  true,
        silcheukFinalDate:  date,
        silcheukFinalTime:  time,
        schedule: {
          ...(prev.schedule || {}),
          silcheuk: date,          // ← 공정일정·대시보드 공용 필드에 확정일 기록
        },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* 목대 발주서 공장 승인 확정 일정 → schedule.mokdae에 기록 → LeftPanel·index.html 자동 반영 */
  const handleMokdaeSchedule = useCallback((date) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      /* 동일 값이면 무한 루프 방지 */
      if (prev.mokdaeFinalDate === date) return prev;
      const updated = {
        ...prev,
        mokdaeFinalDate: date,
        schedule: { ...(prev.schedule || {}), mokdae: date },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* 목대 발주서 버전·파일 변경 → localStorage 영속화 */
  const handleMokdaeVersionsChange = useCallback((versions, uploadedFiles) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, mokdaeVersions: versions, mokdaeUploadedFiles: uploadedFiles };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* CAD 도면 버전 변경 → localStorage 영속화 */
  const handleCadVersionsChange = useCallback((cadVersions) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, cadVersions };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* 목대 SectionC 소비자 승인 / 발주 확정 → localStorage 영속화 */
  const handleSectionCChange = useCallback(({ consumerApproved, confirmedAt }) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        mokdaeConsumerApproved: consumerApproved,
        mokdaeConfirmedAt: confirmedAt,
      };
      if (confirmedAt && prev.status?.mokdae !== "제작진행") {
        updated.status = { ...updated.status, mokdae: "발주확정" };
      }
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* 목대 긴급발주 (확정 후 수정) → status.mokdae = "확정후조정(긴급)" → localStorage 영속화 */
  const handleMokdaeUrgentChange = useCallback(() => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        status: { ...prev.status, mokdae: "확정후조정(긴급)" },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* 상판 긴급발주 (확정 후 수정) → status.sangpan = "확정후조정(긴급)" → localStorage 영속화 */
  const handleSangpanUrgentChange = useCallback(() => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        status: { ...prev.status, sangpan: "확정후조정(긴급)" },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* 목대 SectionD 재마감 요청 → localStorage 영속화 */
  const handleClaimsChange = useCallback((claims) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, mokdaeClaims: claims };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* ═══ 기기 Handlers ═══ */
  const handleGigiSchedule = useCallback((date) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      if (prev.gigiFinalDate === date) return prev;
      const updated = {
        ...prev,
        gigiFinalDate: date,
        schedule: { ...(prev.schedule || {}), gigi: date },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleGigiOrderSubmit = useCallback(async (orderData) => {
    if (isNew) return { ok: false };
    const cid = caseId;
    if (!cid) {
      addToast({ type: "error", title: "저장 실패", message: "상담 ID를 확인할 수 없어 기기 발주를 저장하지 못했습니다." });
      return { ok: false };
    }

    try {
      const savedOrderData = await upsertGigiOrderToDB(cid, orderData);

      setCaseData(prev => {
        if (!prev) return prev;
        const updated = {
          ...prev,
          gigiOrderData: savedOrderData,
          status: { ...prev.status, gigi: savedOrderData.status || orderData.status },
        };
        persistItem(updated);
        return updated;
      });

      return { ok: true, data: savedOrderData };
    } catch (e) {
      console.warn("기기 발주 DB 저장 실패:", e);
      addToast({ type: "error", title: "저장 실패", message: "기기 발주 요청 DB 저장에 실패했습니다. 다시 시도해주세요." });
      return { ok: false, error: e };
    }
  }, [isNew, caseId, addToast]);

  /* ═══ 상판 Handlers (목대와 동일 패턴) ═══ */

  const handleSangpanSchedule = useCallback((date) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      if (prev.sangpanFinalDate === date) return prev;
      const updated = {
        ...prev,
        sangpanFinalDate: date,
        schedule: { ...(prev.schedule || {}), sangpan: date },
      };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleSangpanVersionsChange = useCallback((versions, uploadedFiles) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, sangpanVersions: versions, sangpanUploadedFiles: uploadedFiles };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleSangpanDrawingChange = useCallback((drawingVersions) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, sangpanDrawingVersions: drawingVersions };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleSangpanSectionCChange = useCallback(({ consumerApproved, confirmedAt }) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = {
        ...prev,
        sangpanConsumerApproved: consumerApproved,
        sangpanConfirmedAt: confirmedAt,
      };
      if (confirmedAt && prev.status?.sangpan !== "제작진행") {
        updated.status = { ...updated.status, sangpan: "발주확정" };
      }
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  const handleSangpanClaimsChange = useCallback((claims) => {
    if (isNew) return;
    setCaseData(prev => {
      if (!prev) return prev;
      const updated = { ...prev, sangpanClaims: claims };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  /* 탭 컴포넌트 상태 변경 → localStorage 자동 저장 → 대시보드 연동 */
  const handleStatusChange = useCallback((tabKey, status) => {
    if (isNew) return; // 신규 현장은 ID 미확정 상태이므로 생략
    setCaseData(prev => {
      if (!prev || prev.status[tabKey] === status) return prev; // 변경 없으면 스킵
      const updated = { ...prev, status: { ...prev.status, [tabKey]: status } };
      persistItem(updated);
      return updated;
    });
  }, [isNew]);

  if (!caseData) return null;

  const customerInitial = caseData.customer ? caseData.customer[0] : "?";

  return (
    <div className="flex flex-col h-full">
      {/* ── 글로벌 헤더 ── */}
      <header className="bg-gray-900 text-white flex-shrink-0 flex items-center px-5 py-2 gap-4 shadow z-20">
        {/* 뒤로가기 */}
        <button
          onClick={() => {
            sessionStorage.removeItem('CURRENT_CASE_ID');
            window.location.href = 'index.html';
          }}
          className="flex items-center gap-2 text-gray-400 hover:text-white text-sm transition-colors px-2 py-1 rounded-lg hover:bg-white/10"
        >
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
          </svg>
          목록으로
        </button>

        <div className="w-px h-5 bg-gray-700"></div>

        {/* 시스템 로고 */}
        <div className="flex items-center gap-2">
          <img src="/images/ohouse-logo.png" alt="오늘의집" className="h-7 brightness-0 invert" />
          <span className="text-sm font-medium text-gray-400 hidden sm:block">발주 시스템</span>
        </div>

        {/* 빵부스러기 + 상담ID */}
        <div className="flex items-center gap-2 text-sm text-gray-400">
          <span>현장 상세</span>
          <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
          </svg>
          <span className="font-mono text-brand font-semibold">{caseData.id}</span>
        </div>

        {/* 고객명 뱃지 */}
        <div className="flex items-center gap-2 bg-white/10 rounded-lg px-3 py-1.5">
          <div className="w-5 h-5 rounded-full bg-brand flex items-center justify-center text-white text-xs font-bold">
            {customerInitial}
          </div>
          <span className="text-sm text-white font-medium">
            {caseData.customer || "신규 현장"} 고객
          </span>
        </div>

        <div className="ml-auto flex items-center gap-3 text-xs text-gray-400">
          <span>마지막 수정: 2026-02-25 14:32</span>
        </div>
      </header>

      {/* ── Split View ── */}
      <div className="flex flex-1 min-h-0">
        <LeftPanel data={caseData} onSave={handleSaveCase} isNew={isNew} silcheukFinalDate={caseData.silcheukFinalDate || ""} mokdaeFinalDate={caseData.mokdaeFinalDate || ""} gigiFinalDate={caseData.gigiFinalDate || ""} sangpanFinalDate={caseData.sangpanFinalDate || ""} />
        <RightPanel
          onToast={addToast}
          onScheduleUnlock={() => { /* no-op: 일정 표시가 *FinalDate 데이터 기반으로 전환됨 */ }}
          caseStatus={caseData.status}
          onStatusChange={handleStatusChange}
          silcheukData={{
            proposals:    caseData.silcheukProposals    || [],
            sent:         caseData.silcheukSent          || false,
            engResponse:  caseData.silcheukEngResponse  || null,
            finalized:    caseData.silcheukFinalized     || false,
            finalDate:    caseData.silcheukFinalDate     || "",
            finalTime:    caseData.silcheukFinalTime     || "",
            uploadResult: caseData.silcheukUploadResult  || null,
            resultDone:   caseData.silcheukResultDone    || false,
          }}
          onProposalsSend={handleProposalsSend}
          onFinalConfirm={handleFinalConfirm}
          onResultConfirm={handleResultConfirm}
          onMokdaeSchedule={handleMokdaeSchedule}
          mokdaeData={{
            versions:         caseData.mokdaeVersions         || [],
            uploadedFiles:    caseData.mokdaeUploadedFiles     || {},
            cadVersions:      caseData.cadVersions             || [],
            consumerApproved: caseData.mokdaeConsumerApproved  || false,
            confirmedAt:      caseData.mokdaeConfirmedAt       || null,
            claims:           caseData.mokdaeClaims            || [],
          }}
          onMokdaeVersionsChange={handleMokdaeVersionsChange}
          onCadChange={handleCadVersionsChange}
          onSectionCChange={handleSectionCChange}
          onClaimsChange={handleClaimsChange}
          mokdaeProductionStarted={caseData.mokdaeProductionStarted || false}
          onGigiSchedule={handleGigiSchedule}
          onGigiOrderSubmit={handleGigiOrderSubmit}
          gigiOrderData={caseData.gigiOrderData || null}
          onSangpanSchedule={handleSangpanSchedule}
          sangpanData={{
            versions:         caseData.sangpanVersions          || [],
            uploadedFiles:    caseData.sangpanUploadedFiles      || {},
            drawingVersions:  caseData.sangpanDrawingVersions    || [],
            consumerApproved: caseData.sangpanConsumerApproved   || false,
            confirmedAt:      caseData.sangpanConfirmedAt        || null,
            claims:           caseData.sangpanClaims             || [],
          }}
          onSangpanVersionsChange={handleSangpanVersionsChange}
          onDrawingChange={handleSangpanDrawingChange}
          onSangpanSectionCChange={handleSangpanSectionCChange}
          onSangpanClaimsChange={handleSangpanClaimsChange}
          sangpanProductionStarted={caseData.sangpanProductionStarted || false}
          onMokdaeUrgentChange={handleMokdaeUrgentChange}
          onSangpanUrgentChange={handleSangpanUrgentChange}
        />
      </div>

      {/* ── Toast 컨테이너 ── */}
      <ToastContainer toasts={toasts} onRemove={removeToast} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
